<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.34">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="logo.png"><title>WebGL | 数据可视化</title><meta name="description" content="Leon's library">
    <link rel="modulepreload" href="/visual/assets/app.6795915a.js"><link rel="modulepreload" href="/visual/assets/WebGL-share.html.65bc6f30.js"><link rel="modulepreload" href="/visual/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/visual/assets/WebGL-share.html.25ee364f.js">
    <link rel="stylesheet" href="/visual/assets/style.14b7ee11.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/visual/" class=""><img class="logo" src="/visual/logo.png" alt="数据可视化"><span class="site-name can-hide">数据可视化</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/visual/computer/ComputerGraphics.md" class="" aria-label="计算机图形学"><!--[--><!--]--> 计算机图形学 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="WebGL"><span class="title">WebGL</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="WebGL"><span class="title">WebGL</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>WebGL</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/visual/webgl/WebGL-share.md" class="" aria-label="WebGL基础"><!--[--><!--]--> WebGL基础 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/visual/webgl/WebGL-practice.md" class="" aria-label="WebGL实践"><!--[--><!--]--> WebGL实践 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>GLSL ES</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/visual/webgl/GLSL-ES-basic.md" class="" aria-label="GLSL ES基础"><!--[--><!--]--> GLSL ES基础 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/visual/webgl/GLSL-ES-practice.md" class="" aria-label="GLSL ES实践"><!--[--><!--]--> GLSL ES实践 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a href="/visual/threejs/index.md" class="" aria-label="ThreeJS"><!--[--><!--]--> ThreeJS <!--[--><!--]--></a></div><div class="navbar-item"><a href="/visual/echarts/index.md" class="" aria-label="Echarts"><!--[--><!--]--> Echarts <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="Search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/visual/computer/ComputerGraphics.md" class="" aria-label="计算机图形学"><!--[--><!--]--> 计算机图形学 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="WebGL"><span class="title">WebGL</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="WebGL"><span class="title">WebGL</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>WebGL</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/visual/webgl/WebGL-share.md" class="" aria-label="WebGL基础"><!--[--><!--]--> WebGL基础 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/visual/webgl/WebGL-practice.md" class="" aria-label="WebGL实践"><!--[--><!--]--> WebGL实践 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>GLSL ES</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/visual/webgl/GLSL-ES-basic.md" class="" aria-label="GLSL ES基础"><!--[--><!--]--> GLSL ES基础 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/visual/webgl/GLSL-ES-practice.md" class="" aria-label="GLSL ES实践"><!--[--><!--]--> GLSL ES实践 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a href="/visual/threejs/index.md" class="" aria-label="ThreeJS"><!--[--><!--]--> ThreeJS <!--[--><!--]--></a></div><div class="navbar-item"><a href="/visual/echarts/index.md" class="" aria-label="Echarts"><!--[--><!--]--> Echarts <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">WebGL <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#一、webgl介绍" class="router-link-active router-link-exact-active sidebar-item" aria-label="一、WebGL介绍"><!--[--><!--]--> 一、WebGL介绍 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-webgl的起源" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.WebGL的起源"><!--[--><!--]--> 1.WebGL的起源 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-webgl程序的结构" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.WebGL程序的结构"><!--[--><!--]--> 2.WebGL程序的结构 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#二、webgl基础知识" class="router-link-active router-link-exact-active sidebar-item" aria-label="二、WebGL基础知识"><!--[--><!--]--> 二、WebGL基础知识 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-刷底色" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.刷底色"><!--[--><!--]--> 1.刷底色 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-webgl-坐标系" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.webgl 坐标系"><!--[--><!--]--> 2.webgl 坐标系 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_3-webgl-画一个点" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.webgl 画一个点"><!--[--><!--]--> 3.webgl 画一个点 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#三、js与着色器间的数据传输" class="router-link-active router-link-exact-active sidebar-item" aria-label="三、js与着色器间的数据传输"><!--[--><!--]--> 三、js与着色器间的数据传输 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-js控制顶点位置" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.js控制顶点位置"><!--[--><!--]--> 1.js控制顶点位置 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-webgl同步绘图原理" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.webgl同步绘图原理"><!--[--><!--]--> 2.webgl同步绘图原理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_3-鼠标控制点位" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.鼠标控制点位"><!--[--><!--]--> 3.鼠标控制点位 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_4-js修改顶点颜色" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.js修改顶点颜色"><!--[--><!--]--> 4.js修改顶点颜色 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_5-鼠标绘制随机颜色的点" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.鼠标绘制随机颜色的点"><!--[--><!--]--> 5.鼠标绘制随机颜色的点 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_6-绘制圆点" class="router-link-active router-link-exact-active sidebar-item" aria-label="6.绘制圆点"><!--[--><!--]--> 6.绘制圆点 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#四、绘制图形" class="router-link-active router-link-exact-active sidebar-item" aria-label="四、绘制图形"><!--[--><!--]--> 四、绘制图形 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-三维模型绘图" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.三维模型绘图"><!--[--><!--]--> 1.三维模型绘图 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-绘制多个点" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.绘制多个点"><!--[--><!--]--> 2.绘制多个点 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_3-绘制图形" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.绘制图形"><!--[--><!--]--> 3.绘制图形 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_4-绘制矩形" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.绘制矩形"><!--[--><!--]--> 4.绘制矩形 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_5-buffer缓冲区异步绘制" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.Buffer缓冲区异步绘制"><!--[--><!--]--> 5.Buffer缓冲区异步绘制 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_6-封装多边形对象" class="router-link-active router-link-exact-active sidebar-item" aria-label="6.封装多边形对象"><!--[--><!--]--> 6.封装多边形对象 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_7-鼠标画线" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.鼠标画线"><!--[--><!--]--> 7.鼠标画线 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_8-鼠标画多线" class="router-link-active router-link-exact-active sidebar-item" aria-label="8.鼠标画多线"><!--[--><!--]--> 8.鼠标画多线 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_9-图形转面" class="router-link-active router-link-exact-active sidebar-item" aria-label="9.图形转面"><!--[--><!--]--> 9.图形转面 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#五、矩阵变换" class="router-link-active router-link-exact-active sidebar-item" aria-label="五、矩阵变换"><!--[--><!--]--> 五、矩阵变换 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-平移" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.平移"><!--[--><!--]--> 1.平移 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-旋转" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.旋转"><!--[--><!--]--> 2.旋转 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_3-缩放" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.缩放"><!--[--><!--]--> 3.缩放 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_4-矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.矩阵"><!--[--><!--]--> 4.矩阵 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#六、-矩阵复合变换" class="router-link-active router-link-exact-active sidebar-item" aria-label="六、 矩阵复合变换"><!--[--><!--]--> 六、 矩阵复合变换 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-矩阵相乘" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.矩阵相乘"><!--[--><!--]--> 1.矩阵相乘 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-变换规律" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.变换规律"><!--[--><!--]--> 2.变换规律 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_3-视图矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.视图矩阵"><!--[--><!--]--> 3.视图矩阵 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_4-模型矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.模型矩阵"><!--[--><!--]--> 4.模型矩阵 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#七、颜色与纹理" class="router-link-active router-link-exact-active sidebar-item" aria-label="七、颜色与纹理"><!--[--><!--]--> 七、颜色与纹理 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-多-attribute-变量" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.多 attribute 变量"><!--[--><!--]--> 1.多 attribute 变量 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-彩色三角形" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.彩色三角形"><!--[--><!--]--> 2.彩色三角形 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_3-纹理" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.纹理"><!--[--><!--]--> 3.纹理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_4-纹理合成" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.纹理合成"><!--[--><!--]--> 4.纹理合成 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_5-跨域图像做贴图" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.跨域图像做贴图"><!--[--><!--]--> 5.跨域图像做贴图 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_6-视频贴图" class="router-link-active router-link-exact-active sidebar-item" aria-label="6.视频贴图"><!--[--><!--]--> 6.视频贴图 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#八、世界坐标和本地坐标" class="router-link-active router-link-exact-active sidebar-item" aria-label="八、世界坐标和本地坐标"><!--[--><!--]--> 八、世界坐标和本地坐标 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-基本概念" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.基本概念"><!--[--><!--]--> 1.基本概念 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-世界坐标系和本地坐标系点位关系" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.世界坐标系和本地坐标系点位关系"><!--[--><!--]--> 2.世界坐标系和本地坐标系点位关系 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#九、深入认知三维世界" class="router-link-active router-link-exact-active sidebar-item" aria-label="九、深入认知三维世界"><!--[--><!--]--> 九、深入认知三维世界 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-用位移矩阵做实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.用位移矩阵做实验"><!--[--><!--]--> 1.用位移矩阵做实验 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-位移法则" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.位移法则"><!--[--><!--]--> 2.位移法则 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_3-缩放法则" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.缩放法则"><!--[--><!--]--> 3.缩放法则 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_4-旋转法则" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.旋转法则"><!--[--><!--]--> 4.旋转法则 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#十、旋转法则深度探索" class="router-link-active router-link-exact-active sidebar-item" aria-label="十、旋转法则深度探索"><!--[--><!--]--> 十、旋转法则深度探索 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-顶点绕单轴逆时针旋转" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.顶点绕单轴逆时针旋转"><!--[--><!--]--> 1.顶点绕单轴逆时针旋转 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-欧拉旋转" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.欧拉旋转"><!--[--><!--]--> 2.欧拉旋转 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_3-四元数" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.四元数"><!--[--><!--]--> 3.四元数 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#十一、正交投影矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="十一、正交投影矩阵"><!--[--><!--]--> 十一、正交投影矩阵 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-裁剪空间" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.裁剪空间"><!--[--><!--]--> 1.裁剪空间 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-正交投影矩阵的实现原理" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.正交投影矩阵的实现原理"><!--[--><!--]--> 2.正交投影矩阵的实现原理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_3-正交投影矩阵的代码实现" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.正交投影矩阵的代码实现"><!--[--><!--]--> 3.正交投影矩阵的代码实现 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_4-正交投影矩阵解决-webgl-图形拉伸问题" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.正交投影矩阵解决 webgl 图形拉伸问题"><!--[--><!--]--> 4.正交投影矩阵解决 webgl 图形拉伸问题 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#十二、视图矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="十二、视图矩阵"><!--[--><!--]--> 十二、视图矩阵 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-视图位移" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.视图位移"><!--[--><!--]--> 1.视图位移 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#扩展-matrixworld-详解" class="router-link-active router-link-exact-active sidebar-item" aria-label="扩展-matrixWorld 详解"><!--[--><!--]--> 扩展-matrixWorld 详解 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#扩展-逆矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="扩展-逆矩阵"><!--[--><!--]--> 扩展-逆矩阵 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-视图旋转" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.视图旋转"><!--[--><!--]--> 2.视图旋转 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#十三、透视投影矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="十三、透视投影矩阵"><!--[--><!--]--> 十三、透视投影矩阵 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-基础知识" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.基础知识"><!--[--><!--]--> 1.基础知识 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-认识透视投影矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.认识透视投影矩阵"><!--[--><!--]--> 2.认识透视投影矩阵 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_3-计算透视投影矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.计算透视投影矩阵"><!--[--><!--]--> 3.计算透视投影矩阵 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_4-three-js-里的透视投影矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.three.js 里的透视投影矩阵"><!--[--><!--]--> 4.three.js 里的透视投影矩阵 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_5-透视投影矩阵牛刀小试" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.透视投影矩阵牛刀小试"><!--[--><!--]--> 5.透视投影矩阵牛刀小试 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#十四、投影矩阵、视图矩阵和模型矩阵共冶一炉" class="router-link-active router-link-exact-active sidebar-item" aria-label="十四、投影矩阵、视图矩阵和模型矩阵共冶一炉"><!--[--><!--]--> 十四、投影矩阵、视图矩阵和模型矩阵共冶一炉 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-投影视图矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.投影视图矩阵"><!--[--><!--]--> 1.投影视图矩阵 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-投影视图矩阵乘以模型矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.投影视图矩阵乘以模型矩阵"><!--[--><!--]--> 2.投影视图矩阵乘以模型矩阵 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#十五、正交相机轨道控制器" class="router-link-active router-link-exact-active sidebar-item" aria-label="十五、正交相机轨道控制器"><!--[--><!--]--> 十五、正交相机轨道控制器 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-正交相机的位移轨道" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.正交相机的位移轨道"><!--[--><!--]--> 1.正交相机的位移轨道 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-正交相机的缩放轨道" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.正交相机的缩放轨道"><!--[--><!--]--> 2.正交相机的缩放轨道 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_3-正交相机的旋转轨道" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.正交相机的旋转轨道"><!--[--><!--]--> 3.正交相机的旋转轨道 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_4-轨迹球旋转" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.轨迹球旋转"><!--[--><!--]--> 4.轨迹球旋转 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#十六、透视相机轨道控制器" class="router-link-active router-link-exact-active sidebar-item" aria-label="十六、透视相机轨道控制器"><!--[--><!--]--> 十六、透视相机轨道控制器 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-透视相机的位移轨道" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.透视相机的位移轨道"><!--[--><!--]--> 1.透视相机的位移轨道 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-透视相机的缩放轨道" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.透视相机的缩放轨道"><!--[--><!--]--> 2.透视相机的缩放轨道 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_3-透视相机的旋转轨道" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.透视相机的旋转轨道"><!--[--><!--]--> 3.透视相机的旋转轨道 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#十七、封装相机轨道对象" class="router-link-active router-link-exact-active sidebar-item" aria-label="十七、封装相机轨道对象"><!--[--><!--]--> 十七、封装相机轨道对象 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-轨道控制器的封装" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.轨道控制器的封装"><!--[--><!--]--> 1.轨道控制器的封装 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-轨道控制器的实例化" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.轨道控制器的实例化"><!--[--><!--]--> 2.轨道控制器的实例化 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#十八、顶点索引" class="router-link-active router-link-exact-active sidebar-item" aria-label="十八、顶点索引"><!--[--><!--]--> 十八、顶点索引 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-顶点索引概念" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.顶点索引概念"><!--[--><!--]--> 1.顶点索引概念 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-彩色立方体" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.彩色立方体"><!--[--><!--]--> 2.彩色立方体 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#十九、多着色器" class="router-link-active router-link-exact-active sidebar-item" aria-label="十九、多着色器"><!--[--><!--]--> 十九、多着色器 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-多着色器绘图" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.多着色器绘图"><!--[--><!--]--> 1.多着色器绘图 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-多着色器动画" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.多着色器动画"><!--[--><!--]--> 2.多着色器动画 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#二十、基于-webgl-的轻量级架构" class="router-link-active router-link-exact-active sidebar-item" aria-label="二十、基于 webgl 的轻量级架构"><!--[--><!--]--> 二十、基于 webgl 的轻量级架构 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-几何体-geo" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.几何体 Geo"><!--[--><!--]--> 1.几何体 Geo <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-材质-mat" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.材质 Mat"><!--[--><!--]--> 2.材质 Mat <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_3-三维对象-obj3d" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.三维对象 Obj3D"><!--[--><!--]--> 3.三维对象 Obj3D <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_4-场景对象-scene" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.场景对象 Scene"><!--[--><!--]--> 4.场景对象 Scene <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#测试-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="测试 1"><!--[--><!--]--> 测试 1 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#测试-2" class="router-link-active router-link-exact-active sidebar-item" aria-label="测试 2"><!--[--><!--]--> 测试 2 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#二十一、认识光" class="router-link-active router-link-exact-active sidebar-item" aria-label="二十一、认识光"><!--[--><!--]--> 二十一、认识光 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-光照对物体的影响" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.光照对物体的影响"><!--[--><!--]--> 1.光照对物体的影响 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-光源" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.光源"><!--[--><!--]--> 2.光源 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_3-反射光" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.反射光"><!--[--><!--]--> 3.反射光 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#二十二、着色" class="router-link-active router-link-exact-active sidebar-item" aria-label="二十二、着色"><!--[--><!--]--> 二十二、着色 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-光线与着色点法线的夹角" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.光线与着色点法线的夹角"><!--[--><!--]--> 1.光线与着色点法线的夹角 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-光线的衰减" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.光线的衰减"><!--[--><!--]--> 2.光线的衰减 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_3-漫反射" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.漫反射"><!--[--><!--]--> 3.漫反射 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_4-镜面反射" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.镜面反射"><!--[--><!--]--> 4.镜面反射 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_5-环境反射" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.环境反射"><!--[--><!--]--> 5.环境反射 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_6-blinn-phong反射模型" class="router-link-active router-link-exact-active sidebar-item" aria-label="6.Blinn-Phong反射模型"><!--[--><!--]--> 6.Blinn-Phong反射模型 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#二十二、着色频率" class="router-link-active router-link-exact-active sidebar-item" aria-label="二十二、着色频率"><!--[--><!--]--> 二十二、着色频率 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-法线" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.法线"><!--[--><!--]--> 1.法线 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-认识着色频率" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.认识着色频率"><!--[--><!--]--> 2.认识着色频率 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_3-球体" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.球体"><!--[--><!--]--> 3.球体 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_4-flat逐三角形着色" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.Flat逐三角形着色"><!--[--><!--]--> 4.Flat逐三角形着色 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_5-gouraud逐顶点着色" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.Gouraud逐顶点着色"><!--[--><!--]--> 5.Gouraud逐顶点着色 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_6-phong-逐片元着色" class="router-link-active router-link-exact-active sidebar-item" aria-label="6.Phong-逐片元着色"><!--[--><!--]--> 6.Phong-逐片元着色 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#二十三、光源类型" class="router-link-active router-link-exact-active sidebar-item" aria-label="二十三、光源类型"><!--[--><!--]--> 二十三、光源类型 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-筒灯" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.筒灯"><!--[--><!--]--> 1.筒灯 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-锥形灯" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.锥形灯"><!--[--><!--]--> 2.锥形灯 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#扩展-泉" class="router-link-active router-link-exact-active sidebar-item" aria-label="扩展-泉"><!--[--><!--]--> 扩展-泉 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#二十四、帧缓冲区" class="router-link-active router-link-exact-active sidebar-item" aria-label="二十四、帧缓冲区"><!--[--><!--]--> 二十四、帧缓冲区 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-帧缓冲区的概念" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.帧缓冲区的概念"><!--[--><!--]--> 1.帧缓冲区的概念 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-帧缓冲区的代码实现" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.帧缓冲区的代码实现"><!--[--><!--]--> 2.帧缓冲区的代码实现 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_3-帧缓冲区的显示" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.帧缓冲区的显示"><!--[--><!--]--> 3.帧缓冲区的显示 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_4-帧缓冲区里的深度测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.帧缓冲区里的深度测试"><!--[--><!--]--> 4.帧缓冲区里的深度测试 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#二十五、投影" class="router-link-active router-link-exact-active sidebar-item" aria-label="二十五、投影"><!--[--><!--]--> 二十五、投影 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-投影的概念" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.投影的概念"><!--[--><!--]--> 1.投影的概念 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-投影的代码实现" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.投影的代码实现"><!--[--><!--]--> 2.投影的代码实现 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_3-提高深度数据的精度" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.提高深度数据的精度"><!--[--><!--]--> 3.提高深度数据的精度 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_4-帧缓冲区的封装" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.帧缓冲区的封装"><!--[--><!--]--> 4.帧缓冲区的封装 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#二十六、纹理映射" class="router-link-active router-link-exact-active sidebar-item" aria-label="二十六、纹理映射"><!--[--><!--]--> 二十六、纹理映射 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_1-等距圆柱投影" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.等距圆柱投影"><!--[--><!--]--> 1.等距圆柱投影 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_2-vr" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.VR"><!--[--><!--]--> 2.VR <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/WebGL-share.html#_3-线条的纹理映射" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.线条的纹理映射"><!--[--><!--]--> 3.线条的纹理映射 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="webgl" tabindex="-1"><a class="header-anchor" href="#webgl" aria-hidden="true">#</a> WebGL</h1><h2 id="一、webgl介绍" tabindex="-1"><a class="header-anchor" href="#一、webgl介绍" aria-hidden="true">#</a> 一、WebGL介绍</h2><blockquote><p>WebGL（Web Graphics Library）是一种 3D 绘图协议，WebGL技术结合了HTML5和JavaScript在网页上绘制和渲染复杂的三维图形，并允许用户与之进行交互的技术。并且WebGL是内嵌在浏览器中的，不必安装插件和库就可以直接使用，因为其基于浏览器的特性，可以在多平台上运行WebGL程序，如计算机、平板和手机。</p></blockquote><p><img src="/visual/webgl-share/1.png" alt=""></p><h3 id="_1-webgl的起源" tabindex="-1"><a class="header-anchor" href="#_1-webgl的起源" aria-hidden="true">#</a> 1.WebGL的起源</h3><p>WebGL（使用的语言叫做GLSL ES）是基于另一种三维图形渲染技术OpenGL ES2.0产生的，添加了新特性并且移除了很多陈旧无用的旧特性，更加轻量，保持足够的能力来渲染精美的三维图形。</p><p><img src="/visual/webgl-share/2.png" alt=""></p><h3 id="_2-webgl程序的结构" tabindex="-1"><a class="header-anchor" href="#_2-webgl程序的结构" aria-hidden="true">#</a> 2.WebGL程序的结构</h3><p>传统的动态网页和WebGL网页结构对比如下：</p><p><img src="/visual/webgl-share/3.png" alt=""></p><h2 id="二、webgl基础知识" tabindex="-1"><a class="header-anchor" href="#二、webgl基础知识" aria-hidden="true">#</a> 二、WebGL基础知识</h2><h3 id="_1-刷底色" tabindex="-1"><a class="header-anchor" href="#_1-刷底色" aria-hidden="true">#</a> 1.刷底色</h3><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>webgl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>100<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>100<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token comment">// 获取 &lt;canvas&gt; 元素</span>
    <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取 WebGL 绘图上下文</span>
    <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置背景颜色</span>
    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 清空颜色缓冲区</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><div class="highlight-line"> </div><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/4.png" alt=""></p><p>注意：<br><img src="/visual/webgl-share/5.png" alt=""></p></details><h3 id="_2-webgl-坐标系" tabindex="-1"><a class="header-anchor" href="#_2-webgl-坐标系" aria-hidden="true">#</a> 2.webgl 坐标系</h3><blockquote><p>canvas 2d 画布的坐标系<br> canvas 2d 坐标系的原点在左上角<br> canvas 2d 坐标系的 y 轴方向是朝下的<br> canvas 2d 坐标系的坐标基底有两个分量，分别是一个像素的宽和一个像素的高，即 1 个单位的宽便是 1 个像素的宽，1 个单位的高便是一个像素的高</p></blockquote><p><img src="/visual/webgl-share/6.png" alt=""></p><blockquote><p>webgl 的坐标系<br> webgl 坐标系的坐标原点在画布中心<br> webgl 坐标系的 y 轴方向是朝上的<br> webgl 坐标基底中的两个分量分别是半个 canvas 的宽和 canvas 的高，即 1 个单位的宽便是半个个 canvas 的宽，1 个单位的高便是半个 canvas 的高</p></blockquote><p><img src="/visual/webgl-share/7.png" alt=""></p><h3 id="_3-webgl-画一个点" tabindex="-1"><a class="header-anchor" href="#_3-webgl-画一个点" aria-hidden="true">#</a> 3.webgl 画一个点</h3><h4 id="a-canvas-2d-的绘图基本步骤" tabindex="-1"><a class="header-anchor" href="#a-canvas-2d-的绘图基本步骤" aria-hidden="true">#</a> a. canvas 2d 的绘图基本步骤</h4><ol><li>找一张画布</li><li>找一支画笔</li><li>开始画画</li></ol><details class="custom-container details"><summary>代码实现</summary><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//canvas画布</span>
<span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//二维画笔</span>
<span class="token keyword">const</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;2d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置画笔的颜色</span>
ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&quot;red&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//用画笔画一个矩形</span>
ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></details><h4 id="b-canvas-2d-和-webgl-绘图的差异" tabindex="-1"><a class="header-anchor" href="#b-canvas-2d-和-webgl-绘图的差异" aria-hidden="true">#</a> b. canvas 2d 和 webgl 绘图的差异</h4><blockquote><p>浏览器有三大线程： js 引擎线程、GUI 渲染线程、浏览器事件触发线程<br> GUI 渲染线程就是用于渲图的，在这个渲染线程里，有负责不同渲染工作的工人。比如有负责渲染 HTML+css 的工人，有负责渲染二维图形的工人，有负责渲染三维图形的工人<br> 渲染二维图形的工人说的是 js 语言<br> 渲染三维图形的工人说的是 GLSL ES 语言<br> GLSL ES &lt;=&gt; 程序对象（翻译官） &lt;=&gt; js</p></blockquote><h4 id="c-webgl-的绘图思路步骤" tabindex="-1"><a class="header-anchor" href="#c-webgl-的绘图思路步骤" aria-hidden="true">#</a> c. webgl 的绘图思路步骤</h4><ol><li>找一台电脑 - 浏览器里内置的 webgl 渲染引擎，负责渲染 webgl 图形，只认 GLSL ES 语言</li><li>找一块手绘板 - 程序对象，承载 GLSL ES 语言，翻译 GLSL ES 语言和 js 语言，使两者可以相互通信</li><li>找一支触控笔 - 通过 canvas 获取的 webgl 类型的上下文对象，可以向手绘板传递绘图命令，并接收手绘板的状态信息</li><li>开始画画 - 通过 webgl 类型的上下文对象，用 js 画画</li></ol><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>webgl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>400<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>400<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 点位</span>
    gl_Position <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 尺寸</span>
    gl_PointSize <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 片元着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 片元颜色</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 顶点字符串</span>
    <span class="token keyword">const</span> <span class="token constant">VSHADER_SOURCE</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

    <span class="token comment">// 片元字符串</span>
    <span class="token keyword">const</span> <span class="token constant">FSHADER_SOURCE</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
    
    <span class="token comment">// 初始化着色器</span>
    <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token constant">VSHADER_SOURCE</span><span class="token punctuation">,</span> <span class="token constant">FSHADER_SOURCE</span><span class="token punctuation">)</span>

    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">initShaders</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//创建程序对象</span>
        <span class="token keyword">const</span> program <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//建立顶点着色器和片元着色器对象，二者可以分工合作，</span>
        <span class="token comment">//js解析为计算机语言(GLSL ES)，再让计算机(浏览器的webgl 渲染引擎)识别显示</span>
        <span class="token keyword">const</span> vertexShader <span class="token operator">=</span> <span class="token function">loadShader</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">VERTEX_SHADER</span><span class="token punctuation">,</span> vsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> fragmentShader <span class="token operator">=</span> <span class="token function">loadShader</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FRAGMENT_SHADER</span><span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将顶点着色器对象和片元着色器对象装进程序对象中</span>
        gl<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> vertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        gl<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> fragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接webgl上下文对象和程序对象</span>
        gl<span class="token punctuation">.</span><span class="token function">linkProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动程序对象</span>
        gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将程序对象挂到上下文对象上</span>
        gl<span class="token punctuation">.</span>program <span class="token operator">=</span> program<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">loadShader</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> type<span class="token punctuation">,</span> source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//根据着色类型，建立着色器对象</span>
        <span class="token keyword">const</span> shader <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createShader</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将着色器源文件传入着色器对象中</span>
        gl<span class="token punctuation">.</span><span class="token function">shaderSource</span><span class="token punctuation">(</span>shader<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//编译着色器对象</span>
        gl<span class="token punctuation">.</span><span class="token function">compileShader</span><span class="token punctuation">(</span>shader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//返回着色器对象</span>
        <span class="token keyword">return</span> shader<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><div class="highlight-line"> </div><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/8.png" alt=""></p></details><h5 id="_1-着色器" tabindex="-1"><a class="header-anchor" href="#_1-着色器" aria-hidden="true">#</a> 1） 着色器</h5><p>要使用WebGL进行绘图就必须使用着色器，代码中着色器是以字符串的形式“嵌入”在JavaScript文件中的，在程序真正开始运行前它就已经设置好了。</p><ul><li>顶点着色器（Vertex shader）：描述顶点的特征，如位置、颜色等</li><li>片元着色器（Fragment shader）：进行逐片元处理过程，如光照</li></ul><blockquote><p>两点决定一条直线，顶点着色器里的顶点就是决定这一条直线的两个点，片元着色器里的片元就是把直线画到画布上后，这两个点之间构成直线的每个像素</p></blockquote><p>在浏览器上的绘制过程：</p><ol><li>运行JavaScript，调用WebGL相关方法</li><li>顶点和片元着色器执行，在颜色缓冲区内进行绘制，清空绘图区</li><li>颜色缓冲区的内容自动在浏览器的&lt;canvas&gt;上显示出来<br><img src="/visual/webgl-share/9.png" alt=""></li></ol><h5 id="_2-initshaders" tabindex="-1"><a class="header-anchor" href="#_2-initshaders" aria-hidden="true">#</a> 2） initShaders()</h5><p><img src="/visual/webgl-share/11.png" alt=""></p><h5 id="_3-gl-drawarrays-mode-first-count" tabindex="-1"><a class="header-anchor" href="#_3-gl-drawarrays-mode-first-count" aria-hidden="true">#</a> 3） gl.drawArrays(mode,first,count)</h5><p><img src="/visual/webgl-share/12.png" alt=""></p><h2 id="三、js与着色器间的数据传输" tabindex="-1"><a class="header-anchor" href="#三、js与着色器间的数据传输" aria-hidden="true">#</a> 三、js与着色器间的数据传输</h2><h3 id="_1-js控制顶点位置" tabindex="-1"><a class="header-anchor" href="#_1-js控制顶点位置" aria-hidden="true">#</a> 1.js控制顶点位置</h3><blockquote><p>attribute 变量是只有顶点着色器才能使用它的<br> js 可以通过 attribute 变量向顶点着色器传递与顶点相关的数据</p></blockquote><details class="custom-container details"><summary>使用attribute变量</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>webgl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>400<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>400<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
attribute vec4 a_Position<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//点位</span>
    gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
    <span class="token comment">//尺寸</span>
    gl_PointSize <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 片元着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 片元的颜色</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 顶点字符串</span>
<span class="token keyword">const</span> <span class="token constant">VSHADER_SOURCE</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

<span class="token comment">// 片元字符串</span>
<span class="token keyword">const</span> <span class="token constant">FSHADER_SOURCE</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

<span class="token comment">// 初始化着色器</span>
<span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token constant">VSHADER_SOURCE</span><span class="token punctuation">,</span> <span class="token constant">FSHADER_SOURCE</span><span class="token punctuation">)</span>

<span class="token comment">// 获取 attribute 变量 a_Position 的存储位置</span>
<span class="token keyword">var</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 将顶点位置传递给 attribute 变量</span>
gl<span class="token punctuation">.</span><span class="token function">vertexAttrib3f</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 也可这样写</span>
<span class="token comment">// const position = new Float32Array([0.0, 0.0, 0.0,1.0]);</span>
<span class="token comment">// gl.vertexAttrib4fv(a_Position,position)</span>

gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">initShaders</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//创建程序对象</span>
    <span class="token keyword">const</span> program <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//建立顶点着色器对象和片元着色器对象，二者可以分工合作</span>
    <span class="token comment">//js解析为计算机语言(GLSL ES)，然后让计算机(浏览器的webgl 渲染引擎)识别显示</span>
    <span class="token keyword">const</span> vertexShader <span class="token operator">=</span> <span class="token function">loadShader</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">VERTEX_SHADER</span><span class="token punctuation">,</span> vsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> fragmentShader <span class="token operator">=</span> <span class="token function">loadShader</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FRAGMENT_SHADER</span><span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将顶点着色器对象和片元着色器对象装进程序对象中</span>
    gl<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> vertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> fragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//连接webgl上下文对象和程序对象</span>
    gl<span class="token punctuation">.</span><span class="token function">linkProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//启动程序对象</span>
    gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将程序对象挂到上下文对象上</span>
    gl<span class="token punctuation">.</span>program <span class="token operator">=</span> program<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">loadShader</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> type<span class="token punctuation">,</span> source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//根据着色类型，建立着色器对象</span>
    <span class="token keyword">const</span> shader <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createShader</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将着色器源文件传入着色器对象中</span>
    gl<span class="token punctuation">.</span><span class="token function">shaderSource</span><span class="token punctuation">(</span>shader<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//编译着色器对象</span>
    gl<span class="token punctuation">.</span><span class="token function">compileShader</span><span class="token punctuation">(</span>shader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//返回着色器对象</span>
    <span class="token keyword">return</span> shader<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><div class="highlight-line"> </div><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/8.png" alt=""></p><p>注意：<br><img src="/visual/webgl-share/13.png" alt=""></p><p><img src="/visual/webgl-share/14.png" alt=""></p><p>同族函数：<br><img src="/visual/webgl-share/15.png" alt=""><br> 函数命名规范：<br><img src="/visual/webgl-share/16.png" alt=""></p></details><h3 id="_2-webgl同步绘图原理" tabindex="-1"><a class="header-anchor" href="#_2-webgl同步绘图原理" aria-hidden="true">#</a> 2.webgl同步绘图原理</h3><blockquote><p>gl.drawArrays(gl.POINTS, 0, 1) 方法和 canvas 2d 里的 ctx.draw() 方法是不一样的，ctx.draw() 真的像画画一样，一层一层的覆盖图像<br> gl.drawArrays() 方法只会同步绘图，走完了 js 主线程后，再次绘图时，就会从头再来。也就说，异步执行的 drawArrays() 方法会把画布上的图像都刷掉（ webgl 绘图的时候，是先在颜色缓冲区中画出来，颜色缓冲区中存储的图像，只在当前线程有效。比如我们先在 js 主线程中绘图，主线程结束后，会再去执行信息队列里的异步线程。在执行异步线程时，颜色缓冲区就会被 webgl 系统重置 ）</p></blockquote><details class="custom-container details"><summary>代码示例1</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>webgl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>400<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>400<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
attribute vec4 a_Position<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//点位</span>
    gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
    <span class="token comment">//尺寸</span>
    gl_PointSize <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 片元着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 片元的颜色</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 顶点字符串</span>
<span class="token keyword">const</span> <span class="token constant">VSHADER_SOURCE</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

<span class="token comment">// 片元字符串</span>
<span class="token keyword">const</span> <span class="token constant">FSHADER_SOURCE</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

<span class="token comment">// 初始化着色器</span>
<span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token constant">VSHADER_SOURCE</span><span class="token punctuation">,</span> <span class="token constant">FSHADER_SOURCE</span><span class="token punctuation">)</span>

<span class="token comment">// 获取 attribute 变量 a_Position 的存储位置</span>
<span class="token keyword">var</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 将顶点位置传递给 attribute 变量</span>
gl<span class="token punctuation">.</span><span class="token function">vertexAttrib3f</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//修改attribute 变量</span>
    gl<span class="token punctuation">.</span><span class="token function">vertexAttrib2f</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//绘制顶点</span>
    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/1.gif" alt=""></p></details><details class="custom-container details"><summary>代码示例2</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>webgl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>400<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>400<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
attribute vec4 a_Position<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//点位</span>
    gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
    <span class="token comment">//尺寸</span>
    gl_PointSize <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 片元着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 片元的颜色</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 顶点字符串</span>
<span class="token keyword">const</span> <span class="token constant">VSHADER_SOURCE</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

<span class="token comment">// 片元字符串</span>
<span class="token keyword">const</span> <span class="token constant">FSHADER_SOURCE</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

<span class="token comment">// 初始化着色器</span>
<span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token constant">VSHADER_SOURCE</span><span class="token punctuation">,</span> <span class="token constant">FSHADER_SOURCE</span><span class="token punctuation">)</span>

<span class="token comment">// 获取 attribute 变量 a_Position 的存储位置</span>
<span class="token keyword">var</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 将顶点位置传递给 attribute 变量</span>
gl<span class="token punctuation">.</span><span class="token function">vertexAttrib3f</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 存储顶点数据的数组</span>
<span class="token keyword">const</span> a_points <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0.0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    a_points<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 渲染方法</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    a_points<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">vertexAttrib2f</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/2.gif" alt=""></p></details><h3 id="_3-鼠标控制点位" tabindex="-1"><a class="header-anchor" href="#_3-鼠标控制点位" aria-hidden="true">#</a> 3.鼠标控制点位</h3><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>webgl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>400<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>400<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
attribute vec4 a_Position<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//点位</span>
    gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
    <span class="token comment">//尺寸</span>
    gl_PointSize <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 片元着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 片元的颜色</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 顶点字符串</span>
<span class="token keyword">const</span> <span class="token constant">VSHADER_SOURCE</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

<span class="token comment">// 片元字符串</span>
<span class="token keyword">const</span> <span class="token constant">FSHADER_SOURCE</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

<span class="token comment">// 初始化着色器</span>
<span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token constant">VSHADER_SOURCE</span><span class="token punctuation">,</span> <span class="token constant">FSHADER_SOURCE</span><span class="token punctuation">)</span>

<span class="token comment">// 获取 attribute 变量 a_Position 的存储位置</span>
<span class="token keyword">var</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 将顶点位置传递给 attribute 变量</span>
gl<span class="token punctuation">.</span><span class="token function">vertexAttrib3f</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 鼠标点击事件</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获得 canvas 下的坐标</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>cssX<span class="token punctuation">,</span> cssY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>clientX <span class="token operator">-</span> left<span class="token punctuation">,</span> clientY <span class="token operator">-</span> top<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取 canvas 的中心点</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>halfWidth<span class="token punctuation">,</span> halfHeight<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 将 canvas 原点平移到中心点</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>xBaseCenter<span class="token punctuation">,</span> yBaseCenter<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>cssX <span class="token operator">-</span> halfWidth<span class="token punctuation">,</span> cssY <span class="token operator">-</span> halfHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 解决 y 方向的差异</span>
    <span class="token keyword">const</span> yBaseCenterTop <span class="token operator">=</span> <span class="token operator">-</span>yBaseCenter<span class="token punctuation">;</span>
    <span class="token comment">// 解决坐标基底的差异</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>xBaseCenter <span class="token operator">/</span> halfWidth<span class="token punctuation">,</span> yBaseCenterTop <span class="token operator">/</span> halfHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>

    gl<span class="token punctuation">.</span><span class="token function">vertexAttrib2f</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><p>浏览器与canvas坐标：<br><img src="/visual/webgl-share/17.png" alt=""></p></details><h3 id="_4-js修改顶点颜色" tabindex="-1"><a class="header-anchor" href="#_4-js修改顶点颜色" aria-hidden="true">#</a> 4.js修改顶点颜色</h3><details class="custom-container details"><summary>使用uniform变量</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>webgl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>400<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>400<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    attribute vec4 a_Position<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
      gl_PointSize <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 片元着色器 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    precision mediump float<span class="token punctuation">;</span>
    uniform vec4 u_FragColor<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor <span class="token operator">=</span> u_FragColor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 顶点字符串</span>
    <span class="token keyword">const</span> <span class="token constant">VSHADER_SOURCE</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

    <span class="token comment">// 片元字符串</span>
    <span class="token keyword">const</span> <span class="token constant">FSHADER_SOURCE</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

    <span class="token comment">// 初始化着色器</span>
    <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token constant">VSHADER_SOURCE</span><span class="token punctuation">,</span> <span class="token constant">FSHADER_SOURCE</span><span class="token punctuation">)</span>

    <span class="token comment">// 获取 attribute 变量 a_Position 的存储位置</span>
    <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获取 uniform 变量 u_FragColor 的存储位置</span>
    <span class="token keyword">const</span> u_FragColor <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_FragColor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将顶点位置传递给 attribute 变量</span>
    gl<span class="token punctuation">.</span><span class="token function">vertexAttrib3f</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 修改uniform 变量</span>
    gl<span class="token punctuation">.</span><span class="token function">uniform4f</span><span class="token punctuation">(</span>u_FragColor<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div></details><h3 id="_5-鼠标绘制随机颜色的点" tabindex="-1"><a class="header-anchor" href="#_5-鼠标绘制随机颜色的点" aria-hidden="true">#</a> 5.鼠标绘制随机颜色的点</h3><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>webgl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>400<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>400<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    attribute vec4 a_Position<span class="token punctuation">;</span>
    attribute float a_PointSize<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
      gl_PointSize <span class="token operator">=</span> a_PointSize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 片元着色器 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    precision mediump float<span class="token punctuation">;</span>
    uniform vec4 u_FragColor<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor <span class="token operator">=</span> u_FragColor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 顶点字符串</span>
    <span class="token keyword">const</span> <span class="token constant">VSHADER_SOURCE</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

    <span class="token comment">// 片元字符串</span>
    <span class="token keyword">const</span> <span class="token constant">FSHADER_SOURCE</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

    <span class="token comment">// 初始化着色器</span>
    <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token constant">VSHADER_SOURCE</span><span class="token punctuation">,</span> <span class="token constant">FSHADER_SOURCE</span><span class="token punctuation">)</span>

    <span class="token comment">// 获取 attribute 和 uniform 变量存储位置</span>
    <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> a_PointSize <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_PointSize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> u_FragColor <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_FragColor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> a_points <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">r</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">g</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 鼠标点击事件</span>
    canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>cssX<span class="token punctuation">,</span> cssY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>clientX <span class="token operator">-</span> left<span class="token punctuation">,</span> clientY <span class="token operator">-</span> top<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>halfWidth<span class="token punctuation">,</span> halfHeight<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>xBaseCenter<span class="token punctuation">,</span> yBaseCenter<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>cssX <span class="token operator">-</span> halfWidth<span class="token punctuation">,</span> cssY <span class="token operator">-</span> halfHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> yBaseCenterTop <span class="token operator">=</span> <span class="token operator">-</span>yBaseCenter<span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>xBaseCenter <span class="token operator">/</span> halfWidth<span class="token punctuation">,</span> yBaseCenterTop <span class="token operator">/</span> halfHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> size <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">50</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> n <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> color <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">r</span><span class="token operator">:</span> n<span class="token punctuation">,</span> <span class="token literal-property property">g</span><span class="token operator">:</span> n<span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      a_points<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> size<span class="token punctuation">,</span> color <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 渲染方法</span>
    <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      a_points<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token punctuation">{</span> r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">,</span> a <span class="token punctuation">}</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        gl<span class="token punctuation">.</span><span class="token function">vertexAttrib2f</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        gl<span class="token punctuation">.</span><span class="token function">vertexAttrib1f</span><span class="token punctuation">(</span>a_PointSize<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">,</span> a<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gl<span class="token punctuation">.</span><span class="token function">uniform4fv</span><span class="token punctuation">(</span>u_FragColor<span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div></details><h3 id="_6-绘制圆点" tabindex="-1"><a class="header-anchor" href="#_6-绘制圆点" aria-hidden="true">#</a> 6.绘制圆点</h3><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>webgl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    attribute vec4 a_Position<span class="token punctuation">;</span>
    attribute float a_PointSize<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
      gl_PointSize <span class="token operator">=</span> a_PointSize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 片元着色器 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    precision mediump float<span class="token punctuation">;</span>
    uniform vec4 u_FragColor<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      float dist <span class="token operator">=</span> <span class="token function">distance</span><span class="token punctuation">(</span>gl_PointCoord<span class="token punctuation">,</span><span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        gl_FragColor <span class="token operator">=</span> u_FragColor<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        discard<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
    <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 顶点字符串</span>
    <span class="token keyword">const</span> <span class="token constant">VSHADER_SOURCE</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

    <span class="token comment">// 片元字符串</span>
    <span class="token keyword">const</span> <span class="token constant">FSHADER_SOURCE</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

    <span class="token comment">// 初始化着色器</span>
    <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token constant">VSHADER_SOURCE</span><span class="token punctuation">,</span> <span class="token constant">FSHADER_SOURCE</span><span class="token punctuation">)</span>

    <span class="token comment">// 获取 attribute 和 uniform 变量存储位置</span>
    <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> a_PointSize <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_PointSize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> u_FragColor <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_FragColor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> a_points <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">r</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">g</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 鼠标点击事件</span>
    canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>cssX<span class="token punctuation">,</span> cssY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>clientX <span class="token operator">-</span> left<span class="token punctuation">,</span> clientY <span class="token operator">-</span> top<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>halfWidth<span class="token punctuation">,</span> halfHeight<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>xBaseCenter<span class="token punctuation">,</span> yBaseCenter<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>cssX <span class="token operator">-</span> halfWidth<span class="token punctuation">,</span> cssY <span class="token operator">-</span> halfHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> yBaseCenterTop <span class="token operator">=</span> <span class="token operator">-</span>yBaseCenter<span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>xBaseCenter <span class="token operator">/</span> halfWidth<span class="token punctuation">,</span> yBaseCenterTop <span class="token operator">/</span> halfHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> size <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">50</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> n <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> color <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">r</span><span class="token operator">:</span> n<span class="token punctuation">,</span> <span class="token literal-property property">g</span><span class="token operator">:</span> n<span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      a_points<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> size<span class="token punctuation">,</span> color <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 渲染方法</span>
    <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      a_points<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token punctuation">{</span> r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">,</span> a <span class="token punctuation">}</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        gl<span class="token punctuation">.</span><span class="token function">vertexAttrib2f</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        gl<span class="token punctuation">.</span><span class="token function">vertexAttrib1f</span><span class="token punctuation">(</span>a_PointSize<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">,</span> a<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gl<span class="token punctuation">.</span><span class="token function">uniform4fv</span><span class="token punctuation">(</span>u_FragColor<span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br></div></div></details><h2 id="四、绘制图形" tabindex="-1"><a class="header-anchor" href="#四、绘制图形" aria-hidden="true">#</a> 四、绘制图形</h2><h3 id="_1-三维模型绘图" tabindex="-1"><a class="header-anchor" href="#_1-三维模型绘图" aria-hidden="true">#</a> 1.三维模型绘图</h3><p>构成三维模型的基本单位是三角形，如下图的青蛙，就是由右图所示的许多个三角形以及这些三角形的顶点构成的。不管三维模型的形状多么复杂，其基本组成部分都是三角形，只不过复杂的模型由更多的三角形构成而已。</p><p><img src="/visual/webgl-share/18.png" alt=""></p><h3 id="_2-绘制多个点" tabindex="-1"><a class="header-anchor" href="#_2-绘制多个点" aria-hidden="true">#</a> 2.绘制多个点</h3><p>WebGL提供了一种很方便的机制，即<code>缓冲区对象</code>，她可以一次性地向着色器传入多个顶点的数据。缓冲区对象是WebGL系统中的一块内存区域，我们可以一次性地向缓冲区对象中填充大量的顶点数据，然后将这些数据保存其中，供顶点着色器使用。</p><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
attribute vec4 a_Position<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
    gl_PointSize <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>

    <span class="token comment">// 获取着色器文本</span>
    <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
    <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

    <span class="token comment">// 获取WebGL上下文</span>
    <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化着色器</span>
    <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置顶点位置</span>
    <span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token function">initVertexBuffers</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置背景色</span>
    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 刷底色</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 绘制 n 个点</span>
    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">initVertexBuffers</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 顶点数据</span>
        <span class="token keyword">const</span> vertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
            <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>
            <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 顶点数量</span>
        <span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.创建缓冲区对象</span>
        <span class="token keyword">const</span> vertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.将缓冲区对象绑定到目标</span>
        gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.向缓冲区对象中写入数据</span>
        gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span>
        <span class="token comment">// 获取 attribute 变量</span>
        <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span>
        <span class="token comment">// 4.将缓冲区对象分配给 a_Position 变量</span>
        gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment">// 5.连接 a_Position 变量与缓冲区对象</span>
        gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> n<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/19.png" alt=""></p><p>五个步骤：<br><img src="/visual/webgl-share/20.png" alt=""></p><p>创建缓冲区：<br><img src="/visual/webgl-share/21.png" alt=""></p><p>删除缓冲区：<br><img src="/visual/webgl-share/22.png" alt=""></p><p>绑定缓冲区：<br><img src="/visual/webgl-share/23.png" alt=""></p><p>写入数据到缓冲区：<br><img src="/visual/webgl-share/24.png" alt=""></p><p>类型化数组：<br> 不支持push()和pop()方法，性能更好。<br><img src="/visual/webgl-share/25.png" alt=""><img src="/visual/webgl-share/26.png" alt=""></p><p>将缓冲区对象分配给attribute变量：<br><img src="/visual/webgl-share/27.png" alt=""></p><p>开启attribute变量：<br> 函数名看是用来处理“顶点数组”的，实际上是处理缓冲区对象，历史原因（OpenGL中继承的）。<br><img src="/visual/webgl-share/28.png" alt=""></p><p>关闭分配：<br><img src="/visual/webgl-share/29.png" alt=""></p><p>gl.drawArrays()的第2个参数和第3个参数：<br><img src="/visual/webgl-share/12.png" alt=""></p><p>绘制过程：<br><img src="/visual/webgl-share/30.png" alt=""></p></details><h3 id="_3-绘制图形" tabindex="-1"><a class="header-anchor" href="#_3-绘制图形" aria-hidden="true">#</a> 3.绘制图形</h3><p>gl.drawArrays(mode,first,count) 方法可以绘制以下图形（）：</p><ol><li>POINTS 可视的点</li><li>LINES 单独线段</li><li>LINE_STRIP 线条</li><li>LINE_LOOP 闭合线条</li><li>TRIANGLES 单独三角形</li><li>TRIANGLE_STRIP 三角带</li><li>TRIANGLE_FAN 三角扇</li></ol><p><img src="/visual/webgl-share/31.png" alt=""></p><p><img src="/visual/webgl-share/32.png" alt=""></p><p>注意：<br><code>TRIANGLE_STRIP 三角带的绘制顺序是：</code><br> v0&gt;v1&gt;v2<br> 以上一个三角形的第二条边+下一个点为基础，以和第二条边相反的方向绘制三角形<br> v2&gt;v1&gt;v3<br> 以上一个三角形的第三条边+下一个点为基础，以和第三条边相反的方向绘制三角形<br> v2&gt;v3&gt;v4<br> 以上一个三角形的第二条边+下一个点为基础，以和第二条边相反的方向绘制三角形<br> v4&gt;v3&gt;v5<br><code>规律：</code><br> 第偶数个三角形：以上一个三角形的第二条边+下一个点为基础，以和第二条边相反的方向绘制三角形<br> 第奇数个三角形：以上一个三角形的第三条边+下一个点为基础，以和第三条边相反的方向绘制三角形</p><p><code>TRIANGLE_FAN 三角扇的绘制顺序是：</code><br> ​ v0&gt;v1&gt;v2<br> 以上一个三角形的第三条边+下一个点为基础，按照和第三条边相反的顺序，绘制三角形<br> ​ v0&gt;v2&gt;v3<br> 以上一个三角形的第三条边+下一个点为基础，按照和第三条边相反的顺序，绘制三角形<br> ​ v0&gt;v3&gt;v4<br> 以上一个三角形的第三条边+下一个点为基础，按照和第三条边相反的顺序，绘制三角形<br> ​ v0&gt;v4&gt;v5</p><details class="custom-container details"><summary>代码实现</summary><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">LINES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">LINE_LOOP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_FAN</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></details><h3 id="_4-绘制矩形" tabindex="-1"><a class="header-anchor" href="#_4-绘制矩形" aria-hidden="true">#</a> 4.绘制矩形</h3><p>首先，webgl 可以绘制的面只有三角面，所以要绘制矩形面的话，只能用两个三角形去拼。</p><p>方法1： TRIANGLE_STRIP 三角带拼矩形</p><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
attribute vec4 a_Position<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
    gl_PointSize <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>

    <span class="token comment">// 获取着色器文本</span>
    <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
    <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

    <span class="token comment">// 获取WebGL上下文</span>
    <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化着色器</span>
    <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置顶点位置</span>
    <span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token function">initVertexBuffers</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置背景色</span>
    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 刷底色</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 绘制 n 个点</span>
    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">initVertexBuffers</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 顶点数据</span>
        <span class="token keyword">const</span> vertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
            <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>
            <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
            <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 顶点数量</span>
        <span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建缓冲区对象</span>
        <span class="token keyword">const</span> vertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将缓冲区对象绑定到目标</span>
        gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 向缓冲区对象中写入数据</span>
        gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span>
        <span class="token comment">// 获取 attribute 变量</span>
        <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span>
        <span class="token comment">// 将缓冲区对象分配给 a_Position 变量</span>
        gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment">// 连接 a_Position 变量与缓冲区对象</span>
        gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span>

        <span class="token keyword">return</span> n<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><p>效果如下：<br><img src="/visual/webgl-share/34.png" alt=""><img src="/visual/webgl-share/33.png" alt=""></p><p>若 gl.drawArrays(gl.TRIANGLE_STRIP, 0, n) =&gt; gl.drawArrays(gl.TRIANGLE_FAN, 0, n) <img src="/visual/webgl-share/35.png" alt=""></p></details><h3 id="_5-buffer缓冲区异步绘制" tabindex="-1"><a class="header-anchor" href="#_5-buffer缓冲区异步绘制" aria-hidden="true">#</a> 5.Buffer缓冲区异步绘制</h3><blockquote><p>当缓冲区被绑定在了 webgl 上下文对象上后，在异步方法里直接对其进行修改即可，顶点着色器在绘图的时候会自动从其中调用数据。<br> WebGL Buffer缓冲区中的数据在异步方法里不会被重新置空。</p></blockquote><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
attribute vec4 a_Position<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
    gl_PointSize <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>

    <span class="token comment">// 获取着色器文本</span>
    <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
    <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

    <span class="token comment">// 获取WebGL上下文</span>
    <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化着色器</span>
    <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置顶点位置</span>
    <span class="token keyword">let</span> vertices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token function">initVertexBuffers</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置背景色</span>
    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 刷底色</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 绘制 n 个点</span>
    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 1s后，顶点中再添加的一个顶点，修改缓冲区数据，清理画布，绘制顶点</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        vertices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">)</span>
        gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>vertices<span class="token punctuation">)</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span>
        gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2s后，清理画布，绘制顶点，绘制线条</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">LINES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">initVertexBuffers</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 顶点数据</span>
        vertices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 顶点数量</span>
        <span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建缓冲区对象</span>
        <span class="token keyword">const</span> vertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将缓冲区对象绑定到目标</span>
        gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 向缓冲区对象中写入数据</span>
        gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>vertices<span class="token punctuation">)</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span>
        <span class="token comment">// 获取 attribute 变量</span>
        <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span>
        <span class="token comment">// 将缓冲区对象分配给 a_Position 变量</span>
        gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment">// 连接 a_Position 变量与缓冲区对象</span>
        gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span>

        <span class="token keyword">return</span> n<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/3.gif" alt=""></p></details><h3 id="_6-封装多边形对象" tabindex="-1"><a class="header-anchor" href="#_6-封装多边形对象" aria-hidden="true">#</a> 6.封装多边形对象</h3><p>Poly.js</p><details class="custom-container details"><summary>代码实现</summary><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">defAttr</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">gl</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">vertices</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">geoData</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token literal-property property">attrName</span><span class="token operator">:</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">uniName</span><span class="token operator">:</span> <span class="token string">&#39;u_IsPOINTS&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token literal-property property">types</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;POINTS&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">circleDot</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">u_IsPOINTS</span><span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Poly</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">defAttr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> attr<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> attrName<span class="token punctuation">,</span> size<span class="token punctuation">,</span> gl<span class="token punctuation">,</span> circleDot <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gl<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
    <span class="token comment">// 创建缓冲区对象</span>
    <span class="token keyword">const</span> vertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 绑定缓冲区对象</span>
    gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 写入数据</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 获取attribute 变量</span>
    <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> attrName<span class="token punctuation">)</span>
    <span class="token comment">// 修改attribute 变量</span>
    gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> size<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment">// 赋能，批处理</span>
    gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span>
    <span class="token comment">// 如果是圆点，就获取一下uniform 变量</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>circleDot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>u_IsPOINTS <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;u_IsPOINTS&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">updateBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> gl<span class="token punctuation">,</span> vertices <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>vertices<span class="token punctuation">)</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">updateCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vertices<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>size
  <span class="token punctuation">}</span>
  <span class="token function">addVertice</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vertices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>params<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">popVertice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> vertices<span class="token punctuation">,</span> size <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> len <span class="token operator">=</span> vertices<span class="token punctuation">.</span>length
    vertices<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>len <span class="token operator">-</span> size<span class="token punctuation">,</span> len<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">setVertice</span><span class="token punctuation">(</span><span class="token parameter">ind<span class="token punctuation">,</span> <span class="token operator">...</span>params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> vertices<span class="token punctuation">,</span> size <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> i <span class="token operator">=</span> ind <span class="token operator">*</span> size
    params<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">,</span> paramInd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      vertices<span class="token punctuation">[</span>i <span class="token operator">+</span> paramInd<span class="token punctuation">]</span> <span class="token operator">=</span> param
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">updateVertices</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> geoData <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> vertices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    geoData<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      params<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        vertices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vertices <span class="token operator">=</span> vertices
  <span class="token punctuation">}</span>
  <span class="token function">draw</span><span class="token punctuation">(</span><span class="token parameter">types <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>types</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> gl<span class="token punctuation">,</span> count<span class="token punctuation">,</span> circleDot<span class="token punctuation">,</span> u_IsPOINTS <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> type <span class="token keyword">of</span> types<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      circleDot <span class="token operator">&amp;&amp;</span> gl<span class="token punctuation">.</span><span class="token function">uniform1f</span><span class="token punctuation">(</span>u_IsPOINTS<span class="token punctuation">,</span> type <span class="token operator">===</span> <span class="token string">&#39;POINTS&#39;</span><span class="token punctuation">)</span>
      gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br></div></div><p>属性：</p><ul><li>gl webgl上下文对象</li><li>vertices 顶点数据集合，在被赋值的时候会做两件事 <ul><li>更新count 顶点数量，数据运算尽量不放渲染方法里</li><li>向缓冲区内写入顶点数据</li></ul></li><li>geoData 模型数据，对象数组，可解析出vertices 顶点数据</li><li>size 顶点分量的数目</li><li>positionName 代表顶点位置的attribute 变量名</li><li>count 顶点数量</li><li>types 绘图方式，可以用多种方式绘图</li></ul><p>方法：</p><ul><li>init() 初始化方法，建立缓冲对象，并将其绑定到webgl 上下文对象上，然后向其中写入顶点数据。将缓冲对象交给attribute变量，并开启attribute 变量的批处理功能。</li><li>addVertice() 添加顶点</li><li>popVertice() 删除最后一个顶点</li><li>setVertice() 根据索引位置设置顶点</li><li>updateBuffer() 更新缓冲区数据，同时更新顶点数量</li><li>updateCount() 更新顶点数量</li><li>updateVertices() 基于geoData 解析出vetices 数据</li><li>draw() 绘图方法</li></ul></details><h3 id="_7-鼠标画线" tabindex="-1"><a class="header-anchor" href="#_7-鼠标画线" aria-hidden="true">#</a> 7.鼠标画线</h3><p>场景：鼠标左击绘制线条</p><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      attribute vec4 a_Position<span class="token punctuation">;</span>
      <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
          gl_PointSize <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      precision mediump float<span class="token punctuation">;</span>
      <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          float dist<span class="token operator">=</span><span class="token function">distance</span><span class="token punctuation">(</span>gl_PointCoord<span class="token punctuation">,</span><span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>dist<span class="token operator">&lt;</span><span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              discard<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders<span class="token punctuation">,</span> getMousePosInWebgl <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">import</span> Poly <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Poly.js&quot;</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
      canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>

      <span class="token comment">// 获取着色器文本</span>
      <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
      <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

      <span class="token comment">// 获取WebGL上下文</span>
      <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 初始化着色器</span>
      <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 设置背景色</span>
      gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 刷底色</span>
      gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 实例化多边形</span>
      <span class="token keyword">const</span> poly <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          gl<span class="token punctuation">,</span>
          <span class="token literal-property property">types</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;POINTS&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;LINE_STRIP&#39;</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token comment">// 鼠标点击事件</span>
      canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getMousePosInWebgl</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> canvas<span class="token punctuation">)</span>
          poly<span class="token punctuation">.</span><span class="token function">addVertice</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
          gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          poly<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/4.gif" alt=""></p></details><h3 id="_8-鼠标画多线" tabindex="-1"><a class="header-anchor" href="#_8-鼠标画多线" aria-hidden="true">#</a> 8.鼠标画多线</h3><p>场景：鼠标点击画布，绘制多边形路径。鼠标右击，取消绘制。鼠标再次点击，绘制新的多边形。</p><details class="custom-container details"><summary>代码实现</summary><p>Sky.js</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Sky</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token operator">=</span>gl
    <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    obj<span class="token punctuation">.</span>gl<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>gl
    <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">updateVertices</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">ele</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      ele<span class="token punctuation">.</span><span class="token function">updateVertices</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">ele</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      ele<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      ele<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
属性：
<span class="token operator">-</span> gl webgl上下文对象
<span class="token operator">-</span> children 子级

方法：
<span class="token operator">-</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 添加子对象
<span class="token operator">-</span> <span class="token function">updateVertices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 更新子对象的顶点数据
<span class="token operator">-</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 遍历子对象绘图，每个子对象对应一个buffer 对象，
所以在子对象绘图之前要先初始化。
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      attribute vec4 a_Position<span class="token punctuation">;</span>
      <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
          gl_PointSize <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      precision mediump float<span class="token punctuation">;</span>
      uniform bool u_IsPOINTS<span class="token punctuation">;</span>
      <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">// 修复bug：线条在mac电脑中是断的：</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>u_IsPOINTS<span class="token punctuation">)</span><span class="token punctuation">{</span>
              float dist<span class="token operator">=</span><span class="token function">distance</span><span class="token punctuation">(</span>gl_PointCoord<span class="token punctuation">,</span><span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span>dist<span class="token operator">&lt;</span><span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                  discard<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders<span class="token punctuation">,</span> getMousePosInWebgl <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">import</span> Poly <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Poly.js&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">import</span> Sky <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Sky.js&quot;</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
      canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>

      <span class="token comment">// 获取着色器文本</span>
      <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
      <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

      <span class="token comment">// 获取WebGL上下文</span>
      <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 初始化着色器</span>
      <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 设置背景色</span>
      gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 刷底色</span>
      gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 夜空</span>
      <span class="token keyword">const</span> sky <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sky</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 当前正在绘制的多边形</span>
      <span class="token keyword">let</span> poly <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

      <span class="token comment">// 取消右击提示</span>
      canvas<span class="token punctuation">.</span><span class="token function-variable function">oncontextmenu</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 鼠标点击事件</span>
      canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;mousedown&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>button <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">popVertice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getMousePosInWebgl</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> canvas<span class="token punctuation">)</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>poly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  poly<span class="token punctuation">.</span><span class="token function">addVertice</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                  <span class="token function">crtPoly</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 最后一个点跟随鼠标移动</span>
      canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;mousemove&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>poly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getMousePosInWebgl</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> canvas<span class="token punctuation">)</span>
              poly<span class="token punctuation">.</span><span class="token function">setVertice</span><span class="token punctuation">(</span>poly<span class="token punctuation">.</span>count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
              <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 删除最后一个顶点</span>
      <span class="token keyword">function</span> <span class="token function">popVertice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          poly<span class="token punctuation">.</span><span class="token function">popVertice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          poly <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 创建多边形</span>
      <span class="token keyword">function</span> <span class="token function">crtPoly</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          poly <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              <span class="token literal-property property">vertices</span><span class="token operator">:</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token literal-property property">types</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;POINTS&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;LINE_STRIP&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token literal-property property">circleDot</span><span class="token operator">:</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          sky<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>poly<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 渲染方法</span>
      <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span>
          sky<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/5.gif" alt=""></p></details><h3 id="_9-图形转面" tabindex="-1"><a class="header-anchor" href="#_9-图形转面" aria-hidden="true">#</a> 9.图形转面</h3><h4 id="_1-webgl三种面的适应场景" tabindex="-1"><a class="header-anchor" href="#_1-webgl三种面的适应场景" aria-hidden="true">#</a> 1-webgl三种面的适应场景</h4><p>之前说过，webgl 可以绘制三种面：</p><ul><li>TRIANGLES 单独三角形</li><li>TRIANGLE_STRIP 三角带</li><li>TRIANGLE_FAN 三角扇</li></ul><p>在实际的引擎开发中，TRIANGLES 用得最多的。它的优势是可以绘制任意模型，缺点是比较费点。</p><p>适合 TRIANGLES 单独三角形的的模型：<br><img src="/visual/webgl-share/36.png" alt=""></p><p>TRIANGLE_STRIP 和 TRIANGLE_FAN 优点是相邻的三角形可以共用一条边，省点，其缺点也太明显，因为它们只适合绘制具备相应特点的模型。</p><p>适合 TRIANGLE_STRIP 三角带的模型：<br><img src="/visual/webgl-share/37.png" alt=""></p><p>适合 TRIANGLE_FAN 三角扇的模型：<br><img src="/visual/webgl-share/38.png" alt=""></p><p>three.js 使用的绘制面的方式就是TRIANGLES，可以在其WebGLRenderer 对象的源码的renderBufferImmediate 方法中找到：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>_gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span> _gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> object<span class="token punctuation">.</span>count <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h4 id="_2-图形转面的基本步骤" tabindex="-1"><a class="header-anchor" href="#_2-图形转面的基本步骤" aria-hidden="true">#</a> 2-图形转面的基本步骤</h4><p>在three.js 里有一个图形几何体<a href="https://threejs.org/docs/index.html#api/en/geometries/ShapeGeometry" target="_blank" rel="noopener noreferrer">ShapeGeometry<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，可以把图形变成面。<br><img src="/visual/webgl-share/39.png" alt=""></p><p>只要有数学支撑，也可以实现这种效果。</p><p>接下来就使用TRIANGLES 独立三角形的方式，将图形转成面。</p><p><strong>使用的方法叫做“砍角”（方法不唯一），其原理就是从起点将多边形中符合特定条件的角逐个砍掉，然后保存到一个集合里，直到把多边形砍得只剩下一个三角形为止。这时候集合里的所有三角形就是我们想要的独立三角形。</strong></p><p>举个例子：<br><img src="/visual/webgl-share/40.png" alt=""></p><p>已知：逆时针绘图的路径G<br> 求：将其变成下方网格的方法<br><img src="/visual/webgl-share/41.png" alt=""></p><p>解：</p><ol><li>寻找满足以下条件的▲ABC：</li></ol><ul><li>▲ABC的顶点索引位置连续，如012,123、234</li><li>点C在向量AB的正开半平面里，可以理解为你站在A点，面朝B点，点C要在你的左手边</li><li>▲ABC中没有包含路径G 中的其它顶点</li></ul><ol start="2"><li>当找到▲ABC 后，就将点B从路径的顶点集合中删掉，然后继续往后找。</li><li>当路径的定点集合只剩下3个点时，就结束。</li><li>由所有满足条件的▲ABC构成的集合就是我们要求的独立三角形集合。</li></ol><h4 id="_3-绘制路径g" tabindex="-1"><a class="header-anchor" href="#_3-绘制路径g" aria-hidden="true">#</a> 3-绘制路径G</h4><ol><li>路径G的顶点数据</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> pathData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span>
      <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span>
      <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span>
      <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span>
      <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span>
      <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span>
      <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span>
      <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span>
      <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span>
      <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span>
      <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span>
      <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span>
      <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">0</span>
 <span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>在pathData里两个数字为一组，分别代表顶点的ｘ位和ｙ位。<br> pathData里的数据是以像素为单位画出来的，在实际项目协作中，UI给我们的svg文件可能也是以像素为单位画出来的。<br> 因为，webgl画布的宽和高永远都是两个单位。<br> 所以，要将上面的点画到 webgl 画布中，就需要做一个数据映射。</p><ol start="2"><li>在webgl 中绘制正方形。</li></ol><p>从pathData 数据中可以看出，路径G的宽高都是600，是一个正方形。<br> 所以，可以将路径G映射到 webgl 画布的一个正方形中。<br> 这个正方形的高度可以暂且定为1，那么其宽度就应该是高度除以canvas画布的宽高比。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 宽高比</span>
<span class="token keyword">const</span> ratio <span class="token operator">=</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
<span class="token comment">// 正方形高度</span>
<span class="token keyword">const</span> rectH <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
<span class="token comment">// 正方形宽度</span>
<span class="token keyword">const</span> rectW <span class="token operator">=</span> rectH <span class="token operator">/</span> ratio<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="3"><li>正方形的定位，把正方形放在webgl画布的中心。</li></ol><p>获取正方形尺寸的一半，然后求出其x、y方向的两个极值即可。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 正方形宽高的一半</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>halfRectW<span class="token punctuation">,</span> halfRectH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>rectW <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> rectH <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 两个极点</span>
<span class="token keyword">const</span> minX <span class="token operator">=</span> <span class="token operator">-</span>halfRectW<span class="token punctuation">;</span>
<span class="token keyword">const</span> minY <span class="token operator">=</span> <span class="token operator">-</span>halfRectH<span class="token punctuation">;</span>
<span class="token keyword">const</span> maxX <span class="token operator">=</span> halfRectW<span class="token punctuation">;</span>
<span class="token keyword">const</span> maxY <span class="token operator">=</span> halfRectH<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="4"><li>利用之前的Poly对象绘制正方形，测试一下效果。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> rect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    gl<span class="token punctuation">,</span>
    <span class="token literal-property property">vertices</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        minX<span class="token punctuation">,</span> maxY<span class="token punctuation">,</span>
        minX<span class="token punctuation">,</span> minY<span class="token punctuation">,</span>
        maxX<span class="token punctuation">,</span> minY<span class="token punctuation">,</span> 
        maxX<span class="token punctuation">,</span> maxY<span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rect<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>先画了4个点，效果没问题。<br><img src="/visual/webgl-share/42.png" alt=""></p><ol start="5"><li>建立x轴和y轴比例尺。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> scaleX <span class="token operator">=</span> <span class="token function">ScaleLinear</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> minX<span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> maxX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> scaleY <span class="token operator">=</span> <span class="token function">ScaleLinear</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> minY<span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> maxY<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">ScaleLinear</span><span class="token punctuation">(</span><span class="token parameter">ax<span class="token punctuation">,</span> ay<span class="token punctuation">,</span> bx<span class="token punctuation">,</span> by</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> delta <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">x</span><span class="token operator">:</span> bx <span class="token operator">-</span> ax<span class="token punctuation">,</span>
    <span class="token literal-property property">y</span><span class="token operator">:</span> by <span class="token operator">-</span> ay<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> k <span class="token operator">=</span> delta<span class="token punctuation">.</span>y <span class="token operator">/</span> delta<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
  <span class="token keyword">const</span> b <span class="token operator">=</span> ay <span class="token operator">-</span> ax <span class="token operator">*</span> k<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> k <span class="token operator">*</span> x <span class="token operator">+</span> b<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>ScaleLinear(ax, ay, bx, by) 方法使用的就是点斜式，用于将x轴和y轴上的数据像素数据映射成 webgl数据</p><ul><li>ax 像素数据的极小值</li><li>ay webgl数据的极小值</li><li>bx 像素数据的极大值</li><li>by webgl数据的极大值</li></ul><ol start="6"><li>将路径G中的像素数据解析为 webgl 数据</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> glData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pathData<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    glData<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">scaleX</span><span class="token punctuation">(</span>pathData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">scaleY</span><span class="token punctuation">(</span>pathData<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>画一下看看：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    gl<span class="token punctuation">,</span>
    <span class="token literal-property property">vertices</span><span class="token operator">:</span> glData<span class="token punctuation">,</span>
    <span class="token literal-property property">types</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;POINTS&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;LINE_LOOP&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
path<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="/visual/webgl-share/43.png" alt=""></p><h4 id="_4-将图形网格化" tabindex="-1"><a class="header-anchor" href="#_4-将图形网格化" aria-hidden="true">#</a> 4.将图形网格化</h4><ol><li>建立了一个ShapeGeo 对象，用于将图形网格化。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> shapeGeo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShapeGeo</span><span class="token punctuation">(</span>glData<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><details class="custom-container details"><summary>ShapeGeo</summary><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ShapeGeo</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">pathData<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pathData <span class="token operator">=</span> pathData<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>geoData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>triangles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vertices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parsePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vertices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>triangles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findTriangle</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">upadateVertices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">parsePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>geoData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> pathData<span class="token punctuation">,</span> geoData <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pathData<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      geoData<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> pathData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> pathData<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">findTriangle</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> geoData<span class="token punctuation">,</span> triangles <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> len <span class="token operator">=</span> geoData<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>geoData<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      triangles<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>geoData<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>i0<span class="token punctuation">,</span> i1<span class="token punctuation">,</span> i2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        i <span class="token operator">%</span> len<span class="token punctuation">,</span>
        <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> len<span class="token punctuation">,</span>
        <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">%</span> len
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> triangle <span class="token operator">=</span> <span class="token punctuation">[</span>
        geoData<span class="token punctuation">[</span>i0<span class="token punctuation">]</span><span class="token punctuation">,</span>
        geoData<span class="token punctuation">[</span>i1<span class="token punctuation">]</span><span class="token punctuation">,</span>
        geoData<span class="token punctuation">[</span>i2<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>triangle<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">includePoint</span><span class="token punctuation">(</span>triangle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        triangles<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>triangle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        geoData<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findTriangle</span><span class="token punctuation">(</span>i1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">includePoint</span><span class="token punctuation">(</span><span class="token parameter">triangle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> ele <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>geoData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>triangle<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">inTriangle</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> triangle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">inTriangle</span><span class="token punctuation">(</span><span class="token parameter">p0<span class="token punctuation">,</span> triangle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> inPoly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> j <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>triangle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> triangle<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p0<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        inPoly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> inPoly<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">cross</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>p0<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">,</span> bx<span class="token punctuation">,</span> by<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
      p1<span class="token punctuation">.</span>x <span class="token operator">-</span> p0<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
      p1<span class="token punctuation">.</span>y <span class="token operator">-</span> p0<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
      p2<span class="token punctuation">.</span>x <span class="token operator">-</span> p0<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
      p2<span class="token punctuation">.</span>y <span class="token operator">-</span> p0<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ax <span class="token operator">*</span> by <span class="token operator">-</span> bx <span class="token operator">*</span> ay<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">upadateVertices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>triangles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">triangle</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token keyword">of</span> triangle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vertices <span class="token operator">=</span> arr
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br></div></div></details><p>属性：</p><ul><li>pathData 平展开的路径数据</li><li>geoData 由路径数据pathData 转成的对象型数组</li><li>triangles 三角形集合，对象型数组</li><li>vertices 平展开的对立三角形顶点集合</li></ul><p>方法：</p><ul><li>update() 更新方法，基于pathData 生成vertices</li><li>parsePath() 基于路径数据pathData 转成对象型数组</li><li>findTriangle(i) 寻找符合条件的三角形 <ul><li>i 顶点在geoData 中的索引位置，表示从哪里开始寻找三角形</li></ul></li><li>includePoint(triangle) 判断三角形中是否有其它顶点</li><li>inTriangle(p0, triangle) 判断一个顶点是否在三角形中</li><li>cross([p0, p1, p2]) 以p0为基点，对二维向量p0p1、p0p2做叉乘运算</li><li>upadateVertices() 基于对象数组geoData 生成平展开的vertices 数据</li></ul><ol start="2"><li>绘制G形面</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> face <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    gl<span class="token punctuation">,</span>
    <span class="token literal-property property">vertices</span><span class="token operator">:</span> shapeGeo<span class="token punctuation">.</span>vertices<span class="token punctuation">,</span>
    <span class="token literal-property property">types</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;TRIANGLES&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
face<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>效果如下：<br><img src="/visual/webgl-share/44.png" alt=""></p><details class="custom-container details"><summary>图形转面</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    attribute vec4 a_Position<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
        gl_PointSize <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders<span class="token punctuation">,</span> ScaleLinear <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">import</span> Poly <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Poly.js&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">import</span> ShapeGeo <span class="token keyword">from</span> <span class="token string">&quot;../jsm/ShapeGeo.js&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>

    <span class="token comment">// 获取着色器文本</span>
    <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
    <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

    <span class="token comment">// 获取WebGL上下文</span>
    <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化着色器</span>
    <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置背景色</span>
    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 刷底色</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 路径G-逆时针</span>
    <span class="token keyword">const</span> pathData <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span>
        <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span>
        <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span>
        <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span>
        <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span>
        <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span>
        <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span>
        <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span>
        <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span>
        <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span>
        <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span>
        <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span>
        <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 宽高比</span>
    <span class="token keyword">const</span> ratio <span class="token operator">=</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
    <span class="token comment">// 正方形高度</span>
    <span class="token keyword">const</span> rectH <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token comment">// 正方形宽度</span>
    <span class="token keyword">const</span> rectW <span class="token operator">=</span> rectH <span class="token operator">/</span> ratio<span class="token punctuation">;</span>
    <span class="token comment">// 正方形宽高的一半</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>halfRectW<span class="token punctuation">,</span> halfRectH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>rectW <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> rectH <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 两个极点</span>
    <span class="token keyword">const</span> minX <span class="token operator">=</span> <span class="token operator">-</span>halfRectW<span class="token punctuation">;</span>
    <span class="token keyword">const</span> minY <span class="token operator">=</span> <span class="token operator">-</span>halfRectH<span class="token punctuation">;</span>
    <span class="token keyword">const</span> maxX <span class="token operator">=</span> halfRectW<span class="token punctuation">;</span>
    <span class="token keyword">const</span> maxY <span class="token operator">=</span> halfRectH<span class="token punctuation">;</span>
    <span class="token comment">// 正方形</span>
    <span class="token keyword">const</span> rect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        gl<span class="token punctuation">,</span>
        <span class="token literal-property property">vertices</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            minX<span class="token punctuation">,</span> maxY<span class="token punctuation">,</span>
            minX<span class="token punctuation">,</span> minY<span class="token punctuation">,</span>
            maxX<span class="token punctuation">,</span> minY<span class="token punctuation">,</span>
            maxX<span class="token punctuation">,</span> maxY<span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rect<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 建立比例尺</span>
    <span class="token keyword">const</span> scaleX <span class="token operator">=</span> <span class="token function">ScaleLinear</span><span class="token punctuation">(</span>
        <span class="token number">0</span><span class="token punctuation">,</span> minX<span class="token punctuation">,</span>
        <span class="token number">600</span><span class="token punctuation">,</span> maxX
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> scaleY <span class="token operator">=</span> <span class="token function">ScaleLinear</span><span class="token punctuation">(</span>
        <span class="token number">0</span><span class="token punctuation">,</span> maxY<span class="token punctuation">,</span>
        <span class="token number">600</span><span class="token punctuation">,</span> minY
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将路径G中的像素数据解析为webgl数据</span>
    <span class="token keyword">const</span> glData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pathData<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        glData<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">scaleX</span><span class="token punctuation">(</span>pathData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">scaleY</span><span class="token punctuation">(</span>pathData<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        gl<span class="token punctuation">,</span>
        <span class="token literal-property property">vertices</span><span class="token operator">:</span> glData<span class="token punctuation">,</span>
        <span class="token literal-property property">types</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;POINTS&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;LINE_LOOP&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    path<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> shapeGeo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShapeGeo</span><span class="token punctuation">(</span>glData<span class="token punctuation">)</span>
    <span class="token keyword">const</span> face <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        gl<span class="token punctuation">,</span>
        <span class="token literal-property property">vertices</span><span class="token operator">:</span> shapeGeo<span class="token punctuation">.</span>vertices<span class="token punctuation">,</span>
        <span class="token literal-property property">types</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;TRIANGLES&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    face<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br></div></div></details><details class="custom-container details"><summary>鼠标转面</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    attribute vec4 a_Position<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
        gl_PointSize <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders<span class="token punctuation">,</span> getMousePosInWebgl <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">import</span> Poly <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Poly.js&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">import</span> ShapeGeo <span class="token keyword">from</span> <span class="token string">&quot;../jsm/ShapeGeo.js&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>

    <span class="token comment">// 获取着色器文本</span>
    <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
    <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

    <span class="token comment">// 获取WebGL上下文</span>
    <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化着色器</span>
    <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置背景色</span>
    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 刷底色</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> poly <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        gl<span class="token punctuation">,</span>
        <span class="token literal-property property">types</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;POINTS&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;LINE_STRIP&#39;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> face <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        gl<span class="token punctuation">,</span>
        <span class="token literal-property property">types</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;TRIANGLES&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;POINTS&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;mousedown&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getMousePosInWebgl</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> canvas<span class="token punctuation">)</span>
        arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>

        face<span class="token punctuation">.</span>vertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShapeGeo</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">.</span>vertices
        face<span class="token punctuation">.</span><span class="token function">updateBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        face<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div></details><h2 id="五、矩阵变换" tabindex="-1"><a class="header-anchor" href="#五、矩阵变换" aria-hidden="true">#</a> 五、矩阵变换</h2><p>变换有三种状态：平移、旋转、缩放。</p><p>当变换一个图形时，实际上就是在移动这个图形的所有顶点。</p><h3 id="_1-平移" tabindex="-1"><a class="header-anchor" href="#_1-平移" aria-hidden="true">#</a> 1.平移</h3><p>对图形的平移就是对图形所有顶点的平移</p><p><img src="/visual/webgl-share/45.png" alt=""></p><p>在实际代码中，要有一个向量的概念，比如 (x,y,z) ，我们既可以说它是一个顶点位置，也可以说它是一个向量，顶点的位移其实就是向量的加法。</p><p>GLSL ES 语言里的向量运算</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>attribute vec4 a_Position<span class="token punctuation">;</span>
vec4 translation <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> a_Position <span class="token operator">+</span> translation<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>a_Position 是原始点位，属于 attribute 变量</li><li>translation 是顶点着色器里的私有变量，没有向外部暴露，属于 4 维向量</li><li>a_Position+translation 便是着色器内的向量加法，这里是对原始点位进行位移</li></ul><h3 id="_2-旋转" tabindex="-1"><a class="header-anchor" href="#_2-旋转" aria-hidden="true">#</a> 2.旋转</h3><p>物体的旋转方向是有正负之分的，在 webgl 中，除裁剪空间之外的大部分功能都使用了右手坐标系。</p><p><img src="/visual/webgl-share/46.png" alt=""></p><ul><li>当物体绕 z 轴，从 x 轴正半轴向 y 轴正半轴逆时针旋转时，是正向旋转，反之为负。</li><li>当物体绕 x 轴，从 y 轴正半轴向 z 轴正半轴逆时针旋转时，是正向旋转，反之为负。</li><li>当物体绕 y 轴，从 z 轴正半轴向 x 轴正半轴逆时针旋转时，是正向旋转，反之为负。</li></ul><p>旋转公式:</p><p>由一个让顶点围绕 z 轴旋转的例子引出</p><p><img src="/visual/webgl-share/47.png" alt=""></p><p>已知：</p><ul><li>点 A 的位置是(ax,ay,az)</li><li>点 A 要围绕 z 轴旋转 β 度，转到点 B 的位置</li></ul><p>求：点 A 旋转后的 bx、by 位置</p><p>因为 ∠β 是已知的，∠α 可以通过点 A 得出:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>∠xOB<span class="token operator">=</span>α<span class="token operator">+</span>β
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>三角函数就可以推出 bx、by</p><p>设 ∠xOB=θ，则：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>bx<span class="token operator">=</span>cosθ<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|</span>
by<span class="token operator">=</span>sinθ<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>|OA|是点 O 到点 A 的距离，可以直接用点 A 求出:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|=</span>Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>ax<span class="token operator">*</span>ax<span class="token operator">+</span>ay<span class="token operator">*</span>ay<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>只需要知道 cosθ 和 sinθ 的值即可，因为：θ=α+β<br> 所以可以利用和角公式求 cosθ 和 sinθ 的值：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>cosθ <span class="token operator">=</span> <span class="token function">cos</span><span class="token punctuation">(</span>α <span class="token operator">+</span> β<span class="token punctuation">)</span><span class="token punctuation">;</span>
cosθ <span class="token operator">=</span> cosα <span class="token operator">*</span> cosβ <span class="token operator">-</span> sinα <span class="token operator">*</span> sinβ<span class="token punctuation">;</span>

sinθ <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span>α <span class="token operator">+</span> β<span class="token punctuation">)</span><span class="token punctuation">;</span>
sinθ <span class="token operator">=</span> cosβ <span class="token operator">*</span> sinα <span class="token operator">+</span> sinβ <span class="token operator">*</span> cosα<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>所以：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>bx<span class="token operator">=</span>cosθ<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|</span>
bx<span class="token operator">=</span><span class="token punctuation">(</span>cosα<span class="token operator">*</span>cosβ<span class="token operator">-</span>sinα<span class="token operator">*</span>sinβ<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|</span>
bx<span class="token operator">=</span>cosα<span class="token operator">*</span>cosβ<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|</span><span class="token operator">-</span>sinα<span class="token operator">*</span>sinβ<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|</span>

by<span class="token operator">=</span>sinθ<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|</span>
by<span class="token operator">=</span><span class="token punctuation">(</span>cosβ<span class="token operator">*</span>sinα<span class="token operator">+</span>sinβ<span class="token operator">*</span>cosα<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|</span>
by<span class="token operator">=</span>cosβ<span class="token operator">*</span>sinα<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|</span><span class="token operator">+</span>sinβ<span class="token operator">*</span>cosα<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>因为：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>cosα<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|=</span>ax
sinα<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">OA</span><span class="token operator">|=</span>ay
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>简化得到 bx、by 的公式：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>bx <span class="token operator">=</span> ax <span class="token operator">*</span> cosβ <span class="token operator">-</span> ay <span class="token operator">*</span> sinβ<span class="token punctuation">;</span>
by <span class="token operator">=</span> ay <span class="token operator">*</span> cosβ <span class="token operator">+</span> ax <span class="token operator">*</span> sinβ<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在着色器中旋转</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
    attribute vec4 a_Position<span class="token punctuation">;</span>
    float angle <span class="token operator">=</span> <span class="token function">radians</span><span class="token punctuation">(</span><span class="token number">80.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    float sinB <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float cosB <span class="token operator">=</span> <span class="token function">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        gl_Position<span class="token punctuation">.</span>x <span class="token operator">=</span> a_Position<span class="token punctuation">.</span>x<span class="token operator">*</span>cosB <span class="token operator">-</span> a_Position<span class="token punctuation">.</span>y<span class="token operator">*</span>sinB<span class="token punctuation">;</span>
        gl_Position<span class="token punctuation">.</span>y <span class="token operator">=</span> a_Position<span class="token punctuation">.</span>y<span class="token operator">*</span>cosB <span class="token operator">+</span> a_Position<span class="token punctuation">.</span>x<span class="token operator">*</span>sinB<span class="token punctuation">;</span>
        gl_Position<span class="token punctuation">.</span>z <span class="token operator">=</span> a_Position<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
        gl_Position<span class="token punctuation">.</span>w <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>radians(float degree) 将角度转弧度</li><li>sin(float angle) 正弦</li><li>cos(float angle) 余弦</li></ul><h3 id="_3-缩放" tabindex="-1"><a class="header-anchor" href="#_3-缩放" aria-hidden="true">#</a> 3.缩放</h3><p>缩放可以理解为对向量长度的改变，或者对向量坐标分量的同步缩放</p><p><img src="/visual/webgl-share/48.png" alt=""></p><p>已知：</p><ul><li>点 A 的位置是(ax,ay,az)</li><li>点 A 基于原点內缩了一半</li></ul><p>求：点 A 內缩了一半后的 bx、by、bz 位置</p><p>解：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>bx <span class="token operator">=</span> ax <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
by <span class="token operator">=</span> ay <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
bz <span class="token operator">=</span> az <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在着色器中缩放</p><p>对 gl_Position 的 x、y、z 依次缩放：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
attribute vec4 a_Position<span class="token punctuation">;</span>
float scale <span class="token operator">=</span> <span class="token number">1.2</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	gl_Position<span class="token punctuation">.</span>x <span class="token operator">=</span> a_Position<span class="token punctuation">.</span>x<span class="token operator">*</span>scale<span class="token punctuation">;</span>
	gl_Position<span class="token punctuation">.</span>y <span class="token operator">=</span> a_Position<span class="token punctuation">.</span>y<span class="token operator">*</span>scale<span class="token punctuation">;</span>
	gl_Position<span class="token punctuation">.</span>z <span class="token operator">=</span> a_Position<span class="token punctuation">.</span>z<span class="token operator">*</span>scale<span class="token punctuation">;</span>
	gl_Position<span class="token punctuation">.</span>w <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>a_Position 中抽离出由 x、y、z 组成的三维向量，对其进行一次性缩放：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
attribute vec4 a_Position<span class="token punctuation">;</span>
float scale<span class="token operator">=</span><span class="token number">1.2</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	gl_Position<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token function">vec3</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token operator">*</span>scale<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_4-矩阵" tabindex="-1"><a class="header-anchor" href="#_4-矩阵" aria-hidden="true">#</a> 4.矩阵</h3><p>矩阵（Matrix）是一个按照矩形纵横排列的复数集合<br> 在矩阵中的每一行，或者每一列数字构成的集合，可以视之为向量</p><ol><li>向量</li></ol><p>向量，又叫矢量，指具有大小（magnitude）和方向的量<br> webgl 里的向量有 1 维向量、2 维向量、3 维向量和 4 维向量：</p><ul><li>维向量中有 1 个数字，对应的是单轴坐标系里的点位。</li><li>2 维向量中有 2 个数字，对应的是 2 维坐标系里的点位。</li><li>3 维向量中有 3 个数字，对应的是 3 维坐标系里的点位。</li><li>4 维向量中有 4 个数字，对应的是 3 维坐标系里的点位，外加一个附加数据，至于这个数据是什么，要看项目需求。</li></ul><ol start="2"><li>矩阵和向量的乘法</li></ol><p><img src="/visual/webgl-share/49.png" alt=""></p><p>用专业术语来说：</p><ul><li>横着的两组遵循的规则是行主序，即将矩阵中的一行数据视之为一个向量。</li><li>竖着的两组遵循的规则是列主序，即将矩阵中的一列数据视之为一个向量。</li></ul><p>至于是使用行主序，还是列主序，这就得看规则的定制者了。<br> 在 webgl 里，矩阵元素的排列规则是列主序。<br> 数学中常用的写法是行主序</p><p>可以用矩阵乘以向量的方式让点 p 旋转 β 度：</p><p><img src="/visual/webgl-share/50.png" alt=""></p><ol start="3"><li>在着色器中写矩阵</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
    attribute vec4 a_Position<span class="token punctuation">;</span>
    float angle <span class="token operator">=</span> <span class="token function">radians</span><span class="token punctuation">(</span><span class="token number">40.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    float sinB <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float cosB <span class="token operator">=</span> <span class="token function">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mat2 m2 <span class="token operator">=</span> <span class="token function">mat2</span><span class="token punctuation">(</span>
      cosB<span class="token punctuation">,</span> sinB<span class="token punctuation">,</span>
      <span class="token operator">-</span>sinB<span class="token punctuation">,</span>cosB
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>m2<span class="token operator">*</span><span class="token function">vec2</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">,</span> a_Position<span class="token punctuation">.</span>z<span class="token punctuation">,</span> a_Position<span class="token punctuation">.</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ol start="4"><li>四维矩阵</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
    attribute vec4 a_Position<span class="token punctuation">;</span>
    float angle<span class="token operator">=</span><span class="token function">radians</span><span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    float cosB<span class="token operator">=</span><span class="token function">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float sinB<span class="token operator">=</span><span class="token function">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//列主序</span>
    mat4 m4<span class="token operator">=</span><span class="token function">mat4</span><span class="token punctuation">(</span>
      cosB<span class="token punctuation">,</span> sinB<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
      <span class="token operator">-</span>sinB<span class="token punctuation">,</span>cosB<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
      <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
      <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> m4<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ol start="5"><li>矩阵平移</li></ol><p>让顶点的 x 移动 0.1，y 移动 0.2，z 移动 0.3：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
    attribute vec4 a_Position<span class="token punctuation">;</span>
    <span class="token comment">//列主序</span>
    mat4 m4<span class="token operator">=</span><span class="token function">mat4</span><span class="token punctuation">(</span>
      <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
      <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
      <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
      <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">1.0</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> m4<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ol start="6"><li>矩阵缩放</li></ol><p>顶点在 x 轴向缩放 2，y 轴向缩放 3，轴向缩放 4：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
    attribute vec4 a_Position<span class="token punctuation">;</span>
    <span class="token comment">//列主序</span>
    mat4 m4<span class="token operator">=</span><span class="token function">mat4</span><span class="token punctuation">(</span>
      <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
      <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
      <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">4.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
      <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> m4<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ol start="7"><li>矩阵库</li></ol><p>three.js 的 Matrix3 和 Matrix4 对象：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 1.引入Matrix4对象</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Matrix4 <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;https://unpkg.com/three/build/three.module.js&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 2.实例化矩阵对象，在其中写入旋转信息</span>
<span class="token keyword">const</span> matrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
matrix<span class="token punctuation">.</span><span class="token function">makeRotationZ</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 3.基于matrix 对象的elements 属性，修改uniform 变量</span>
<span class="token keyword">const</span> u_Matrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_Matrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_Matrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="六、-矩阵复合变换" tabindex="-1"><a class="header-anchor" href="#六、-矩阵复合变换" aria-hidden="true">#</a> 六、 矩阵复合变换</h2><h3 id="_1-矩阵相乘" tabindex="-1"><a class="header-anchor" href="#_1-矩阵相乘" aria-hidden="true">#</a> 1.矩阵相乘</h3><p>矩阵相乘可以实现复合变换，就比如先位移再旋转、先旋转在位移，或着连续位移。</p><p><img src="/visual/webgl-share/60.png" alt=""><img src="/visual/webgl-share/61.png" alt=""></p><h3 id="_2-变换规律" tabindex="-1"><a class="header-anchor" href="#_2-变换规律" aria-hidden="true">#</a> 2.变换规律</h3><ol><li>使用 three.js 的 Matrix4 对象建立矩阵</li></ol><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>const a = new Matrix4().set(
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span>
    <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span>
    <span class="token number">12</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">15</span>
)
const b = new Matrix4().set(
    <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span>
    <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span>
    <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span><span class="token number">110</span><span class="token punctuation">,</span>
    <span class="token number">120</span><span class="token punctuation">,</span><span class="token number">130</span><span class="token punctuation">,</span><span class="token number">140</span><span class="token punctuation">,</span><span class="token number">150</span>
)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>注：set()方法里输入的矩阵是行主序的，但 elements 输出的矩阵是列主序的。</p><ol start="2"><li>位移加位移</li></ol><p>例子：让一个物体沿 x 轴位移 ax，沿 y 轴位移 ay 后，再沿 x 轴位移 bx，沿 y 轴位移 by。</p><p>已知：</p><ul><li>初始点位 A(ax,ay,az,1.0)</li><li>初次位移：沿 x 轴位移 bx，沿 y 轴位移 by</li><li>第二次位移：沿 x 轴位移 cx，沿 y 轴位移 cy</li></ul><p>求：变换后的位置 F(fx,fy,fz,fw)</p><p>解：</p><p>1.设初次变换矩阵为 bm(行主序)：</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>bm
<span class="token punctuation">[</span>
	<span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>bx<span class="token punctuation">,</span>
	<span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>by<span class="token punctuation">,</span>
	<span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
	<span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>则初次变换后的点 F 为：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">F</span> <span class="token operator">=</span> bm <span class="token operator">*</span> <span class="token constant">A</span><span class="token punctuation">;</span>
fx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> bx<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">,</span> az<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> ax <span class="token operator">+</span> bx<span class="token punctuation">;</span>
fy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> by<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">,</span> az<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> ay <span class="token operator">+</span> by<span class="token punctuation">;</span>
fz <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">,</span> az<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> az<span class="token punctuation">;</span>
fw <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">,</span> az<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>2.设第二次变换矩阵为 cm(行主序)：</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>cm
<span class="token punctuation">[</span>
	<span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>cx<span class="token punctuation">,</span>
	<span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>cy<span class="token punctuation">,</span>
	<span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>
	<span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>则第二次变换后的点 F 为第二次变换矩阵乘以上一次变换后的点 F：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">F</span> <span class="token operator">=</span> cm <span class="token operator">*</span> <span class="token constant">F</span><span class="token punctuation">;</span>
fx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> cx<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>fx<span class="token punctuation">,</span> fy<span class="token punctuation">,</span> fz<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> fx <span class="token operator">+</span> cx<span class="token punctuation">;</span>
fy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> cy<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>fx<span class="token punctuation">,</span> fy<span class="token punctuation">,</span> fz<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> fy <span class="token operator">+</span> cy<span class="token punctuation">;</span>
fz <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>fx<span class="token punctuation">,</span> fy<span class="token punctuation">,</span> fz<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> fz<span class="token punctuation">;</span>
fw <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>fx<span class="token punctuation">,</span> fy<span class="token punctuation">,</span> fz<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>所以理解最终的点 F：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>fx <span class="token operator">=</span> ax <span class="token operator">+</span> bx <span class="token operator">+</span> cx<span class="token punctuation">;</span>
fy <span class="token operator">=</span> ay <span class="token operator">+</span> by <span class="token operator">+</span> cy<span class="token punctuation">;</span>
fz <span class="token operator">=</span> az<span class="token punctuation">;</span>
fw <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>上面的点 F 还可以这么理解：（矩阵乘以矩阵）</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">F</span> <span class="token operator">=</span> cm <span class="token operator">*</span> bm <span class="token operator">*</span> <span class="token constant">A</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>设 cm*bm 的结果为矩阵 dm(行主序)，参照 dm 中元素的索引位置：</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>cm
<span class="token punctuation">[</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span>
	<span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span>
	<span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span>
	<span class="token number">12</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>则 dm 中的第一行元素为：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>dm<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> bx<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
dm<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> bx<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
dm<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> bx<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
dm<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> bx<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>cx<span class="token punctuation">,</span> cy<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> cx <span class="token operator">+</span> bx<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>通过 dm 矩阵的第一行元素我们就可以得到点 F 的 fx 值了，验证一下：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>fx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> cx <span class="token operator">+</span> bx<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">,</span> az<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">=</span> ax <span class="token operator">+</span> cx <span class="token operator">+</span> bx<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>这和之前两次矩阵乘以向量得到的结果是一样的。</p><p><code>先位移bm再位移cm：</code></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">[</span>bx<span class="token punctuation">,</span> by<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>cx<span class="token punctuation">,</span> cy<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> bm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bx<span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> by<span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> cm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cx<span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cy<span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> matrix <span class="token operator">=</span> cm<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>bm<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_Matrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ol start="3"><li>先移动后旋转</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mr<span class="token punctuation">.</span><span class="token function">makeRotationZ</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> mt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mt<span class="token punctuation">.</span><span class="token function">makeTranslation</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> matrix <span class="token operator">=</span> mr<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>mt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> u_Matrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_Matrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_Matrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>mr.multiply(mt) 便是先位移再旋转：<br><img src="/visual/webgl-share/51.png" alt=""></p><ol start="4"><li>先旋转后移动</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mr<span class="token punctuation">.</span><span class="token function">makeRotationZ</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> mt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mt<span class="token punctuation">.</span><span class="token function">makeTranslation</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> matrix <span class="token operator">=</span> mt<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>mr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> u_Matrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_Matrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_Matrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>mt.multiply(mr)便是先旋转再位移：<br><img src="/visual/webgl-share/52.png" alt=""></p><ol start="5"><li>其它变换方式</li></ol><p>1)旋转和缩放</p><ul><li>先旋转后缩放</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mr<span class="token punctuation">.</span><span class="token function">makeRotationZ</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ms<span class="token punctuation">.</span><span class="token function">makeScale</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> matrix <span class="token operator">=</span> ms<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>mr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> u_Matrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_Matrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_Matrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>先缩放后旋转</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> matrix <span class="token operator">=</span> mr<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>在此要注意一个性质：当缩放因子一致时，旋转和缩放没有先后之分。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> ms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ms<span class="token punctuation">.</span><span class="token function">makeScale</span><span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>此是下面的两种变换结果都是一样的:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> matrix <span class="token operator">=</span> ms<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>mr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> matrix <span class="token operator">=</span> mr<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>2)综合变换</p><p>Matrix4 还有一个 compose 综合变换方法，它可以将所有变换信息都写进去，其变换顺序就是 <code>先缩放，再旋转，最后位移</code>。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> matrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//位移</span>
<span class="token keyword">const</span> pos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//旋转</span>
<span class="token keyword">const</span> rot <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Quaternion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rot<span class="token punctuation">.</span><span class="token function">setFromAxisAngle</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//缩放</span>
<span class="token keyword">const</span> scale <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
matrix<span class="token punctuation">.</span><span class="token function">compose</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> rot<span class="token punctuation">,</span> scale<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> u_Matrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_Matrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_Matrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>compose ( position : Vector3, quaternion : Quaternion, scale : Vector3 )</p><ul><li>position 位置</li><li>quaternion 用四元数存储的旋转数据</li><li>scale 缩放</li></ul><p>compose() 方法分解开来，就是这样的：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mt<span class="token punctuation">.</span><span class="token function">makeTranslation</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> mr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mr<span class="token punctuation">.</span><span class="token function">makeRotationZ</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ms<span class="token punctuation">.</span><span class="token function">makeScale</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> matrix <span class="token operator">=</span> mt<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>mr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> u_Matrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_Matrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_Matrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_3-视图矩阵" tabindex="-1"><a class="header-anchor" href="#_3-视图矩阵" aria-hidden="true">#</a> 3.视图矩阵</h3><p>视图矩阵是用于确定相机角度和位置的矩阵。<br> 能不能在没有视图矩阵的情况下，看见物体的另一个角度呢？<br> 答案肯定是可以，我们自己用模型矩阵把物体转一下就可以了。<br> 因此，视图矩阵的本质是对物体的旋转变换。<br> 而物体变换的本质则是对物体顶点的位移。</p><h4 id="_1-相机的定义" tabindex="-1"><a class="header-anchor" href="#_1-相机的定义" aria-hidden="true">#</a> 1.相机的定义</h4><p><img src="/visual/webgl-share/53.png" alt=""></p><ul><li>视点：相机的位置</li><li>视线方向：相机所看的方向</li><li>上方向：相机绕视线转动的方向</li></ul><h4 id="_2-相对运动" tabindex="-1"><a class="header-anchor" href="#_2-相对运动" aria-hidden="true">#</a> 2.相对运动</h4><p>当相机与它所拍摄的物体同时运动的时候，相机所拍摄的画面不会有任何改变</p><p><img src="/visual/webgl-share/54.png" alt=""></p><p>因此，我们可以默认相机的视点就在零点，相机看向-z 方向，其上方向就是 y 轴。<br> 当我我们改变的相机的视点、视线和上方向的时候，只要相对的去改变场景中的物体即可。<br> 而这个相对的去改变场景中的物体的矩阵，就是视图矩阵。</p><p><img src="/visual/webgl-share/55.png" alt=""></p><p>通过上面原理可以知道，想要计算视图矩阵，让其满足以下条件即可：</p><ol><li>把视点 e(ex,ey,ez)对齐到 O 点上</li><li>把视线 c(cx,cy,cz) 旋转到-z 轴上</li><li>把上方向 b(bx,by,bz) 旋转到 y 轴上</li><li>把 c 与 b 的垂线 a(ax,ay,az) 旋转到 x 轴上</li></ol><h4 id="_3-正交矩阵的旋转" tabindex="-1"><a class="header-anchor" href="#_3-正交矩阵的旋转" aria-hidden="true">#</a> 3.正交矩阵的旋转</h4><p>为了理解视图矩阵的运算，从几个例题说起。</p><p>题 1<br> 已知：点 A(1,0,0)<br> 求：把点 A 绕 z 轴逆时针旋转 30°，旋转到 B 点的行主序矩阵 m1<br><img src="/visual/webgl-share/56.png" alt=""></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>m1<span class="token operator">=</span><span class="token punctuation">[</span>
	cos30°<span class="token punctuation">,</span><span class="token operator">-</span>sin30°<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	sin30°<span class="token punctuation">,</span>cos30°<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span>      <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
<span class="token constant">B</span><span class="token operator">=</span>m1<span class="token operator">*</span><span class="token constant">A</span>
<span class="token constant">B</span><span class="token punctuation">.</span>x<span class="token operator">=</span><span class="token punctuation">(</span>cos30°<span class="token punctuation">,</span><span class="token operator">-</span>sin30°<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token function">·</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span>cos30°
<span class="token constant">B</span><span class="token punctuation">.</span>y<span class="token operator">=</span><span class="token punctuation">(</span>sin30°<span class="token punctuation">,</span>cos30°<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token function">·</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span>sin30°
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>题 2<br> 继题 1 的已知条件<br> 求：把点 B 绕 z 轴逆时针旋转-30°，旋转到 A 点的列行序矩阵 m2</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>m2<span class="token operator">=</span><span class="token punctuation">[</span>
	cos<span class="token operator">-</span><span class="token number">30</span>°<span class="token punctuation">,</span><span class="token operator">-</span>sin<span class="token operator">-</span><span class="token number">30</span>°<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	sin<span class="token operator">-</span><span class="token number">30</span>°<span class="token punctuation">,</span>cos<span class="token operator">-</span><span class="token number">30</span>°<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">,</span>       <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">,</span>       <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
m2<span class="token operator">=</span><span class="token punctuation">[</span>
	cos30°<span class="token punctuation">,</span> sin30°<span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token operator">-</span>sin30°<span class="token punctuation">,</span>cos30°<span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">,</span>       <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">,</span>       <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>观察题 1、题 2，我们可以发现两个规律：</p><ul><li>m2 是 m1 的逆矩阵</li><li>m2 也是 m1 的转置矩阵</li></ul><p>由此我们可以得到一个结论：<strong>正交旋转矩阵的逆矩阵就是其转置矩阵</strong>。</p><p>题 3<br> 已知：</p><ul><li><p>三维直角坐标系 m1，其基向量是：</p><ul><li>x(1,0,0)</li><li>y(0,1,0)</li><li>z(0,0,1)</li></ul></li><li><p>三维直角坐标系 m2，其基向量是：</p><ul><li>x(cos30°, sin30°,0)</li><li>y(-sin30°,cos30°,0)</li><li>z(0, 0, 1)</li></ul></li></ul><p>求：将 m1 中的基向量对齐到 m2 的行主序矩阵 m3<br><img src="/visual/webgl-share/57.png" alt=""></p><p>解：</p><p>将 m2 的基向量 x,y,z 中的 x 分量写入 m3 第 1 行;<br> 将 m2 的基向量 x,y,z 中的 y 分量写入 m3 第 2 行;<br> 将 m2 的基向量 x,y,z 中的 z 分量写入 m3 第 3 行。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>m3<span class="token operator">=</span><span class="token punctuation">[</span>
	cos30°<span class="token punctuation">,</span><span class="token operator">-</span>sin30°<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	sin30°<span class="token punctuation">,</span>cos30°<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span>      <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>题 4<br> 继题 3 的已知条件<br> 求：将 m2 中的基向量对齐到 m1 的行主序矩阵 m4</p><p>解：<br> 由题 3 已知：将 m1 中的基向量对齐到 m2 的行主序矩阵是 m3<br> 由题 4 的问题可知：m4 就是 m3 的逆矩阵<br> 因为：正交旋转矩阵的逆矩阵就是其转置矩阵<br> 所以：m4 就是 m3 的转置矩阵</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>m3<span class="token operator">=</span><span class="token punctuation">[</span>
	cos30°<span class="token punctuation">,</span><span class="token operator">-</span>sin30°<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	sin30°<span class="token punctuation">,</span>cos30°<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span>      <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
m4<span class="token operator">=</span><span class="token punctuation">[</span>
	cos30°<span class="token punctuation">,</span>sin30°<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token operator">-</span>sin30°<span class="token punctuation">,</span>cos30°<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_4-计算视图矩阵" tabindex="-1"><a class="header-anchor" href="#_4-计算视图矩阵" aria-hidden="true">#</a> 4.计算视图矩阵</h4><p><img src="/visual/webgl-share/57.png" alt=""></p><ol><li>先位移：写出把视点 e(ex,ey,ez) 对齐到 O 点上的行主序位移矩阵 mt</li></ol><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>mt
mt=<span class="token punctuation">[</span>
  <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>-ex<span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>-ey<span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>-ez<span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>写出把{o;x,y,-z} 对齐到{e;a,b,c} 的行主序旋转矩阵 mr1</li></ol><p>把 a,b,-c 的 x 分量写入 mr1 的第 1 行；<br> ​ 把 a,b,-c 的 y 分量写入 mr1 的第 2 行；<br> ​ 把 a,b,-c 的 z 分量写入 mr1 的第 3 行；</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>mr1
mr1=<span class="token punctuation">[</span>
	 ax<span class="token punctuation">,</span> bx<span class="token punctuation">,</span> -cx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
	 ay<span class="token punctuation">,</span> by<span class="token punctuation">,</span> -cy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
	 az<span class="token punctuation">,</span> bz<span class="token punctuation">,</span> -cz<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
	 <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>   <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">1</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="3"><li>计算 mr1 的逆矩阵 mr2。</li></ol><p>因为正交旋转矩阵的逆矩阵就是其转置矩阵，所以 mr2 就是 mr1 的转置矩阵。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>mr2
mr2=<span class="token punctuation">[</span>
	 ax<span class="token punctuation">,</span> ay<span class="token punctuation">,</span> az<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
	 bx<span class="token punctuation">,</span> by<span class="token punctuation">,</span> bz<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
	-cx<span class="token punctuation">,</span>-cy<span class="token punctuation">,</span>-cz<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
	 <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="4"><li>视图投影矩阵=mr2*mt</li></ol><h4 id="_5-视图矩阵的代码实现" tabindex="-1"><a class="header-anchor" href="#_5-视图矩阵的代码实现" aria-hidden="true">#</a> 5.视图矩阵的代码实现</h4><p><img src="/visual/webgl-share/58.png" alt=""></p><p>基于视点、目标点、上方向生成视图矩阵。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>getViewMatrix 相当于 threeJS 的 lookAt 方法
function getViewMatrix(e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> u) <span class="token punctuation">{</span>
  <span class="token comment">//基向量c，视线</span>
  const c = new Vector3().subVectors(e<span class="token punctuation">,</span> t).normalize()
  <span class="token comment">//基向量a，视线和上方向的垂线</span>
  const a = new Vector3().crossVectors(u<span class="token punctuation">,</span> c).normalize()
  <span class="token comment">//基向量b，修正上方向</span>
  const b = new Vector3().crossVectors(c<span class="token punctuation">,</span> a).normalize()
  <span class="token comment">//正交旋转矩阵</span>
  const mr = new Matrix4().set(
    ...a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    ...b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    -c.x<span class="token punctuation">,</span> -c.y<span class="token punctuation">,</span> -c.z<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
  )
  <span class="token comment">//位移矩阵</span>
  const mt = new Matrix4().set(
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> -e.x<span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> -e.y<span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> -e.z<span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
  )
  return mr.multiply(mt).elements
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>getViewMatrix 方法就是从一个新的角度去看某一个东西的意思</p><ul><li>e 视点</li><li>t 目标点</li><li>u 上方向</li></ul><p>在其中我借助了 Three.js 的 Vector3 对象</p><ul><li>subVectors(e, t) 向量 e 减向量 t</li><li>normalize() 向量的归一化</li><li>crossVectors(u, d) 向量 u 和向量 d 的叉乘</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">crossVectors</span><span class="token punctuation">(</span> <span class="token parameter">a<span class="token punctuation">,</span> b</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ax <span class="token operator">=</span> a<span class="token punctuation">.</span>x<span class="token punctuation">,</span> ay <span class="token operator">=</span> a<span class="token punctuation">.</span>y<span class="token punctuation">,</span> az <span class="token operator">=</span> a<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
  <span class="token keyword">const</span> bx <span class="token operator">=</span> b<span class="token punctuation">.</span>x<span class="token punctuation">,</span> by <span class="token operator">=</span> b<span class="token punctuation">.</span>y<span class="token punctuation">,</span> bz <span class="token operator">=</span> b<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> ay <span class="token operator">*</span> bz <span class="token operator">-</span> az <span class="token operator">*</span> by<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> az <span class="token operator">*</span> bx <span class="token operator">-</span> ax <span class="token operator">*</span> bz<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>z <span class="token operator">=</span> ax <span class="token operator">*</span> by <span class="token operator">-</span> ay <span class="token operator">*</span> bx<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>解释一下上面基向量 a,b,c 的运算原理，以下图为例：</p><p><img src="/visual/webgl-share/59.png" alt=""></p><p>视线 c 之所以是视点 e 减目标点 t，是为了取一个正向的基向量。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>c<span class="token operator">=</span><span class="token punctuation">(</span>e<span class="token operator">-</span>t<span class="token punctuation">)</span><span class="token operator">/</span><span class="token operator">|</span>e<span class="token operator">-</span>t<span class="token operator">|</span>
c<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>
c<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>基向量 a 是上方向 u 和向量 c 的叉乘</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>a<span class="token operator">=</span>u<span class="token operator">^</span>c<span class="token operator">/</span><span class="token operator">|</span>u<span class="token operator">^</span>c<span class="token operator">|</span>
a<span class="token operator">=</span><span class="token punctuation">(</span>cos30°<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">/</span>cos30°
a<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>基向量 b 是向量 c 和向量 a 的叉乘，可以理解为把上方向摆正</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>b<span class="token operator">=</span>c<span class="token operator">^</span>a<span class="token operator">/</span><span class="token operator">|</span>c<span class="token operator">^</span>a<span class="token operator">|</span>
b<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1</span>
b<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_6-测试" tabindex="-1"><a class="header-anchor" href="#_6-测试" aria-hidden="true">#</a> 6.测试</h4><ol><li>顶点着色器</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
    attribute vec4 a_Position<span class="token punctuation">;</span>
    <span class="token comment">//视图矩阵</span>
    uniform mat4 u_ViewMatrix<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> u_ViewMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol start="2"><li>建立视图矩阵，并传递给顶点着色器</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> u_ViewMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_ViewMatrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> <span class="token function">getViewMatrix</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ViewMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> viewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>注：</p><p>three.js 里的 lookAt() 方法便可以实现矩阵的正交旋转，其参数也是视点、目标点、上方向，它的实现原理上面说的是一样的。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> u_ViewMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_ViewMatrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ViewMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> viewMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_4-模型矩阵" tabindex="-1"><a class="header-anchor" href="#_4-模型矩阵" aria-hidden="true">#</a> 4.模型矩阵</h3><p>一个模型可能经过了多次变换，将这些变换复合成一个等效的变换，就得到了<strong>模型变换</strong>，相应的模型变换的矩阵称为<strong>模型矩阵</strong>（可以对物体进行位移、旋转、缩放变换）。</p><p>代码实现：</p><ol><li>在顶点着色器中添加一个模型矩阵</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
    attribute vec4 a_Position<span class="token punctuation">;</span>
    <span class="token comment">//模型矩阵</span>
    uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
    <span class="token comment">//视图矩阵</span>
    uniform mat4 u_ViewMatrix<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> u_ViewMatrix<span class="token operator">*</span>u_ModelMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol start="2"><li>在 js 中建立模型矩阵，并传递给顶点着色器</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> u_ModelMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_ModelMatrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> u_ViewMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_ViewMatrix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> modelMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ModelMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> modelMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ViewMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> viewMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ol start="3"><li>添加一个旋转动画</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> angle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">ani</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  angle <span class="token operator">+=</span> <span class="token number">0.02</span><span class="token punctuation">;</span>
  modelMatrix<span class="token punctuation">.</span><span class="token function">makeRotationY</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ModelMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> modelMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>

  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">LINES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> indices<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>ani<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol start="4"><li>还可以来个弹性动画</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> angle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> minY <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.7</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> maxY <span class="token operator">=</span> <span class="token number">0.7</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> y <span class="token operator">=</span> maxY<span class="token punctuation">;</span>
<span class="token keyword">let</span> vy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ay <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.001</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bounce <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">ani</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  angle <span class="token operator">+=</span> <span class="token number">0.01</span><span class="token punctuation">;</span>
  vy <span class="token operator">+=</span> ay<span class="token punctuation">;</span>
  y <span class="token operator">+=</span> vy<span class="token punctuation">;</span>
  modelMatrix<span class="token punctuation">.</span><span class="token function">makeRotationY</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
  modelMatrix<span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>modelMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> minY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    y <span class="token operator">=</span> minY<span class="token punctuation">;</span>
    vy <span class="token operator">*=</span> <span class="token operator">-</span>bounce<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ModelMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> modelMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">LINES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> indices<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>ani<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="七、颜色与纹理" tabindex="-1"><a class="header-anchor" href="#七、颜色与纹理" aria-hidden="true">#</a> 七、颜色与纹理</h2><h3 id="_1-多-attribute-变量" tabindex="-1"><a class="header-anchor" href="#_1-多-attribute-变量" aria-hidden="true">#</a> 1.多 attribute 变量</h3><p>如何一次性绘制三个不同颜色的点？</p><ol><li>多点同色</li></ol><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
      gl_PointSize <span class="token operator">=</span> <span class="token number">50.0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform vec4 u_FragColor<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor <span class="token operator">=</span> u_FragColor<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//顶点数据</span>
  <span class="token keyword">const</span> vertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span>
    <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> vertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> u_FragColor <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_FragColor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniform4f</span><span class="token punctuation">(</span>u_FragColor<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/62.png" alt=""></p><p>注意：<br> 这种方式只会绘制三个同样颜色的点。<br> 若想给这三个点不同的颜色，就需要再建立一个接收颜色数据的 attribute 变量。</p></details><ol start="2"><li>多点异色</li></ol><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  attribute vec4 a_Color<span class="token punctuation">;</span>
  varying vec4 v_Color<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
      gl_PointSize <span class="token operator">=</span> <span class="token number">50.0</span><span class="token punctuation">;</span>
      v_Color <span class="token operator">=</span> a_Color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  varying vec4 v_Color<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor <span class="token operator">=</span> v_Color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 顶点数据</span>
  <span class="token keyword">const</span> vertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span>
    <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> vertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span>

  <span class="token comment">// 颜色数据</span>
  <span class="token keyword">const</span> colors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> colorBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> colorBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> colors<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> a_Color <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Color&#39;</span><span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_Color<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Color<span class="token punctuation">)</span>

  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><div class="highlight-line"> </div><br><br><br><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/63.png" alt=""></p><p>注意：</p><ol><li>这里使用<strong>varying变量</strong>向片元着色器传入数据，实际上，varying变量的作用是从顶点着色器向片元着色器传输数据</li><li>建立了两份 attribute 数据，一份是顶点位置数据，一份是顶点颜色数据</li></ol></details><ol start="3"><li>多 attribute 数据合一</li></ol><p>数据合一，点位数据和颜色数据放一个集合里，让 attribute 变量按照某种规律从其中寻找数据</p><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  attribute vec4 a_Color<span class="token punctuation">;</span>
  varying vec4 v_Color<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
      gl_PointSize <span class="token operator">=</span> <span class="token number">50.0</span><span class="token punctuation">;</span>
      v_Color <span class="token operator">=</span> a_Color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  varying vec4 v_Color<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor <span class="token operator">=</span> v_Color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//数据源</span>
  <span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//元素字节数</span>
  <span class="token keyword">const</span> elementBytes <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token constant">BYTES_PER_ELEMENT</span><span class="token punctuation">;</span>
  <span class="token comment">//系列尺寸</span>
  <span class="token keyword">const</span> verticeSize <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> colorSize <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
  <span class="token comment">//类目尺寸</span>
  <span class="token keyword">const</span> categorySize <span class="token operator">=</span> verticeSize <span class="token operator">+</span> colorSize<span class="token punctuation">;</span>
  <span class="token comment">//类目字节数</span>
  <span class="token keyword">const</span> categoryBytes <span class="token operator">=</span> categorySize <span class="token operator">*</span> elementBytes<span class="token punctuation">;</span>
  <span class="token comment">//系列字节索引位置</span>
  <span class="token keyword">const</span> verticeByteIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> colorByteIndex <span class="token operator">=</span> verticeSize <span class="token operator">*</span> elementBytes<span class="token punctuation">;</span>
  <span class="token comment">//顶点总数</span>
  <span class="token keyword">const</span> sourceSize <span class="token operator">=</span> source<span class="token punctuation">.</span>length <span class="token operator">/</span> categorySize<span class="token punctuation">;</span>

  <span class="token comment">//缓冲对象</span>
  <span class="token keyword">const</span> sourceBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//绑定缓冲对象</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> sourceBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//写入数据</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span>
  <span class="token comment">//获取attribute 变量</span>
  <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">//修改attribute 变量</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>
    a_Position<span class="token punctuation">,</span>
    verticeSize<span class="token punctuation">,</span>
    gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    categoryBytes<span class="token punctuation">,</span>
    verticeByteIndex
  <span class="token punctuation">)</span>
  <span class="token comment">//赋能</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span>

  <span class="token comment">//获取attribute 变量</span>
  <span class="token keyword">const</span> a_Color <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Color&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">//修改attribute 变量</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>
    a_Color<span class="token punctuation">,</span>
    colorSize<span class="token punctuation">,</span>
    gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    categoryBytes<span class="token punctuation">,</span>
    colorByteIndex
  <span class="token punctuation">)</span>
  <span class="token comment">//赋能</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Color<span class="token punctuation">)</span>

  <span class="token comment">//刷底色</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//绘制顶点</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sourceSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/63.png" alt=""></p><p>对应上面的数据，先有以下概念：</p><ul><li>数据源：整个合而为一的数据 source</li><li>元素字节数：32 位浮点集合中每个元素的字节数</li><li>类目：一个顶点对应一个类目，也就是上面 source 中的每一行</li><li>系列：一个类目中所包含的每一种数据，比如顶点位置数据、顶点颜色数据</li><li>系列尺寸：一个系列所对应的向量的分量数目</li><li>类目尺寸：一个类目中所有系列尺寸的总和</li><li>类目字节数：一个类目的所有字节数量</li><li>系列元素索引位置：一个系列在一个类目中，以集合元素为单位的索引位置</li><li>系列字节索引位置：一个系列在一个类目中，以字节为单位的索引位置</li><li>顶点总数：数据源中的顶点总数</li></ul><p>gl.vertexAttribPointer() 方法玩转数据源：</p><ul><li>以前在说 vertexAttribPointer() 的时候，说过它的功能就是让 gl 修改 attribute 上下文对象的。</li><li>其实具体而言，它是在告诉顶点着色器中的 attribute 变量以怎样的方式从顶点着色器中寻找它所需要的数据。</li><li>比如，我想让顶点着色器中，名叫 a_Position 的 attribute 的变量从数据源中，寻找它所需要的数据。</li></ul><p>gl.vertexAttribPointer(index, size, type, normalized, stride, offset) ：</p><ul><li>index：attribute 变量，具体而言是指向存储 attribute 变量的空间的指针</li><li>size：系列尺寸</li><li>type：元素的数据类型</li><li>normalized：是否归一化</li><li>stride：类目字节数</li><li>offset：系列索引位置</li></ul><p><img src="/visual/webgl-share/64.png" alt=""><img src="/visual/webgl-share/65.png" alt=""></p></details><h3 id="_2-彩色三角形" tabindex="-1"><a class="header-anchor" href="#_2-彩色三角形" aria-hidden="true">#</a> 2.彩色三角形</h3><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  attribute vec4 a_Color<span class="token punctuation">;</span>
  varying vec4 v_Color<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
      gl_PointSize <span class="token operator">=</span> <span class="token number">50.0</span><span class="token punctuation">;</span>
      v_Color <span class="token operator">=</span> a_Color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 片元着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  varying vec4 v_Color<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor <span class="token operator">=</span> v_Color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//数据源</span>
  <span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//元素字节数</span>
  <span class="token keyword">const</span> elementBytes <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token constant">BYTES_PER_ELEMENT</span>
  <span class="token comment">//系列尺寸</span>
  <span class="token keyword">const</span> verticeSize <span class="token operator">=</span> <span class="token number">3</span>
  <span class="token keyword">const</span> colorSize <span class="token operator">=</span> <span class="token number">4</span>
  <span class="token comment">//类目尺寸</span>
  <span class="token keyword">const</span> categorySize <span class="token operator">=</span> verticeSize <span class="token operator">+</span> colorSize
  <span class="token comment">//类目字节数</span>
  <span class="token keyword">const</span> categoryBytes <span class="token operator">=</span> categorySize <span class="token operator">*</span> elementBytes
  <span class="token comment">//系列字节索引位置</span>
  <span class="token keyword">const</span> verticeByteIndex <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">const</span> colorByteIndex <span class="token operator">=</span> verticeSize <span class="token operator">*</span> elementBytes
  <span class="token comment">//顶点总数</span>
  <span class="token keyword">const</span> sourceSize <span class="token operator">=</span> source<span class="token punctuation">.</span>length <span class="token operator">/</span> categorySize

  <span class="token comment">//缓冲对象</span>
  <span class="token keyword">const</span> sourceBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//绑定缓冲对象</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> sourceBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//写入数据</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span>
  <span class="token comment">//获取attribute 变量</span>
  <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">//修改attribute 变量</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>
    a_Position<span class="token punctuation">,</span>
    verticeSize<span class="token punctuation">,</span>
    gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    categoryBytes<span class="token punctuation">,</span>
    verticeByteIndex
  <span class="token punctuation">)</span>
  <span class="token comment">//赋能-批处理</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span>

  <span class="token comment">//获取attribute 变量</span>
  <span class="token keyword">const</span> a_Color <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Color&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">//修改attribute 变量</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>
    a_Color<span class="token punctuation">,</span>
    colorSize<span class="token punctuation">,</span>
    gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    categoryBytes<span class="token punctuation">,</span>
    colorByteIndex
  <span class="token punctuation">)</span>
  <span class="token comment">//赋能-批处理</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Color<span class="token punctuation">)</span>

  <span class="token comment">//刷底色</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//绘制顶点</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sourceSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br></div></div><p>效果如下：<br><img src="/visual/webgl-share/66.png" alt=""></p><p>原理：<br> 三角形的三个顶点绑定了三种颜色，在三个点之间做线性补间，将补间得出的颜色填充到三角形所围成的每个片元之中。<br><img src="/visual/webgl-share/67.gif" alt=""></p><p>顶点着色器和片元着色器之间的图形装配和光栅化：<br><strong>图形装配</strong>：将孤立的顶点坐标装配成几何图形。几何图形的类别由gl.drawArrays()函数的第一个参数决定。</p><p><strong>光栅化</strong>过程：将装配好的几何图形转化为片元。 <img src="/visual/webgl-share/68.png" alt=""></p><p>注意：</p><ol><li>gl.Position实际上是<strong>几何图形装配</strong>阶段的输入数据</li><li>几何图形装配过程又被称为<strong>图元装配过程</strong></li><li>被装配过的图形(点、线、面)又称为<strong>图元</strong></li><li>显示在屏幕上的三角形是由片元(像素)组成的，所以还需要将图形转化为片元，这个过程称为<strong>光栅化</strong></li></ol><p><img src="/visual/webgl-share/69.png" alt=""></p></details><h3 id="_3-纹理" tabindex="-1"><a class="header-anchor" href="#_3-纹理" aria-hidden="true">#</a> 3.纹理</h3><p>纹理，通常指的就是二维的栅格图像，可以将其作为 webgl 图形的贴图。<br> 而在 webgl 里，还有一个纹理对象的概念，它是对图像又做了一层封装。</p><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  attribute vec2 a_Pin<span class="token punctuation">;</span>
  varying vec2 v_Pin<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
    v_Pin <span class="token operator">=</span> a_Pin<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform sampler2D u_Sampler<span class="token punctuation">;</span>
  varying vec2 v_Pin<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../jsm/Utils.js&#39;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vertexShader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fragmentShader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//数据源</span>
  <span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token constant">FSIZE</span> <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token constant">BYTES_PER_ELEMENT</span><span class="token punctuation">;</span>
  <span class="token comment">//元素字节数</span>
  <span class="token keyword">const</span> elementBytes <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token constant">BYTES_PER_ELEMENT</span>
  <span class="token comment">//系列尺寸</span>
  <span class="token keyword">const</span> posSize <span class="token operator">=</span> <span class="token number">2</span>
  <span class="token keyword">const</span> pinSize <span class="token operator">=</span> <span class="token number">2</span>
  <span class="token comment">//类目尺寸</span>
  <span class="token keyword">const</span> categorySize <span class="token operator">=</span> posSize <span class="token operator">+</span> pinSize
  <span class="token comment">//类目字节数</span>
  <span class="token keyword">const</span> categoryBytes <span class="token operator">=</span> categorySize <span class="token operator">*</span> elementBytes
  <span class="token comment">//系列字节索引位置</span>
  <span class="token keyword">const</span> posByteIndex <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">const</span> pinByteIndex <span class="token operator">=</span> posSize <span class="token operator">*</span> elementBytes
  <span class="token comment">//顶点总数</span>
  <span class="token keyword">const</span> sourceSize <span class="token operator">=</span> source<span class="token punctuation">.</span>length <span class="token operator">/</span> categorySize

  <span class="token keyword">const</span> sourceBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> sourceBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>
    a_Position<span class="token punctuation">,</span>
    posSize<span class="token punctuation">,</span>
    gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    categoryBytes<span class="token punctuation">,</span>
    posByteIndex
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> a_Pin <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Pin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>
    a_Pin<span class="token punctuation">,</span>
    pinSize<span class="token punctuation">,</span>
    gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    categoryBytes<span class="token punctuation">,</span>
    pinByteIndex
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* 图像预处理 */</span>
  gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

  <span class="token comment">/* 准备三个角色 */</span>
  gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span>
  <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&#39;./images/erha.jpg&#39;</span>
  image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span>
      gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span>
      gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span>
      gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span>
      image
    <span class="token punctuation">)</span>

    gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
      gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span>
      gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">const</span> u_Sampler <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;u_Sampler&#39;</span><span class="token punctuation">)</span>
    gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//渲染</span>
  <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sourceSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><div class="highlight-line"> </div><br><br><br><br><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/80.png" alt=""></p><p>步骤：</p><ol><li>准备好映射到几何图形上的纹理图像</li><li>为几何图形配置纹理映射方式</li><li>加载纹理图像，对其进行配置，以在WebGL中使用它</li><li>在片元着色器中奖相应的纹素从纹理中抽取出来，并将纹素的颜色赋给片元</li></ol></details><h4 id="_1-基础概念" tabindex="-1"><a class="header-anchor" href="#_1-基础概念" aria-hidden="true">#</a> 1.基础概念</h4><ol><li>栅格系统</li></ol><p>在说图像的时候，往往都是指点阵图、栅格图、位图，而与其相对应的是图形，也做矢量图。<br> 纹理，就是属于图像，其图像的建立和显示会遵循栅格系统里的规范。<br> 所有图像都是由像素组成的，在 webgl 里我们把像素称为片元，像素是按照相互垂直的行列排列的。</p><p>如下图：<br><img src="/visual/webgl-share/70.png" alt=""></p><p>将其放大后就可以看见其中的栅格：<br><img src="/visual/webgl-share/71.png" alt=""></p><p>图像中的每个像素都可以通过行数 y 和列数 x 来找到，由(x, y) 构成的点位，就是图像的像素坐标。</p><p>因为 canvas 画布也是一张图像，所以图像的栅格坐标系和我们之前说过的 canvas2d 的坐标系是一样的：<br><img src="/visual/webgl-share/6.png" alt=""></p><p>栅格坐标系的原点在左上角。<br> 栅格坐标系的 y 轴方向是朝下的。<br> 栅格坐标系的坐标基底由两个分量组成，分别是一个像素的宽和一个像素的高。</p><ol start="2"><li>图钉（WebGL纹理坐标）</li></ol><p>图钉是我自己写的概念，源自于 photoshop 中图像的操控变形功能，这种称呼很形象。<br><img src="/visual/webgl-share/72.png" alt=""></p><p>webgl 中，图钉的位置是通过 uv （st）坐标来控制的，图钉的 uv 坐标和顶点的 webgl 坐标是两种不同的坐标系统，之后会将其相互映射，从而将图像特定的一块区域贴到 webgl 图形中。</p><p>例如：<br><img src="/visual/webgl-share/73.png" alt=""></p><ol start="3"><li>uv 坐标系</li></ol><p><img src="/visual/webgl-share/74.png" alt=""> uv 坐标系，也叫 st 坐标系，坐标原点在图像的左下角，u 轴在右，v 轴在上<br> u 轴上的 1 个单位是图像的宽；<br> v 轴上的一个单位是图像的高。</p><ol start="4"><li>采样器</li></ol><p>采样器是按照图钉位置从图像中获取片元的方式。</p><p>在图像中所打的图钉位置，并不是图像中某一个片元的位置，因为片元位置走的是栅格坐标系。</p><p>需要一个采样器去对图钉的 uv 坐标系和像素的栅格坐标系做映射，从而去采集图像中图钉所对应的片元。</p><p>着色器基于一张图像可以建立一个或多个采样器，不同的采样器可以定义不同的规则去获取图像中的片元。</p><p>采样器在着色器中是一种变量类型，写做 sampler2D，它就像之前写过的 vec4 类型一样，可以在片元着色器中通过 uniform 变量暴露给 js，让 js 对其进行修改。</p><ol start="5"><li>纹理对象</li></ol><p>着色器使用一个纹理对象，就可以建立一个采样器。</p><p>纹理对象的建立需要一个图像源，比如 Image 对象。</p><p>同时，还需要设置纹理对象和图钉进行数据映射的方式。</p><p>js =&gt; 纹理对象，webgl =&gt; 缓冲区<br> 缓存区用于存放纹理对象的磁盘空间，这块空间可以将纹理对象翻译成着色器可以读懂的数据。<br> 之后会把这个空间的索引位置传给着色器，让着色器基于这个空间的索引位置，找到这个空间，然后再从空间中找到纹理对象，最后通过纹理对象建立采样器。</p><ol start="6"><li>纹理单元</li></ol><p>纹理单元是一种专门用来存放纹理对象的缓冲区，就像我们之前用 createBuffer()方法建立的用于存储数据源的缓冲区一样。</p><p>webgl=&gt; 纹理单元，如 TEXTURE0|1|2|3|4|5|6|7|</p><p>纹理单元虽然无需我们自己建立，但需要我们自己激活，让其进入使用状态</p><h4 id="_2-整体代码" tabindex="-1"><a class="header-anchor" href="#_2-整体代码" aria-hidden="true">#</a> 2.整体代码</h4><ol><li>顶点着色器</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
    attribute vec4 a_Position<span class="token punctuation">;</span>
    attribute vec2 a_Pin<span class="token punctuation">;</span> <span class="token comment">// 图钉位置</span>
    varying vec2 v_Pin<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
      v_Pin <span class="token operator">=</span> a_Pin<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol start="2"><li>片元着色器</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;fragmentShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-fragment&quot;</span><span class="token operator">&gt;</span>
    precision mediump float<span class="token punctuation">;</span>
    uniform sampler2D u_Sampler<span class="token punctuation">;</span>
    varying vec2 v_Pin<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

<span class="token comment">// sampler2D 是 uniform 变量的类型，叫做二维取样器</span>
<span class="token comment">// texture2D() 基于图钉从取样器中获取片元颜色</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ol start="3"><li>初始化着色器</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
<span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
<span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
<span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol start="4"><li>建立数据源，并计算相应尺寸</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//数据源 (顶点位置系列 和 图钉位置)</span>
<span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">FSIZE</span> <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token constant">BYTES_PER_ELEMENT</span><span class="token punctuation">;</span>
<span class="token comment">//元素字节数</span>
<span class="token keyword">const</span> elementBytes <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token constant">BYTES_PER_ELEMENT</span>
<span class="token comment">//系列尺寸</span>
<span class="token keyword">const</span> posSize <span class="token operator">=</span> <span class="token number">2</span>
<span class="token keyword">const</span> PinSize <span class="token operator">=</span> <span class="token number">2</span>
<span class="token comment">//类目尺寸</span>
<span class="token keyword">const</span> categorySize <span class="token operator">=</span> posSize <span class="token operator">+</span> PinSize
<span class="token comment">//类目字节数</span>
<span class="token keyword">const</span> categoryBytes <span class="token operator">=</span> categorySize <span class="token operator">*</span> elementBytes
<span class="token comment">//系列字节索引位置</span>
<span class="token keyword">const</span> posByteIndex <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> pinByteIndex <span class="token operator">=</span> posSize <span class="token operator">*</span> elementBytes
<span class="token comment">//顶点总数</span>
<span class="token keyword">const</span> sourceSize <span class="token operator">=</span> source<span class="token punctuation">.</span>length <span class="token operator">/</span> categorySize
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ol start="5"><li>将数据源写入到缓冲区，让 attribute 变量从其中寻找数据</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> sourceBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> sourceBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>
  a_Position<span class="token punctuation">,</span>
  posSize<span class="token punctuation">,</span>
  gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span><span class="token punctuation">,</span>
  categoryBytes<span class="token punctuation">,</span>
  posByteIndex
<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> a_Pin <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;a_Pin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>
  a_Pin<span class="token punctuation">,</span>
  pinSize<span class="token punctuation">,</span>
  gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span><span class="token punctuation">,</span>
  categoryBytes<span class="token punctuation">,</span>
  pinByteIndex
<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><ol start="6"><li>建立 Image 图像作为图像源，当图像源加载成功后再贴图</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//对纹理图像垂直翻转</span>
gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//激活 0 号纹理单元</span>
gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//纹理对象</span>
<span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//把纹理对象装进纹理单元里</span>
gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//image 对象</span>
<span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;./images/erha2.jpg&quot;</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">showMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//贴图</span>
<span class="token keyword">function</span> <span class="token function">showMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//配置纹理图像</span>
  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//配置纹理参数</span>
  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//获取u_Sampler</span>
  <span class="token keyword">const</span> u_Sampler <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_Sampler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//将0号纹理分配给着色器，0 是纹理单元编号</span>
  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//渲染</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sourceSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h4 id="_3-贴图详解" tabindex="-1"><a class="header-anchor" href="#_3-贴图详解" aria-hidden="true">#</a> 3.贴图详解</h4><ol><li>准备三个角色</li></ol><ul><li>Image 图像</li><li>纹理对象</li><li>纹理单元</li></ul><p><img src="/visual/webgl-share/75.png" alt=""></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 激活0号纹理单元</span>
gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//纹理对象</span>
<span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//image 对象</span>
<span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;./images/erha.jpg&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol start="2"><li>把纹理对象装进当前已被激活的纹理单元里</li></ol><p><img src="/visual/webgl-share/76.png" alt=""></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>TEXTURE_2D 纹理对象的类型</li></ul><ol start="3"><li>当 Image 图像加载成功后，把图像装进当前纹理单元的纹理对象里</li></ol><p><img src="/visual/webgl-share/77.png" alt=""></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>texImage2D(type, level, internalformat, format, type, pixels)</p><ul><li>type 纹理类型</li><li>level 基本图像等级</li><li>internalformat 纹理中的颜色组件</li><li>format 纹理数据格式，必须和 internalformat 一样</li><li>type 纹理数据的数据类型 <ul><li>UNSIGNED_BYTE 无符号字节</li></ul></li><li>pixels 图像源</li></ul><ol start="4"><li>纹理对象还有一些相应参数需要设置一下</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>texParameteri(type, pname, param)</p><ul><li>type 纹理类型 <ul><li>TEXTURE_2D 二维纹理</li></ul></li><li>pname 纹理参数的名称 <ul><li>TEXTURE_MIN_FILTER 纹理缩小滤波器</li></ul></li><li>param 与 pname 相对应的纹理参数值 <ul><li>gl.LINEAR 线性</li></ul></li></ul><ol start="5"><li>在 js 中获取采样器对应的 Uniform 变量,告诉片元着色器中的采样器，纹理对象在哪个单元里。之后采样器便会根据单元号去单元对象中寻找纹理对象</li></ol><p><img src="/visual/webgl-share/78.png" alt=""></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> u_Sampler <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_Sampler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="6"><li>渲染</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sourceSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>效果如下：<br><img src="/visual/webgl-share/79.png" alt=""></p><p>这时候的图像是倒立的，这是由于 Image 对象遵守的是栅格坐标系，栅格坐标系的 y 轴朝下，而 uv 坐标系的 y 朝上，两者相反，所以画出的图形反了。</p><ol start="7"><li>对图像进行预处理，将图像垂直翻转</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>pixelStorei(pname, param) 图像预处理</p><ul><li>pname 参数名 <ul><li>gl.UNPACK_FLIP_Y_WEBGL 是否垂直翻，布尔值，1|0</li></ul></li><li>param 参数值</li></ul><p><img src="/visual/webgl-share/80.png" alt=""></p><h4 id="_4-纹理容器" tabindex="-1"><a class="header-anchor" href="#_4-纹理容器" aria-hidden="true">#</a> 4.纹理容器</h4><p>在贴图的时候，默认图像源的尺寸只能是 2 的 n 次方，比如 2、4、8、16、……、256、512 等，如果我们把图像的尺寸改成非 2 次幂尺寸，如 300*300，那贴图就无法显示。</p><p>要想解决这种问题，就得设置一下纹理的容器，在图像上打图钉的时候，形成一块 uv 区域，这块区域可以理解为纹理容器。纹理容器可以定义图钉区域的纹理如何显示在 webgl 图形中。通过对纹理容器的设置，我们可以实现以下功能：</p><ul><li>非二次幂图像源的显示</li><li>纹理的复制</li><li>纹理的镜像</li></ul><ol><li>非二次幂图像源的显示</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>TEXTURE_WRAP_S 和 TEXTURE_WRAP_T 就是纹理容器在 s 方向和 t 方向的尺寸，这里的 s、t 就是 st 坐标系里的 s、t，st 坐标系和 uv 坐标系是一回事。</p><p>CLAMP_TO_EDGE 翻译过来就是边缘夹紧的意思，可以理解为任意尺寸的图像源都可以被宽高为 1 的 uv 尺寸夹紧。</p><p>注：只有 CLAMP_TO_EDGE 才能实现非二次幂图像源的显示，其它的参数都不可以。</p><ol start="2"><li>纹理的复制</li></ol><p>uv 坐标系的坐标基底分别是 1 个图片的宽和 1 个图片的高，可是如果我们将 2 个图片的宽高映射到了图形上会是什么结果呢？</p><p>默认是这样的：<br><img src="/visual/webgl-share/81.png" alt=""></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">REPEAT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">REPEAT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>REPEAT 就是纹理重复的意思</p><ol start="3"><li>纹理的镜像复制 纹理的镜像复制可以实现纹理的水平、垂直翻转和复制。</li></ol><p>效果如下：<br><img src="/visual/webgl-share/82.png" alt=""></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">MIRRORED_REPEAT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">MIRRORED_REPEAT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>MIRRORED_REPEAT 就是镜像复制的意思。</p><p>也可以通过使用 CLAMP_TO_EDGE 只对某一个方向纹理镜像复制</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">MIRRORED_REPEAT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>效果如下：<br><img src="/visual/webgl-share/83.png" alt=""></p><h4 id="_5-分子贴图" tabindex="-1"><a class="header-anchor" href="#_5-分子贴图" aria-hidden="true">#</a> 5.分子贴图</h4><p>分子贴图 mipmap 是一种纹理映射技术。</p><p>比如：</p><p>webgl 中有一个正方形，它在 canvas 画布中显示的时候，占据了 2*2 个像素，我们要将一个 8*8 的图像源贴上去。</p><p>正方形中肯定不能显示图像源中的所有像素，因为它只有 2*2=4 个像素。</p><p>在 Photoshop 中，会将图像源切割成 2 行、2 列的色块，然后将每个色块的均值交个正方形。</p><p>在 webgl 中也有类似的方法，并且它还有一层渲染性能的优化（Photoshop 底层是否有这层优化我尚且不知）。</p><p>接下来咱们就说一下这层优化优化的是什么。</p><p>先想象一个场景，我要把 1024*1024 的图像源映射到 canvas 画布上 2*2 的正方形中，若把图像源分割求均值会产生庞大的数据运算，我们需要想办法把和正方形相映射的图像源的尺寸降到最小，比如就是 2*2 的。</p><p>因此，我们就需要<a href="https://baike.baidu.com/item/Mipmap/3722136?fr=aladdin" target="_blank" rel="noopener noreferrer">分子贴图<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>了。</p><p>分子贴图是一个基于分辨率等比排列的图像集合，集合中每一项的宽高与其前一项宽高的比值都是 1/2。</p><p>如下图：</p><p><img src="/visual/webgl-share/84.png" alt=""></p><p>在 webgl 中，我们可以使用 gl.generateMipmap() 方法为图像源创建分子贴图，</p><p>有了分子贴图后，之前 2*2 的正方形便会从分子集合中寻找与其分辨率最接近的分子图像。</p><p>在找到分子图像后，就需要基于 webgl 图形的片元尺寸对其分割取色了。</p><p>对于取色的方法，咱们之前说一个均值算法，其实还有其它算法</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//创建分子贴图</span>
gl<span class="token punctuation">.</span><span class="token function">generateMipmap</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//定义从分子图像中取色的方法</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>gl.texParameteri()方法中的第 2 个参数和第 3 个参数是键值对的关系。</p><p>TEXTURE_MAG_FILTER 和 TEXTURE_MIN_FILTER，对应的是纹理在 webgl 图形中的缩放情况。</p><ul><li>TEXTURE_MAG_FILTER 纹理放大滤波器，是纹理在 webgl 图形中被放大的情况。</li><li>TEXTURE_MIN_FILTER 纹理缩小滤波器，是纹理在 webgl 图形中被缩小的情况。</li></ul><p>TEXTURE_MAG_FILTER 具备以下参数：</p><ul><li>LINEAR (默认值) ，线性滤镜， 获取纹理坐标点附近 4 个像素的加权平均值，效果平滑</li><li>NEAREST 最近滤镜， 获得最靠近纹理坐标点的像素 ，效果锐利</li></ul><p>TEXTURE_MIN_FILTER 具备以下参数：</p><ul><li>LINEAR 线性滤镜，获取纹理坐标点附近 4 个像素的加权平均值，效果平滑</li><li>NEAREST 最近滤镜， 获得最靠近纹理坐标点的像素，效果锐利</li><li>NEAREST_MIPMAP_NEAREST Select the nearest mip level and perform nearest neighbor filtering .</li><li>NEAREST_MIPMAP_LINEAR (默认值) Perform a linear interpolation between mip levels and perform nearest neighbor filtering within each .</li><li>LINEAR_MIPMAP_NEAREST Select the nearest mip level and perform linear filtering within it .</li><li>LINEAR_MIPMAP_LINEAR Perform a linear interpolation between mip levels and perform linear filtering : also called trilinear filtering .</li></ul><p>注：后面这 4 个与分子贴图相关的参数适合比较大的贴图，若是比较小的贴图，使用 LINEAR 或 NEAREST 就好。</p><p>注：缩小滤波器的默认值取色方法是 NEAREST_MIPMAP_LINEAR ，这个方法会从分子贴图里找分子图像，然后从其中取色，然而当我们没有使用 gl.generateMipmap()方法建立分子贴图的时候，就得给它一个不需要从分子贴图中去色的方法，如 LINEAR 或 NEAREST。</p><h4 id="_6-多纹理模型" tabindex="-1"><a class="header-anchor" href="#_6-多纹理模型" aria-hidden="true">#</a> 6.多纹理模型</h4><p>在实际开发中，经常会遇到一个模型，多个纹理的的情况。</p><p>比如这个魔方：</p><p><img src="/visual/webgl-share/86.gif" alt=""></p><p>有时候会很自然的想到一个面给它一个贴图，而实际上，最高效的方式是一个物体给它一个贴图，如下图：</p><p><img src="/visual/webgl-share/85.jpg" alt=""></p><p>这样只需要加载一次图片，建立一个纹理对象，做一次纹理和顶点数据的映射就可以了。</p><p>这里面没有涉及任何新的知识点，但这是一种很重要的项目开发经验。</p><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  attribute vec2 a_Pin<span class="token punctuation">;</span>
  uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
  varying vec2 v_Pin<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_ModelMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
    v_Pin <span class="token operator">=</span> a_Pin<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform sampler2D u_Sampler<span class="token punctuation">;</span>
  varying vec2 v_Pin<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../jsm/Utils.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> Matrix4 <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vertexShader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fragmentShader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">CULL_FACE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//数据源</span>
  <span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>

    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>

    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>

    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>

    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>

    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token constant">FSIZE</span> <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token constant">BYTES_PER_ELEMENT</span><span class="token punctuation">;</span>
  <span class="token comment">//元素字节数</span>
  <span class="token keyword">const</span> elementBytes <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token constant">BYTES_PER_ELEMENT</span>
  <span class="token comment">//系列尺寸</span>
  <span class="token keyword">const</span> posSize <span class="token operator">=</span> <span class="token number">3</span>
  <span class="token keyword">const</span> pinSize <span class="token operator">=</span> <span class="token number">2</span>
  <span class="token comment">//类目尺寸</span>
  <span class="token keyword">const</span> categorySize <span class="token operator">=</span> posSize <span class="token operator">+</span> pinSize
  <span class="token comment">//类目字节数</span>
  <span class="token keyword">const</span> categoryBytes <span class="token operator">=</span> categorySize <span class="token operator">*</span> elementBytes
  <span class="token comment">//系列字节索引位置</span>
  <span class="token keyword">const</span> posByteIndex <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">const</span> pinByteIndex <span class="token operator">=</span> posSize <span class="token operator">*</span> elementBytes
  <span class="token comment">//顶点总数</span>
  <span class="token keyword">const</span> sourceSize <span class="token operator">=</span> source<span class="token punctuation">.</span>length <span class="token operator">/</span> categorySize

  <span class="token keyword">const</span> sourceBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> sourceBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>
    a_Position<span class="token punctuation">,</span>
    posSize<span class="token punctuation">,</span>
    gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    categoryBytes<span class="token punctuation">,</span>
    posByteIndex
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> a_Pin <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Pin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>
    a_Pin<span class="token punctuation">,</span>
    pinSize<span class="token punctuation">,</span>
    gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    categoryBytes<span class="token punctuation">,</span>
    pinByteIndex
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//模型矩阵</span>
  <span class="token keyword">const</span> modelMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> mx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeRotationX</span><span class="token punctuation">(</span><span class="token number">0.02</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> my <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeRotationY</span><span class="token punctuation">(</span><span class="token number">0.02</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> u_ModelMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;u_ModelMatrix&#39;</span><span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ModelMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> modelMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span>

  <span class="token comment">/* 图像预处理 */</span>
  gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

  <span class="token comment">/* 准备三个角色 */</span>
  gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span>

  <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&#39;./images/mf.jpg&#39;</span>
  image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span>
      gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span>
      gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span>
      gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span>
      image
    <span class="token punctuation">)</span>

    gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
      gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span>
      gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> u_Sampler <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;u_Sampler&#39;</span><span class="token punctuation">)</span>
    gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//渲染</span>
  <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sourceSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 连续渲染</span>
  <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">ani</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    modelMatrix<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>my<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>mx<span class="token punctuation">)</span>
    gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ModelMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> modelMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>ani<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br></div></div></details><h3 id="_4-纹理合成" tabindex="-1"><a class="header-anchor" href="#_4-纹理合成" aria-hidden="true">#</a> 4.纹理合成</h3><p>纹理合成就是按照某种规则将多张图片合在一起。</p><h4 id="_4-1-多图加载" tabindex="-1"><a class="header-anchor" href="#_4-1-多图加载" aria-hidden="true">#</a> 4-1 多图加载</h4><p>纹理合成是需要多张图像源的，因此我们需要多张图像源都加载成功后，再去合成纹理。</p><ol><li>将图像的加载方法封装进一个 Promise 中，等图像加载成功后，再 resolve。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">imgPromise</span><span class="token punctuation">(</span><span class="token parameter">img</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    img<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>建立多个 Image 对象</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> originImg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
originImg<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;./images/dress.jpg&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pattern <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pattern<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;./images/pattern1.jpg&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="3"><li>利用 Promise.all 监听所有图片的记载成功</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">imgPromise</span><span class="token punctuation">(</span>originImg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">imgPromise</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  rect<span class="token punctuation">.</span>maps <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">u_Sampler</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">image</span><span class="token operator">:</span> originImg <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">u_Pattern</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">image</span><span class="token operator">:</span> pattern <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  rect<span class="token punctuation">.</span><span class="token function">updateMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>等所有的图片都加载成功后，会往 rect 的 maps 集合里写入贴图，然后对其更新和渲染。</p><p>接下来，看一下纹理合成最核心的地方，片元着色器。</p><h4 id="_4-2-在片元着色器中合成纹理" tabindex="-1"><a class="header-anchor" href="#_4-2-在片元着色器中合成纹理" aria-hidden="true">#</a> 4-2 在片元着色器中合成纹理</h4><p>片元着色器：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;fragmentShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-fragment&quot;</span><span class="token operator">&gt;</span>  
  precision mediump float<span class="token punctuation">;</span>  
  uniform sampler2D u_Sampler<span class="token punctuation">;</span>  
  uniform sampler2D u_Pattern<span class="token punctuation">;</span>  
  varying vec2 v_Pin<span class="token punctuation">;</span>  
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    
    vec4 o <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span>v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    vec4 p <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_Pattern<span class="token punctuation">,</span>v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    gl_FragColor <span class="token operator">=</span> p<span class="token operator">*</span>o<span class="token punctuation">;</span>  
  <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>u_Sampler 是原始图片采样器，对应下图：</li></ul><p><img src="/visual/webgl-share/87.jpg" alt=""></p><ul><li>u_Pattern 是纹理图案采样器，对应下图：</li></ul><p><img src="/visual/webgl-share/88.jpg" alt=""></p><p>之后，通过采样器找到原始图片和纹理图案的片元后，便可以对其进行运算：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>vec4 o <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span>v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
vec4 p <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_Pattern<span class="token punctuation">,</span>v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl_FragColor <span class="token operator">=</span> p<span class="token operator">*</span>o<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>上面的 p*o 便是在对片元做分量相乘的运算，这种算法会让原始图片的亮度变暗，有点类似于 ps 里的正片叠底。</p><p><img src="/visual/webgl-share/89.png" alt=""></p><p>举个例子说一下片元相乘的逻辑。</p><p>已知：</p><ul><li>原始图像片元 o(ox,oy,oz,ow)</li><li>纹理图案片元 p(px,py,pz,pw)</li></ul><p>求：p*o</p><p>解：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>p <span class="token operator">*</span> o <span class="token operator">=</span> <span class="token punctuation">(</span>px <span class="token operator">*</span> ox<span class="token punctuation">,</span> py <span class="token operator">*</span> oy<span class="token punctuation">,</span> pz <span class="token operator">*</span> oz<span class="token punctuation">,</span> pw <span class="token operator">*</span> ow<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>通过此例可知：因为片元分量的值域为[0,1]，所以 p*o 的亮度小于等于 p 和 o</p><ul><li>当 p=(1,1,1,1) 时，p*o=o</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>p <span class="token operator">*</span> o <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> ox<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">*</span> oy<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">*</span> oz<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">*</span> ow<span class="token punctuation">)</span><span class="token punctuation">;</span>
p <span class="token operator">*</span> o <span class="token operator">=</span> <span class="token punctuation">(</span>ox<span class="token punctuation">,</span> oy<span class="token punctuation">,</span> oz<span class="token punctuation">,</span> ow<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>当 p=(0,0,0,0) 时，p*o=(0,0,0,0)</li></ul><h4 id="_4-3-纹理混合" tabindex="-1"><a class="header-anchor" href="#_4-3-纹理混合" aria-hidden="true">#</a> 4-3 纹理混合</h4><p>纹理混合就是按照一定比例，将第一张图像合到另一张图像上，这类似于 ps 里的透明度合成。</p><p>直接看一下纹理在片元着色里的合成方法。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;fragmentShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-fragment&quot;</span><span class="token operator">&gt;</span>  
  precision mediump float<span class="token punctuation">;</span>
  uniform sampler2D u_Sampler<span class="token punctuation">;</span>
  uniform sampler2D u_Pattern<span class="token punctuation">;</span>
  varying vec2 v_Pin<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec4 o <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vec4 p <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_Pattern<span class="token punctuation">,</span> v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">mix</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>上面的 mix() 方法便是按照比例对两个纹理的合成方法。</p><p>mix() 方法的返回数据类型会因其合成对象的不同而不同。</p><p>其规则如下：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">mix</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> n<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token operator">=</span> m <span class="token operator">+</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> m<span class="token punctuation">)</span> <span class="token operator">*</span> a<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>例 1：</p><ul><li>m=3</li><li>n=5</li><li>a=0.5</li></ul><p>求：mix(m,n,a)</p><p>解：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">mix</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> n<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
<span class="token function">mix</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> n<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
<span class="token function">mix</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> n<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>例 2：</p><ul><li>m=(1,2,3)</li><li>n=(3,4,5)</li><li>a=0.5</li></ul><p>求：mix(m,n,a)</p><p>解：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">mix</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> n<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">mix</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> n<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>简单总结一下 mix(m,n,a) 方法的特性：</p><ul><li>当 a=0 时，mix(m,n,a)=m</li><li>当 a=1 时，mix(m,n,a)=n</li></ul><p>参考地址：https://www.khronos.org/registry/OpenGL-Refpages/gl4/</p><p>利用纹理混合，我们可以实现转场动画。</p><h3 id="_5-跨域图像做贴图" tabindex="-1"><a class="header-anchor" href="#_5-跨域图像做贴图" aria-hidden="true">#</a> 5.跨域图像做贴图</h3><p>这里要说的跨域图像问题，并不单是 webgl 问题，也是 canvas 2d 里的问题。</p><ol><li>img 标签与跨域图像</li></ol><p>用 img 标签显示跨域图像的时候，只能将图像展示给用户，但并不能获取图像中的数据。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token string">&quot;https://xxx/xxx.png&#39;&quot;</span><span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>不能通过 img 标签获取图像数据，是浏览器出于安全考虑的，因为有的图像里可能会含有验证码、签名、或者其它不可告人的东东，这种数据是不能随意被别人获取的。</p><ol start="2"><li>获取图像数据</li></ol><p>若图像是同域的，下面的方法是没问题的：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;2d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
img<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;https://xxx/xxx.png&quot;</span><span class="token punctuation">;</span>

img<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> width<span class="token punctuation">,</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">getImageData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>若图像是跨域的，那就会报错：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>Failed to execute <span class="token string">&#39;getImageData&#39;</span> on <span class="token string">&#39;CanvasRenderingContext2D&#39;</span><span class="token operator">:</span> The canvas has been tainted by cross<span class="token operator">-</span>origin data<span class="token punctuation">.</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>用 webgl 获取跨域图像数据时，也会报错：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;https://xxx/xxx.png&quot;</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> u_Sampler <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_Sampler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>错误信息：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>Failed to execute <span class="token string">&#39;texImage2D&#39;</span> on <span class="token string">&#39;WebGLRenderingContext&#39;</span><span class="token operator">:</span> The image element contains cross<span class="token operator">-</span>origin data<span class="token punctuation">,</span> and may not be loaded<span class="token punctuation">.</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol start="3"><li>CORS 跨域</li></ol><p>CORS 是 Cross Origin Resource Sharing 的简写，译作跨域资源共享。</p><p>CORS 是一种网页向图像服务器请求使用图像许可的方式。</p><p>CORS 的实现过程如下：</p><p>1.先让服务器向其它域名放权，比如 Apache 服务器需要这样设置：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>Header <span class="token keyword">set</span> Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Origin <span class="token string">&quot;*&quot;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>上面代码的意思就是允许其它域名的网页跨域获取自己服务端的资源。</p><p>上面的* 是允许所有域名获取其服务端资源。</p><p>我们也可以写具体的域名，从而允许特定域名获取其服务端资源。</p><p>2.在网页里，通过特定的方法告诉服务端，我需要跨域获取你的资源。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;https://xxx/xxx.png&quot;</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;crossOrigin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Anonymous&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>有了上面 crossOrigin 属性的设置，无论是在 canvas 2d 里使用此图像源，还是在 webgl 里使用此图像源，都不会报错。</p><p>crossOrigin 接收的值有三种：</p><ul><li>undefined 是默认值，表示不需要向其它域名的服务器请求资源共享</li><li>anonymous 向其它域名的服务器请求资源共享，但不需要向其发送任何信息</li><li>use-credentials 向其它域名的服务器请求资源共享，并发送 cookies 等信息，服务器会通过这些信息决定是否授权</li></ul><h3 id="_6-视频贴图" tabindex="-1"><a class="header-anchor" href="#_6-视频贴图" aria-hidden="true">#</a> 6.视频贴图</h3><p>之前使用 texImage2D 方法将 Image 图像源装进了纹理对象里：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>也可以把上面的 image 换成 video 对象</p><ol><li>正常建立纹理对象，并设置其相关属性</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="2"><li>获取采样器对应的 uniform 变量，并将纹理单元号赋给它</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> u_Sampler <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&quot;u_Sampler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="3"><li>建立 video 对象，并播放</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> video <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;video&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
video<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;http://img.yxyy.name/ripples.mp4&quot;</span><span class="token punctuation">;</span>
video<span class="token punctuation">.</span>autoplay <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
video<span class="token punctuation">.</span>muted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
video<span class="token punctuation">.</span>loop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
video<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;crossOrigin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Anonymous&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
video<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
video<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;playing&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">ani</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol start="4"><li>在 video 对象播放时，向纹理对象连续写入 video</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> video<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sourceSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="八、世界坐标和本地坐标" tabindex="-1"><a class="header-anchor" href="#八、世界坐标和本地坐标" aria-hidden="true">#</a> 八、世界坐标和本地坐标</h2><h3 id="_1-基本概念" tabindex="-1"><a class="header-anchor" href="#_1-基本概念" aria-hidden="true">#</a> 1.基本概念</h3><p>3D空间拥有一个世界坐标系，3D屏幕中的所有物体都可以在该坐标系系统下移动和旋转，对于屏幕上的所有物体来说，这个坐标系系统都是相同的，并且它不会改变。用户默认的观察视角是沿着Z轴的负半轴方向</p><p>除了世界坐标系外，每个物体都有一个本地坐标系，如图：<br><img src="/visual/webgl-share/90.png" alt=""></p><p>当物体旋转时，本地坐标系统也会跟着物体一起旋转，如图：<br><img src="/visual/webgl-share/91.png" alt=""></p><h3 id="_2-世界坐标系和本地坐标系点位关系" tabindex="-1"><a class="header-anchor" href="#_2-世界坐标系和本地坐标系点位关系" aria-hidden="true">#</a> 2.世界坐标系和本地坐标系点位关系</h3><p><code>已知</code>：</p><ul><li>世界坐标系[O1;i1,j1,k1]</li><li>点 P</li><li>点 P 所处的本地坐标系是[O2;i2,j2,k2]</li><li>世界坐标系[O1;i1,j1,k1]∋ 本地坐标系[O2;i2,j2,k2]</li></ul><p><code>分析</code>：</p><p>[O;i,j,k]中：</p><ul><li>O 是坐标原点</li><li>i,j,k 是坐标向量</li></ul><p>这是空间直角坐标系的书写方式，可在高中数学的空间几何部分找到</p><p><code>提问 1</code>：</p><p>点 P 的坐标位是(x,y,z)，可否找到点 P？</p><p>答：不可。</p><p>因为没说(x,y,z) 是在世界坐标系[O1;i1,j1,k1]里的位置，还是在本地坐标系是[O2;i2,j2,k2]里的位置。</p><p><code>提问 2</code>：</p><p>点 P 的世界坐标位是(x,y,z)，可否找到点 P？</p><p>答：可</p><p><code>提问 3</code>：</p><p>点 P 的本地坐标位是(x,y,z)，可否找到点 P？若可以，求点 P 的世界位。</p><p>答：可</p><p><code>解</code>：</p><p>根据空间向量分解定理。</p><p>由世界坐标系[O1;i1,j1,k1]可解析出四维矩阵 m1：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	i1.x, j1.x, k1.x, 0,
	i1.y, j1.y, k1.y, 0,
	i1.z, j1.z, k1.z, 0,
	O1.x, O1.y, O1.z, 1
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>同理，由本地坐标系[O2;i2,j2,k2]可解析出四维矩阵 m2：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	i2.x, j2.x, k2.x, 0,
	i2.y, j2.y, k2.y, 0,
	i2.z, j2.z, k2.z, 0,
	O2.x, O2.y, O2.z, 1
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>点 P 的世界位是：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>m1 <span class="token operator">*</span> m2 <span class="token operator">*</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h2 id="九、深入认知三维世界" tabindex="-1"><a class="header-anchor" href="#九、深入认知三维世界" aria-hidden="true">#</a> 九、深入认知三维世界</h2><h3 id="_1-用位移矩阵做实验" tabindex="-1"><a class="header-anchor" href="#_1-用位移矩阵做实验" aria-hidden="true">#</a> 1.用位移矩阵做实验</h3><h4 id="_1-1示例" tabindex="-1"><a class="header-anchor" href="#_1-1示例" aria-hidden="true">#</a> 1.1示例</h4><p><code>已知</code>：</p><ul><li>宇宙 universe</li><li>宇宙的本地坐标系是[O1;i1,j1,k1] <ul><li>O1(0,0,0)</li><li>i1(1,0,0)</li><li>j1(0,1,0)</li><li>k1(0,0,1)</li></ul></li><li>宇宙包含万物，其本地坐标系就是万物的世界坐标系</li><li>银河系 galaxy</li><li>银河系的本地坐标系是[O2;i2,j2,k2] <ul><li>O2(1,2,3)</li><li>i2(1,0,0)</li><li>j2(0,1,0)</li><li>k2(0,0,1)</li></ul></li><li>太阳 sun</li><li>太阳在银河系内的本地坐标位是 P2(4,5,6)</li><li>太阳 ∈ 银河系 ∈ 宇宙</li></ul><p>求：太阳的世界位 P1</p><p><code>解</code>：</p><p>由宇宙坐标系[O1;i1,j1,k1]解矩阵 m1：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	1, 0, 0, 0,
	0, 1, 0, 0,
	0, 0, 1, 0,
	0, 0, 0, 1
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>由银河系[O2;i2,j2,k2]解矩阵 m2:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	1, 0, 0, 0,
	0, 1, 0, 0,
	0, 0, 1, 0,
	1, 2, 3, 1
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>点 P 的世界坐标位是：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">P1</span> <span class="token operator">=</span> m1 <span class="token operator">*</span> m2 <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">P1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">P1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_1-2用-three-js-验证" tabindex="-1"><a class="header-anchor" href="#_1-2用-three-js-验证" aria-hidden="true">#</a> 1.2用 three.js 验证</h4><details class="custom-container details"><summary>代码实现</summary><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">import</span> <span class="token punctuation">{</span> 
    Group<span class="token punctuation">,</span> 
    Matrix4<span class="token punctuation">,</span> 
    Object3D<span class="token punctuation">,</span> 
    Scene<span class="token punctuation">,</span> 
    Vector3 
  <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span>

  <span class="token comment">//世界坐标系-宇宙</span>
  <span class="token keyword">const</span> m1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  m1<span class="token punctuation">.</span>elements <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>

  <span class="token comment">//本地坐标系-银河系</span>
  <span class="token keyword">const</span> m2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  m2<span class="token punctuation">.</span>elements <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>

  <span class="token comment">//太阳在银河系内的本地坐标位</span>
  <span class="token keyword">const</span> <span class="token constant">P2</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>

  <span class="token comment">//创造宇宙</span>
  <span class="token keyword">const</span> universe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  universe<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m1<span class="token punctuation">)</span>

  <span class="token comment">//创造银河系</span>
  <span class="token keyword">const</span> galaxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Group</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  galaxy<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m2<span class="token punctuation">)</span>

  <span class="token comment">//创造太阳</span>
  <span class="token keyword">const</span> sun <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object3D</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  sun<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token constant">P2</span><span class="token punctuation">)</span>

  <span class="token comment">//银河系包含太阳</span>
  galaxy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sun<span class="token punctuation">)</span>

  <span class="token comment">//宇宙包含银河系</span>
  universe<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>galaxy<span class="token punctuation">)</span>

  <span class="token comment">//求太阳在宇宙中的世界位</span>
  <span class="token keyword">const</span> <span class="token constant">P1</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  sun<span class="token punctuation">.</span><span class="token function">getWorldPosition</span><span class="token punctuation">(</span><span class="token constant">P1</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">P1</span><span class="token punctuation">)</span>  <span class="token comment">// {x: 5, y: 7, z: 9}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div></details><h3 id="_2-位移法则" tabindex="-1"><a class="header-anchor" href="#_2-位移法则" aria-hidden="true">#</a> 2.位移法则</h3><p>若不想求太阳的位置，想求太阳系内的地球的位置，是否还可按照之前的思路来求解？答案是肯定的。</p><h4 id="_2-1示例" tabindex="-1"><a class="header-anchor" href="#_2-1示例" aria-hidden="true">#</a> 2.1示例</h4><p>调整一下之前的已知条件。</p><ul><li><p>把太阳改成太阳系 solar</p></li><li><p>太阳系的本地坐标系是[O3;i3,j3,k3]</p><ul><li>O3(4,5,6)</li><li>i3(1,0,0)</li><li>j3(0,1,0)</li><li>k3(0,0,1)</li></ul></li><li><p>地球 earth</p></li><li><p>地球在太阳系内的本地坐标位是 P3(7,8,9)</p></li><li><p>地球 ∈ 太阳系 ∈ 银河系 ∈ 宇宙</p></li></ul><p>求：地球的世界坐标位 P1</p><p><code>解</code>：</p><p>由太阳系的本地坐标系可得矩阵 m3：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	1, 0, 0, 0,
    0, 1, 0, 0,
    0, 0, 1, 0,
    4, 5, 6, 1
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>求地球的世界坐标位 P1：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">P1</span> <span class="token operator">=</span> m1 <span class="token operator">*</span> m2 <span class="token operator">*</span> m3 <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">P1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">6</span> <span class="token operator">+</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">P1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_2-2用-three-js验证" tabindex="-1"><a class="header-anchor" href="#_2-2用-three-js验证" aria-hidden="true">#</a> 2.2用 three.js验证</h4><details class="custom-container details"><summary>代码实现</summary><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> 
  Group<span class="token punctuation">,</span> 
  Matrix4<span class="token punctuation">,</span> 
  Object3D<span class="token punctuation">,</span> 
  Scene<span class="token punctuation">,</span> 
  Vector3
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>

<span class="token comment">//世界坐标系-宇宙</span>
<span class="token keyword">const</span> m1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
m1<span class="token punctuation">.</span>elements <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">]</span>

<span class="token comment">//本地坐标系-银河系</span>
<span class="token keyword">const</span> m2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
m2<span class="token punctuation">.</span>elements <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">]</span>

<span class="token comment">//本地坐标系-太阳系</span>
<span class="token keyword">const</span> m3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
m3<span class="token punctuation">.</span>elements <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">]</span>

<span class="token comment">//本地坐标位-地球</span>
<span class="token keyword">const</span> <span class="token constant">P3</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>

<span class="token comment">//宇宙(世界坐标系是宇宙的本地坐标系)</span>
<span class="token keyword">const</span> universe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
universe<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m1<span class="token punctuation">)</span>

<span class="token comment">//银河系</span>
<span class="token keyword">const</span> galaxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Group</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
galaxy<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m2<span class="token punctuation">)</span>

<span class="token comment">//太阳系</span>
<span class="token keyword">const</span> solar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Group</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
solar<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m3<span class="token punctuation">)</span>

<span class="token comment">//地球</span>
<span class="token keyword">const</span> earth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object3D</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
earth<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token constant">P3</span><span class="token punctuation">)</span>

<span class="token comment">//包含关系</span>
solar<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>earth<span class="token punctuation">)</span>
galaxy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>solar<span class="token punctuation">)</span>
universe<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>galaxy<span class="token punctuation">)</span>

<span class="token comment">//点P的世界位</span>
<span class="token keyword">const</span> <span class="token constant">P1</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
earth<span class="token punctuation">.</span><span class="token function">getWorldPosition</span><span class="token punctuation">(</span><span class="token constant">P1</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">P1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//{x: 12, y: 15, z: 18}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div></details><h4 id="_2-3推理" tabindex="-1"><a class="header-anchor" href="#_2-3推理" aria-hidden="true">#</a> 2.3推理</h4><p>可以从上面的结论中得到一个规律：</p><p>当一点 P 和宇宙之间存在 n 层嵌套<br> 点 P 的本地坐标位是 Pn<br> 第 n 层世界的本地坐标系所对应的矩阵是 mn<br> 则点 P 的世界位 P1 是：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">P1</span> <span class="token operator">=</span> m1 <span class="token operator">*</span> m2 <span class="token operator">*</span> …… <span class="token operator">*</span> mn <span class="token operator">*</span> pn
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>上面的公式，就暂且叫它“<strong>本地坐标转世界坐标公式</strong>”。</p><h3 id="_3-缩放法则" tabindex="-1"><a class="header-anchor" href="#_3-缩放法则" aria-hidden="true">#</a> 3.缩放法则</h3><h4 id="_3-1示例" tabindex="-1"><a class="header-anchor" href="#_3-1示例" aria-hidden="true">#</a> 3.1示例</h4><p>修改之前已知条件：</p><ul><li><p>在银河系的本地坐标系[O2;i2,j2,k2]中，让 j2 是单位向量的 2 倍：</p><ul><li>O2(1, 2, 3)</li><li>i2(1, 0, 0)</li><li>j2(0, 2, 0)</li><li>k2(0, 0, 1)</li></ul></li><li><p>在太阳系的本地坐标系[O3;i3,j3,k3]，让 k3 是单位向量的 3 倍：</p><ul><li>O3(4, 5, 6)</li><li>i3(1, 0, 0)</li><li>j3(0, 1, 0)</li><li>k3(0, 0, 3)</li></ul></li></ul><p>求：地球的世界坐标位 P1</p><p><code>解</code>：</p><p>由银河系的本地坐标系可得矩阵 m2：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
   1, 0, 0, 0,
   0, 2, 0, 0,
   0, 0, 1, 0,
   1, 2, 3, 1
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>由太阳系的本地坐标系可得矩阵 m3：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
   1, 0, 0, 0,
   0, 1, 0, 0,
   0, 0, 3, 0,
   4, 5, 6, 1
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>求地球的世界坐标位 P1：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">P1</span> <span class="token operator">=</span> m1 <span class="token operator">*</span> m2 <span class="token operator">*</span> m3 <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>
m1 <span class="token operator">*</span> m2 <span class="token operator">*</span> m3 <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span>
    <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token number">0</span>
    <span class="token number">4</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">5</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span>
<span class="token punctuation">]</span>
m1 <span class="token operator">*</span> m2 <span class="token operator">*</span> m3<span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">]</span>
<span class="token constant">P1</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">)</span>
<span class="token constant">P1</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="_3-2用-three-js验证" tabindex="-1"><a class="header-anchor" href="#_3-2用-three-js验证" aria-hidden="true">#</a> 3.2用 three.js验证</h4><details class="custom-container details"><summary>代码实现</summary><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> 
  Group<span class="token punctuation">,</span> 
  Matrix4<span class="token punctuation">,</span> 
  Object3D<span class="token punctuation">,</span> 
  Scene<span class="token punctuation">,</span> 
  Vector3
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>

<span class="token comment">//世界坐标系-宇宙</span>
<span class="token keyword">const</span> m1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
m1<span class="token punctuation">.</span>elements <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token comment">//本地坐标系-银河系</span>
<span class="token keyword">const</span> m2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
m2<span class="token punctuation">.</span>elements <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token comment">//本地坐标系-太阳系</span>
<span class="token keyword">const</span> m3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
m3<span class="token punctuation">.</span>elements <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token comment">//地球在太阳系内的本地坐标位</span>
<span class="token keyword">const</span> <span class="token constant">P3</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>

<span class="token comment">//创造宇宙</span>
<span class="token keyword">const</span> universe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
universe<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m1<span class="token punctuation">)</span>

<span class="token comment">//创造银河系</span>
<span class="token keyword">const</span> galaxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Group</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
galaxy<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m2<span class="token punctuation">)</span>

<span class="token comment">//创造太阳系</span>
<span class="token keyword">const</span> solar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Group</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
solar<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m3<span class="token punctuation">)</span>

<span class="token comment">//创造地球</span>
<span class="token keyword">const</span> earth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object3D</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
earth<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token constant">P3</span><span class="token punctuation">)</span>

<span class="token comment">//太阳系包含地球</span>
solar<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>earth<span class="token punctuation">)</span>

<span class="token comment">//银河系包含太阳</span>
galaxy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>solar<span class="token punctuation">)</span>

<span class="token comment">//宇宙包含银河系</span>
universe<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>galaxy<span class="token punctuation">)</span>

<span class="token comment">//求太阳在宇宙中的世界位</span>
<span class="token keyword">const</span> <span class="token constant">P1</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
earth<span class="token punctuation">.</span><span class="token function">getWorldPosition</span><span class="token punctuation">(</span><span class="token constant">P1</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">P1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// {x: 12, y: 28, z: 36}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div></details><h3 id="_4-旋转法则" tabindex="-1"><a class="header-anchor" href="#_4-旋转法则" aria-hidden="true">#</a> 4.旋转法则</h3><h4 id="_4-1示例" tabindex="-1"><a class="header-anchor" href="#_4-1示例" aria-hidden="true">#</a> 4.1示例</h4><p>修改之前已知条件：</p><ul><li><p>让银河系的本地坐标系[O2;i2,j2,k2]绕 j2 轴逆时针旋转 20°。</p><p>设：c2 = cos(-20°)，s2 = sin(-20°)</p><p>则：</p><ul><li>O2(1, 2, 3)</li><li>i2(c2, 0, -s2)</li><li>j2(0, 1, 0)</li><li>k2(s2, 0, c2)</li></ul></li><li><p>让太阳系的本地坐标系[O3;i3,j3,k3]绕 k3 轴逆时针旋转 30°</p><p>设：c3 = cos(30°)，s3 = sin(30°)</p><p>则：</p><ul><li>O3(4, 5, 6)</li><li>i3(c3, -s3, 0)</li><li>j3(s3, c3, 0)</li><li>k3(0, 0, 1)</li></ul></li></ul><p>求：地球的世界坐标位 P1</p><p><code>解</code>：</p><p>由银河系的本地坐标系可得矩阵 m2：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	c2, 0, s2, 0,
    0,  1, 0,  0,
    -s2,0, c2, 0,
    1,  2, 3,  1
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>由太阳系的本地坐标系可得矩阵 m3：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	c3,  s3, 0, 0,
    -s3, c3, 0, 0,
    0,   0,  1, 0,
    4,   5,  6, 1
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>求地球的世界坐标位 P1：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">P1</span> <span class="token operator">=</span> m1 <span class="token operator">*</span> m2 <span class="token operator">*</span> m3 <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>
m1 <span class="token operator">*</span> m2 <span class="token operator">*</span> m3 <span class="token operator">=</span> <span class="token punctuation">[</span>
    c2<span class="token operator">*</span>c3<span class="token punctuation">,</span>      s3<span class="token punctuation">,</span>   s2<span class="token operator">*</span>c3<span class="token punctuation">,</span>      <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token operator">-</span>c2<span class="token operator">*</span>s3<span class="token punctuation">,</span>     c3<span class="token punctuation">,</span>   <span class="token operator">-</span>s2<span class="token operator">*</span>s3<span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token operator">-</span>s2<span class="token punctuation">,</span>        <span class="token number">0</span><span class="token punctuation">,</span>    c2<span class="token punctuation">,</span>         <span class="token number">0</span><span class="token punctuation">,</span>
    c2<span class="token operator">*</span><span class="token number">4</span><span class="token operator">-</span>s2<span class="token operator">*</span><span class="token number">6</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span>s2<span class="token operator">*</span><span class="token number">4</span><span class="token operator">+</span>c2<span class="token operator">*</span><span class="token number">6</span><span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span>
<span class="token punctuation">]</span>
<span class="token constant">P1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">11.826885919330648</span><span class="token punctuation">,</span> <span class="token number">17.428203230275507</span><span class="token punctuation">,</span> <span class="token number">15.02200238270646</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>注意，上式很难像之前那样心算，可以直接用计算机算：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//让银河系的本地坐标系[O2;i2,j2,k2]绕j2轴逆时针旋转20°</span>
<span class="token keyword">const</span> ang2 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">20</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">180</span>
<span class="token keyword">const</span> c2 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>ang2<span class="token punctuation">)</span>
<span class="token keyword">const</span> s2 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>ang2<span class="token punctuation">)</span>

<span class="token comment">//让太阳系的本地坐标系[O3;i3,j3,k3]绕k3轴逆时针旋转30°</span>
<span class="token keyword">const</span> ang3 <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">180</span>
<span class="token keyword">const</span> c3 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>ang3<span class="token punctuation">)</span>
<span class="token keyword">const</span> s3 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>ang3<span class="token punctuation">)</span>

<span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
m<span class="token punctuation">.</span>elements <span class="token operator">=</span> <span class="token punctuation">[</span>
    c2 <span class="token operator">*</span> c3<span class="token punctuation">,</span> s3<span class="token punctuation">,</span> s2 <span class="token operator">*</span> c3<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token operator">-</span>c2 <span class="token operator">*</span> s3<span class="token punctuation">,</span> c3<span class="token punctuation">,</span> <span class="token operator">-</span>s2 <span class="token operator">*</span> s3<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token operator">-</span>s2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    c2 <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">-</span> s2 <span class="token operator">*</span> <span class="token number">6</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> s2 <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> c2 <span class="token operator">*</span> <span class="token number">6</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">]</span>
<span class="token keyword">const</span> <span class="token constant">P1</span> <span class="token operator">=</span> <span class="token constant">P3</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">P1</span><span class="token punctuation">)</span>
<span class="token comment">// {x: 11.826885919330648, y: 17.428203230275507, z: 15.02200238270646}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="_4-2用-three-js-验证" tabindex="-1"><a class="header-anchor" href="#_4-2用-three-js-验证" aria-hidden="true">#</a> 4.2用 three.js 验证</h4><details class="custom-container details"><summary>代码实现</summary><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Group<span class="token punctuation">,</span>
  Matrix4<span class="token punctuation">,</span>
  Object3D<span class="token punctuation">,</span>
  Scene<span class="token punctuation">,</span>
  Vector3<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;https://unpkg.com/three/build/three.module.js&quot;</span><span class="token punctuation">;</span>

<span class="token comment">//世界坐标系-宇宙</span>
<span class="token keyword">const</span> m1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
m1<span class="token punctuation">.</span>elements <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">//本地坐标系-银河系</span>
<span class="token keyword">const</span> ang2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">20</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> m2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
m2<span class="token punctuation">.</span><span class="token function">makeRotationY</span><span class="token punctuation">(</span>ang2<span class="token punctuation">)</span><span class="token punctuation">;</span>
m2<span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m2<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//本地坐标系-太阳系</span>
<span class="token keyword">const</span> ang3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">30</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> m3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
m3<span class="token punctuation">.</span><span class="token function">makeRotationZ</span><span class="token punctuation">(</span>ang3<span class="token punctuation">)</span><span class="token punctuation">;</span>
m3<span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//地球在太阳系内的本地坐标位</span>
<span class="token keyword">const</span> <span class="token constant">P3</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//创造宇宙</span>
<span class="token keyword">const</span> universe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
universe<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m1<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//创造银河系</span>
<span class="token keyword">const</span> galaxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
galaxy<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//创造太阳系</span>
<span class="token keyword">const</span> solar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
solar<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m3<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//创造地球</span>
<span class="token keyword">const</span> earth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object3D</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
earth<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token constant">P3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//太阳系包含地球</span>
solar<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>earth<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//银河系包含太阳</span>
galaxy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>solar<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//宇宙包含银河系</span>
universe<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>galaxy<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//求太阳在宇宙中的世界位</span>
<span class="token keyword">const</span> <span class="token constant">P1</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
earth<span class="token punctuation">.</span><span class="token function">getWorldPosition</span><span class="token punctuation">(</span><span class="token constant">P1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">P1</span><span class="token punctuation">)</span>
<span class="token comment">// {x: 11.826885919330648, y: 17.428203230275507, z: 15.02200238270646}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div></details><h2 id="十、旋转法则深度探索" tabindex="-1"><a class="header-anchor" href="#十、旋转法则深度探索" aria-hidden="true">#</a> 十、旋转法则深度探索</h2><p>物体旋转的复杂程度是位移和缩放的 n 多倍。<br> 以前在旋转物体时，只是让其绕坐标轴 x|y|z 旋转。<br> 然而，在实际项目开发中，会有其它的旋转需求。</p><p>比如：</p><ul><li><p>欧拉 Euler：让物体基于世界坐标系绕 x 轴旋转 a°，然后绕本地坐标系 y 轴旋转 b°，最后绕本地坐标系 z 轴旋转 c°。</p></li><li><p>四元数 Quaternion：让物体绕任意一轴旋转 a°。</p></li></ul><h3 id="_1-顶点绕单轴逆时针旋转" tabindex="-1"><a class="header-anchor" href="#_1-顶点绕单轴逆时针旋转" aria-hidden="true">#</a> 1.顶点绕单轴逆时针旋转</h3><p><img src="/visual/webgl-share/92.png" alt=""></p><p>在右手坐标系的逆时针旋转里，绕 y 轴的逆时针旋转有点特别。</p><p>绕 y 轴旋转时，x 轴正半轴是起始轴，即 x 轴正半轴的弧度为 0。<br> 一顶点绕 y 轴逆时针旋转时，旋转量越大，弧度值越小。</p><p>而绕其它两个轴旋转时，则与其相反：<br> 一顶点绕 x 轴或 z 轴逆时针旋转时，旋转量越大，弧度值越大。</p><p>所以银河系的本地坐标系 [O2;i2,j2,k2] 绕 j2 轴逆时针旋转 20° 时，是通过-20° 取的 sin 值和 cos 值。</p><details class="custom-container details"><summary>three.js验证</summary><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> ang <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">180</span>
<span class="token comment">//three.js四维矩阵对象</span>
<span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">//绕x轴逆时针旋转30°</span>
<span class="token punctuation">{</span>
    <span class="token comment">//three.js 旋转</span>
    m<span class="token punctuation">.</span><span class="token function">makeRotationX</span><span class="token punctuation">(</span>ang<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>m<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//手动旋转</span>
    <span class="token keyword">const</span> c <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>ang<span class="token punctuation">)</span>
    <span class="token keyword">const</span> s <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>ang<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>s<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//绕y轴逆时针旋转30°</span>
<span class="token punctuation">{</span>
    <span class="token comment">//three.js 旋转</span>
    m<span class="token punctuation">.</span><span class="token function">makeRotationY</span><span class="token punctuation">(</span>ang<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>m<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//手动旋转</span>
    <span class="token keyword">const</span> c <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span><span class="token operator">-</span>ang<span class="token punctuation">)</span>
    <span class="token keyword">const</span> s <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span><span class="token operator">-</span>ang<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token operator">-</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//绕z轴逆时针旋转30°</span>
<span class="token punctuation">{</span>
    <span class="token comment">//three.js 旋转</span>
    m<span class="token punctuation">.</span><span class="token function">makeRotationZ</span><span class="token punctuation">(</span>ang<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>m<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//手动旋转</span>
    <span class="token keyword">const</span> c <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>ang<span class="token punctuation">)</span>
    <span class="token keyword">const</span> s <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>ang<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        c<span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token operator">-</span>s<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div></details><h3 id="_2-欧拉旋转" tabindex="-1"><a class="header-anchor" href="#_2-欧拉旋转" aria-hidden="true">#</a> 2.欧拉旋转</h3><p>欧拉旋转就是绕单轴多次逆时针旋转，第一次是绕世界坐标系的单轴逆时针旋转，之后则是绕本地坐标系的单轴逆时针旋转。</p><h4 id="_2-1示例-1" tabindex="-1"><a class="header-anchor" href="#_2-1示例-1" aria-hidden="true">#</a> 2.1示例</h4><p><code>已知</code>：</p><p>世界坐标系 m1<br> 点 P 在世界坐标系内<br> 点 P 的世界坐标位 P1(x, y, z)</p><p><code>求</code>：</p><p>点 P 绕世界坐标系的 x 轴逆时针旋转 angX 度，<br> 绕本地坐标系的 y 轴逆时针旋转 angY 度，<br> 绕本地坐标系的 z 轴逆时针旋转 angZ 度后的世界位 P2。</p><p><code>解</code>：</p><p>分别基于 angX, angY, angZ 建立三个矩阵 mx,my,mz<br> 点 P 的世界位是：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">P2</span> <span class="token operator">=</span> mx <span class="token operator">*</span> my <span class="token operator">*</span> mz <span class="token operator">*</span> <span class="token constant">P1</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h4 id="_2-3用-three-js-验证" tabindex="-1"><a class="header-anchor" href="#_2-3用-three-js-验证" aria-hidden="true">#</a> 2.3用 three.js 验证</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Group<span class="token punctuation">,</span>
  Matrix4<span class="token punctuation">,</span>
  Object3D<span class="token punctuation">,</span>
  Scene<span class="token punctuation">,</span>
  Vector3<span class="token punctuation">,</span>
  Euler<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;https://unpkg.com/three/build/three.module.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">[</span>angX<span class="token punctuation">,</span> angY<span class="token punctuation">,</span> angZ<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">P1</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//用矩阵乘法实现顶点绕单轴多次逆时针旋转</span>
<span class="token punctuation">{</span>
  <span class="token keyword">const</span> mx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeRotationX</span><span class="token punctuation">(</span>angX<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> my <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeRotationY</span><span class="token punctuation">(</span>angY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> mz <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeRotationZ</span><span class="token punctuation">(</span>angZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//P2=mx*my*mz*P1</span>
  <span class="token keyword">const</span> <span class="token constant">P2</span> <span class="token operator">=</span> <span class="token constant">P1</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">P2</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>mx<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>my<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>mz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">P2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//用欧拉实现顶点绕单轴多次逆时针旋转</span>
<span class="token punctuation">{</span>
  <span class="token keyword">const</span> euler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Euler</span><span class="token punctuation">(</span>angX<span class="token punctuation">,</span> angY<span class="token punctuation">,</span> angZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  m<span class="token punctuation">.</span><span class="token function">makeRotationFromEuler</span><span class="token punctuation">(</span>euler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token constant">P2</span> <span class="token operator">=</span> <span class="token constant">P1</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">P2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>上面 P2 的两个输出结果都是一样的。</p><h4 id="_2-4讲个故事理解欧拉" tabindex="-1"><a class="header-anchor" href="#_2-4讲个故事理解欧拉" aria-hidden="true">#</a> 2.4讲个故事理解欧拉</h4><p>通过之前的代码，可以发现欧拉旋转和之前说过的世界坐标系、本地坐标系的呼应规律。</p><p>可以即此编一个关于王者荣耀故事：</p><ul><li>宇宙，宇宙的本地坐标系是万物的世界坐标系，此坐标系为单位矩阵</li><li>mx：银河系的本地坐标系</li><li>my：太阳系的本地坐标系</li><li>mz：凡间界的本地坐标系</li><li>P1：瑶在欧拉旋转前的世界位</li><li>宇宙 ∋ 银河系 ∋ 太阳系 ∋ 凡间界 ∋ 瑶</li></ul><p>求：瑶欧拉旋转(angX,angY,angZ) 后的世界位 P2，旋转顺序为 xyz</p><p><code>解</code>：</p><ol><li><p>让瑶坠落凡间界。</p><p>当前宇宙万界的本地坐标系都是单位矩阵，所以瑶的世界坐标位 P1，也是瑶在万界中的本地坐标位。</p><p>下面的 P1 也就可以理解为瑶在凡间界的本地坐标位。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>const P1 = new Vector3(1, 1, 1)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></li><li><p>将银河系、太阳系、凡间界分别沿 x 轴、y 轴、z 轴旋转 angX、angY、angZ 度。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>const mx = new Matrix4().makeRotationX(angX)
const my = new Matrix4().makeRotationY(angY)
const mz = new Matrix4().makeRotationZ(angZ)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li><li><p>让瑶跳出三界之外，求其世界位</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//P2=mx*my*mz*P1</span>
<span class="token keyword">const</span> <span class="token constant">P2</span> <span class="token operator">=</span> <span class="token constant">P1</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">P2</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>mx<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>my<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>mz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ol><h3 id="_3-四元数" tabindex="-1"><a class="header-anchor" href="#_3-四元数" aria-hidden="true">#</a> 3.四元数</h3><p>四元数 Quaternion：让物体绕任意轴旋转 a°。</p><p><img src="/visual/webgl-share/93.png" alt=""></p><p><code>已知</code>：</p><ul><li>轴 OC2</li><li>弧度 ang</li><li>点 P1(x,y,z)</li></ul><div class="language-j ext-j line-numbers-mode"><pre class="language-j"><code>const OC2 <span class="token verb keyword">=</span> new Vector3<span class="token punctuation">(</span><span class="token number">3</span><span class="token verb keyword">,</span> <span class="token number">2</span><span class="token verb keyword">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token conjunction variable">.</span>normalize<span class="token punctuation">(</span><span class="token punctuation">)</span>
const ang <span class="token verb keyword">=</span> <span class="token number">2</span>
const P1 <span class="token verb keyword">=</span> new Vector3<span class="token punctuation">(</span><span class="token number">1</span><span class="token verb keyword">,</span> <span class="token number">2</span><span class="token verb keyword">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>求</code>：点 P1 绕 OC2 逆时针旋转 ang 度后的位置 P2</p><p><code>解</code>：</p><p><code>接下来要把 OC2 转得与 z 轴同向</code>。</p><ol><li>计算绕 x 轴把 OC2 旋转到平面 Ozx 上的旋转矩阵 mx1。</li></ol><p>旋转的度数是 OC2 在平面 Oyz 上的正射影 OB2 与 z 轴的夹角，即 ∠B2OB1。</p><p><img src="/visual/webgl-share/94.png" alt=""></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token constant">B2OB1</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">atan2</span><span class="token punctuation">(</span><span class="token constant">OC2</span><span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token constant">OC2</span><span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mx1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeRotationX</span><span class="token punctuation">(</span><span class="token constant">B2OB1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li>顺便再求出绕 x 轴反向旋转 ∠B2OB1 的矩阵 mx2，以备后用。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mx2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeRotationX</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token constant">B2OB1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol start="3"><li>基于矩阵 mx1 旋转 OC2，旋转到 OC3 的位置。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//OC3 = m1*OC2</span>
<span class="token keyword">const</span> <span class="token constant">OC3</span> <span class="token operator">=</span> <span class="token constant">OC2</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">OC3</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>mx1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="4"><li>计算绕 y 轴把 OC3 旋转到 z 轴上的旋转矩阵 my1。</li></ol><p>旋转的度数是 OC3 与 z 轴的夹角，即 ∠C3OB1。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token constant">C3OB1</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">atan2</span><span class="token punctuation">(</span><span class="token constant">OC3</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token constant">OC3</span><span class="token punctuation">.</span>z<span class="token punctuation">)</span>
<span class="token keyword">const</span> my1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeRotationY</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token constant">C3OB1</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>​ 至于旋转后 OC3 在哪里，就不重要了，只要知道了其旋转了多少度，以及其最后会和 z 轴同向就够了。</p><ol start="5"><li>顺便再求出绕 y 轴反向旋转 ∠C3OB1 的矩阵 my2，以备后用。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> my2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeRotationY</span><span class="token punctuation">(</span><span class="token constant">C3OB1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol start="6"><li>在 OC2 转到 z 轴上的时候，也让点 P1 做等量的旋转，得 P2 点</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//P2 =my1*mx1*P1</span>
<span class="token keyword">const</span> <span class="token constant">P2</span> <span class="token operator">=</span> <span class="token constant">P1</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">P2</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>mx1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">P2</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>my1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="7"><li>计算绕 z 轴旋转 ang 度的矩阵 mz</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mz <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeRotationZ</span><span class="token punctuation">(</span>ang<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol start="8"><li>让点 P2 绕 z 轴旋转 ang 度</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">P2</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>mz<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol start="9"><li>让点 P2 按照之前 OC2 的旋转量再逆向转回去。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">P2</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>my2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">P2</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>mx2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>也可以把所有的矩阵合一下，再乘以 P2</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token constant">P2</span> <span class="token operator">=</span> <span class="token constant">P1</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> m <span class="token operator">=</span> mx2<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>my2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>mz<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>my1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>mx1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">P2</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="10"><li>验证</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> quaternion <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Quaternion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
quaternion<span class="token punctuation">.</span><span class="token function">setFromAxisAngle</span><span class="token punctuation">(</span><span class="token constant">OC2</span><span class="token punctuation">,</span> ang<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
m<span class="token punctuation">.</span><span class="token function">makeRotationFromQuaternion</span><span class="token punctuation">(</span>quaternion<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">P1</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>四元数旋转的<code>实现原理</code>：</p><ol><li>将旋转轴带着顶点一起旋转，让旋转轴与 xyz 中的某一个轴同向，比如 z 轴。</li><li>让顶点绕 z 轴旋转相应的度数。</li><li>让顶点按照之前旋转轴的旋转量逆向转回去。</li></ol><h2 id="十一、正交投影矩阵" tabindex="-1"><a class="header-anchor" href="#十一、正交投影矩阵" aria-hidden="true">#</a> 十一、正交投影矩阵</h2><p>WebGL 是一个光栅引擎，其本身并不会实现三维效果，那要在其中实现三维效果的关键就在于算法：<br><strong><code>顶点在裁剪空间中的位置 = 投影矩阵 * 视图矩阵 * 模型矩阵 * 顶点的初始点位</code></strong></p><p>正交投影矩阵是投影矩阵的一种，先从它说起。在说正交投影矩阵之前，还需要对裁剪空间有一个清晰的认知。</p><h3 id="_1-裁剪空间" tabindex="-1"><a class="header-anchor" href="#_1-裁剪空间" aria-hidden="true">#</a> 1.裁剪空间</h3><p>裁剪空间（左手坐标系）是用于显示 webgl 图形的空间，此空间是一个宽、高、深皆为 2 的盒子。其坐标系的原点在 canvas 画布的中心，如下图：</p><p><img src="/visual/webgl-share/95.png" alt=""></p><p>裁剪空间中：</p><ul><li>x 轴上-1 的位置对应 canvas 画布的左边界，1 的位置对应 canvas 画布的右边界</li><li>y 轴上-1 的位置对应 canvas 画布的下边界，1 的位置对应 canvas 画布的上边界</li><li>y 轴上-1 的位置朝向屏幕外部，1 的位置朝向屏幕内部，如下图：</li></ul><p><img src="/visual/webgl-share/96.png" alt=""></p><h3 id="_2-正交投影矩阵的实现原理" tabindex="-1"><a class="header-anchor" href="#_2-正交投影矩阵的实现原理" aria-hidden="true">#</a> 2.正交投影矩阵的实现原理</h3><p><img src="/visual/webgl-share/97.png" alt=""></p><p>正交投影矩阵 orthographic projection：将世界坐标系中的一块矩形区域(正交相机的可视区域)投射到裁剪空间中，不同深度的物体不具备近大远小的透视规则。</p><p><img src="/visual/webgl-share/98.png" alt=""></p><p><code>问</code>：要将一个任意尺寸的长方体塞进裁剪空间里，分几步？</p><p><code>答</code>：先位移，再缩放</p><p><img src="/visual/webgl-share/99.png" alt=""></p><p>设：正交相机可视区域的上、下、左、右、前、后的边界分别是 t、b、l、r、n、f</p><p>1.位移矩阵</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	1, 0, 0, -(r+l)/2,
	0, 1, 0, -(t+b)/2,
	0, 0, 1, -(f+n)/2,
	0, 0, 0, 1,
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>2.缩放矩阵</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	2/(r-l), 0,       0,        0,
	0,       2/(t-b), 0,        0,
	0,       0,       2/(f-n), 0,
	0,       0,       0,        1,
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>正交投影矩阵 = 缩放矩阵*位移矩阵</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	2/(r-l), 0,       0,        -(r+l)/(r-l),
	0,       2/(t-b), 0,        -(t+b)/(t-b),
	0,       0,       2/(f-n),  -(f+n)/(f-n),
	0,       0,       0,        1,
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>若 n、f 是一个距离量，而不是在 z 轴上的刻度值，正交投影矩阵在 z 轴上的缩放因子需要取反：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
	2/(r-l), 0,       0,         -(r+l)/(r-l),
	0,       2/(t-b), 0,         -(t+b)/(t-b),
	0,       0,       -2/(f-n),  -(f+n)/(f-n),
	0,       0,       0,         1,
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_3-正交投影矩阵的代码实现" tabindex="-1"><a class="header-anchor" href="#_3-正交投影矩阵的代码实现" aria-hidden="true">#</a> 3.正交投影矩阵的代码实现</h3><p>正交投影矩阵的代码实现很简单，可以直接从 three.js 的 Matrix4 对象的 makeOrthographic() 方法中找到：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">makeOrthographic</span><span class="token punctuation">(</span> <span class="token parameter">left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">const</span> te <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>elements<span class="token punctuation">;</span>
    <span class="token keyword">const</span> w <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span> right <span class="token operator">-</span> left <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> h <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span> top <span class="token operator">-</span> bottom <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span> far <span class="token operator">-</span> near <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token punctuation">(</span> right <span class="token operator">+</span> left <span class="token punctuation">)</span> <span class="token operator">*</span> w<span class="token punctuation">;</span>
    <span class="token keyword">const</span> y <span class="token operator">=</span> <span class="token punctuation">(</span> top <span class="token operator">+</span> bottom <span class="token punctuation">)</span> <span class="token operator">*</span> h<span class="token punctuation">;</span>
    <span class="token keyword">const</span> z <span class="token operator">=</span> <span class="token punctuation">(</span> far <span class="token operator">+</span> near <span class="token punctuation">)</span> <span class="token operator">*</span> p<span class="token punctuation">;</span>

    te<span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> w<span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">4</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">8</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">12</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span> x<span class="token punctuation">;</span>
    te<span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">5</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> h<span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">9</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">13</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span> y<span class="token punctuation">;</span>
    te<span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">6</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">10</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> p<span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">14</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span> z<span class="token punctuation">;</span>
    te<span class="token punctuation">[</span> <span class="token number">3</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">7</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">11</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">15</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>以前在绘制 webgl 图形的时候，它们会随 canvas 画布的大小发生拉伸，对于这个问题，便可以用投影矩阵来解决。</p><h3 id="_4-正交投影矩阵解决-webgl-图形拉伸问题" tabindex="-1"><a class="header-anchor" href="#_4-正交投影矩阵解决-webgl-图形拉伸问题" aria-hidden="true">#</a> 4.正交投影矩阵解决 webgl 图形拉伸问题</h3><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    attribute vec4 a_Position<span class="token punctuation">;</span>
    uniform mat4 u_ProjectionMatrix<span class="token punctuation">;</span> <span class="token comment">// 正交投影矩阵</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> u_ProjectionMatrix <span class="token operator">*</span> a_Position<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 片元着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    precision mediump float<span class="token punctuation">;</span>
    uniform vec4 u_Color<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor <span class="token operator">=</span> u_Color<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../jsm/Utils.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> 
    Matrix4<span class="token punctuation">,</span> 
    OrthographicCamera 
  <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> Poly <span class="token keyword">from</span> <span class="token string">&#39;./jsm/Poly.js&#39;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>viewW<span class="token punctuation">,</span> viewH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">,</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">]</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> viewW<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> viewH<span class="token punctuation">;</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vertexShader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fragmentShader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//正交投影矩阵</span>
  <span class="token keyword">const</span> projectionMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">//定义相机世界高度尺寸的一半</span>
  <span class="token keyword">const</span> halfH <span class="token operator">=</span> <span class="token number">2</span>
  <span class="token comment">//计算画布的宽高比</span>
  <span class="token keyword">const</span> ratio <span class="token operator">=</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height
  <span class="token comment">//基于halfH和画布宽高比计算相机世界宽度尺寸的一半</span>
  <span class="token keyword">const</span> halfW <span class="token operator">=</span> halfH <span class="token operator">*</span> ratio
  <span class="token comment">//定义相机世界的6个边界</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token operator">-</span>halfW<span class="token punctuation">,</span> halfW<span class="token punctuation">,</span> halfH<span class="token punctuation">,</span> <span class="token operator">-</span>halfH<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span>
  <span class="token punctuation">]</span>
  <span class="token comment">//获取正交投影矩阵</span>
  projectionMatrix<span class="token punctuation">.</span><span class="token function">makeOrthographic</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span>

  <span class="token keyword">const</span> triangle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    gl<span class="token punctuation">,</span>
    <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span>
      <span class="token operator">-</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span>
      <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;TRIANGLES&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token number">0</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">uniforms</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">u_Color</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform4fv&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_ProjectionMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> projectionMatrix<span class="token punctuation">.</span>elements
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    triangle<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div></details><p>利用投影矩阵将现实世界投射到裁剪空间中后，往往还会对裁剪空间中视图进行位移或旋转，这时候就需要视图矩阵了。</p><h2 id="十二、视图矩阵" tabindex="-1"><a class="header-anchor" href="#十二、视图矩阵" aria-hidden="true">#</a> 十二、视图矩阵</h2><p>之前在说视图变换的时候说过视图矩阵，这里就通过 three.js 里的正交相机对象，更加形象的认识一下视图矩阵。</p><h3 id="_1-视图位移" tabindex="-1"><a class="header-anchor" href="#_1-视图位移" aria-hidden="true">#</a> 1.视图位移</h3><p>1.基于之前的代码，再绘制一个三角形</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> triangle1 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span>
        <span class="token operator">-</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span>
        <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> triangle2 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
        <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
        <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span>

<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    triangle1<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle1<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    triangle2<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle2<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span><span class="token parameter">color<span class="token punctuation">,</span> source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        gl<span class="token punctuation">,</span>
        <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;TRIANGLES&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token number">0</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">uniforms</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">u_Color</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform4fv&#39;</span><span class="token punctuation">,</span>
                <span class="token literal-property property">value</span><span class="token operator">:</span> color
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">u_ProjectionMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
              <span class="token literal-property property">value</span><span class="token operator">:</span> projectionMatrix<span class="token punctuation">.</span>elements
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>这是一前一后两个三角形。<br> 前面的是黄色三角形，深度为 0.2；<br> 后面的是红色三角形，深度为-0.2，被前面的三角形挡住了，所以看不见。</p><p>效果如下：<br><img src="/visual/webgl-share/100.png" alt=""></p><p>2.从 three.js 里引入正交相机对象 OrthographicCamera</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Matrix4<span class="token punctuation">,</span>
  Vector3<span class="token punctuation">,</span>
  OrthographicCamera<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;https://unpkg.com/three/build/three.module.js&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>3.建立正交相机对象</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrthographicCamera</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>4.设置相机位置 position</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span><span class="token function">updateWorldMatrix</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>设置完相机位置后，要使用 updateWorldMatrix() 方法更新相机的世界坐标系。<br> updateWorldMatrix() 方法主要是考虑到了相机存在父级的情况。<br> updateWorldMatrix() 方法会把更新后的世界坐标系写进写进相机的 matrixWorld 属性里。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>matrixWorld<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>5.将相机的投影矩阵和相机的世界坐标系的逆矩阵合一下，合一个投影视图矩阵。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> pvMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span> camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>a.multiplyMatrices(b,c) 相当于：</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>a <span class="token operator">=</span> b <span class="token operator">*</span> c<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ul><li>camera.projectionMatrix 可以直接获取相机的投影矩阵</li><li>matrixWorldInverse 是 matrixWorld 的逆矩阵，这是因为相机的移动方向和现实中的物体相反。</li></ul><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>console.log(camera.matrixWorldInverse);
 <span class="token number">1</span>   <span class="token number">0</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">0</span>   <span class="token number">1</span>  <span class="token number">0</span>  <span class="token number">0</span>
 <span class="token number">0</span>   <span class="token number">0</span>  <span class="token number">1</span>  <span class="token number">0</span>
<span class="token number">-1</span>  <span class="token number">-1</span> <span class="token number">-3</span>  <span class="token number">1</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>7.把之前的 projectionMatrix 改成 pvMatrix</p><ul><li>顶点着色器</li></ul><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_PvMatrix <span class="token operator">*</span> a_Position<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>js 代码</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span><span class="token parameter">color<span class="token punctuation">,</span> source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    gl<span class="token punctuation">,</span>
    <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;TRIANGLES&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">uniforms</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">u_Color</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniform4fv&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> color<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniformMatrix4fv&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> pvMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="扩展-matrixworld-详解" tabindex="-1"><a class="header-anchor" href="#扩展-matrixworld-详解" aria-hidden="true">#</a> 扩展-matrixWorld 详解</h3><p><code>已知</code>：</p><ul><li><p>宇宙 universe</p><ul><li>本地坐标系是 m1</li><li>m1 也是宇宙万界的世界坐标系</li></ul></li><li><p>银河系 galaxy</p><ul><li>本地坐标系是 m2</li></ul></li><li><p>太阳系 solar</p><ul><li>本地坐标系是 m3</li></ul></li><li><p>太阳系 ∈ 银河系 ∈ 宇宙</p></li></ul><p>求：太阳系的世界坐标系 matrixWorld</p><p><code>解</code>：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>matrixWorld <span class="token operator">=</span> m1 <span class="token operator">*</span> m2 <span class="token operator">*</span> m3<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>答案就这么简单，拿代码测一下：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//宇宙(世界坐标系是宇宙的本地坐标系)</span>
<span class="token keyword">const</span> universe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
universe<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m1<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//银河系</span>
<span class="token keyword">const</span> galaxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
galaxy<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//太阳系</span>
<span class="token keyword">const</span> solar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
solar<span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>m3<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//地球</span>
<span class="token keyword">const</span> earth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object3D</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
earth<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token constant">P3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//包含关系</span>
solar<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>earth<span class="token punctuation">)</span><span class="token punctuation">;</span>
galaxy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>solar<span class="token punctuation">)</span><span class="token punctuation">;</span>
universe<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>galaxy<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 更新太阳系的世界坐标系</span>
solar<span class="token punctuation">.</span><span class="token function">updateWorldMatrix</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//太阳系的世界坐标系</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>solar<span class="token punctuation">.</span>matrixWorld<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//手动计算太阳系的世界坐标系</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>m1<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>m2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>m3<span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="扩展-逆矩阵" tabindex="-1"><a class="header-anchor" href="#扩展-逆矩阵" aria-hidden="true">#</a> 扩展-逆矩阵</h3><p>之前在说 matrixWorldInverse 的时候说过，它是 matrixWorld 的逆矩阵。<br> 逆矩阵在图形项目的应用很广，所以接下来就系统说一下逆矩阵的概念。</p><h4 id="_1-逆矩阵的概念" tabindex="-1"><a class="header-anchor" href="#_1-逆矩阵的概念" aria-hidden="true">#</a> 1.逆矩阵的概念</h4><p>逆矩阵就好比学习除法的时候，一个实数的倒数。</p><p><code>如</code>：</p><p>2 的倒数是 1/2。<br> 那么，矩阵 m 的倒数就是 1/m。<br> 只不过，1/m 不叫做矩阵 m 的倒数，而是叫做矩阵 m 的逆矩阵。<br> 由上，可以推导出的一些特性。</p><p><code>已知</code>：</p><ul><li>矩阵 m</li><li>矩阵 n</li></ul><p><code>可得</code>：</p><p>1.矩阵与其逆矩阵的相乘结果为单位矩阵</p><p><code>因为</code>：</p><p>2*1/2=1</p><p><code>所以</code>：</p><p>m*1/m=单位矩阵</p><p>2.矩阵 m 除以矩阵 n 就等于矩阵 m 乘以矩阵 n 的逆矩阵</p><p><code>因为</code>：</p><p>3/2=3*1/2</p><p><code>所以</code>：</p><p>m/n=m*1/n</p><h4 id="_2-矩阵转逆矩阵" tabindex="-1"><a class="header-anchor" href="#_2-矩阵转逆矩阵" aria-hidden="true">#</a> 2.矩阵转逆矩阵</h4><ol><li>位移矩阵的逆矩阵是取位移因子的相反数</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> m<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
m<span class="token punctuation">.</span>elements<span class="token operator">=</span><span class="token punctuation">[</span>
  <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">invert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//打印结果</span>
<span class="token punctuation">[</span>
  <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ol start="2"><li>缩放矩阵的逆矩阵是取缩放因子的倒数</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token keyword">const</span> m<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  m<span class="token punctuation">.</span>elements<span class="token operator">=</span><span class="token punctuation">[</span>
    <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">invert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//打印结果</span>
<span class="token punctuation">[</span>
  <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.125</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">]</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>3.旋转矩阵的逆矩阵是基于旋转弧度反向旋转</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token keyword">const</span> ang<span class="token operator">=</span><span class="token number">30</span><span class="token operator">*</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token operator">/</span><span class="token number">180</span>
  <span class="token keyword">const</span> c<span class="token operator">=</span>Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>ang<span class="token punctuation">)</span>
  <span class="token keyword">const</span> s<span class="token operator">=</span>Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>ang<span class="token punctuation">)</span>
  <span class="token keyword">const</span> m<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  m<span class="token punctuation">.</span>elements<span class="token operator">=</span><span class="token punctuation">[</span>
    c<span class="token punctuation">,</span>s<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token operator">-</span>s<span class="token punctuation">,</span>c<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">invert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//打印结果</span>
<span class="token punctuation">[</span>
  <span class="token number">0.866</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.45</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0.45</span><span class="token punctuation">,</span> <span class="token number">0.866</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>关于即旋转又缩放还位移的复合矩阵，也是按照类似的原理转逆矩阵的，只不过过程要更复杂一些。</p><p>three.js 的 Matrix4 对象的 invert() 方法。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">invert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// based on http://www.euclideanspace.com/maths/algebra/matrix/functions/inverse/fourD/index.htm</span>
  <span class="token keyword">const</span> te <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>

        n11 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n21 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n31 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n41 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
        n12 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">4</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n22 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">5</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n32 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">6</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n42 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">7</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
        n13 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">8</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n23 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">9</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n33 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">10</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n43 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">11</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
        n14 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">12</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n24 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">13</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n34 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">14</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> n44 <span class="token operator">=</span> te<span class="token punctuation">[</span> <span class="token number">15</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>

        t11 <span class="token operator">=</span> n23 <span class="token operator">*</span> n34 <span class="token operator">*</span> n42 <span class="token operator">-</span> n24 <span class="token operator">*</span> n33 <span class="token operator">*</span> n42 <span class="token operator">+</span> n24 <span class="token operator">*</span> n32 <span class="token operator">*</span> n43 <span class="token operator">-</span> n22 <span class="token operator">*</span> n34 <span class="token operator">*</span> n43 <span class="token operator">-</span> n23 <span class="token operator">*</span> n32 <span class="token operator">*</span> n44 <span class="token operator">+</span> n22 <span class="token operator">*</span> n33 <span class="token operator">*</span> n44<span class="token punctuation">,</span>
        t12 <span class="token operator">=</span> n14 <span class="token operator">*</span> n33 <span class="token operator">*</span> n42 <span class="token operator">-</span> n13 <span class="token operator">*</span> n34 <span class="token operator">*</span> n42 <span class="token operator">-</span> n14 <span class="token operator">*</span> n32 <span class="token operator">*</span> n43 <span class="token operator">+</span> n12 <span class="token operator">*</span> n34 <span class="token operator">*</span> n43 <span class="token operator">+</span> n13 <span class="token operator">*</span> n32 <span class="token operator">*</span> n44 <span class="token operator">-</span> n12 <span class="token operator">*</span> n33 <span class="token operator">*</span> n44<span class="token punctuation">,</span>
        t13 <span class="token operator">=</span> n13 <span class="token operator">*</span> n24 <span class="token operator">*</span> n42 <span class="token operator">-</span> n14 <span class="token operator">*</span> n23 <span class="token operator">*</span> n42 <span class="token operator">+</span> n14 <span class="token operator">*</span> n22 <span class="token operator">*</span> n43 <span class="token operator">-</span> n12 <span class="token operator">*</span> n24 <span class="token operator">*</span> n43 <span class="token operator">-</span> n13 <span class="token operator">*</span> n22 <span class="token operator">*</span> n44 <span class="token operator">+</span> n12 <span class="token operator">*</span> n23 <span class="token operator">*</span> n44<span class="token punctuation">,</span>
        t14 <span class="token operator">=</span> n14 <span class="token operator">*</span> n23 <span class="token operator">*</span> n32 <span class="token operator">-</span> n13 <span class="token operator">*</span> n24 <span class="token operator">*</span> n32 <span class="token operator">-</span> n14 <span class="token operator">*</span> n22 <span class="token operator">*</span> n33 <span class="token operator">+</span> n12 <span class="token operator">*</span> n24 <span class="token operator">*</span> n33 <span class="token operator">+</span> n13 <span class="token operator">*</span> n22 <span class="token operator">*</span> n34 <span class="token operator">-</span> n12 <span class="token operator">*</span> n23 <span class="token operator">*</span> n34<span class="token punctuation">;</span>

  <span class="token keyword">const</span> det <span class="token operator">=</span> n11 <span class="token operator">*</span> t11 <span class="token operator">+</span> n21 <span class="token operator">*</span> t12 <span class="token operator">+</span> n31 <span class="token operator">*</span> t13 <span class="token operator">+</span> n41 <span class="token operator">*</span> t14<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> det <span class="token operator">===</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> detInv <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> det<span class="token punctuation">;</span>

  te<span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> t11 <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n24 <span class="token operator">*</span> n33 <span class="token operator">*</span> n41 <span class="token operator">-</span> n23 <span class="token operator">*</span> n34 <span class="token operator">*</span> n41 <span class="token operator">-</span> n24 <span class="token operator">*</span> n31 <span class="token operator">*</span> n43 <span class="token operator">+</span> n21 <span class="token operator">*</span> n34 <span class="token operator">*</span> n43 <span class="token operator">+</span> n23 <span class="token operator">*</span> n31 <span class="token operator">*</span> n44 <span class="token operator">-</span> n21 <span class="token operator">*</span> n33 <span class="token operator">*</span> n44 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n22 <span class="token operator">*</span> n34 <span class="token operator">*</span> n41 <span class="token operator">-</span> n24 <span class="token operator">*</span> n32 <span class="token operator">*</span> n41 <span class="token operator">+</span> n24 <span class="token operator">*</span> n31 <span class="token operator">*</span> n42 <span class="token operator">-</span> n21 <span class="token operator">*</span> n34 <span class="token operator">*</span> n42 <span class="token operator">-</span> n22 <span class="token operator">*</span> n31 <span class="token operator">*</span> n44 <span class="token operator">+</span> n21 <span class="token operator">*</span> n32 <span class="token operator">*</span> n44 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">3</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n23 <span class="token operator">*</span> n32 <span class="token operator">*</span> n41 <span class="token operator">-</span> n22 <span class="token operator">*</span> n33 <span class="token operator">*</span> n41 <span class="token operator">-</span> n23 <span class="token operator">*</span> n31 <span class="token operator">*</span> n42 <span class="token operator">+</span> n21 <span class="token operator">*</span> n33 <span class="token operator">*</span> n42 <span class="token operator">+</span> n22 <span class="token operator">*</span> n31 <span class="token operator">*</span> n43 <span class="token operator">-</span> n21 <span class="token operator">*</span> n32 <span class="token operator">*</span> n43 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>

  te<span class="token punctuation">[</span> <span class="token number">4</span> <span class="token punctuation">]</span> <span class="token operator">=</span> t12 <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">5</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n13 <span class="token operator">*</span> n34 <span class="token operator">*</span> n41 <span class="token operator">-</span> n14 <span class="token operator">*</span> n33 <span class="token operator">*</span> n41 <span class="token operator">+</span> n14 <span class="token operator">*</span> n31 <span class="token operator">*</span> n43 <span class="token operator">-</span> n11 <span class="token operator">*</span> n34 <span class="token operator">*</span> n43 <span class="token operator">-</span> n13 <span class="token operator">*</span> n31 <span class="token operator">*</span> n44 <span class="token operator">+</span> n11 <span class="token operator">*</span> n33 <span class="token operator">*</span> n44 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">6</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n14 <span class="token operator">*</span> n32 <span class="token operator">*</span> n41 <span class="token operator">-</span> n12 <span class="token operator">*</span> n34 <span class="token operator">*</span> n41 <span class="token operator">-</span> n14 <span class="token operator">*</span> n31 <span class="token operator">*</span> n42 <span class="token operator">+</span> n11 <span class="token operator">*</span> n34 <span class="token operator">*</span> n42 <span class="token operator">+</span> n12 <span class="token operator">*</span> n31 <span class="token operator">*</span> n44 <span class="token operator">-</span> n11 <span class="token operator">*</span> n32 <span class="token operator">*</span> n44 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">7</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n12 <span class="token operator">*</span> n33 <span class="token operator">*</span> n41 <span class="token operator">-</span> n13 <span class="token operator">*</span> n32 <span class="token operator">*</span> n41 <span class="token operator">+</span> n13 <span class="token operator">*</span> n31 <span class="token operator">*</span> n42 <span class="token operator">-</span> n11 <span class="token operator">*</span> n33 <span class="token operator">*</span> n42 <span class="token operator">-</span> n12 <span class="token operator">*</span> n31 <span class="token operator">*</span> n43 <span class="token operator">+</span> n11 <span class="token operator">*</span> n32 <span class="token operator">*</span> n43 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>

  te<span class="token punctuation">[</span> <span class="token number">8</span> <span class="token punctuation">]</span> <span class="token operator">=</span> t13 <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">9</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n14 <span class="token operator">*</span> n23 <span class="token operator">*</span> n41 <span class="token operator">-</span> n13 <span class="token operator">*</span> n24 <span class="token operator">*</span> n41 <span class="token operator">-</span> n14 <span class="token operator">*</span> n21 <span class="token operator">*</span> n43 <span class="token operator">+</span> n11 <span class="token operator">*</span> n24 <span class="token operator">*</span> n43 <span class="token operator">+</span> n13 <span class="token operator">*</span> n21 <span class="token operator">*</span> n44 <span class="token operator">-</span> n11 <span class="token operator">*</span> n23 <span class="token operator">*</span> n44 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">10</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n12 <span class="token operator">*</span> n24 <span class="token operator">*</span> n41 <span class="token operator">-</span> n14 <span class="token operator">*</span> n22 <span class="token operator">*</span> n41 <span class="token operator">+</span> n14 <span class="token operator">*</span> n21 <span class="token operator">*</span> n42 <span class="token operator">-</span> n11 <span class="token operator">*</span> n24 <span class="token operator">*</span> n42 <span class="token operator">-</span> n12 <span class="token operator">*</span> n21 <span class="token operator">*</span> n44 <span class="token operator">+</span> n11 <span class="token operator">*</span> n22 <span class="token operator">*</span> n44 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">11</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n13 <span class="token operator">*</span> n22 <span class="token operator">*</span> n41 <span class="token operator">-</span> n12 <span class="token operator">*</span> n23 <span class="token operator">*</span> n41 <span class="token operator">-</span> n13 <span class="token operator">*</span> n21 <span class="token operator">*</span> n42 <span class="token operator">+</span> n11 <span class="token operator">*</span> n23 <span class="token operator">*</span> n42 <span class="token operator">+</span> n12 <span class="token operator">*</span> n21 <span class="token operator">*</span> n43 <span class="token operator">-</span> n11 <span class="token operator">*</span> n22 <span class="token operator">*</span> n43 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>

  te<span class="token punctuation">[</span> <span class="token number">12</span> <span class="token punctuation">]</span> <span class="token operator">=</span> t14 <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">13</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n13 <span class="token operator">*</span> n24 <span class="token operator">*</span> n31 <span class="token operator">-</span> n14 <span class="token operator">*</span> n23 <span class="token operator">*</span> n31 <span class="token operator">+</span> n14 <span class="token operator">*</span> n21 <span class="token operator">*</span> n33 <span class="token operator">-</span> n11 <span class="token operator">*</span> n24 <span class="token operator">*</span> n33 <span class="token operator">-</span> n13 <span class="token operator">*</span> n21 <span class="token operator">*</span> n34 <span class="token operator">+</span> n11 <span class="token operator">*</span> n23 <span class="token operator">*</span> n34 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">14</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n14 <span class="token operator">*</span> n22 <span class="token operator">*</span> n31 <span class="token operator">-</span> n12 <span class="token operator">*</span> n24 <span class="token operator">*</span> n31 <span class="token operator">-</span> n14 <span class="token operator">*</span> n21 <span class="token operator">*</span> n32 <span class="token operator">+</span> n11 <span class="token operator">*</span> n24 <span class="token operator">*</span> n32 <span class="token operator">+</span> n12 <span class="token operator">*</span> n21 <span class="token operator">*</span> n34 <span class="token operator">-</span> n11 <span class="token operator">*</span> n22 <span class="token operator">*</span> n34 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>
  te<span class="token punctuation">[</span> <span class="token number">15</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> n12 <span class="token operator">*</span> n23 <span class="token operator">*</span> n31 <span class="token operator">-</span> n13 <span class="token operator">*</span> n22 <span class="token operator">*</span> n31 <span class="token operator">+</span> n13 <span class="token operator">*</span> n21 <span class="token operator">*</span> n32 <span class="token operator">-</span> n11 <span class="token operator">*</span> n23 <span class="token operator">*</span> n32 <span class="token operator">-</span> n12 <span class="token operator">*</span> n21 <span class="token operator">*</span> n33 <span class="token operator">+</span> n11 <span class="token operator">*</span> n22 <span class="token operator">*</span> n33 <span class="token punctuation">)</span> <span class="token operator">*</span> detInv<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h3 id="_2-视图旋转" tabindex="-1"><a class="header-anchor" href="#_2-视图旋转" aria-hidden="true">#</a> 2.视图旋转</h3><p>之前实现了视图的移动效果，然而有时候当遇到一个好玩的物体时，需要在不移动相机的前提下看向它。<br> 这个时候，就需要旋转视图了。</p><h4 id="_2-1用-three-js-的-lookat-实现视图旋转" tabindex="-1"><a class="header-anchor" href="#_2-1用-three-js-的-lookat-实现视图旋转" aria-hidden="true">#</a> 2.1用 three.js 的 lookAt()实现视图旋转</h4><p><code>已知</code>：</p><ul><li>正交相机的边界 left, right, top, bottom, near, far</li><li>正交相机的视点位置 eye</li><li>正交相机的目标点 target</li><li>正交相机从 eye 看向 target 时的上方向 up</li></ul><p><code>求</code>：从视点看向目标点时的投影视图矩阵 pvMatrix</p><p><code>解</code>：</p><p>1.声明已知条件</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> halfH <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ratio <span class="token operator">=</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
<span class="token keyword">const</span> halfW <span class="token operator">=</span> halfH <span class="token operator">*</span> ratio<span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token operator">-</span>halfW<span class="token punctuation">,</span>
  halfW<span class="token punctuation">,</span>
  halfH<span class="token punctuation">,</span>
  <span class="token operator">-</span>halfH<span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">4</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>2.建立正交相机</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrthographicCamera</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>3.设置相机的位置</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>4.使用 lookAt()方法，让相机看向目标点，并更新一下相机的世界坐标系。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span><span class="token function">updateWorldMatrix</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>上面的 lookAt() 方法实际上就是在让相机世界进行旋转。<br> 之后，现实世界在裁剪空间中显示的时候，便会基于此旋转量逆向旋转。</p><p>5.通过相机计算投影视图矩阵 pvMatrix</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> pvMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span> camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>效果如下：</p><p><img src="/visual/webgl-share/101.png" alt=""></p><p>接下来，对 lookAt 功能进行一下深度剖析。</p><h4 id="_2-2深度剖析-lookat-功能" tabindex="-1"><a class="header-anchor" href="#_2-2深度剖析-lookat-功能" aria-hidden="true">#</a> 2.2深度剖析 lookAt 功能</h4><p>先不考虑相机存在父级情况。<br> 可以从之前的正交相机里分解出以下矩阵：</p><ul><li>视图矩阵 viewMatrix：相机位移矩阵乘以旋转矩阵后的逆矩阵，即相机的世界矩阵的逆矩阵 <ul><li>位移矩阵 positionMatrix：由视点位置得出</li><li>旋转矩阵 rotationMatrix：由视点、目标点、上方向得出</li></ul></li><li>投影矩阵 projectionMatrix：由正交相机的 6 个边界得出</li><li>投影视图矩阵：投影矩阵乘以视图矩阵</li></ul><p>接下来就基于之前的代码做一下分解：</p><p>1.由视点位置得出位移矩阵 positionMatrix</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> positionMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>2.由视点、目标点、上方向得出旋转矩阵 rotationMatrix</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> rotationMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>eye<span class="token punctuation">,</span> target<span class="token punctuation">,</span> up<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>3.基于位移矩阵和旋转矩阵计算视图矩阵 viewMatrix</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>positionMatrix<span class="token punctuation">,</span> rotationMatrix<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">invert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>4.由正交相机对象提取投影矩阵 projectionMatrix</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrthographicCamera</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> projectionMatrix <span class="token operator">=</span> camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>5.由投影矩阵和视图矩阵的相乘得到投影视图矩阵 pvMatrix</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> pvMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>projectionMatrix<span class="token punctuation">,</span> viewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>6.最后在顶点着色器里让 pvMatrix 乘以顶点点位即可</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>attribute vec4 a_Position<span class="token punctuation">;</span>
uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_PvMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>注：若相机对象存在父级，就需要基于相机的世界坐标系做相应运算了。</p><h2 id="十三、透视投影矩阵" tabindex="-1"><a class="header-anchor" href="#十三、透视投影矩阵" aria-hidden="true">#</a> 十三、透视投影矩阵</h2><p>透视投影矩阵可以将现实世界更真实的投射到裁剪空间中。</p><h3 id="_1-基础知识" tabindex="-1"><a class="header-anchor" href="#_1-基础知识" aria-hidden="true">#</a> 1.基础知识</h3><h4 id="_1-1齐次坐标系" tabindex="-1"><a class="header-anchor" href="#_1-1齐次坐标系" aria-hidden="true">#</a> 1.1齐次坐标系</h4><p>在齐次坐标系中以下等式是成立的：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> k <span class="token operator">=</span> <span class="token punctuation">(</span>kx<span class="token punctuation">,</span> ky<span class="token punctuation">,</span> kz<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token function">k≠0</span>
<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> z <span class="token operator">=</span> <span class="token punctuation">(</span>zx<span class="token punctuation">,</span> zy<span class="token punctuation">,</span> z²<span class="token punctuation">,</span> z<span class="token punctuation">)</span> z≠<span class="token number">0</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>比如：<br> (1, 0, 0, 1) 和 (2, 0, 0, 2) 都代表同一个三维点位(1, 0 ,0)</p><h4 id="_1-2线性补间运算" tabindex="-1"><a class="header-anchor" href="#_1-2线性补间运算" aria-hidden="true">#</a> 1.2线性补间运算</h4><p>之前说过点斜式 y = kx + b，它就是线性补间运算的公式。<br> 除了点斜式，两种数据间的线性映射关系还可以用其它方法来表示。</p><p><img src="/visual/webgl-share/102.png" alt=""></p><p><code>已知</code>：</p><ul><li>N 类型的数据极值是[minN,maxN]</li><li>M 类型的数据极值是[minM,maxM]</li><li>x 属于 N</li><li>将 x 映射到 M 的中的值为 y</li></ul><p>则 x,y 的关系可以用两个等式表示：</p><ol><li>比例式：</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">(</span>x <span class="token operator">-</span> minN<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>maxN <span class="token operator">-</span> minN<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>y <span class="token operator">-</span> minM<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>maxM <span class="token operator">-</span> minM<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol start="2"><li>点斜式</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>k <span class="token operator">=</span> <span class="token punctuation">(</span>maxM <span class="token operator">-</span> minM<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>maxN <span class="token operator">-</span> minN<span class="token punctuation">)</span><span class="token punctuation">;</span>
b <span class="token operator">=</span> minM <span class="token operator">-</span> minN <span class="token operator">*</span> k<span class="token punctuation">;</span>
y <span class="token operator">=</span> kx <span class="token operator">+</span> b<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>通过线性插值的特性：</p><p>[minN,maxN] 中的每个点都与 [minM,maxM] 中的唯一点相对应，由一个 x 便可以求出唯一一个 y</p><h3 id="_2-认识透视投影矩阵" tabindex="-1"><a class="header-anchor" href="#_2-认识透视投影矩阵" aria-hidden="true">#</a> 2.认识透视投影矩阵</h3><p>透视投影矩阵 perspective projection：将世界坐标系中的一块四棱台形的区域投射到裁剪空间中，不同深度的物体具备近大远小的透视规则。</p><p><img src="/visual/webgl-share/103.png" alt=""></p><p><img src="/visual/webgl-share/104.png" alt=""></p><p>透视相机的建立需要以下已知条件：</p><ul><li>fov：摄像机视锥体垂直视野角度</li><li>aspect：摄像机视锥体宽高比(近裁剪面)</li><li>near：摄像机近裁剪面到视点的距离</li><li>far：摄像机远裁剪面到视点的距离</li></ul><p><img src="/visual/webgl-share/105.png" alt=""></p><p><code>问</code>：要将一个任意尺寸的正四棱台塞进裁剪空间里，分几步？</p><p><code>答</code>：从透视到正交</p><ol><li>收缩远裁剪面，将原来的正四棱台变成长方体</li><li>像之前的正交投影矩阵一样，将长方体先位移，再缩放</li></ol><h3 id="_3-计算透视投影矩阵" tabindex="-1"><a class="header-anchor" href="#_3-计算透视投影矩阵" aria-hidden="true">#</a> 3.计算透视投影矩阵</h3><ol><li>基于 fov、aspect、n(near)、f(far)计算近裁剪面边界。</li></ol><p><img src="/visual/webgl-share/104.png" alt=""></p><p>上下左右四个边界：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>t <span class="token operator">=</span> n <span class="token operator">*</span> <span class="token function">tan</span><span class="token punctuation">(</span>fov<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> <span class="token operator">-</span>t
r <span class="token operator">=</span> t <span class="token operator">*</span> aspect
l <span class="token operator">=</span> <span class="token operator">-</span>r
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="2"><li>设：可视区域中一顶点为 P1(x1, y1, z1)</li></ol><p>​<code>求</code>：求 P1 在近裁剪面上的投影 P2(x2, y2, z2)</p><p><img src="/visual/webgl-share/106.png" alt=""></p><p>由相似三角形性质得：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>x1<span class="token operator">/</span>x2 <span class="token operator">=</span> y1<span class="token operator">/</span>y2 <span class="token operator">=</span>z1<span class="token operator">/</span>z2
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p><code>因为</code>：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>z2 <span class="token operator">=</span> <span class="token operator">-</span>n
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p><code>所以</code>：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>x2 <span class="token operator">=</span> nx1<span class="token operator">/</span><span class="token operator">-</span>z1
y2 <span class="token operator">=</span> ny1<span class="token operator">/</span><span class="token operator">-</span>z1
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>若把 P1 点的 x1,y1 替换成 x2,y2，就可以理解为把相机可视区域塞进了一个长方体里。</p><p><img src="/visual/webgl-share/107.png" alt=""></p><ol start="3"><li>把长方体里的顶点塞进裁剪空间中。</li></ol><p><img src="/visual/webgl-share/108.png" alt=""></p><p><code>设</code>：P2 映射到裁剪空间中的点为 P3(x3, y3, z3) 点</p><p><code>则</code>：P2 点和 P3 点满足以下关系式：</p><ul><li>x 方向</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">(</span>x3<span class="token operator">-</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>x2<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span>
<span class="token punctuation">(</span>x3<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span> <span class="token operator">=</span> <span class="token punctuation">(</span>x2<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span>
<span class="token punctuation">(</span>x3<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">(</span>x2<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span>
x3 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">(</span>x2<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span>
x3 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">(</span>x2<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token operator">-</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span>
x3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">(</span>x2<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token operator">-</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span>
x3 <span class="token operator">=</span> <span class="token punctuation">(</span>2x2<span class="token operator">-</span><span class="token punctuation">(</span>r<span class="token operator">+</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span>
x3 <span class="token operator">=</span> 2x2<span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token operator">-</span><span class="token punctuation">(</span>r<span class="token operator">+</span>l<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>因为</code>：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>x2 <span class="token operator">=</span> nx1 <span class="token operator">/</span> <span class="token operator">-</span>z1<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p><code>所以</code>：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>x3 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">(</span>nx1<span class="token operator">/</span><span class="token operator">-</span>z1<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token operator">-</span><span class="token punctuation">(</span>r<span class="token operator">+</span>l<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span>
x3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2n</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>x1<span class="token operator">/</span><span class="token operator">-</span>z1<span class="token operator">-</span><span class="token punctuation">(</span>r<span class="token operator">+</span>l<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>y 方向</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">(</span>y3<span class="token operator">-</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>y2<span class="token operator">-</span>b<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>t<span class="token operator">-</span>b<span class="token punctuation">)</span>
y3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2n</span><span class="token operator">/</span><span class="token punctuation">(</span>t<span class="token operator">-</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>y1<span class="token operator">/</span><span class="token operator">-</span>z1<span class="token operator">-</span><span class="token punctuation">(</span>t<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>t<span class="token operator">-</span>b<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>观察一下当前求出的 x3,y3：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>x3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2n</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>x1<span class="token operator">/</span><span class="token operator">-</span>z1<span class="token operator">-</span><span class="token punctuation">(</span>r<span class="token operator">+</span>l<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span>
y3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2n</span><span class="token operator">/</span><span class="token punctuation">(</span>t<span class="token operator">-</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>y1<span class="token operator">/</span><span class="token operator">-</span>z1<span class="token operator">-</span><span class="token punctuation">(</span>t<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>t<span class="token operator">-</span>b<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>只要让 x3,y3 乘以-z1，便可以得到一个齐次坐标 P4(x4, y4, z4, w4)：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>x4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2n</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>x1<span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token operator">+</span>l<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>z1
y4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2n</span><span class="token operator">/</span><span class="token punctuation">(</span>t<span class="token operator">-</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>y1<span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span>t<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>t<span class="token operator">-</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>z1
z4 <span class="token operator">=</span> <span class="token operator">?</span>
w4<span class="token operator">=</span><span class="token operator">-</span>z1
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>当前把顶点的 z 分量投射到裁剪空间中的方法，还不知道，所以 z4=?</p><p>可以先从已知条件中提取投影矩阵(行主序)的矩阵因子：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">[</span>
  <span class="token number">2n</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span>       <span class="token number">0</span>         <span class="token punctuation">(</span>r<span class="token operator">+</span>l<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span>   <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span>              <span class="token number">2n</span><span class="token operator">/</span><span class="token punctuation">(</span>t<span class="token operator">-</span>b<span class="token punctuation">)</span>  <span class="token punctuation">(</span>t<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>t<span class="token operator">-</span>b<span class="token punctuation">)</span>   <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token operator">?</span>              <span class="token operator">?</span>          <span class="token operator">?</span>            <span class="token operator">?</span><span class="token punctuation">,</span>
  <span class="token number">0</span>              <span class="token number">0</span>          <span class="token operator">-</span><span class="token number">1</span>           <span class="token number">0</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>接下来，就剩下 z 轴相关的矩阵因子了。</p><p>因为整个投影矩阵始终是在做线性变换的，投影点的 z 值与投影矩阵的 z 轴向的 x,y 分量无关。</p><p>所以投影矩阵的 z 轴向的 x,y 分量可以写做 0，z 和 w 分量可以设为 k,b，如下：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">[</span>
  <span class="token number">2n</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span>       <span class="token number">0</span>         <span class="token punctuation">(</span>r<span class="token operator">+</span>l<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span>   <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span>              <span class="token number">2n</span><span class="token operator">/</span><span class="token punctuation">(</span>t<span class="token operator">-</span>b<span class="token punctuation">)</span>  <span class="token punctuation">(</span>t<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>t<span class="token operator">-</span>b<span class="token punctuation">)</span>   <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span>              <span class="token number">0</span>          k            b
  <span class="token number">0</span>              <span class="token number">0</span>          <span class="token operator">-</span><span class="token number">1</span>           <span class="token number">0</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>之前说了，整个投影矩阵始终是在做线性变换，所以可以用 k,b 组合一个点斜式：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>z4 <span class="token operator">=</span> k<span class="token operator">*</span>z1<span class="token operator">+</span>b
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>当然，可以认为是点积的结果：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>z4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>k<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token function">·</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span>y1<span class="token punctuation">,</span>z1<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
z4 <span class="token operator">=</span> k<span class="token operator">*</span>z1 <span class="token operator">+</span> b
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>接下来，只要求出上面的 k,b,就可以得到透视投影矩阵。</p><p>可以用当前的已知条件，构建一个二元一次方程组，求出 k,b：</p><p><img src="/visual/webgl-share/105.png" alt=""></p><ul><li>当 z1=-n 时，z3=-1，z4=-1*-z1 （近裁剪面），即：</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>z4 <span class="token operator">=</span> k <span class="token operator">*</span> z1 <span class="token operator">+</span> b <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">*</span> n <span class="token operator">=</span> k <span class="token operator">*</span> <span class="token operator">-</span>n <span class="token operator">+</span> b <span class="token operator">-</span> n <span class="token operator">=</span> <span class="token operator">-</span>kn <span class="token operator">+</span> b<span class="token punctuation">;</span>
b <span class="token operator">=</span> kn <span class="token operator">-</span> n<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>当 z1=-f 时，z3=1，z4=1*-z1（远裁剪面），即：</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>z4 <span class="token operator">=</span> k <span class="token operator">*</span> z1 <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token number">1</span> <span class="token operator">*</span> f <span class="token operator">=</span> k <span class="token operator">*</span> <span class="token operator">-</span>f <span class="token operator">+</span> b<span class="token punctuation">;</span>
f <span class="token operator">=</span> <span class="token operator">-</span>kf <span class="token operator">+</span> b<span class="token punctuation">;</span>
kf <span class="token operator">=</span> b <span class="token operator">-</span> f<span class="token punctuation">;</span>
k <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">-</span> f<span class="token punctuation">)</span> <span class="token operator">/</span> f<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>用消元法求 b：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>b <span class="token operator">=</span> kn<span class="token operator">-</span>n
b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token operator">-</span>f<span class="token punctuation">)</span><span class="token operator">/</span>f<span class="token punctuation">)</span>n<span class="token operator">-</span>n
b <span class="token operator">=</span> <span class="token punctuation">(</span>b<span class="token operator">-</span>f<span class="token punctuation">)</span>n<span class="token operator">/</span>f<span class="token operator">-</span>n
fb <span class="token operator">=</span> <span class="token punctuation">(</span>b<span class="token operator">-</span>f<span class="token punctuation">)</span>n<span class="token operator">-</span>fn
fb <span class="token operator">=</span> bn<span class="token operator">-</span>fn<span class="token operator">-</span>fn
fb<span class="token operator">-</span>bn <span class="token operator">=</span> <span class="token operator">-</span>2fn
<span class="token function">b</span><span class="token punctuation">(</span>f<span class="token operator">-</span>n<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span>2fn
b <span class="token operator">=</span> <span class="token operator">-</span>2fn<span class="token operator">/</span><span class="token punctuation">(</span>f<span class="token operator">-</span>n<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>再求 k：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>k <span class="token operator">=</span> <span class="token punctuation">(</span>b<span class="token operator">-</span>f<span class="token punctuation">)</span><span class="token operator">/</span>f
k <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span>2fn<span class="token operator">/</span><span class="token punctuation">(</span>f<span class="token operator">-</span>n<span class="token punctuation">)</span><span class="token operator">-</span>f<span class="token punctuation">)</span><span class="token operator">/</span>f
k <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2n</span><span class="token operator">/</span><span class="token punctuation">(</span>f<span class="token operator">-</span>n<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span>
k <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2n</span><span class="token operator">-</span>f<span class="token operator">+</span>n<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>f<span class="token operator">-</span>n<span class="token punctuation">)</span>
k <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span>f<span class="token operator">-</span>n<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>f<span class="token operator">-</span>n<span class="token punctuation">)</span>
k <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>f<span class="token operator">+</span>n<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>f<span class="token operator">-</span>n<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>最终的透视投影矩阵如下：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">[</span>
  <span class="token number">2n</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span>       <span class="token number">0</span>         <span class="token punctuation">(</span>r<span class="token operator">+</span>l<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span>   <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span>              <span class="token number">2n</span><span class="token operator">/</span><span class="token punctuation">(</span>t<span class="token operator">-</span>b<span class="token punctuation">)</span>  <span class="token punctuation">(</span>t<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>t<span class="token operator">-</span>b<span class="token punctuation">)</span>   <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token number">0</span>              <span class="token number">0</span>         <span class="token operator">-</span><span class="token punctuation">(</span>f<span class="token operator">+</span>n<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>f<span class="token operator">-</span>n<span class="token punctuation">)</span>  <span class="token operator">-</span>2fn<span class="token operator">/</span><span class="token punctuation">(</span>f<span class="token operator">-</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token number">0</span>              <span class="token number">0</span>         <span class="token operator">-</span><span class="token number">1</span>            <span class="token number">0</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>透视投影的建立方法，可以在 three.js 的源码里找到。</p><h3 id="_4-three-js-里的透视投影矩阵" tabindex="-1"><a class="header-anchor" href="#_4-three-js-里的透视投影矩阵" aria-hidden="true">#</a> 4.three.js 里的透视投影矩阵</h3><p>three.js 的 PerspectiveCamera 对象的 updateProjectionMatrix() 方法，便是透视相机建立透视投影矩阵的方法。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">updateProjectionMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> near <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>near<span class="token punctuation">;</span>
	  <span class="token comment">//近裁剪面上边界</span>
    <span class="token keyword">let</span> top <span class="token operator">=</span> near <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">tan</span><span class="token punctuation">(</span> MathUtils<span class="token punctuation">.</span><span class="token constant">DEG2RAD</span> <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fov <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom<span class="token punctuation">;</span>
    <span class="token comment">//近裁剪面高度</span>
    <span class="token keyword">let</span> height <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> top<span class="token punctuation">;</span>
    <span class="token comment">//近裁剪面宽度</span>
    <span class="token keyword">let</span> width <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aspect <span class="token operator">*</span> height<span class="token punctuation">;</span>
    <span class="token comment">//近裁剪面左边界</span>
    <span class="token keyword">let</span> left <span class="token operator">=</span> <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> width<span class="token punctuation">;</span>
    <span class="token comment">//默认为null</span>
    <span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>view<span class="token punctuation">;</span>

    <span class="token comment">//多视图</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>view <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>enabled <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> fullWidth <span class="token operator">=</span> view<span class="token punctuation">.</span>fullWidth<span class="token punctuation">,</span>
              fullHeight <span class="token operator">=</span> view<span class="token punctuation">.</span>fullHeight<span class="token punctuation">;</span>
        left <span class="token operator">+=</span> view<span class="token punctuation">.</span>offsetX <span class="token operator">*</span> width <span class="token operator">/</span> fullWidth<span class="token punctuation">;</span>
        top <span class="token operator">-=</span> view<span class="token punctuation">.</span>offsetY <span class="token operator">*</span> height <span class="token operator">/</span> fullHeight<span class="token punctuation">;</span>
        width <span class="token operator">*=</span> view<span class="token punctuation">.</span>width <span class="token operator">/</span> fullWidth<span class="token punctuation">;</span>
        height <span class="token operator">*=</span> view<span class="token punctuation">.</span>height <span class="token operator">/</span> fullHeight<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token comment">//偏离值，默认0</span>
    <span class="token keyword">const</span> skew <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>filmOffset<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> skew <span class="token operator">!==</span> <span class="token number">0</span> <span class="token punctuation">)</span> left <span class="token operator">+=</span> near <span class="token operator">*</span> skew <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFilmWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//基于近裁剪面边界、近裁剪面和远裁剪面到相机视点的距离设置投影矩阵</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">.</span><span class="token function">makePerspective</span><span class="token punctuation">(</span> left<span class="token punctuation">,</span> left <span class="token operator">+</span> width<span class="token punctuation">,</span> top<span class="token punctuation">,</span> top <span class="token operator">-</span> height<span class="token punctuation">,</span> near<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>far <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//投影矩阵的逆矩阵</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>projectionMatrixInverse<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>projectionMatrix <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><ul><li>makePerspective() 是 Matrix4 对象里的方法，会基于投影空间建立透视投影矩阵</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">makePerspective</span><span class="token punctuation">(</span> <span class="token parameter">left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> te <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>elements<span class="token punctuation">;</span>

    <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> near <span class="token operator">/</span> <span class="token punctuation">(</span> right <span class="token operator">-</span> left <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> y <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> near <span class="token operator">/</span> <span class="token punctuation">(</span> top <span class="token operator">-</span> bottom <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token punctuation">(</span> right <span class="token operator">+</span> left <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span> right <span class="token operator">-</span> left <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token punctuation">(</span> top <span class="token operator">+</span> bottom <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span> top <span class="token operator">-</span> bottom <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token operator">-</span> <span class="token punctuation">(</span> far <span class="token operator">+</span> near <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span> far <span class="token operator">-</span> near <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> d <span class="token operator">=</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> far <span class="token operator">*</span> near <span class="token operator">/</span> <span class="token punctuation">(</span> far <span class="token operator">-</span> near <span class="token punctuation">)</span><span class="token punctuation">;</span>

    te<span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">4</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">8</span> <span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">12</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    te<span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">5</span> <span class="token punctuation">]</span> <span class="token operator">=</span> y<span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">9</span> <span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">13</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    te<span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">6</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">10</span> <span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">14</span> <span class="token punctuation">]</span> <span class="token operator">=</span> d<span class="token punctuation">;</span>
    te<span class="token punctuation">[</span> <span class="token number">3</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">7</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">11</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>	te<span class="token punctuation">[</span> <span class="token number">15</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_5-透视投影矩阵牛刀小试" tabindex="-1"><a class="header-anchor" href="#_5-透视投影矩阵牛刀小试" aria-hidden="true">#</a> 5.透视投影矩阵牛刀小试</h3><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  uniform mat4 u_ProjectionMatrix<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_ProjectionMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform vec4 u_Color<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor <span class="token operator">=</span> u_Color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../jsm/Utils.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span>
    Matrix4<span class="token punctuation">,</span>
    PerspectiveCamera
  <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> Poly <span class="token keyword">from</span> <span class="token string">&#39;./jsm/Poly.js&#39;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>viewW<span class="token punctuation">,</span> viewH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">,</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">]</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> viewW<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> viewH<span class="token punctuation">;</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vertexShader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fragmentShader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//建立透视相机</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">45</span><span class="token punctuation">,</span>
    canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">20</span>
  <span class="token punctuation">]</span>
  <span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span>

  <span class="token comment">//投影视图矩阵</span>
  <span class="token keyword">const</span> pvMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>
      camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span>
      camera<span class="token punctuation">.</span>matrixWorldInverse
    <span class="token punctuation">)</span>

  <span class="token comment">// 前面是两个黄色三角形，后面是两个红色三角形。</span>
  <span class="token keyword">const</span> triangle1 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">const</span> triangle2 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">const</span> triangle3 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">const</span> triangle4 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>
  <span class="token punctuation">)</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    triangle1<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle1<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle2<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle2<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle3<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle3<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle4<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle4<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span><span class="token parameter">color<span class="token punctuation">,</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      gl<span class="token punctuation">,</span>
      <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        x<span class="token punctuation">,</span> <span class="token number">0.3</span> <span class="token operator">+</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span>
        <span class="token operator">-</span> <span class="token number">0.3</span> <span class="token operator">+</span> x<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span> <span class="token operator">+</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span>
        <span class="token number">0.3</span> <span class="token operator">+</span> x<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span> <span class="token operator">+</span> y<span class="token punctuation">,</span> z
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;TRIANGLES&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
          <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">uniforms</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">u_Color</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform4fv&#39;</span><span class="token punctuation">,</span>
          <span class="token literal-property property">value</span><span class="token operator">:</span> color
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">u_ProjectionMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
          <span class="token literal-property property">value</span><span class="token operator">:</span> camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">.</span>elements
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/109.png" alt=""></p></details><h2 id="十四、投影矩阵、视图矩阵和模型矩阵共冶一炉" tabindex="-1"><a class="header-anchor" href="#十四、投影矩阵、视图矩阵和模型矩阵共冶一炉" aria-hidden="true">#</a> 十四、投影矩阵、视图矩阵和模型矩阵共冶一炉</h2><p>投影矩阵、视图矩阵、模型矩阵的结合方式：<br><strong>最终的顶点坐标 = 投影矩阵 * 视图矩阵 * 模型矩阵 * 初始顶点坐标</strong></p><p><strong><code>投影矩阵</code></strong>：</p><ul><li>正交投影矩阵：将世界坐标系中的一块矩形区域(正交相机的可视区域)投射到裁剪空间中，不同深度物体不具备近大远小的透视规则 <code>正交投影矩阵 = 缩放矩阵*位移矩阵</code></li><li>透视投影矩阵：将世界坐标系中的一块四棱台形的区域投射到裁剪空间中，不同深度的物体具备近大远小的透视规则</li></ul><p><strong><code>视图矩阵</code></strong>：相机位移矩阵乘以旋转矩阵后的逆矩阵，即相机的世界矩阵的逆矩阵</p><ul><li>位移矩阵：由视点位置得出</li><li>旋转矩阵：由视点、目标点、上方向得出</li></ul><p><strong><code>投影视图矩阵</code></strong>：投影矩阵乘以视图矩阵</p><p><strong><code>模型矩阵</code></strong>：模型矩阵可以对物体进行位移、旋转、缩放变换，比如让物体沿 z 旋转</p><h3 id="_1-投影视图矩阵" tabindex="-1"><a class="header-anchor" href="#_1-投影视图矩阵" aria-hidden="true">#</a> 1.投影视图矩阵</h3><p>1.在顶点着色器里把投影矩阵变成投影视图矩阵。</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_PvMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>2.设置相机位置，并让其看向一点</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">[</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">45</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span><span class="token function">updateWorldMatrix</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>3.计算投影视图矩阵，即让相机的投影矩阵乘以视图矩阵</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> pvMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span> camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>4.修改一下建立三角形方法里的 uniform 变量</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> pvMatrix<span class="token punctuation">.</span>elements
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>效果如下：<br><img src="/visual/webgl-share/110.png" alt=""></p><p>接下来，再把模型矩阵加进去。</p><h3 id="_2-投影视图矩阵乘以模型矩阵" tabindex="-1"><a class="header-anchor" href="#_2-投影视图矩阵乘以模型矩阵" aria-hidden="true">#</a> 2.投影视图矩阵乘以模型矩阵</h3><p>之前设置三角形位置的时候，是直接对顶点的原始数据进行的修改。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    x<span class="token punctuation">,</span> <span class="token number">0.3</span> <span class="token operator">+</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0.3</span> <span class="token operator">+</span> x<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span> <span class="token operator">+</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span>
    <span class="token number">0.3</span> <span class="token operator">+</span> x<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span> <span class="token operator">+</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>其实，可以将位移数据写进模型矩阵里的，当然旋转和缩放数据也可以写进去，然后用模型矩阵乘以原始顶点，从而实现对模型的变换。</p><p>1.顶点着色器</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>attribute vec4 a_Position<span class="token punctuation">;</span>
uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_PvMatrix<span class="token operator">*</span>u_ModelMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>2.在 crtTriangle()方法里，把三角形的数据源写死，在 uniforms 里添加一个模型矩阵。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span><span class="token parameter">color<span class="token punctuation">,</span> modelMatrix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    gl<span class="token punctuation">,</span>
    modelMatrix<span class="token punctuation">,</span>
    <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;TRIANGLES&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">uniforms</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">u_Color</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniform4fv&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> color<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniformMatrix4fv&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> pvMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniformMatrix4fv&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> modelMatrix<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>2.建立四个三角形</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> triangle1 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> triangle2 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> triangle3 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> triangle4 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>效果如下：<br><img src="/visual/webgl-share/111.png" alt=""></p><h2 id="十五、正交相机轨道控制器" tabindex="-1"><a class="header-anchor" href="#十五、正交相机轨道控制器" aria-hidden="true">#</a> 十五、正交相机轨道控制器</h2><p>相机轨道控制器可以变换相机，从而灵活观察物体。<br> three.js 中的相机轨道控制器是通过以下事件变换相机的：（<a href="https://threejs.org/examples/?q=orbi#misc_controls_orbit" target="_blank" rel="noopener noreferrer">orbitControls<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>）</p><ol><li>旋转</li></ol><ul><li>鼠标左键拖拽</li><li>单手指移动</li></ul><ol start="2"><li>缩放</li></ol><ul><li>鼠标滚轮滚动</li><li>两个手指展开或挤压</li></ul><ol start="3"><li>平移</li></ol><ul><li>鼠标右键拖拽</li><li>鼠标左键+ctrl/meta/shiftKey 拖拽</li><li>箭头键</li><li>两个手指移动</li></ul><h3 id="_1-正交相机的位移轨道" tabindex="-1"><a class="header-anchor" href="#_1-正交相机的位移轨道" aria-hidden="true">#</a> 1.正交相机的位移轨道</h3><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
  uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_PvMatrix <span class="token operator">*</span> u_ModelMatrix <span class="token operator">*</span> a_Position<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform vec4 u_Color<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor <span class="token operator">=</span> u_Color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span>
    Matrix4<span class="token punctuation">,</span>
    Vector2<span class="token punctuation">,</span>
    Vector3<span class="token punctuation">,</span>
    OrthographicCamera
  <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../jsm/Utils.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> Poly <span class="token keyword">from</span> <span class="token string">&#39;./jsm/Poly.js&#39;</span><span class="token punctuation">;</span>

  <span class="token comment">/* 搭建场景 */</span>
  <span class="token comment">// 1.初始化着色器 </span>
  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>viewW<span class="token punctuation">,</span> viewH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">,</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> viewW<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> viewH<span class="token punctuation">;</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vertexShader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fragmentShader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2.正交相机</span>
  <span class="token keyword">const</span> halfH <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ratio <span class="token operator">=</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
  <span class="token keyword">const</span> halfW <span class="token operator">=</span> halfH <span class="token operator">*</span> ratio<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token operator">-</span>halfW<span class="token punctuation">,</span> halfW<span class="token punctuation">,</span> halfH<span class="token punctuation">,</span> <span class="token operator">-</span>halfH<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrthographicCamera</span><span class="token punctuation">(</span>
    left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> pvMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>
    camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span>
    camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 3.创建 4 个三角形</span>
  <span class="token keyword">const</span> triangle1 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
      <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> triangle2 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> triangle3 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> triangle4 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    triangle1<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle1<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle2<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle2<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle3<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle3<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle4<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle4<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span><span class="token parameter">color<span class="token punctuation">,</span> modelMatrix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      gl<span class="token punctuation">,</span>
      <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;TRIANGLES&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
          <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">uniforms</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">u_Color</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform4fv&#39;</span><span class="token punctuation">,</span>
          <span class="token literal-property property">value</span><span class="token operator">:</span> color
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
          <span class="token literal-property property">value</span><span class="token operator">:</span> pvMatrix<span class="token punctuation">.</span>elements
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
          <span class="token literal-property property">value</span><span class="token operator">:</span> modelMatrix
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>


  <span class="token comment">/* 声明基础数据 */</span>
  <span class="token comment">// 1.鼠标事件集合</span>
  <span class="token keyword">const</span> mouseButtons <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&#39;pan&#39;</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//鼠标右键按下时的event.button值为2</span>
  <span class="token comment">//pan：平移</span>
  <span class="token comment">// 2.轨道控制器状态，表示控制器正在对相机进行哪种变换。</span>
  <span class="token comment">// 比如 state 等于 pan 时，代表位移</span>
  <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token string">&#39;none&#39;</span><span class="token punctuation">;</span>
  <span class="token comment">// 3.鼠标在屏幕上拖拽时的起始位和结束位，以像素为单位</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>dragStart<span class="token punctuation">,</span> dragEnd<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 4.鼠标每次移动时的位移量，webgl 坐标量</span>
  <span class="token keyword">const</span> panOffset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 5.鼠标在屏幕上垂直拖拽时，是基于相机本地坐标系的 y 方向还是 z 方向移动相机</span>
  <span class="token keyword">const</span> screenSpacePanning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">//true：y向移动</span>
  <span class="token comment">//false：z向移动</span>

  <span class="token comment">/* 在canvas上绑定鼠标事件 */</span>
  <span class="token comment">// 1.取消右击菜单的显示</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;contextmenu&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2.指针按下时，设置拖拽起始位，获取轨道控制器状态</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerdown&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">,</span> button<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    dragStart<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    state <span class="token operator">=</span> mouseButtons<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//注：指针事件支持多种方式的指针顶点输入，如鼠标、触控笔、触摸屏等。</span>
  <span class="token comment">// 3.指针移动时，若控制器处于平移状态，平移相机</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointermove&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">&#39;pan&#39;</span><span class="token operator">:</span>
        <span class="token function">handleMouseMovePan</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 4.指针抬起时，清除控制器状态</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerup&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> <span class="token string">&#39;none&#39;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">/* 相机平移方法 */</span>
  <span class="token keyword">function</span> <span class="token function">handleMouseMovePan</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//指针拖拽的结束位(像素单位)</span>
    dragEnd<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//基于拖拽距离(像素单位)移动相机</span>
    <span class="token function">pan</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>dragStart<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//重置拖拽起始位</span>
    dragStart<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 平移方法</span>
  <span class="token keyword">function</span> <span class="token function">pan</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> right<span class="token punctuation">,</span> left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> matrix<span class="token punctuation">,</span> position<span class="token punctuation">,</span> up <span class="token punctuation">}</span> <span class="token operator">=</span> camera<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> clientWidth<span class="token punctuation">,</span> clientHeight <span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">;</span>
    <span class="token comment">//相机近裁剪面尺寸</span>
    <span class="token keyword">const</span> cameraW <span class="token operator">=</span> right <span class="token operator">-</span> left<span class="token punctuation">;</span>
    <span class="token keyword">const</span> cameraH <span class="token operator">=</span> top <span class="token operator">-</span> bottom<span class="token punctuation">;</span>
    <span class="token comment">//指针拖拽量在画布中的比值</span>
    <span class="token keyword">const</span> ratioX <span class="token operator">=</span> x <span class="token operator">/</span> clientWidth<span class="token punctuation">;</span>
    <span class="token keyword">const</span> ratioY <span class="token operator">=</span> y <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
    <span class="token comment">//将像素单位的位移量转换为相机近裁剪面上的位移量</span>
    <span class="token keyword">const</span> distanceLeft <span class="token operator">=</span> ratioX <span class="token operator">*</span> cameraW<span class="token punctuation">;</span>
    <span class="token keyword">const</span> distanceUp <span class="token operator">=</span> ratioY <span class="token operator">*</span> cameraH<span class="token punctuation">;</span>
    <span class="token comment">//相机本地坐标系里的x轴(第一列)</span>
    <span class="token keyword">const</span> mx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//相机x轴平移量(取反 =&gt; 往右拖拽场景，相机往左移动)</span>
    <span class="token keyword">const</span> vx <span class="token operator">=</span> mx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span><span class="token operator">-</span>distanceLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//相机z|y轴平移量</span>
    <span class="token keyword">const</span> vy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>screenSpacePanning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//y向(第二列)</span>
      vy<span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//-z向</span>
      vy<span class="token punctuation">.</span><span class="token function">crossVectors</span><span class="token punctuation">(</span>up<span class="token punctuation">,</span> mx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//相机y向或-z向的平移量</span>
    vy<span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span>distanceUp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//整合平移量</span>
    panOffset<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>vx<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//更新</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 基于平移量，位移相机，更新投影视图矩阵</span>
  <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    camera<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>
      camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span>
      camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/112.gif" alt=""></p><p>基于拖拽距离(像素单位)移动相机：<br><img src="/visual/webgl-share/113.png" alt=""></p></details><h3 id="_2-正交相机的缩放轨道" tabindex="-1"><a class="header-anchor" href="#_2-正交相机的缩放轨道" aria-hidden="true">#</a> 2.正交相机的缩放轨道</h3><h4 id="_2-1正交相机的缩放原理" tabindex="-1"><a class="header-anchor" href="#_2-1正交相机的缩放原理" aria-hidden="true">#</a> 2.1正交相机的缩放原理</h4><p>相机的缩放就是让我们在裁剪空间中看到的同一深度上的东西更多或者更少。</p><p>通常很容易结合实际生活来考虑，比如我们正对着一面墙壁，墙壁上铺满瓷砖。<br> 当把镜头拉近时，看到的瓷砖数量就变少了，每块瓷砖的尺寸也变大了；<br> 反之，当我们把镜头拉远时，看到的瓷砖数量就变多了，每块瓷砖的尺寸也变小了。<br> 然而这种方式只适用于透视相机，并不适用于正交相机，因为正交相机不具备近大远小规则。</p><p>正交相机的缩放，是直接缩放的投影面，这个投影面在 three.js 里就是近裁剪面。<br> 当投影面变大了，那么能投影的顶点数量也就变多了；<br> 反之，当投影面变小了，那么能投影的顶点数量也就变少了。<br><img src="/visual/webgl-share/97.png" alt=""></p><h4 id="_2-2正交相机缩放方法" tabindex="-1"><a class="header-anchor" href="#_2-2正交相机缩放方法" aria-hidden="true">#</a> 2.2正交相机缩放方法</h4><p>在 three.js 里的正交相机对象 OrthographicCamera 的 updateProjectionMatrix() 方法里可以找到正交相机的缩放方法。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function-variable function">updateProjectionMatrix</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dx <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>right <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>left <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> dy <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>top <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bottom <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoom <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> cx <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>right <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>left <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> cy <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>top <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bottom <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> left <span class="token operator">=</span> cx <span class="token operator">-</span> dx<span class="token punctuation">;</span>
    <span class="token keyword">let</span> right <span class="token operator">=</span> cx <span class="token operator">+</span> dx<span class="token punctuation">;</span>
    <span class="token keyword">let</span> top <span class="token operator">=</span> cy <span class="token operator">+</span> dy<span class="token punctuation">;</span>
    <span class="token keyword">let</span> bottom <span class="token operator">=</span> cy <span class="token operator">-</span> dy<span class="token punctuation">;</span>
    ……
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>可以将上面的 dx、dy 分解一下：</p><ul><li>近裁剪面宽度的一半 width：( this.right - this.left ) / 2</li><li>近裁剪面高度的一半 height：( this.top - this.bottom ) / 2</li><li>dx=width/zoom</li><li>dy=height/zoom</li></ul><p>在 three.js 里，zoom 的默认值是 1，即不做缩放。</p><p>由上可以得到正交相机缩放的性质：</p><ul><li>zoom 值和近裁剪面的尺寸成反比</li><li>近裁剪面的尺寸和我们在同一深度所看物体的数量成正比</li><li>近裁剪面的尺寸和我们所看的同一物体的尺寸成反比</li></ul><h4 id="_2-4正交相机缩放轨道的实现" tabindex="-1"><a class="header-anchor" href="#_2-4正交相机缩放轨道的实现" aria-hidden="true">#</a> 2.4正交相机缩放轨道的实现</h4><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
  uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_PvMatrix <span class="token operator">*</span> u_ModelMatrix <span class="token operator">*</span> a_Position<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform vec4 u_Color<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor <span class="token operator">=</span> u_Color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span>
    Matrix4<span class="token punctuation">,</span> 
    Vector2<span class="token punctuation">,</span> 
    Vector3<span class="token punctuation">,</span>
    OrthographicCamera
  <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../jsm/Utils.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> Poly <span class="token keyword">from</span> <span class="token string">&#39;./jsm/Poly.js&#39;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>viewW<span class="token punctuation">,</span> viewH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">,</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">]</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> viewW<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> viewH<span class="token punctuation">;</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vertexShader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fragmentShader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> halfH <span class="token operator">=</span> <span class="token number">2</span>
  <span class="token keyword">const</span> ratio <span class="token operator">=</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height
  <span class="token keyword">const</span> halfW <span class="token operator">=</span> halfH <span class="token operator">*</span> ratio
  <span class="token keyword">const</span> <span class="token punctuation">[</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token operator">-</span>halfW<span class="token punctuation">,</span> halfW<span class="token punctuation">,</span> halfH<span class="token punctuation">,</span> <span class="token operator">-</span>halfH<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span>
  <span class="token punctuation">]</span>
  <span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrthographicCamera</span><span class="token punctuation">(</span>
    left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far
  <span class="token punctuation">)</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span>
  camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  camera<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> pvMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>
    camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span>
    camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">,</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">const</span> triangle1 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
      <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">const</span> triangle2 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements
  <span class="token punctuation">)</span>

  <span class="token keyword">const</span> triangle3 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements
  <span class="token punctuation">)</span>

  <span class="token keyword">const</span> triangle4 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements
  <span class="token punctuation">)</span>


  <span class="token comment">/* 声明基础数据 */</span>
  <span class="token keyword">const</span> mouseButtons <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&#39;pan&#39;</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token string">&#39;none&#39;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>dragStart<span class="token punctuation">,</span> dragEnd<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>

  <span class="token comment">/* 平移轨道 */</span>
  <span class="token keyword">const</span> panOffset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> screenSpacePanning <span class="token operator">=</span> <span class="token boolean">true</span>

  <span class="token comment">/* 缩放轨道 */</span>
  <span class="token comment">// 1.定义滚轮在每次滚动时的缩放系数</span>
  <span class="token keyword">const</span> zoomScale <span class="token operator">=</span> <span class="token number">0.95</span>

  <span class="token comment">//在canvas上绑定鼠标事件</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;contextmenu&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerdown&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">,</span> button <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    dragStart<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">)</span>
    state <span class="token operator">=</span> mouseButtons<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointermove&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">&#39;pan&#39;</span><span class="token operator">:</span>
        <span class="token function">handleMouseMovePan</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerup&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> <span class="token string">&#39;none&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 2.为 canvas 添加滚轮事件</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;wheel&#39;</span><span class="token punctuation">,</span> handleMouseWheel<span class="token punctuation">)</span>
  <span class="token keyword">function</span> <span class="token function">handleMouseWheel</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> deltaY <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;deltaY&#39;</span><span class="token punctuation">,</span> deltaY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>deltaY <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">dolly</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> zoomScale<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">dolly</span><span class="token punctuation">(</span>zoomScale<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 当 deltaY &lt; 0 时，是向上滑动滚轮，会缩小裁剪面；</span>
  <span class="token comment">// 当 deltaY &gt; 0 时，是向下滑动滚轮，会放大裁剪面。</span>

  <span class="token comment">// 3.通过 dolly()方法缩放相机</span>
  <span class="token keyword">function</span> <span class="token function">dolly</span><span class="token punctuation">(</span><span class="token parameter">dollyScale</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    camera<span class="token punctuation">.</span>zoom <span class="token operator">*=</span> dollyScale
    camera<span class="token punctuation">.</span><span class="token function">updateProjectionMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">function</span> <span class="token function">handleMouseMovePan</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dragEnd<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">)</span>
    <span class="token function">pan</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>dragStart<span class="token punctuation">)</span><span class="token punctuation">)</span>
    dragStart<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//平移方法</span>
  <span class="token keyword">function</span> <span class="token function">pan</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> right<span class="token punctuation">,</span> left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> matrix<span class="token punctuation">,</span> position<span class="token punctuation">,</span> up <span class="token punctuation">}</span> <span class="token operator">=</span> camera
    <span class="token keyword">const</span> <span class="token punctuation">{</span> clientWidth<span class="token punctuation">,</span> clientHeight <span class="token punctuation">}</span> <span class="token operator">=</span> canvas
    <span class="token keyword">const</span> cameraW <span class="token operator">=</span> right <span class="token operator">-</span> left
    <span class="token keyword">const</span> cameraH <span class="token operator">=</span> top <span class="token operator">-</span> bottom
    <span class="token keyword">const</span> ratioX <span class="token operator">=</span> x <span class="token operator">/</span> clientWidth
    <span class="token keyword">const</span> ratioY <span class="token operator">=</span> y <span class="token operator">/</span> clientHeight
    <span class="token keyword">const</span> distanceLeft <span class="token operator">=</span> ratioX <span class="token operator">*</span> cameraW
    <span class="token keyword">const</span> distanceUp <span class="token operator">=</span> ratioY <span class="token operator">*</span> cameraH
    <span class="token keyword">const</span> mx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> vx <span class="token operator">=</span> mx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span><span class="token operator">-</span>distanceLeft<span class="token punctuation">)</span>
    <span class="token keyword">const</span> vy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>screenSpacePanning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vy<span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      vy<span class="token punctuation">.</span><span class="token function">crossVectors</span><span class="token punctuation">(</span>up<span class="token punctuation">,</span> mx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    vy<span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span>distanceUp<span class="token punctuation">)</span>
    panOffset<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>vx<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vy<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span>
    camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    camera<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>
      camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span>
      camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    triangle1<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle1<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle2<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle2<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle3<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle3<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle4<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle4<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span><span class="token parameter">color<span class="token punctuation">,</span> modelMatrix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      gl<span class="token punctuation">,</span>
      <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;TRIANGLES&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
          <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">uniforms</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">u_Color</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform4fv&#39;</span><span class="token punctuation">,</span>
          <span class="token literal-property property">value</span><span class="token operator">:</span> color
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
          <span class="token literal-property property">value</span><span class="token operator">:</span> pvMatrix<span class="token punctuation">.</span>elements
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
          <span class="token literal-property property">value</span><span class="token operator">:</span> modelMatrix
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/116.gif" alt=""></p></details><h3 id="_3-正交相机的旋转轨道" tabindex="-1"><a class="header-anchor" href="#_3-正交相机的旋转轨道" aria-hidden="true">#</a> 3.正交相机的旋转轨道</h3><h4 id="_3-1正交相机的旋转轨道的概念" tabindex="-1"><a class="header-anchor" href="#_3-1正交相机的旋转轨道的概念" aria-hidden="true">#</a> 3.1正交相机的旋转轨道的概念</h4><p>相机的旋转轨道的实现原理就是让相机绕物体旋转。<br> 相机旋转轨迹的集合是一个球体。<br> 相机旋转轨道的实现方式是有许多种的，至于具体用哪种，还要看具体的项目需求。</p><p><strong>基于球坐标系旋转的相机旋转轨道</strong>:</p><p><img src="/visual/webgl-share/114.png" alt=""></p><p><code>已知</code>：</p><ul><li>三维坐标系[O;x,y,z]</li><li>正交相机 <ul><li>视点位：点 P</li><li>目标位：点 O</li></ul></li><li>正交相机旋转轨的旋转轴是 y 轴</li></ul><p><code>则</code>：</p><p>正交相机在球坐标系中的旋转轨道有两种：</p><ul><li>点 P 绕旋转轴 y 轴的旋转轨道，即上图的蓝色轨道。</li><li>点 P 在平面 OPy 中的旋转轨道，即上图的绿色轨迹。</li></ul><p>接下来，结合正交相机的实际情况，如何计算正交相机旋转后的视点位。</p><h4 id="_3-2正交相机旋转后的视点位" tabindex="-1"><a class="header-anchor" href="#_3-2正交相机旋转后的视点位" aria-hidden="true">#</a> 3.2正交相机旋转后的视点位</h4><p><img src="/visual/webgl-share/114.png" alt=""></p><p><code>已知</code>：</p><ul><li>三维坐标系[O;x,y,z]</li><li>正交相机 <ul><li>视点位：三维坐标点 P(x,y,z)</li><li>目标位：点 O</li></ul></li><li>正交相机旋转轨的旋转轴是 y 轴</li></ul><p><code>求</code>：相机在平面 OPy 中旋转 a 度，绕 y 轴旋转 b 度后，相机视点的三维空间位 P&#39;(x&#39;,y&#39;,z&#39;)</p><p><code>解</code>：</p><ol><li>将点 P(x,y,z)的三维坐标位换算为球坐标位，即 P(r,φ,θ)</li><li>计算点 P 在平面 OPy 中旋转 a 度，绕 y 轴旋转 b 度后的球坐标位，即 P(r,φ+a,θ+b)</li><li>将点 P 的球坐标位转换为三维坐标位</li></ol><p>求解的思路就这么简单，那具体怎么实现呢？先把上面的球坐标解释一下。</p><h4 id="_3-3球坐标系" tabindex="-1"><a class="header-anchor" href="#_3-3球坐标系" aria-hidden="true">#</a> 3.3球坐标系</h4><p>Ⅰ 球坐标系的概念</p><p><img src="/visual/webgl-share/114.png" alt=""></p><p>球坐标系（spherical coordinate system）是用球坐标表示空间点位的坐标系。</p><p>球坐标由以下分量构成：</p><ul><li>半径(radial distance) r：OP 长度( 0 ≤ r ) 。</li><li>极角(polar angle) φ：OP 与 y 轴的夹角(0 ≤ φ ≤ π)</li><li>方位角(azimuth angle) θ：OP 在平面 Oxz 上的投影与正 x 轴的夹角( 0 ≤ θ &lt; 2π )。</li></ul><p><code>注</code>：</p><ul><li>球坐标系可视极坐标系的三维推广。</li><li>当 r=0 时，φ 和 θ 无意义。</li><li>当 φ =0 或 φ =π 时，θ 无意义。</li></ul><p>Ⅱ 三维坐标转球坐标</p><p><img src="/visual/webgl-share/114.png" alt=""></p><p><code>已知</code>：点 P 的三维坐标位(x,y,z)</p><p><code>求</code>：点 P 的球坐标位(r,φ,θ)</p><p><code>解</code>：</p><p>求半径 r：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>r <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>x² <span class="token operator">+</span> y² <span class="token operator">+</span> z²<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>求极角 φ 的方法有三种：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>φ <span class="token operator">=</span> <span class="token function">acos</span><span class="token punctuation">(</span>y<span class="token operator">/</span>r<span class="token punctuation">)</span>
φ <span class="token operator">=</span> <span class="token function">asin</span><span class="token punctuation">(</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x² <span class="token operator">+</span> z²<span class="token punctuation">)</span><span class="token operator">/</span>r<span class="token punctuation">)</span>
φ <span class="token operator">=</span> <span class="token function">atan</span><span class="token punctuation">(</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x² <span class="token operator">+</span> z²<span class="token punctuation">)</span><span class="token operator">/</span>y<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>求方位角 θ 的方法有三种：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>θ <span class="token operator">=</span> <span class="token function">acos</span><span class="token punctuation">(</span>x<span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">*</span>sinφ<span class="token punctuation">)</span><span class="token punctuation">)</span>
θ <span class="token operator">=</span> <span class="token function">asin</span><span class="token punctuation">(</span>z<span class="token operator">/</span><span class="token punctuation">(</span>r<span class="token operator">*</span>sinφ<span class="token punctuation">)</span><span class="token punctuation">)</span>
θ <span class="token operator">=</span> <span class="token function">atan</span><span class="token punctuation">(</span>z<span class="token operator">/</span>x<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>注</code>：</p><p>在用反正切求角度时，需要注意点问题。</p><p>atan()返回的值域是[-PI/2,PI/2]，这是个半圆，这会导致其返回的弧度失真。</p><p>如：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">atan</span><span class="token punctuation">(</span>z<span class="token operator">/</span>x<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">atan</span><span class="token punctuation">(</span><span class="token operator">-</span>z<span class="token operator">/</span><span class="token operator">-</span>x<span class="token punctuation">)</span>
<span class="token function">atan</span><span class="token punctuation">(</span><span class="token operator">-</span>z<span class="token operator">/</span>x<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">atan</span><span class="token punctuation">(</span>z<span class="token operator">/</span><span class="token operator">-</span>x<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>所以，在 js 里用反正切计算弧度时，要使用 atan2() 方法，即：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>φ <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">atan2</span><span class="token punctuation">(</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x²<span class="token operator">+</span>z²<span class="token punctuation">)</span><span class="token punctuation">,</span>y<span class="token punctuation">)</span>
θ <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">atan2</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span>x<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>atan2()返回的值域是[-PI,PI]，这是一个整圆。</p><p>atan2()方法是将 z,x 分开写入的，其保留了其最原始的正负符号，所以其返回的弧度不会失真。</p><p>Ⅲ 球坐标转三维坐标</p><p><code>已知</code>：点 P 的球坐标位(r,φ,θ)</p><p><code>求</code>：点 P 的三维坐标位(x,y,z)</p><p><code>解</code>：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>x <span class="token operator">=</span> r <span class="token operator">*</span> sinφ <span class="token operator">*</span> cosθ<span class="token punctuation">;</span>
y <span class="token operator">=</span> r <span class="token operator">*</span> cosφ<span class="token punctuation">;</span>
z <span class="token operator">=</span> r <span class="token operator">*</span> sinφ <span class="token operator">*</span> sinθ<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_3-4正交相机旋转轨道的代码实现" tabindex="-1"><a class="header-anchor" href="#_3-4正交相机旋转轨道的代码实现" aria-hidden="true">#</a> 3.4正交相机旋转轨道的代码实现</h4><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
  uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_PvMatrix<span class="token operator">*</span>u_ModelMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform vec4 u_Color<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor<span class="token operator">=</span>u_Color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span>
    Matrix4<span class="token punctuation">,</span>
    Vector2<span class="token punctuation">,</span>
    Vector3<span class="token punctuation">,</span>
    OrthographicCamera<span class="token punctuation">,</span>
    Spherical
  <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../jsm/Utils.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> Poly <span class="token keyword">from</span> <span class="token string">&#39;./jsm/Poly.js&#39;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>viewW<span class="token punctuation">,</span> viewH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">,</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">]</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> viewW<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> viewH<span class="token punctuation">;</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vertexShader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fragmentShader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> halfH <span class="token operator">=</span> <span class="token number">2</span>
  <span class="token keyword">const</span> ratio <span class="token operator">=</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height
  <span class="token keyword">const</span> halfW <span class="token operator">=</span> halfH <span class="token operator">*</span> ratio
  <span class="token keyword">const</span> <span class="token punctuation">[</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token operator">-</span>halfW<span class="token punctuation">,</span> halfW<span class="token punctuation">,</span> halfH<span class="token punctuation">,</span> <span class="token operator">-</span>halfH<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span>
  <span class="token punctuation">]</span>
  <span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrthographicCamera</span><span class="token punctuation">(</span>
    left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far
  <span class="token punctuation">)</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span>
  camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  camera<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> pvMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>
    camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span>
    camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">,</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">const</span> triangle1 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
      <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">const</span> triangle2 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements
  <span class="token punctuation">)</span>

  <span class="token keyword">const</span> triangle3 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements
  <span class="token punctuation">)</span>

  <span class="token keyword">const</span> triangle4 <span class="token operator">=</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements
  <span class="token punctuation">)</span>


  <span class="token comment">/* 声明基础数据 */</span>
  <span class="token comment">//鼠标事件集合</span>
  <span class="token keyword">const</span> mouseButtons <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&#39;rotate&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&#39;pan&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token comment">//轨道状态</span>
  <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token string">&#39;none&#39;</span>
  <span class="token comment">//2PI</span>
  <span class="token keyword">const</span> pi2 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span>
  <span class="token comment">//鼠标拖拽的起始位和结束位，无论是左键按下还是右键按下</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>dragStart<span class="token punctuation">,</span> dragEnd<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

  <span class="token comment">/* 平移轨道 */</span>
  <span class="token comment">//平移量</span>
  <span class="token keyword">const</span> panOffset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">//是否沿相机y轴平移相机</span>
  <span class="token keyword">const</span> screenSpacePanning <span class="token operator">=</span> <span class="token boolean">true</span>

  <span class="token comment">/* 缩放轨道 */</span>
  <span class="token comment">//滚轮在每次滚动时的缩放系数</span>
  <span class="token keyword">const</span> zoomScale <span class="token operator">=</span> <span class="token number">0.95</span>

  <span class="token comment">/* 旋转轨道 */</span>
  <span class="token comment">// 相机视点相对于目标的球坐标</span>
  <span class="token keyword">const</span> spherical <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Spherical</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setFromVector3</span><span class="token punctuation">(</span>
      camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

  <span class="token comment">/* 取消右击菜单的显示 */</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;contextmenu&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">/* 指针按下时，设置拖拽起始位，获取轨道控制器状态。 */</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerdown&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">,</span> button <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    dragStart<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">)</span>
    state <span class="token operator">=</span> mouseButtons<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">/* 指针移动时，若控制器处于平移状态，平移相机；若控制器处于旋转状态，旋转相机。 */</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointermove&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    dragEnd<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">)</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">&#39;pan&#39;</span><span class="token operator">:</span>
        <span class="token function">pan</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>dragStart<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">&#39;rotate&#39;</span><span class="token operator">:</span>
        <span class="token function">rotate</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>dragStart<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    dragStart<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerup&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> <span class="token string">&#39;none&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">//滚轮事件</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;wheel&#39;</span><span class="token punctuation">,</span> handleMouseWheel<span class="token punctuation">)</span>
  <span class="token keyword">function</span> <span class="token function">handleMouseWheel</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> deltaY <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;deltaY&#39;</span><span class="token punctuation">,</span> deltaY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>deltaY <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">dolly</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> zoomScale<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">dolly</span><span class="token punctuation">(</span>zoomScale<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">dolly</span><span class="token punctuation">(</span><span class="token parameter">dollyScale</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    camera<span class="token punctuation">.</span>zoom <span class="token operator">*=</span> dollyScale
    camera<span class="token punctuation">.</span><span class="token function">updateProjectionMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//平移方法</span>
  <span class="token keyword">function</span> <span class="token function">pan</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> right<span class="token punctuation">,</span> left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> matrix<span class="token punctuation">,</span> position<span class="token punctuation">,</span> up <span class="token punctuation">}</span> <span class="token operator">=</span> camera
    <span class="token keyword">const</span> <span class="token punctuation">{</span> clientWidth<span class="token punctuation">,</span> clientHeight <span class="token punctuation">}</span> <span class="token operator">=</span> canvas
    <span class="token keyword">const</span> cameraW <span class="token operator">=</span> right <span class="token operator">-</span> left
    <span class="token keyword">const</span> cameraH <span class="token operator">=</span> top <span class="token operator">-</span> bottom
    <span class="token keyword">const</span> ratioX <span class="token operator">=</span> x <span class="token operator">/</span> clientWidth
    <span class="token keyword">const</span> ratioY <span class="token operator">=</span> y <span class="token operator">/</span> clientHeight
    <span class="token keyword">const</span> distanceLeft <span class="token operator">=</span> ratioX <span class="token operator">*</span> cameraW
    <span class="token keyword">const</span> distanceUp <span class="token operator">=</span> ratioY <span class="token operator">*</span> cameraH
    <span class="token keyword">const</span> mx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> vx <span class="token operator">=</span> mx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span><span class="token operator">-</span>distanceLeft<span class="token punctuation">)</span>
    <span class="token keyword">const</span> vy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>screenSpacePanning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vy<span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      vy<span class="token punctuation">.</span><span class="token function">crossVectors</span><span class="token punctuation">(</span>up<span class="token punctuation">,</span> mx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    vy<span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span>distanceUp<span class="token punctuation">)</span>
    panOffset<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>vx<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vy<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 旋转方法</span>
  <span class="token keyword">function</span> <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> clientHeight <span class="token punctuation">}</span> <span class="token operator">=</span> canvas
    spherical<span class="token punctuation">.</span>theta <span class="token operator">-=</span> pi2 <span class="token operator">*</span> x <span class="token operator">/</span> clientHeight <span class="token comment">// yes, height</span>
    spherical<span class="token punctuation">.</span>phi <span class="token operator">-=</span> pi2 <span class="token operator">*</span> y <span class="token operator">/</span> clientHeight
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//基于平移量平移相机</span>
    target<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span>

    <span class="token comment">//基于旋转量旋转相机</span>
    <span class="token keyword">const</span> rotateOffset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">setFromSpherical</span><span class="token punctuation">(</span>spherical<span class="token punctuation">)</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>
      target<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rotateOffset<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    <span class="token comment">//更新投影视图矩阵</span>
    camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    camera<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>
      camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span>
      camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token comment">//重置旋转量和平移量</span>
    spherical<span class="token punctuation">.</span><span class="token function">setFromVector3</span><span class="token punctuation">(</span>
      camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    panOffset<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment">// 渲染</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    triangle1<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle1<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle2<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle2<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle3<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle3<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle4<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    triangle4<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">crtTriangle</span><span class="token punctuation">(</span><span class="token parameter">color<span class="token punctuation">,</span> modelMatrix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      gl<span class="token punctuation">,</span>
      <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;TRIANGLES&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
          <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">uniforms</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">u_Color</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform4fv&#39;</span><span class="token punctuation">,</span>
          <span class="token literal-property property">value</span><span class="token operator">:</span> color
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
          <span class="token literal-property property">value</span><span class="token operator">:</span> pvMatrix<span class="token punctuation">.</span>elements
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
          <span class="token literal-property property">value</span><span class="token operator">:</span> modelMatrix
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/117.gif" alt=""></p></details><h4 id="_3-5限制旋转轴" tabindex="-1"><a class="header-anchor" href="#_3-5限制旋转轴" aria-hidden="true">#</a> 3.5限制旋转轴</h4><p>在 three.js 的轨道控制器里，无法限制旋转轴，比如只想横向旋转相机，或者竖向旋转相机。</p><ol><li>声明一个控制旋转方向的属性</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> rotateDir <span class="token operator">=</span> <span class="token string">&quot;xy&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ul><li>x：可以在 x 方向旋转相机</li><li>y：可以在 y 方向旋转相机</li><li>xy：可以在 x,y 方向旋转相机</li></ul><ol start="2"><li>旋转方法，基于 rotateDir 属性约束旋转方向</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> clientHeight <span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">;</span>
  <span class="token keyword">const</span> deltaT <span class="token operator">=</span> <span class="token punctuation">(</span>pi2 <span class="token operator">*</span> x<span class="token punctuation">)</span> <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
  <span class="token keyword">const</span> deltaP <span class="token operator">=</span> <span class="token punctuation">(</span>pi2 <span class="token operator">*</span> y<span class="token punctuation">)</span> <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rotateDir<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    spherical<span class="token punctuation">.</span>theta <span class="token operator">-=</span> deltaT<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rotateDir<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;y&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    spherical<span class="token punctuation">.</span>phi <span class="token operator">-=</span> deltaP<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_3-6限制极角" tabindex="-1"><a class="header-anchor" href="#_3-6限制极角" aria-hidden="true">#</a> 3.6限制极角</h4><p>之前说球坐标系的时候说过，其极角的定义域是[0,180°]，所以在代码里也要对其做一下限制。<br> 在 rotate() 方法里做下调整即可。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//旋转</span>
<span class="token keyword">function</span> <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> clientHeight <span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">;</span>
    <span class="token keyword">const</span> deltaT <span class="token operator">=</span> <span class="token punctuation">(</span>pi2 <span class="token operator">*</span> x<span class="token punctuation">)</span> <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
    <span class="token keyword">const</span> deltaP <span class="token operator">=</span> <span class="token punctuation">(</span>pi2 <span class="token operator">*</span> y<span class="token punctuation">)</span> <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rotateDir<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      spherical<span class="token punctuation">.</span>theta <span class="token operator">-=</span> deltaT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rotateDir<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;y&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> phi <span class="token operator">=</span> spherical<span class="token punctuation">.</span>phi <span class="token operator">-</span> deltaP
        spherical<span class="token punctuation">.</span>phi <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">,</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> phi<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>因为当球坐标里的极角等于 0 或 180 度的时候，方位角会失去意义，所以还不能在代码真的给极角 0 或 180 度，不然方位角会默认归零。<br> 所以，需要分别给极角里的 0 和 180 度一个近似值。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>spherical<span class="token punctuation">.</span>phi <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">0.99999999</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.00000001</span><span class="token punctuation">,</span> phi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>基于球坐标系的相机旋转轨道我们就说到这，其具体代码可以参考 three.js 里的 OrbitControls 对象的源码。</p><p>接下来，再说一个另一种形式的正交相机旋转轨道。</p><h3 id="_4-轨迹球旋转" tabindex="-1"><a class="header-anchor" href="#_4-轨迹球旋转" aria-hidden="true">#</a> 4.轨迹球旋转</h3><p>轨迹球这个名字，来自 three.js 的 TrackballControls 对象，其具体的代码实现便可以在这里找到。</p><p>轨迹球不像基于球坐标系的旋转轨道那样具有恒定的上方向。<br> 轨迹球的上方向是一个垂直于鼠标拖拽方向和视线的轴，相机视点会基于此轴旋转。<br> 轨迹球的上方向会随鼠标拖拽方向的改变而改变。</p><p>如下图：</p><p><img src="/visual/webgl-share/115.png" alt=""></p><p>接下来，说一下具体的代码实现。</p><p>在 three.js 中，TrackballControls 和 OrbitControls 对象里的代码，不太像一个人写的。</p><p>因为完全可以沿用 OrbitControls 里的一部分代码去写 TrackballControls，比如鼠标在相机世界里的偏移量，而 TrackballControls 完全用一套风格迥异的代码从头写了一遍。</p><p>当然，这里并不是说 TrackballControls 不好，其原理和功能的实现方法依旧是很值得学习。</p><p>只是在写轨迹球的时候，完全可以基于 TrackballControls 的实现原理，把 OrbitControls 给改一下，这样可以少写许多代码。</p><p>1.定义用于沿某个轴旋转相机视点的四元数</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> quaternion <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Quaternion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>2.把之前的 rotate()旋转方法改一下</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> right<span class="token punctuation">,</span> left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> matrix<span class="token punctuation">,</span> position <span class="token punctuation">}</span> <span class="token operator">=</span> camera<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> clientWidth<span class="token punctuation">,</span> clientHeight <span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">;</span>

  <span class="token comment">// 相机宽高</span>
  <span class="token keyword">const</span> cameraW <span class="token operator">=</span> right <span class="token operator">-</span> left<span class="token punctuation">;</span>
  <span class="token keyword">const</span> cameraH <span class="token operator">=</span> top <span class="token operator">-</span> bottom<span class="token punctuation">;</span>

  <span class="token comment">// 鼠标位移距离在画布中的占比</span>
  <span class="token keyword">const</span> ratioX <span class="token operator">=</span> x <span class="token operator">/</span> clientWidth<span class="token punctuation">;</span>
  <span class="token keyword">const</span> ratioY <span class="token operator">=</span> <span class="token operator">-</span>y <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>

  <span class="token comment">//基于高度的x位置比-用于旋转量的计算</span>
  <span class="token keyword">const</span> ratioXBaseHeight <span class="token operator">=</span> x <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
  <span class="token comment">//位移量</span>
  <span class="token keyword">const</span> ratioLen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span>ratioXBaseHeight<span class="token punctuation">,</span> ratioY<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//旋转量</span>
  <span class="token keyword">const</span> angle <span class="token operator">=</span> ratioLen <span class="token operator">*</span> pi2<span class="token punctuation">;</span>

  <span class="token comment">// 在相机世界中的位移距离</span>
  <span class="token keyword">const</span> distanceLeft <span class="token operator">=</span> ratioX <span class="token operator">*</span> cameraW<span class="token punctuation">;</span>
  <span class="token keyword">const</span> distanceUp <span class="token operator">=</span> ratioY <span class="token operator">*</span> cameraH<span class="token punctuation">;</span>

  <span class="token comment">// 相机本地坐标系的x,y轴</span>
  <span class="token keyword">const</span> mx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>matrix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> my <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>matrix<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 将鼠标在相机世界的x,y轴向的位移量转换为世界坐标位</span>
  <span class="token keyword">const</span> vx <span class="token operator">=</span> mx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span>distanceLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> vy <span class="token operator">=</span> my<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span>distanceUp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//鼠标在s&#39;j&#39;z中的位移方向-x轴</span>
  <span class="token keyword">const</span> moveDir <span class="token operator">=</span> vx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//目标点到视点的单位向量-z轴</span>
  <span class="token keyword">const</span> eyeDir <span class="token operator">=</span> camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//基于位移方向和视线获取旋转轴-上方向y轴</span>
  <span class="token keyword">const</span> axis <span class="token operator">=</span> moveDir<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>eyeDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//基于旋转轴和旋转量建立四元数</span>
  quaternion<span class="token punctuation">.</span><span class="token function">setFromAxisAngle</span><span class="token punctuation">(</span>axis<span class="token punctuation">,</span> angle<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><ol start="3"><li>在 update()更新方法中，基于四元数设置相机视点位置，并更新相机上方向</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* 更新相机，并渲染 */</span>
<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ……

    <span class="token comment">//旋转视线</span>
    <span class="token keyword">const</span> rotateOffset <span class="token operator">=</span> camera<span class="token punctuation">.</span>position
    <span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">applyQuaternion</span><span class="token punctuation">(</span>quaternion<span class="token punctuation">)</span>

    <span class="token comment">//基于最新视线设置相机位置</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>
        target<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rotateOffset<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token comment">//旋转相机上方向</span>
    camera<span class="token punctuation">.</span>up<span class="token punctuation">.</span><span class="token function">applyQuaternion</span><span class="token punctuation">(</span>quaternion<span class="token punctuation">)</span>

    ……

    <span class="token comment">//重置旋转量和平移量</span>
    panOffset<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    quaternion<span class="token punctuation">.</span><span class="token function">setFromRotationMatrix</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    ……
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>修改完相机的视点位和上方后，要记得重置四元数，以避免在拖拽和缩放时，造成相机旋转。</p><p><code>注</code>：<br> 轨迹球的操控难度是要比球坐标系轨道大的，它常常让不熟练其特性的操作者找不到北，所以在实际项目中还是球坐标系轨道用得比较多。</p><h2 id="十六、透视相机轨道控制器" tabindex="-1"><a class="header-anchor" href="#十六、透视相机轨道控制器" aria-hidden="true">#</a> 十六、透视相机轨道控制器</h2><h3 id="_1-透视相机的位移轨道" tabindex="-1"><a class="header-anchor" href="#_1-透视相机的位移轨道" aria-hidden="true">#</a> 1.透视相机的位移轨道</h3><p>透视相机的位移轨道和正交相机的位移轨道是相同原理的，都是对相机视点和目标点的平移。</p><p>1.建透视交相机</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">[</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">45</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span><span class="token function">updateWorldMatrix</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>2.在正交相机的位移轨道的基础上改一下 pan 方法</p><p><img src="/visual/webgl-share/118.png" alt=""></p><ul><li>将鼠标在画布中的位移量转目标平面位移量</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> matrix<span class="token punctuation">,</span> position<span class="token punctuation">,</span> up <span class="token punctuation">}</span> <span class="token operator">=</span> camera<span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> clientWidth<span class="token punctuation">,</span> clientHeight <span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">;</span>

<span class="token comment">//视线长度：相机视点到目标点的距离</span>
<span class="token keyword">const</span> sightLen <span class="token operator">=</span> position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//视椎体垂直夹角的一半(弧度) =&gt; (fov/2)*Math.PI/180</span>
<span class="token keyword">const</span> halfFov <span class="token operator">=</span> <span class="token punctuation">(</span>fov <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">360</span><span class="token punctuation">;</span>
<span class="token comment">//目标平面的高度</span>
<span class="token keyword">const</span> targetHeight <span class="token operator">=</span> sightLen <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">tan</span><span class="token punctuation">(</span>halfFov<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token comment">//目标平面与画布的高度比</span>
<span class="token keyword">const</span> ratio <span class="token operator">=</span> targetHeight <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
<span class="token comment">//画布位移量转目标平面位移量</span>
<span class="token keyword">const</span> distanceLeft <span class="token operator">=</span> x <span class="token operator">*</span> ratio<span class="token punctuation">;</span>
<span class="token keyword">const</span> distanceUp <span class="token operator">=</span> y <span class="token operator">*</span> ratio<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>注：目标平面是过视点，平行于裁剪面的平面</p><ul><li>将鼠标在目标平面中的位移量转世界坐标</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//相机平移方向</span>
<span class="token comment">//鼠标水平运动时，按照相机本地坐标的x轴平移相机</span>
<span class="token keyword">const</span> mx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//鼠标水平运动时，按照相机本地坐标的y轴，或者-z轴平移相机</span>
<span class="token keyword">const</span> myOrz <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>screenSpacePanning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//y轴，正交相机中默认</span>
  myOrz<span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">//-z轴，透视相机中默认</span>
  myOrz<span class="token punctuation">.</span><span class="token function">crossVectors</span><span class="token punctuation">(</span>up<span class="token punctuation">,</span> mx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//目标平面位移量转世界坐标</span>
<span class="token keyword">const</span> vx <span class="token operator">=</span> mx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span><span class="token operator">-</span>distanceLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> vy <span class="token operator">=</span> myOrz<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span>distanceUp<span class="token punctuation">)</span><span class="token punctuation">;</span>
panOffset<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>vx<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_2-透视相机的缩放轨道" tabindex="-1"><a class="header-anchor" href="#_2-透视相机的缩放轨道" aria-hidden="true">#</a> 2.透视相机的缩放轨道</h3><p>透视相机缩放是通过视点按照视线的方向，接近或者远离目标点来实现的。</p><p><img src="/visual/webgl-share/119.png" alt=""></p><h4 id="_2-1举个例子" tabindex="-1"><a class="header-anchor" href="#_2-1举个例子" aria-hidden="true">#</a> 2.1举个例子</h4><p><code>已知</code>：</p><ul><li>视点 e=5</li><li>目标点 t=15</li><li>（视点即将位移的距离）/（位移前，视点与与目标点的距离）= 0.4</li></ul><p>求：视点移动 2 次后的位置</p><p><code>解</code>：</p><p>视点第 1 次移动后的位置：5+(15-5)*0.4=9<br> 视点第 2 次移动后的位置：9+(15-9)*0.4= 11.4<br> 基本原理就是这样，视点移动 n 此后的位置都可以按照上面的逻辑来计算。</p><h4 id="_2-2代码实现" tabindex="-1"><a class="header-anchor" href="#_2-2代码实现" aria-hidden="true">#</a> 2.2代码实现</h4><p>可以直接在正交相机缩放轨道的基础上做一下修改。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">dolly</span><span class="token punctuation">(</span><span class="token parameter">dollyScale</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">-</span> dollyScale<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li><p>lerp ( v : Vector3, alpha : Float ) 按比例去两点之间的插值</p><p>其源码如下：</p></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">lerp</span><span class="token punctuation">(</span> <span class="token parameter">v<span class="token punctuation">,</span> alpha</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">+=</span> <span class="token punctuation">(</span> v<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token punctuation">)</span> <span class="token operator">*</span> alpha<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">+=</span> <span class="token punctuation">(</span> v<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token punctuation">)</span> <span class="token operator">*</span> alpha<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>z <span class="token operator">+=</span> <span class="token punctuation">(</span> v<span class="token punctuation">.</span>z <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>z <span class="token punctuation">)</span> <span class="token operator">*</span> alpha<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li><p>dollyScale：（位移之后视点与目标点的距离）/（位移前，视点与与目标点的距离）</p></li><li><p>1-dollyScale：（视点即将位移的距离）/（位移前，视点于与目标点的距离）</p></li></ul><p>正交相机缩放轨道的基本实现原理就是这么简单。</p><p>然而，后面还得用球坐标对相机进行旋转，球坐标是已经涵盖了相机视点位的。<br> 因此，还可以直接把相机视点位写进球坐标里。</p><h4 id="_2-3球坐标缩放" tabindex="-1"><a class="header-anchor" href="#_2-3球坐标缩放" aria-hidden="true">#</a> 2.3球坐标缩放</h4><p>1.像正交相机的旋转轨道那样，定义球坐标对象。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> spherical <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Spherical</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromVector3</span><span class="token punctuation">(</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>2.修改旋转方法</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">dolly</span><span class="token punctuation">(</span><span class="token parameter">dollyScale</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  spherical<span class="token punctuation">.</span>radius <span class="token operator">*=</span> dollyScale<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>3.更新方法也和正交相机的旋转轨道一样</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//基于平移量平移相机</span>
  target<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//基于球坐标缩放和旋转相机</span>
  <span class="token keyword">const</span> rotateOffset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromSpherical</span><span class="token punctuation">(</span>spherical<span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rotateOffset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//更新投影视图矩阵</span>
  camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span> camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//重置球坐标和平移量</span>
  spherical<span class="token punctuation">.</span><span class="token function">setFromVector3</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  panOffset<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 渲染</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="_3-透视相机的旋转轨道" tabindex="-1"><a class="header-anchor" href="#_3-透视相机的旋转轨道" aria-hidden="true">#</a> 3.透视相机的旋转轨道</h3><p>透视相机的旋转轨道和正交相机的实现原理都是一样的，可以用球坐标系实现，也可以用轨迹球实现。</p><ul><li>基于球坐标系的旋转轨道，可直接参考正交相机基于球坐标系的旋转轨道来写。</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* 旋转轨道 */</span>
<span class="token keyword">const</span> spherical <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Spherical</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">setFromVector3</span><span class="token punctuation">(</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token comment">//&#39;xy&#39;,&#39;x&#39;,&#39;y&#39;</span>
<span class="token keyword">const</span> rotateDir <span class="token operator">=</span> <span class="token string">&#39;xy&#39;</span>

……

<span class="token comment">/* 指针移动时，若控制器处于平移状态，平移相机；若控制器处于旋转状态，旋转相机。 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointermove&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    dragEnd<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">)</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">&#39;pan&#39;</span><span class="token operator">:</span>
            <span class="token function">pan</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>dragStart<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
        <span class="token keyword">case</span> <span class="token string">&#39;rotate&#39;</span><span class="token operator">:</span>
            <span class="token function">rotate</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>dragStart<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    dragStart<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
……

<span class="token comment">// 旋转方法</span>
<span class="token keyword">function</span> <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> clientHeight <span class="token punctuation">}</span> <span class="token operator">=</span> canvas
    <span class="token keyword">const</span> deltaT <span class="token operator">=</span> pi2 <span class="token operator">*</span> x <span class="token operator">/</span> clientHeight
    <span class="token keyword">const</span> deltaP <span class="token operator">=</span> pi2 <span class="token operator">*</span> y <span class="token operator">/</span> clientHeight
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rotateDir<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;x&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        spherical<span class="token punctuation">.</span>theta <span class="token operator">-=</span> deltaT
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rotateDir<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;y&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> phi <span class="token operator">=</span> spherical<span class="token punctuation">.</span>phi <span class="token operator">-</span> deltaP
        spherical<span class="token punctuation">.</span>phi <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>
            Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">0.99999999</span><span class="token punctuation">,</span>
            Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.00000001</span><span class="token punctuation">,</span> phi<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//基于平移量平移相机</span>
    target<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span>

    <span class="token comment">//基于球坐标缩放相机</span>
    <span class="token keyword">const</span> rotateOffset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setFromSpherical</span><span class="token punctuation">(</span>spherical<span class="token punctuation">)</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>
        target<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rotateOffset<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    <span class="token comment">//更新投影视图矩阵</span>
    camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    camera<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>
        camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span>
        camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token comment">//重置旋转量和平移量</span>
    spherical<span class="token punctuation">.</span><span class="token function">setFromVector3</span><span class="token punctuation">(</span>
        camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    panOffset<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment">// 渲染</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><ul><li>对于轨迹球的旋转轨道，基于正交相机轨迹球旋转的代码略作调整即可。</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* 旋转轨道 */</span>
<span class="token keyword">const</span> quaternion <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Quaternion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> matrix<span class="token punctuation">,</span> position<span class="token punctuation">,</span> fov <span class="token punctuation">}</span> <span class="token operator">=</span> camera<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> clientHeight <span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">;</span>

  <span class="token comment">/* 1.基于鼠标拖拽距离计算旋转量 */</span>
  <span class="token comment">// 鼠标位移距离在画布中的占比</span>
  <span class="token keyword">const</span> ratioY <span class="token operator">=</span> <span class="token operator">-</span>y <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
  <span class="token comment">//基于高度的x位置比-用于旋转量的计算</span>
  <span class="token keyword">const</span> ratioBaseHeight <span class="token operator">=</span> x <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
  <span class="token comment">//位移量</span>
  <span class="token keyword">const</span> ratioLen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span>ratioBaseHeight<span class="token punctuation">,</span> ratioY<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//旋转量</span>
  <span class="token keyword">const</span> angle <span class="token operator">=</span> ratioLen <span class="token operator">*</span> pi2<span class="token punctuation">;</span>

  <span class="token comment">/* 2.将鼠标在画布中的位移量转目标平面位移量 */</span>
  <span class="token comment">//视线长度：相机视点到目标点的距离</span>
  <span class="token keyword">const</span> sightLen <span class="token operator">=</span> position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//视椎体垂直夹角的一半(弧度)</span>
  <span class="token keyword">const</span> halfFov <span class="token operator">=</span> <span class="token punctuation">(</span>fov <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">360</span><span class="token punctuation">;</span>
  <span class="token comment">//目标平面的高度</span>
  <span class="token keyword">const</span> targetHeight <span class="token operator">=</span> sightLen <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">tan</span><span class="token punctuation">(</span>halfFov<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token comment">//目标平面与画布的高度比</span>
  <span class="token keyword">const</span> ratio <span class="token operator">=</span> targetHeight <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
  <span class="token comment">//画布位移量转目标平面位移量</span>
  <span class="token keyword">const</span> distanceLeft <span class="token operator">=</span> x <span class="token operator">*</span> ratio<span class="token punctuation">;</span>
  <span class="token keyword">const</span> distanceUp <span class="token operator">=</span> <span class="token operator">-</span>y <span class="token operator">*</span> ratio<span class="token punctuation">;</span>

  <span class="token comment">/* 3.将鼠标在目标平面中的位移量转世界坐标，并从中提取鼠标在世界坐标系中的位移方向 */</span>
  <span class="token comment">// 相机本地坐标系的x,y轴</span>
  <span class="token keyword">const</span> mx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> my <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将鼠标在相机世界的x,y轴向的位移量转换为世界坐标位</span>
  <span class="token keyword">const</span> vx <span class="token operator">=</span> mx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span>distanceLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> vy <span class="token operator">=</span> my<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span>distanceUp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//鼠标在世界坐标系中的位移方向-x轴</span>
  <span class="token keyword">const</span> moveDir <span class="token operator">=</span> vx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* 4.基于位移方向和视线获取旋转轴 */</span>
  <span class="token comment">//目标点到视点的单位向量-z轴</span>
  <span class="token keyword">const</span> eyeDir <span class="token operator">=</span> position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//基于位移方向和视线获取旋转轴-上方向y轴</span>
  <span class="token keyword">const</span> axis <span class="token operator">=</span> moveDir<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>eyeDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* 5.基于旋转轴和旋转量更新四元数 */</span>
  quaternion<span class="token punctuation">.</span><span class="token function">setFromAxisAngle</span><span class="token punctuation">(</span>axis<span class="token punctuation">,</span> angle<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//基于平移量平移相机</span>
  target<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//基于旋转量旋转相机</span>
  <span class="token keyword">const</span> rotateOffset <span class="token operator">=</span> camera<span class="token punctuation">.</span>position
    <span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">applyQuaternion</span><span class="token punctuation">(</span>quaternion<span class="token punctuation">)</span><span class="token punctuation">;</span>

  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rotateOffset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span>up<span class="token punctuation">.</span><span class="token function">applyQuaternion</span><span class="token punctuation">(</span>quaternion<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//更新投影视图矩阵</span>
  camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">,</span> camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//重置旋转量和平移量</span>
  quaternion<span class="token punctuation">.</span><span class="token function">setFromRotationMatrix</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  panOffset<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 渲染</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><h2 id="十七、封装相机轨道对象" tabindex="-1"><a class="header-anchor" href="#十七、封装相机轨道对象" aria-hidden="true">#</a> 十七、封装相机轨道对象</h2><p>参考 three.js 里的 OrbitControls 对象，封装一个轨道控制器出来。<br> 至于轨迹球的封装，可以参考着 TrackballControls 来实现。</p><p><strong><code>正交相机轨道和透视相机轨道差异对比</code></strong>：</p><ol><li>旋转轨道</li></ol><ul><li>正交相机和透视相机的旋转轨道都是一样的，都是使用球坐标，让相机视点围绕目标点做的旋转。</li></ul><ol start="2"><li>位移轨道</li></ol><ul><li>正交相机的位移轨道是鼠标从 canvas 画布到近裁剪面，再到世界坐标系的位移量的转换，最后这个位移量会同时作用于相机的目标点和视点。</li><li>透视相机的位移轨道是鼠标从 canvas 画布到目标平面，再到世界坐标系的位移量的转换，最后这个位移量会同时作用于相机的目标点和视点。</li></ul><ol start="3"><li>缩放轨道</li></ol><ul><li>正交相机的缩放轨道是通过对其可视区域的宽高尺寸的缩放实现的。</li><li>透视相机的缩放轨道是通过相机视点在视线上的位移实现的。</li></ul><h3 id="_1-轨道控制器的封装" tabindex="-1"><a class="header-anchor" href="#_1-轨道控制器的封装" aria-hidden="true">#</a> 1.轨道控制器的封装</h3><details class="custom-container details"><summary>代码实现</summary><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Matrix4<span class="token punctuation">,</span>
  Vector2<span class="token punctuation">,</span>
  Vector3<span class="token punctuation">,</span>
  Spherical<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;https://unpkg.com/three/build/three.module.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pi2 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pvMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">defAttr</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">camera</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">dom</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">mouseButtons</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;rotate&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;pan&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">dragStart</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">dragEnd</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">panOffset</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">screenSpacePanning</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">zoomScale</span><span class="token operator">:</span> <span class="token number">0.95</span><span class="token punctuation">,</span>
  <span class="token literal-property property">spherical</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Spherical</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">rotateDir</span><span class="token operator">:</span> <span class="token string">&quot;xy&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">OrbitControls</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">defAttr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateSpherical</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">updateSpherical</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> spherical<span class="token punctuation">,</span> camera<span class="token punctuation">,</span> target <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    spherical<span class="token punctuation">.</span><span class="token function">setFromVector3</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">pointerdown</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">,</span> button <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> dragStart<span class="token punctuation">,</span> mouseButtons <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    dragStart<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> mouseButtons<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">pointermove</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      dragStart<span class="token punctuation">,</span>
      dragEnd<span class="token punctuation">,</span>
      state<span class="token punctuation">,</span>
      <span class="token literal-property property">camera</span><span class="token operator">:</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    dragEnd<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">&quot;pan&quot;</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pan</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>dragStart<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">&quot;rotate&quot;</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>dragStart<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    dragStart<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">pointerup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">wheel</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> deltaY <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      zoomScale<span class="token punctuation">,</span>
      <span class="token literal-property property">camera</span><span class="token operator">:</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> scale <span class="token operator">=</span> deltaY <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> zoomScale <span class="token operator">:</span> <span class="token number">1</span> <span class="token operator">/</span> zoomScale<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">dolly</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">(</span>scale<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">dollyPerspectiveCamera</span><span class="token punctuation">(</span><span class="token parameter">dollyScale</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>spherical<span class="token punctuation">.</span>radius <span class="token operator">*=</span> dollyScale<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">dollyOrthographicCamera</span><span class="token punctuation">(</span><span class="token parameter">dollyScale</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> camera <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    camera<span class="token punctuation">.</span>zoom <span class="token operator">*=</span> dollyScale<span class="token punctuation">;</span>
    camera<span class="token punctuation">.</span><span class="token function">updateProjectionMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">panPerspectiveCamera</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">camera</span><span class="token operator">:</span> <span class="token punctuation">{</span> matrix<span class="token punctuation">,</span> position<span class="token punctuation">,</span> fov<span class="token punctuation">,</span> up <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">dom</span><span class="token operator">:</span> <span class="token punctuation">{</span> clientHeight <span class="token punctuation">}</span><span class="token punctuation">,</span>
      panOffset<span class="token punctuation">,</span>
      screenSpacePanning<span class="token punctuation">,</span>
      target<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token comment">//视线长度：相机视点到目标点的距离</span>
    <span class="token keyword">const</span> sightLen <span class="token operator">=</span> position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//视椎体垂直夹角的一半(弧度)</span>
    <span class="token keyword">const</span> halfFov <span class="token operator">=</span> <span class="token punctuation">(</span>fov <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">360</span><span class="token punctuation">;</span>
    <span class="token comment">//目标平面的高度</span>
    <span class="token keyword">const</span> targetHeight <span class="token operator">=</span> sightLen <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">tan</span><span class="token punctuation">(</span>halfFov<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token comment">//目标平面与画布的高度比</span>
    <span class="token keyword">const</span> ratio <span class="token operator">=</span> targetHeight <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
    <span class="token comment">//画布位移量转目标平面位移量</span>
    <span class="token keyword">const</span> distanceLeft <span class="token operator">=</span> x <span class="token operator">*</span> ratio<span class="token punctuation">;</span>
    <span class="token keyword">const</span> distanceUp <span class="token operator">=</span> y <span class="token operator">*</span> ratio<span class="token punctuation">;</span>

    <span class="token comment">//相机平移方向</span>
    <span class="token comment">//鼠标水平运动时，按照相机本地坐标的x轴平移相机</span>
    <span class="token keyword">const</span> mx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//鼠标水平运动时，按照相机本地坐标的y轴，或者-z轴平移相机</span>
    <span class="token keyword">const</span> myOrz <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>screenSpacePanning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//y轴，正交相机中默认</span>
      myOrz<span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//-z轴，透视相机中默认</span>
      myOrz<span class="token punctuation">.</span><span class="token function">crossVectors</span><span class="token punctuation">(</span>up<span class="token punctuation">,</span> mx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//目标平面位移量转世界坐标</span>
    <span class="token keyword">const</span> vx <span class="token operator">=</span> mx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span><span class="token operator">-</span>distanceLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> vy <span class="token operator">=</span> myOrz<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span>distanceUp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    panOffset<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>vx<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">panOrthographicCamera</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">camera</span><span class="token operator">:</span> <span class="token punctuation">{</span> right<span class="token punctuation">,</span> left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> matrix<span class="token punctuation">,</span> up <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">dom</span><span class="token operator">:</span> <span class="token punctuation">{</span> clientWidth<span class="token punctuation">,</span> clientHeight <span class="token punctuation">}</span><span class="token punctuation">,</span>
      panOffset<span class="token punctuation">,</span>
      screenSpacePanning<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> cameraW <span class="token operator">=</span> right <span class="token operator">-</span> left<span class="token punctuation">;</span>
    <span class="token keyword">const</span> cameraH <span class="token operator">=</span> top <span class="token operator">-</span> bottom<span class="token punctuation">;</span>
    <span class="token keyword">const</span> ratioX <span class="token operator">=</span> x <span class="token operator">/</span> clientWidth<span class="token punctuation">;</span>
    <span class="token keyword">const</span> ratioY <span class="token operator">=</span> y <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
    <span class="token keyword">const</span> distanceLeft <span class="token operator">=</span> ratioX <span class="token operator">*</span> cameraW<span class="token punctuation">;</span>
    <span class="token keyword">const</span> distanceUp <span class="token operator">=</span> ratioY <span class="token operator">*</span> cameraH<span class="token punctuation">;</span>
    <span class="token keyword">const</span> mx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> vx <span class="token operator">=</span> mx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span><span class="token operator">-</span>distanceLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> vy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>screenSpacePanning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vy<span class="token punctuation">.</span><span class="token function">setFromMatrixColumn</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      vy<span class="token punctuation">.</span><span class="token function">crossVectors</span><span class="token punctuation">(</span>up<span class="token punctuation">,</span> mx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    vy<span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span>distanceUp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    panOffset<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>vx<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">dom</span><span class="token operator">:</span> <span class="token punctuation">{</span> clientHeight <span class="token punctuation">}</span><span class="token punctuation">,</span>
      spherical<span class="token punctuation">,</span>
      rotateDir<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> deltaT <span class="token operator">=</span> <span class="token punctuation">(</span>pi2 <span class="token operator">*</span> x<span class="token punctuation">)</span> <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
    <span class="token keyword">const</span> deltaP <span class="token operator">=</span> <span class="token punctuation">(</span>pi2 <span class="token operator">*</span> y<span class="token punctuation">)</span> <span class="token operator">/</span> clientHeight<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rotateDir<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      spherical<span class="token punctuation">.</span>theta <span class="token operator">-=</span> deltaT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rotateDir<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;y&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> phi <span class="token operator">=</span> spherical<span class="token punctuation">.</span>phi <span class="token operator">-</span> deltaP<span class="token punctuation">;</span>
      spherical<span class="token punctuation">.</span>phi <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>
        Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">0.99999999</span><span class="token punctuation">,</span> 
        Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.00000001</span><span class="token punctuation">,</span> phi<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> camera<span class="token punctuation">,</span> target<span class="token punctuation">,</span> spherical<span class="token punctuation">,</span> panOffset <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">//基于平移量平移相机</span>
    target<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>panOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//基于球坐标缩放相机</span>
    <span class="token keyword">const</span> rotateOffset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromSpherical</span><span class="token punctuation">(</span>spherical<span class="token punctuation">)</span><span class="token punctuation">;</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rotateOffset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//更新投影视图矩阵</span>
    camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    camera<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//重置旋转量和平移量</span>
    spherical<span class="token punctuation">.</span><span class="token function">setFromVector3</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    panOffset<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">camera</span><span class="token operator">:</span> <span class="token punctuation">{</span> projectionMatrix<span class="token punctuation">,</span> matrixWorldInverse <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> pvMatrix<span class="token punctuation">.</span><span class="token function">multiplyMatrices</span><span class="token punctuation">(</span>projectionMatrix<span class="token punctuation">,</span> matrixWorldInverse<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br></div></div></details><h3 id="_2-轨道控制器的实例化" tabindex="-1"><a class="header-anchor" href="#_2-轨道控制器的实例化" aria-hidden="true">#</a> 2.轨道控制器的实例化</h3><p>OrbitControls 对象就像 three.js 里的样，可以自动根据相机类型去做相应的轨道变换。</p><details class="custom-container details"><summary>代码实现</summary><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* 透视相机 */</span>
<span class="token comment">/*
	const eye = new Vector3(0, 0.5, 1)
    const target = new Vector3(0, 0, -2.5)
    const up = new Vector3(0, 1, 0)
    const [fov, aspect, near, far] = [
      45,
      canvas.width / canvas.height,
      1,
      20
    ]
    const camera = new PerspectiveCamera(fov, aspect, near, far)
    camera.position.copy(eye)
*/</span>

<span class="token comment">/* 正交相机 */</span>
<span class="token keyword">const</span> halfH <span class="token operator">=</span> <span class="token number">2</span>
<span class="token keyword">const</span> ratio <span class="token operator">=</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height
<span class="token keyword">const</span> halfW <span class="token operator">=</span> halfH <span class="token operator">*</span> ratio
<span class="token keyword">const</span> <span class="token punctuation">[</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token operator">-</span>halfW<span class="token punctuation">,</span> halfW<span class="token punctuation">,</span> halfH<span class="token punctuation">,</span> <span class="token operator">-</span>halfH<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span>
<span class="token punctuation">]</span>
<span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrthographicCamera</span><span class="token punctuation">(</span>
    left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far
<span class="token punctuation">)</span>
camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span>

<span class="token keyword">const</span> pvMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

……

<span class="token comment">/* 实例化轨道控制器 */</span>
<span class="token keyword">const</span> orbit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrbitControls</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    camera<span class="token punctuation">,</span>
    target<span class="token punctuation">,</span>
    <span class="token literal-property property">dom</span><span class="token operator">:</span> canvas<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
pvMatrix<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">/* 取消右击菜单的显示 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;contextmenu&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">/* 指针按下时，设置拖拽起始位，获取轨道控制器状态。 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerdown&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">pointerdown</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">/* 指针移动时，若控制器处于平移状态，平移相机；若控制器处于旋转状态，旋转相机。 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointermove&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">pointermove</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
    pvMatrix<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerup&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">pointerup</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//滚轮事件</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;wheel&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">wheel</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
    pvMatrix<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div></details><h2 id="十八、顶点索引" tabindex="-1"><a class="header-anchor" href="#十八、顶点索引" aria-hidden="true">#</a> 十八、顶点索引</h2><h3 id="_1-顶点索引概念" tabindex="-1"><a class="header-anchor" href="#_1-顶点索引概念" aria-hidden="true">#</a> 1.顶点索引概念</h3><p>对于顶点索引的概念，在复合变换里 (用 js 实现的顶点索引功能) 的模型矩阵提过。</p><details class="custom-container details"><summary>webgl api代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  uniform mat4 u_ViewMatrix<span class="token punctuation">;</span>
  uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_ViewMatrix <span class="token operator">*</span> u_ModelMatrix <span class="token operator">*</span> a_Position<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../jsm/Utils.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span>
    Matrix4<span class="token punctuation">,</span>
    Vector3
  <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vertexShader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fragmentShader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 顶点库 （3个一组，代表x, y, z）</span>
  <span class="token keyword">const</span> verticeLib <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 顶点索引集合，每一个数字对应每一组顶点（3个）</span>
  <span class="token keyword">const</span> indices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>

    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span>
    <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span>
    <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span>

    <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span>
    <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span>
    <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">4</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> vertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> verticeLib<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 视图矩阵和模型矩阵</span>
  <span class="token keyword">const</span> u_ViewMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;u_ViewMatrix&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> u_ModelMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;u_ModelMatrix&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> modelMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  modelMatrix<span class="token punctuation">.</span><span class="token function">makeScale</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ViewMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> viewMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ModelMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> modelMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//建立缓冲区对象</span>
  <span class="token keyword">const</span> indicesBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//把缓冲区绑定到webgl 上下文对象</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ELEMENT_ARRAY_BUFFER</span><span class="token punctuation">,</span> indicesBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//往缓冲区写数据</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ELEMENT_ARRAY_BUFFER</span><span class="token punctuation">,</span> indices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//刷底色</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//绘图</span>
  gl<span class="token punctuation">.</span><span class="token function">drawElements</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">LINES</span><span class="token punctuation">,</span> indices<span class="token punctuation">.</span>length<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div><br><br><br><div class="highlight-line"> </div><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/120.png" alt=""></p><p>gl.drawElements()：<br><img src="/visual/webgl-share/121.png" alt=""></p></details><h3 id="_2-彩色立方体" tabindex="-1"><a class="header-anchor" href="#_2-彩色立方体" aria-hidden="true">#</a> 2.彩色立方体</h3><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  attribute vec4 a_Color<span class="token punctuation">;</span>
  uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
  uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
  varying vec4 v_Color<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_PvMatrix <span class="token operator">*</span> u_ModelMatrix <span class="token operator">*</span> a_Position<span class="token punctuation">;</span>
    v_Color <span class="token operator">=</span> a_Color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  varying vec4 v_Color<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor <span class="token operator">=</span> v_Color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../jsm/Utils.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span>
    Matrix4<span class="token punctuation">,</span>
    PerspectiveCamera<span class="token punctuation">,</span>
    Vector3
  <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> OrbitControls <span class="token keyword">from</span> <span class="token string">&#39;./jsm/OrbitControls.js&#39;</span><span class="token punctuation">;</span>

  <span class="token comment">/* 正常初始化着色器，打开深度测试*/</span>
  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vertexShader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fragmentShader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token function">initShaders</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//打开深度测试=&gt;深度测试可以解决物体的遮挡问题,不然后面的物体可能挡住前面的物体</span>
  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">/* 建立透视相机和轨道控制器 */</span>
  <span class="token comment">//透视相机 </span>
  <span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">45</span><span class="token punctuation">,</span>
    canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">20</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span><span class="token punctuation">;</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//实例化轨道控制器 </span>
  <span class="token keyword">const</span> orbit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrbitControls</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    camera<span class="token punctuation">,</span> target<span class="token punctuation">,</span>
    <span class="token literal-property property">dom</span><span class="token operator">:</span> canvas<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//取消右击菜单的显示 </span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;contextmenu&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">//指针按下时，设置拖拽起始位，获取轨道控制器状态</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerdown&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">pointerdown</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">//指针移动时,若控制器处于平移状态,平移相机；若控制器处于旋转状态,旋转相机</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointermove&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">pointermove</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">//指针抬起 </span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerup&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">pointerup</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">//滚轮事件</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;wheel&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">wheel</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>


  <span class="token comment">/* 声明顶点数据 vertices 和顶点索引 indexes */</span>
  <span class="token comment">//    v6----- v5</span>
  <span class="token comment">//   /|      /|</span>
  <span class="token comment">//  v1------v0|</span>
  <span class="token comment">//  | |     | |</span>
  <span class="token comment">//  | |v7---|-|v4</span>
  <span class="token comment">//  |/      |/</span>
  <span class="token comment">//  v2------v3</span>
  <span class="token keyword">const</span> vertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment">// v0 White</span>
    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment">// v1 Magenta</span>
    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment">// v2 Red</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment">// v3 Yellow</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment">// v4 Green</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment">// v5 Cyan</span>
    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment">// v6 Blue</span>
    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>   <span class="token comment">// v7 Black</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> indexes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span>    <span class="token comment">// front</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span>    <span class="token comment">// right</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token comment">// up</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token comment">// left</span>
    <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token comment">// down</span>
    <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span>     <span class="token comment">// back</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>


  <span class="token comment">/* 将顶点数据写入缓冲区，并将其中的点位和颜色数据分别分配给 
  *  a_Position 和 a_Color 
  */</span>
  <span class="token comment">//元素字节数</span>
  <span class="token keyword">const</span> elementBytes <span class="token operator">=</span> vertices<span class="token punctuation">.</span><span class="token constant">BYTES_PER_ELEMENT</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token constant">FSIZE</span> <span class="token operator">=</span> vertices<span class="token punctuation">.</span><span class="token constant">BYTES_PER_ELEMENT</span><span class="token punctuation">;</span>
  <span class="token comment">//系列尺寸</span>
  <span class="token keyword">const</span> verticeSize <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> colorSize <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token comment">//类目尺寸</span>
  <span class="token keyword">const</span> categorySize <span class="token operator">=</span> verticeSize <span class="token operator">+</span> colorSize<span class="token punctuation">;</span>
  <span class="token comment">//类目字节数</span>
  <span class="token keyword">const</span> categoryBytes <span class="token operator">=</span> categorySize <span class="token operator">*</span> elementBytes<span class="token punctuation">;</span>
  <span class="token comment">//系列字节索引位置</span>
  <span class="token keyword">const</span> verticeByteIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> colorByteIndex <span class="token operator">=</span> verticeSize <span class="token operator">*</span> elementBytes<span class="token punctuation">;</span>

  <span class="token comment">//顶点缓冲区</span>
  <span class="token keyword">const</span> vertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//将顶点缓冲区里的点位数据分配给a_Position</span>
  <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>
    a_Position<span class="token punctuation">,</span>
    verticeSize<span class="token punctuation">,</span>
    gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    categoryBytes<span class="token punctuation">,</span>
    verticeByteIndex
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//将顶点缓冲区里的颜色数据分配给a_Color</span>
  <span class="token keyword">const</span> a_Color <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Color&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>
    a_Color<span class="token punctuation">,</span>
    colorSize<span class="token punctuation">,</span>
    gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    categoryBytes<span class="token punctuation">,</span>
    colorByteIndex
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Color<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">/* 将顶点索引写入缓冲区 */</span>
  <span class="token comment">// 建立缓冲区对象</span>
  <span class="token keyword">const</span> indexesBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//把缓冲区绑定到webgl 上下文对象上</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ELEMENT_ARRAY_BUFFER</span><span class="token punctuation">,</span> indexesBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 往缓冲区写数据</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ELEMENT_ARRAY_BUFFER</span><span class="token punctuation">,</span> indexes<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  
  <span class="token comment">/* 建立模型矩阵，并传递给片元着色器 */</span>
  <span class="token keyword">const</span> u_ModelMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;u_ModelMatrix&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> modelMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  modelMatrix<span class="token punctuation">.</span><span class="token function">makeScale</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ModelMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> modelMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">/* 建立投影视图矩阵，并传递给片元着色器 */</span>
  <span class="token keyword">const</span> u_PvMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>program<span class="token punctuation">,</span> <span class="token string">&#39;u_PvMatrix&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_PvMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">/* 用连续渲染的方法绘图 */</span>
  <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">ani</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    modelMatrix<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeRotationY</span><span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ModelMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> modelMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">drawElements</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> indexes<span class="token punctuation">.</span>length<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>ani<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/122.gif" alt=""></p><p>注意：<br> a_Color 和 a_Position 一一对应的，一个顶点，一个颜色，所以用 attribute 声明的 a_Color<br> 如果整个立方体都是一个颜色，直接在片元着色器里用 uniform 声明就好了</p></details><h2 id="十九、多着色器" tabindex="-1"><a class="header-anchor" href="#十九、多着色器" aria-hidden="true">#</a> 十九、多着色器</h2><p>在实际开发中，不可能只用一套着色器做项目的，比如场景里有两个三角形，一个三角形需要着纯色，一个三角形需要着纹理。</p><p><img src="/visual/webgl-share/123.png" alt=""></p><h3 id="_1-多着色器绘图" tabindex="-1"><a class="header-anchor" href="#_1-多着色器绘图" aria-hidden="true">#</a> 1.多着色器绘图</h3><h4 id="_1-1准备两套着色器" tabindex="-1"><a class="header-anchor" href="#_1-1准备两套着色器" aria-hidden="true">#</a> 1.1准备两套着色器</h4><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- 着纯色 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>solidVertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>solidFragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 着纹理 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>textureVertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  attribute vec2 a_Pin<span class="token punctuation">;</span>
  varying vec2 v_Pin<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
    v_Pin <span class="token operator">=</span> a_Pin<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>textureFragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform sampler2D u_Sampler<span class="token punctuation">;</span>
  varying vec2 v_Pin<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span> <span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h4 id="_1-2绘制纯色三角形" tabindex="-1"><a class="header-anchor" href="#_1-2绘制纯色三角形" aria-hidden="true">#</a> 1.2绘制纯色三角形</h4><ol><li>建立程序对象，并应用</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> solidVsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;solidVertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
<span class="token keyword">const</span> solidFsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;solidFragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
<span class="token keyword">const</span> solidProgram <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> solidVsSource<span class="token punctuation">,</span> solidFsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>solidProgram<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>createProgram() 方法是基于一套着色器建立程序对象的方法：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createProgram</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//创建程序对象</span>
  <span class="token keyword">const</span> program <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//建立着色对象</span>
  <span class="token keyword">const</span> vertexShader <span class="token operator">=</span> <span class="token function">loadShader</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">VERTEX_SHADER</span><span class="token punctuation">,</span> vsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> fragmentShader <span class="token operator">=</span> <span class="token function">loadShader</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FRAGMENT_SHADER</span><span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//把顶点着色对象装进程序对象中</span>
  gl<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> vertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//把片元着色对象装进程序对象中</span>
  gl<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> fragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//连接webgl上下文对象和程序对象</span>
  gl<span class="token punctuation">.</span><span class="token function">linkProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> program<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>之前初始化着色器方法 initShaders() 只是比上面的方法多了一个应用程序对象的步骤：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>这里之所以把启用程序的步骤提取出来，是因为一套着色器对应着一个程序对象。<br> 而一个 webgl 上下文对象，是可以依次应用多个程序对象的。<br> 通过不同程序对象，可以绘制不同材质的图形。</p><ol start="2"><li>用当前的程序对象绘制图形</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> solidVertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> 
  <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> 
  <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> solidVertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> solidVertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> solidVertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> solidPosition <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>solidProgram<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>solidPosition<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>solidPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>因为后面还需要绘制一个纹理图形，纹理图形是需要等纹理加载成功才能绘制的。<br> 这会造成两个三角形的异步绘制，这不是我们想要的，因为异步会把之前三角形的缓冲数据给清理掉。<br> 因此，需要同步绘制两个三角形。</p><p>先把上面的绘图方法封装到一个函数里，等纹理三角形的图片加载成功了，再执行。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">drawSolid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* 1.建立程序对象，并应用 */</span>
  <span class="token keyword">const</span> solidVsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;solidVertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> solidFsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>
    <span class="token string">&quot;solidFragmentShader&quot;</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> solidProgram <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> solidVsSource<span class="token punctuation">,</span> solidFsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>solidProgram<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* 2.用当前的程序对象绘制图形 */</span>
  <span class="token keyword">const</span> solidVertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> solidVertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> solidVertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> solidVertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> solidPosition <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>solidProgram<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>solidPosition<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>solidPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="_1-3绘制纹理三角形" tabindex="-1"><a class="header-anchor" href="#_1-3绘制纹理三角形" aria-hidden="true">#</a> 1.3绘制纹理三角形</h4><p>纹理三角形的绘制原理和纯色三角形一样，要用一套新的着色器建立一个新的程序对象，然后用这个新的程序对象进行绘图。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">drawTexture</span><span class="token punctuation">(</span><span class="token parameter">image</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* 1.建立程序对象，并应用 */</span>
  <span class="token keyword">const</span> textureVsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>
    <span class="token string">&quot;textureVertexShader&quot;</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> textureFsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>
    <span class="token string">&quot;textureFragmentShader&quot;</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> textureProgram <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> textureVsSource<span class="token punctuation">,</span> textureFsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>textureProgram<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* 2.用当前的程序对象绘制图形 */</span>
  <span class="token comment">// 顶点</span>
  <span class="token keyword">const</span> textureVertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> textureVertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> textureVertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> textureVertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> texturePosition <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>textureProgram<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>texturePosition<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>texturePosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 图钉</span>
  <span class="token keyword">const</span> pins <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> pinBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> pinBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> pins<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> pin <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>textureProgram<span class="token punctuation">,</span> <span class="token string">&quot;a_Pin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>pin<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 纹理</span>
  gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> u_Sampler <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>textureProgram<span class="token punctuation">,</span> <span class="token string">&quot;u_Sampler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h4 id="_1-4同步绘图" tabindex="-1"><a class="header-anchor" href="#_1-4同步绘图" aria-hidden="true">#</a> 1.4同步绘图</h4><p>当纹理图形加载成功后，进行同步绘图。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;./images/erha.jpg&quot;</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">drawSolid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">drawTexture</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>想给场景中的图形添加一个动画，比如想让纯色三角形不断的变换颜色。<br> 首先要给纯色三角形的片元着色器开一个 uniform 变量。</p><p>然后接下来是不是就要不断修改这个 uniform 变量，然后执行上面的 drawSolid()和 drawTexture(image) 方法呢？</p><h3 id="_2-多着色器动画" tabindex="-1"><a class="header-anchor" href="#_2-多着色器动画" aria-hidden="true">#</a> 2.多着色器动画</h3><p>在上面的绘图方法中，很多操作都是不需要重复执行的，比如程序对象在建立之后，就不需要再建立了，后面在绘图的时候再接着用。</p><h4 id="_2-1给纯色三角形添加一个代表时间的-uniform-变量" tabindex="-1"><a class="header-anchor" href="#_2-1给纯色三角形添加一个代表时间的-uniform-变量" aria-hidden="true">#</a> 2.1给纯色三角形添加一个代表时间的 uniform 变量</h4><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>solidFragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
     uniform float u_Time<span class="token punctuation">;</span>
     <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       float r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">sin</span><span class="token punctuation">(</span>u_Time<span class="token operator">/</span><span class="token number">200.0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
       gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="_2-2声明不需要重复获取变量" tabindex="-1"><a class="header-anchor" href="#_2-2声明不需要重复获取变量" aria-hidden="true">#</a> 2.2声明不需要重复获取变量</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> solidProgram<span class="token punctuation">,</span>
  solidVertexBuffer<span class="token punctuation">,</span>
  solidPosition<span class="token punctuation">,</span>
  solidTime <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> textureProgram<span class="token punctuation">,</span>
  textureVertexBuffer<span class="token punctuation">,</span>
  texturePosition <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> pinBuffer<span class="token punctuation">,</span>
  pin <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>程序对象、缓冲对象、从着色器中获取的 attribute 变量和 uniform 变量都是不需要重复获取的。</p><h4 id="_2-3初始化方法" tabindex="-1"><a class="header-anchor" href="#_2-3初始化方法" aria-hidden="true">#</a> 2.3初始化方法</h4><p>把绘制纯色三角形的方法变成初始化方法</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">initSolid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* 1.建立程序对象*/</span>
  <span class="token keyword">const</span> solidVsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;solidVertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> solidFsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>
    <span class="token string">&quot;solidFragmentShader&quot;</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  solidProgram <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> solidVsSource<span class="token punctuation">,</span> solidFsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>solidProgram<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* 2.用当前的程序对象绘制图形 */</span>
  <span class="token keyword">const</span> solidVertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  solidVertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> solidVertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> solidVertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  solidPosition <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>solidProgram<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>solidPosition<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>solidPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>

  solidTime <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>solidProgram<span class="token punctuation">,</span> <span class="token string">&quot;u_Time&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* gl.clear(gl.COLOR_BUFFER_BIT)
       gl.drawArrays(gl.TRIANGLES, 0, 3) */</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>把绘制纹理三角形的方法变成初始化方法</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">initTexture</span><span class="token punctuation">(</span><span class="token parameter">image</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* 1.建立程序对象，并应用 */</span>
  <span class="token keyword">const</span> textureVsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>
    <span class="token string">&quot;textureVertexShader&quot;</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> textureFsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>
    <span class="token string">&quot;textureFragmentShader&quot;</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  textureProgram <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> textureVsSource<span class="token punctuation">,</span> textureFsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>textureProgram<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* 2.用当前的程序对象绘制图形 */</span>
  <span class="token comment">// 顶点</span>
  <span class="token keyword">const</span> textureVertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  textureVertexBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> textureVertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> textureVertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  texturePosition <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>textureProgram<span class="token punctuation">,</span> <span class="token string">&quot;a_Position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>texturePosition<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>texturePosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 图钉</span>
  <span class="token keyword">const</span> pins <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pinBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> pinBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> pins<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pin <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>textureProgram<span class="token punctuation">,</span> <span class="token string">&quot;a_Pin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>pin<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 纹理</span>
  gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> u_Sampler <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>textureProgram<span class="token punctuation">,</span> <span class="token string">&quot;u_Sampler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// gl.drawArrays(gl.TRIANGLES, 0, 3)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>上面已经注释掉的是需要在绘图时重复执行的。</p><h4 id="_2-4把需要重复执行的方法收集一下-用于连续渲染" tabindex="-1"><a class="header-anchor" href="#_2-4把需要重复执行的方法收集一下-用于连续渲染" aria-hidden="true">#</a> 2.4把需要重复执行的方法收集一下，用于连续渲染</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">time <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>solidProgram<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> solidVertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>solidPosition<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniform1f</span><span class="token punctuation">(</span>solidTime<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>textureProgram<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> textureVertexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>texturePosition<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> pinBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>pin<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>由上可知，在连续渲染时，必须要有的操作：</p><ul><li>clear() 清理画布</li><li>useProgram() 应用程序对象</li><li>bindBuffer() 绑定缓冲区对象</li><li>vertexAttribPointer() 告诉显卡从当前绑定的缓冲区（bindBuffer()指定的缓冲区）中读取顶点数据</li><li>drawArrays() 绘图方法</li></ul><p>若 attribute 变量、uniform 变量或者图片发生了变化，那就需要对其进行更新。</p><h4 id="_2-5当纹理图像加载成功后-初始化绘图方法-连续绘图" tabindex="-1"><a class="header-anchor" href="#_2-5当纹理图像加载成功后-初始化绘图方法-连续绘图" aria-hidden="true">#</a> 2.5当纹理图像加载成功后，初始化绘图方法，连续绘图</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;./images/erha.jpg&quot;</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">initSolid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">initTexture</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="二十、基于-webgl-的轻量级架构" tabindex="-1"><a class="header-anchor" href="#二十、基于-webgl-的轻量级架构" aria-hidden="true">#</a> 二十、基于 webgl 的轻量级架构</h2><p>之前简单架构 Poly 已经无法满足基本需求，需要在其基础上再做一下升级。<br> 下图便是要搭建的框架，参考了 three.js，但要简单很多。</p><p>意欲先用它整几个案例练练手再说，等以后遇到满足不了的需求了，再做深度扩展。</p><p><img src="/visual/webgl-share/124.png" alt=""></p><ol><li>场景 Scene：包含所有的三维对象，并负责绘图</li><li>三维对象 Obj3D：包含几何体 Geo 和材质 Mat，对两者进行统一管理</li><li>几何体 Geo：对应 attribute 顶点数据</li><li>材质 Mat：包含程序对象，对应 uniform 变量</li></ol><h3 id="_1-几何体-geo" tabindex="-1"><a class="header-anchor" href="#_1-几何体-geo" aria-hidden="true">#</a> 1.几何体 Geo</h3><h4 id="_1-1默认属性" tabindex="-1"><a class="header-anchor" href="#_1-1默认属性" aria-hidden="true">#</a> 1.1默认属性</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">defAttr</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">count</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">drawType</span><span class="token operator">:</span><span class="token string">&#39;drawArrays&#39;</span><span class="token punctuation">,</span><span class="token comment">//drawElements</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Geo</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">defAttr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> attr<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  ……
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>data 顶点数据</li><li>count 顶点总数</li><li>index 顶点索引数据 <ul><li>默认为 null，用 drawArrays 的方式绘图</li><li>若不为 null，用 drawElements 的方式绘图</li></ul></li><li>drawType 绘图方式 <ul><li>drawArrays 使用顶点集合绘图，默认</li><li>drawElements，使用顶点索引绘图</li></ul></li></ul><p>data 的数据结构如下：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">array</span><span class="token operator">:</span>类型数组<span class="token punctuation">,</span>
    <span class="token literal-property property">size</span><span class="token operator">:</span>矢量长度<span class="token punctuation">,</span>
    <span class="token literal-property property">buffer</span><span class="token operator">:</span>缓冲对象<span class="token punctuation">,</span>
    <span class="token literal-property property">location</span><span class="token operator">:</span>attribute变量<span class="token punctuation">,</span>
    needUpdate：<span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">a_Color</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">array</span><span class="token operator">:</span>类型数组<span class="token punctuation">,</span>
    <span class="token literal-property property">size</span><span class="token operator">:</span>矢量长度<span class="token punctuation">,</span>
    <span class="token literal-property property">buffer</span><span class="token operator">:</span>缓冲对象<span class="token punctuation">,</span>
    <span class="token literal-property property">location</span><span class="token operator">:</span>attribute变量<span class="token punctuation">,</span>
    needUpdate：<span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  ……
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ul><li>array 存储所有的 attribute 数据</li><li>size 构成一个顶点的所有分量的数目</li><li>buffer 用 createBuffer() 方法建立的缓冲对象</li><li>location 用 getAttribLocation() 方法获取的 attribute 变量</li><li>needUpdate 在连续渲染时，是否更新缓冲对象</li></ul><p>index 数据结构</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token literal-property property">array</span><span class="token operator">:</span>类型数组<span class="token punctuation">,</span>
    <span class="token literal-property property">buffer</span><span class="token operator">:</span>缓冲对象<span class="token punctuation">,</span>
    needUpdate：<span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_1-2初始化方法" tabindex="-1"><a class="header-anchor" href="#_1-2初始化方法" aria-hidden="true">#</a> 1.2初始化方法</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span>program</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initData</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span>program<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initIndex</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><p>init(gl,program) 方法会在场景 Scene 初始化时被调用</p><ul><li>gl：webgl 上下文对象，会通过场景 Scene 的初始化方法传入</li><li>program：程序对象，会通过 Obj3D 的初始化方法传入</li></ul></li><li><p>initData() 初始化顶点索引</p><ul><li>初始化顶点数量 count 和绘图方式 drawType</li><li>若顶点索引不为 null，就建立缓冲区对象，向其中写入顶点索引数据</li></ul></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">initData</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span>program</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> attr<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        attr<span class="token punctuation">.</span>buffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> attr<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span>
        gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> attr<span class="token punctuation">.</span>array<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> location <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>
            location<span class="token punctuation">,</span>
            attr<span class="token punctuation">.</span>size<span class="token punctuation">,</span>
            gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span>
            <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span>
        <span class="token punctuation">)</span>
        gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span>
        attr<span class="token punctuation">.</span>location<span class="token operator">=</span>location
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>initIndex() 初始化 attribute 变量</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">initIndex</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> index <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">=</span>index<span class="token punctuation">.</span>array<span class="token punctuation">.</span>length
        <span class="token keyword">this</span><span class="token punctuation">.</span>drawType <span class="token operator">=</span> <span class="token string">&#39;drawElements&#39;</span>
        index<span class="token punctuation">.</span>buffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ELEMENT_ARRAY_BUFFER</span><span class="token punctuation">,</span> index<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span>
        gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ELEMENT_ARRAY_BUFFER</span><span class="token punctuation">,</span> index<span class="token punctuation">.</span>array<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> array<span class="token punctuation">,</span> size <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">]</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> array<span class="token punctuation">.</span>length <span class="token operator">/</span> size
        <span class="token keyword">this</span><span class="token punctuation">.</span>drawType<span class="token operator">=</span><span class="token string">&#39;drawArrays&#39;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_1-3更新方法-用于连续渲染" tabindex="-1"><a class="header-anchor" href="#_1-3更新方法-用于连续渲染" aria-hidden="true">#</a> 1.3更新方法，用于连续渲染</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateData</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateIndex</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>updateData(gl) 更新 attribute 变量</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">updateData</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> attr <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> buffer<span class="token punctuation">,</span> location<span class="token punctuation">,</span> size<span class="token punctuation">,</span> needUpdate<span class="token punctuation">,</span>array <span class="token punctuation">}</span> <span class="token operator">=</span> attr
        gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>needUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            attr<span class="token punctuation">.</span>needUpdate <span class="token operator">=</span> <span class="token boolean">false</span>
            gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> array<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>
            location<span class="token punctuation">,</span>
            size<span class="token punctuation">,</span>
            gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span>
            <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>updateIndex(gl) 更新顶点索引</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">updateIndex</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>index<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ELEMENT_ARRAY_BUFFER</span><span class="token punctuation">,</span> index<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index<span class="token punctuation">.</span>needUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            index<span class="token punctuation">.</span>needUpdate <span class="token operator">=</span> <span class="token boolean">false</span>
            gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ELEMENT_ARRAY_BUFFER</span><span class="token punctuation">,</span> index<span class="token punctuation">.</span>array<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="_1-4设置-attribute-数据和顶点索引数据的方法" tabindex="-1"><a class="header-anchor" href="#_1-4设置-attribute-数据和顶点索引数据的方法" aria-hidden="true">#</a> 1.4设置 attribute 数据和顶点索引数据的方法</h4><p>setData(key,val) 设置 attribute 数据</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">setData</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span>val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> obj <span class="token operator">=</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
    obj<span class="token punctuation">.</span>needUpdate<span class="token operator">=</span><span class="token boolean">true</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span>val<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>setIndex(val)设置顶点索引数据</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">setIndex</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>index<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        index<span class="token punctuation">.</span>needUpdate <span class="token operator">=</span> <span class="token boolean">true</span>
        index<span class="token punctuation">.</span>array<span class="token operator">=</span>val
        <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">=</span>index<span class="token punctuation">.</span>array<span class="token punctuation">.</span>length
        <span class="token keyword">this</span><span class="token punctuation">.</span>drawType <span class="token operator">=</span> <span class="token string">&#39;drawElements&#39;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> array<span class="token punctuation">,</span> size <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">]</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> array<span class="token punctuation">.</span>length <span class="token operator">/</span> size
        <span class="token keyword">this</span><span class="token punctuation">.</span>drawType<span class="token operator">=</span><span class="token string">&#39;drawArrays&#39;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_2-材质-mat" tabindex="-1"><a class="header-anchor" href="#_2-材质-mat" aria-hidden="true">#</a> 2.材质 Mat</h3><h4 id="_1-1默认属性-1" tabindex="-1"><a class="header-anchor" href="#_1-1默认属性-1" aria-hidden="true">#</a> 1.1默认属性</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">defAttr</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">&#39;TRIANGLES&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">maps</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Mat</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">defAttr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> attr<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  ……
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>program 程序对象</li><li>data uniform 数据</li><li>mode 图形的绘制方式，默认独立三角形。<br> 注：mode 也可以是数组，表示多种绘图方式，如[&#39;TRIANGLE_STRIP&#39;, &#39;POINTS&#39;]</li><li>maps 集合</li></ul><ol><li>data 数据结构：</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">u_Color</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform1f&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">location</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">needUpdate</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  ……
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>value uniform 数据值</li><li>type uniform 数据的写入方式</li><li>location 用 getUniformLocation() 方法获取的 uniform 变量</li><li>needUpdate 在连续渲染时，是否更新 uniform 变量</li></ul><ol start="2"><li>maps 数据结构:</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">u_Sampler</span><span class="token operator">:</span><span class="token punctuation">{</span>
    image<span class="token punctuation">,</span>
    format<span class="token punctuation">,</span>
    wrapS<span class="token punctuation">,</span>
    wrapT<span class="token punctuation">,</span>
    magFilter<span class="token punctuation">,</span>
    minFilter<span class="token punctuation">,</span>
    <span class="token literal-property property">needUpdate</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  ……
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>image 图形源</li><li>format 数据类型，默认 gl.RGB</li><li>wrapS 对应纹理对象的 TEXTURE_WRAP_S 属性</li><li>wrapT 对应纹理对象的 TEXTURE_WRAP_T 属性</li><li>magFilter 对应纹理对象的 TEXTURE_MAG_FILTER 属性</li><li>minFilter 对应纹理对象的 TEXTURE_MIN_FILTER 属性</li></ul><h4 id="_1-2初始化方法-1" tabindex="-1"><a class="header-anchor" href="#_1-2初始化方法-1" aria-hidden="true">#</a> 1.2初始化方法</h4><p>获取 uniform 变量，绑定到其所在的对象上。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>program<span class="token punctuation">,</span>data<span class="token punctuation">,</span>maps<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> obj<span class="token punctuation">]</span> <span class="token keyword">of</span> <span class="token punctuation">[</span><span class="token operator">...</span>Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">...</span>Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>maps<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        obj<span class="token punctuation">.</span>location <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        obj<span class="token punctuation">.</span>needUpdate<span class="token operator">=</span><span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_1-3更新方法-用于连续渲染-1" tabindex="-1"><a class="header-anchor" href="#_1-3更新方法-用于连续渲染-1" aria-hidden="true">#</a> 1.3更新方法，用于连续渲染</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateData</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateMaps</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>updateData(gl) 更新 uniform 变量</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">updateData</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> obj <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">.</span>needUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">continue</span> <span class="token punctuation">}</span>
        obj<span class="token punctuation">.</span>needUpdate<span class="token operator">=</span><span class="token boolean">false</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> value<span class="token punctuation">,</span> location <span class="token punctuation">}</span> <span class="token operator">=</span> obj
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;Matrix&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            gl<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            gl<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>updateMaps(gl) 更新纹理</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">updateMaps</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> maps <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>maps<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">map<span class="token punctuation">,</span> ind</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>map<span class="token punctuation">.</span>needUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
        map<span class="token punctuation">.</span>needUpdate <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span>
            format <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span>
            image<span class="token punctuation">,</span>
            wrapS<span class="token punctuation">,</span>
            wrapT<span class="token punctuation">,</span>
            magFilter<span class="token punctuation">,</span>
            minFilter<span class="token punctuation">,</span>
            location<span class="token punctuation">,</span>
        <span class="token punctuation">}</span> <span class="token operator">=</span> map

        gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">TEXTURE</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ind<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span>
        gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>
            gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            format<span class="token punctuation">,</span>
            format<span class="token punctuation">,</span>
            gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span>
            image
        <span class="token punctuation">)</span>
        wrapS<span class="token operator">&amp;&amp;</span>gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>
            gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
            gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span>
            wrapS
        <span class="token punctuation">)</span>
        wrapT<span class="token operator">&amp;&amp;</span>gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>
            gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
            gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span>
            wrapT
        <span class="token punctuation">)</span>
        magFilter<span class="token operator">&amp;&amp;</span>gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>
            gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
            gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span>
            magFilter
        <span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>minFilter <span class="token operator">||</span> minFilter <span class="token operator">&gt;</span> <span class="token number">9729</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            gl<span class="token punctuation">.</span><span class="token function">generateMipmap</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        minFilter<span class="token operator">&amp;&amp;</span>gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>
            gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
            gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span>
            minFilter
        <span class="token punctuation">)</span>
        gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> ind<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><h4 id="_1-4设置-uniform-数据和纹理的方法" tabindex="-1"><a class="header-anchor" href="#_1-4设置-uniform-数据和纹理的方法" aria-hidden="true">#</a> 1.4设置 uniform 数据和纹理的方法</h4><p>setData(key,val) 设置 uniform 数据</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">setData</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span>val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> obj <span class="token operator">=</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
    obj<span class="token punctuation">.</span>needUpdate<span class="token operator">=</span><span class="token boolean">true</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span>val<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>setMap(val)设置纹理</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">setMap</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span>val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> maps <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> obj <span class="token operator">=</span> maps<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
    obj<span class="token punctuation">.</span>needUpdate<span class="token operator">=</span><span class="token boolean">true</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span>val<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_3-三维对象-obj3d" tabindex="-1"><a class="header-anchor" href="#_3-三维对象-obj3d" aria-hidden="true">#</a> 3.三维对象 Obj3D</h3><p>obj3D 对象比较简单，主要负责对 Geo 对象和 Mat 对象的统一初始化和更新。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">defAttr</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">geo</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">mat</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Obj3D</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">defAttr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> mat<span class="token punctuation">,</span> geo <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    mat<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    geo<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> mat<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> mat<span class="token punctuation">,</span> geo <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    mat<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    geo<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_4-场景对象-scene" tabindex="-1"><a class="header-anchor" href="#_4-场景对象-scene" aria-hidden="true">#</a> 4.场景对象 Scene</h3><p>Scene 对象的主要功能就是收集所有的三维对象，然后画出来。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/*默认属性*/</span>
<span class="token keyword">const</span> <span class="token function-variable function">defAttr</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">gl</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Scene</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">attr <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">defAttr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> children<span class="token punctuation">,</span> gl <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      obj<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>objs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> children<span class="token punctuation">,</span> gl <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    objs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
      obj<span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      obj<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">remove</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> children <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> i <span class="token operator">=</span> children<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      children<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> mat <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      mat<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> gl<span class="token punctuation">,</span> children <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">geo</span><span class="token operator">:</span> <span class="token punctuation">{</span> drawType<span class="token punctuation">,</span> count <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">mat</span><span class="token operator">:</span> <span class="token punctuation">{</span> mode<span class="token punctuation">,</span> program <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span> <span class="token operator">=</span> obj<span class="token punctuation">;</span>
      gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
      obj<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> mode <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">[</span>drawType<span class="token punctuation">]</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> count<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        mode<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">[</span>drawType<span class="token punctuation">]</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> count<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">drawArrays</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> count<span class="token punctuation">,</span> mode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">[</span>mode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">drawElements</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> count<span class="token punctuation">,</span> mode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl<span class="token punctuation">.</span><span class="token function">drawElements</span><span class="token punctuation">(</span>gl<span class="token punctuation">[</span>mode<span class="token punctuation">]</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>我们依次解释一下上面的方法。</p><ul><li><p>Scene 对象的属性只有两个：</p><ul><li>gl：webgl 上下文对象</li><li>children：三维对象集合</li></ul></li><li><p>init() 初始化方法</p></li><li><p>add() 添加三维对象</p></li><li><p>remove() 删除三维对象</p></li><li><p>setUniform() 统一设置所有对象共有的属性，比如视图投影矩阵</p></li><li><p>draw() 绘图方法</p></li></ul><p>关于 webgl 的轻量级架构就先写到这，以后学到新的知识了，或者遇到新的需求了，再做升级。</p><h3 id="测试-1" tabindex="-1"><a class="header-anchor" href="#测试-1" aria-hidden="true">#</a> 测试 1</h3><p>可以基于之前多着色器的例子，测试一下刚才的 webgl 框架在多着色器中的应用。</p><ol><li>两套着色器</li></ol><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- 着纯色 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>solidVertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
  uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_PvMatrix <span class="token operator">*</span> u_ModelMatrix <span class="token operator">*</span> a_Position<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>solidFragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform float u_Time<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    float r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">sin</span><span class="token punctuation">(</span>u_Time <span class="token operator">/</span> <span class="token number">200.0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 着纹理 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>textureVertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  attribute vec2 a_Pin<span class="token punctuation">;</span>
  uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
  uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
  varying vec2 v_Pin<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_PvMatrix <span class="token operator">*</span> u_ModelMatrix <span class="token operator">*</span> a_Position<span class="token punctuation">;</span>
    v_Pin <span class="token operator">=</span> a_Pin<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>textureFragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform sampler2D u_Sampler<span class="token punctuation">;</span>
  varying vec2 v_Pin<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><ol start="2"><li>引入 js 模块</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createProgram <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../jsm/Utils.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Matrix4<span class="token punctuation">,</span>
  OrthographicCamera<span class="token punctuation">,</span>
  Vector3<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;https://unpkg.com/three/build/three.module.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> OrbitControls <span class="token keyword">from</span> <span class="token string">&quot;./jsm/OrbitControls.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Mat <span class="token keyword">from</span> <span class="token string">&quot;./jsm/Mat.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Geo <span class="token keyword">from</span> <span class="token string">&quot;./jsm/Geo.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Obj3D <span class="token keyword">from</span> <span class="token string">&quot;./jsm/Obj3D.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Scene <span class="token keyword">from</span> <span class="token string">&quot;./jsm/Scene.js&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ol start="3"><li>备好 webgl 上下文对象</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
<span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="4"><li>备好相机，稍后从中提取投影视图矩阵</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> halfH <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ratio <span class="token operator">=</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
<span class="token keyword">const</span> halfW <span class="token operator">=</span> halfH <span class="token operator">*</span> ratio<span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token operator">-</span>halfW<span class="token punctuation">,</span>
  halfW<span class="token punctuation">,</span>
  halfH<span class="token punctuation">,</span>
  <span class="token operator">-</span>halfH<span class="token punctuation">,</span>
  <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token number">8</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrthographicCamera</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
camera<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ol start="5"><li>实例化场景对象</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> scene <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">{</span> gl <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol start="6"><li>建立纯色三角形</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token keyword">const</span> vs <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;solidVertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fs <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;solidFragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> program <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vs<span class="token punctuation">,</span> fs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> mat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    program<span class="token punctuation">,</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">u_Time</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniform1f&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniformMatrix4fv&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniformMatrix4fv&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> geo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">array</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span> geo<span class="token punctuation">,</span> mat <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><ol start="7"><li>建立纹理三角形</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;./images/erha.jpg&quot;</span><span class="token punctuation">;</span>
image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> vs <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;textureVertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fs <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;textureFragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> program <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vs<span class="token punctuation">,</span> fs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> mat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    program<span class="token punctuation">,</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniformMatrix4fv&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniformMatrix4fv&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">maps</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">u_Sampler</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        image<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> geo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">array</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">a_Pin</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">array</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span> geo<span class="token punctuation">,</span> mat <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* 统一设置uniform变量 */</span>
  scene<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&quot;u_PvMatrix&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><ol start="8"><li>渲染方法</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">time <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  scene<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mat<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">&quot;u_Time&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> time <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="测试-2" tabindex="-1"><a class="header-anchor" href="#测试-2" aria-hidden="true">#</a> 测试 2</h3><p>再拿之前的彩色立方体来测试一下 webgl 框架的顶点索引功能。</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    attribute vec4 a_Position<span class="token punctuation">;</span>
    attribute vec4 a_Color<span class="token punctuation">;</span>
    uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
    uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
    varying vec4 v_Color<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> u_PvMatrix <span class="token operator">*</span> u_ModelMatrix <span class="token operator">*</span> a_Position<span class="token punctuation">;</span>
      v_Color <span class="token operator">=</span> a_Color<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    precision mediump float<span class="token punctuation">;</span>
    varying vec4 v_Color<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor <span class="token operator">=</span> v_Color<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">import</span> <span class="token punctuation">{</span> initShaders<span class="token punctuation">,</span> createProgram <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../jsm/Utils.js&#39;</span><span class="token punctuation">;</span>
    <span class="token keyword">import</span> <span class="token punctuation">{</span> 
      Matrix4<span class="token punctuation">,</span> 
      PerspectiveCamera<span class="token punctuation">,</span> 
      Vector3 
    <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>
    <span class="token keyword">import</span> OrbitControls <span class="token keyword">from</span> <span class="token string">&#39;./jsm/OrbitControls.js&#39;</span><span class="token punctuation">;</span>
    <span class="token keyword">import</span> Mat <span class="token keyword">from</span> <span class="token string">&#39;./jsm/Mat.js&#39;</span><span class="token punctuation">;</span>
    <span class="token keyword">import</span> Geo <span class="token keyword">from</span> <span class="token string">&#39;./jsm/Geo.js&#39;</span><span class="token punctuation">;</span>
    <span class="token keyword">import</span> Obj3D <span class="token keyword">from</span> <span class="token string">&#39;./jsm/Obj3D.js&#39;</span><span class="token punctuation">;</span>
    <span class="token keyword">import</span> Scene <span class="token keyword">from</span> <span class="token string">&#39;./jsm/Scene.js&#39;</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
    <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> vsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vertexShader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
    <span class="token keyword">const</span> fsSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fragmentShader&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
    <span class="token keyword">const</span> program <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vsSource<span class="token punctuation">,</span> fsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/* 透视相机 */</span>
    <span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token number">45</span><span class="token punctuation">,</span>
        canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
        <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token number">20</span>
    <span class="token punctuation">]</span>
    <span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span>

    <span class="token comment">/* 实例化轨道控制器 */</span>
    <span class="token keyword">const</span> orbit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrbitControls</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        camera<span class="token punctuation">,</span> target<span class="token punctuation">,</span>
        <span class="token literal-property property">dom</span><span class="token operator">:</span> canvas<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    orbit<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">/* 取消右击菜单的显示 */</span>
    canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;contextmenu&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">/* 指针按下时，设置拖拽起始位，获取轨道控制器状态。 */</span>
    canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerdown&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        orbit<span class="token punctuation">.</span><span class="token function">pointerdown</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">/* 指针移动时，若控制器处于平移状态，平移相机；若控制器处于旋转状态，旋转相机。 */</span>
    canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointermove&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        orbit<span class="token punctuation">.</span><span class="token function">pointermove</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">/* 指针抬起 */</span>
    canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerup&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        orbit<span class="token punctuation">.</span><span class="token function">pointerup</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">/* 滚轮事件 */</span>
    canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;wheel&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        orbit<span class="token punctuation">.</span><span class="token function">wheel</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> scene <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">{</span> gl <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> mat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        program<span class="token punctuation">,</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">u_Time</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform1f&#39;</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">value</span><span class="token operator">:</span> orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> geo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">array</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">a_Color</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">array</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
                <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">array</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span>    <span class="token comment">// front</span>
                <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span>    <span class="token comment">// right</span>
                <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token comment">// up</span>
                <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token comment">// left</span>
                <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token comment">// down</span>
                <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span>     <span class="token comment">// back</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span> geo<span class="token punctuation">,</span> mat <span class="token punctuation">}</span><span class="token punctuation">)</span>
    scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>

    <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">ani</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        scene<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span>
            <span class="token string">&#39;u_PvMatrix&#39;</span><span class="token punctuation">,</span>
            orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements
        <span class="token punctuation">)</span>
        scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>ani<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br></div></div><h2 id="二十一、认识光" tabindex="-1"><a class="header-anchor" href="#二十一、认识光" aria-hidden="true">#</a> 二十一、认识光</h2><p>光是由光源发出的，光有方向、亮度和颜色。</p><p>可以想象手电筒打出的一道白色的光。<br> 手电筒是光源，其亮度会受电池的影响，颜色为白色，方向可以由你来控制。</p><p>因为光的存在，我们可以看到世界的多姿多彩。<br> 接下就具体看一下光照会对现实世界中的物体产生哪些影响。</p><h3 id="_1-光照对物体的影响" tabindex="-1"><a class="header-anchor" href="#_1-光照对物体的影响" aria-hidden="true">#</a> 1.光照对物体的影响</h3><p>现实世界中的物体被光线照射时，会吸收一部分光，反射一部分光。 当反射的光进入人的眼睛中时，人们便可以看到物体，并识别出它的颜色。</p><p>光会对物体产生以下影响：</p><ul><li>影响物体表面不同位置的明暗程度</li><li>影响物体的颜色</li><li>影响物体的投影</li></ul><p>物体的明暗差异，可以让我们感觉这个物体是立体的。<br> 比如下图中，左侧的立方体没有明暗差异，给人的感觉就是一个平面；右侧的立方体具有明暗差异，给人的感觉是立体的。<br><img src="/visual/webgl-share/125.png" alt=""></p><p>素描的“三大面”、“五调子”<br> 三大面、五调子就是在描述光对物体的明暗影响，这两个概念可以让我们画出的东西更有体感。</p><ul><li><p>三大面：黑、白、灰三个面，描述的就是物体的明暗差异。<br><img src="/visual/webgl-share/126.png" alt=""></p></li><li><p>五调子：高光、中间调、明暗交界线、反光和投影。<br><img src="/visual/webgl-share/127.png" alt=""></p></li></ul><p>物体的颜色会受光色的影响，这个我们之后会详说。<br> 物体的影子就是光源看不见的地方，我们之后会通过算法来计算。<br> 接下来，我们再认识一下光源。</p><h3 id="_2-光源" tabindex="-1"><a class="header-anchor" href="#_2-光源" aria-hidden="true">#</a> 2.光源</h3><p>光源，就是光的源头。<br> 基于光源发出的光线的方向，我们可以将光源分成两种：<br><img src="/visual/webgl-share/128.png" alt=""></p><ul><li>平行光（directional light）：光线相互平行，射向同一方向。比如从窗外摄入房间的阳光就是平行的。 <code>注</code>：虽让太阳的光也是向四周发射的，但太阳相对于房间而言太大，光线夹角可以忽略不计，所以就认为从窗外射入室内的阳光是平行的。</li><li>点光源（point light）：光线从一点向周围放射。比如房间里的的灯泡就是点光源。</li></ul><p>若对光源的照射范围做限制，还可以衍生出一些更加具体的光源，比如筒灯、聚光灯等。<br> 现实世界中还有一种间接光源，叫环境光（ambient light），它是经过物体反射后的光。<br><img src="/visual/webgl-share/129.png" alt=""></p><p>当光源射出的光线打到物体上时，物体反射的光便是我们识别物体的关键。<br> 接下来，我们再认识一下物体反射的光。</p><h3 id="_3-反射光" tabindex="-1"><a class="header-anchor" href="#_3-反射光" aria-hidden="true">#</a> 3.反射光</h3><p>反射光：当光源射出的光线打到物体上时，物体反射的光。</p><p>物体的反射光是有方向和颜色的，其方向和颜色会受入射光和物体表面的影响。<br><img src="/visual/webgl-share/130.png" alt=""></p><p>物体常见的的反射光：</p><ul><li>漫反射( diffuse reflection)： 物体在接收到直接光源的入射光后，会将光线均匀的反射向四面八方，如下图：<br><img src="/visual/webgl-share/131.png" alt=""></li></ul><p>物体表面越粗糙，漫反射就越明显。</p><ul><li>镜面反射(specular reflection)： 物体在接收到直接光源的入射光后，会将光线以与物体表面的法线对称的方向反射出去。<br><img src="/visual/webgl-share/132.png" alt=""></li></ul><p>​物体表面越光滑，镜面反射就越明显。</p><ul><li>环境反射（ enviroment ambient reflection）：物体对环境光的反射。</li></ul><p>关于光的基本概念咱们就先说到这，接下来具体的说一下如何为物体着色。</p><h2 id="二十二、着色" tabindex="-1"><a class="header-anchor" href="#二十二、着色" aria-hidden="true">#</a> 二十二、着色</h2><p>通俗而言，着色(shading)是绘画时，用线条或色块表示物体明暗或颜色的方式。</p><ul><li>线条着色 <img src="/visual/webgl-share/133.png" alt=""></li><li>色块着色 <img src="/visual/webgl-share/134.png" alt=""></li></ul><p>在计算机图形学中，着色是对不同物体应用不同材质的过程。<br><img src="/visual/webgl-share/135.png" alt=""></p><p>在计算机里为模型着色，是很难原封不动的还原现实的。<br> 只能让模型更加接近现实。</p><p>让模型接近现实的着色方法是有很多种的。<br> 接下来，说一个叫 Blinn-Phong 着色方法。<br> Blinn-Phong 是一种反射模型，不具备严格的物理意义，它是对物理现象的模拟，所以不要基于现实情况太过较真。</p><p>先看一下要对一个物体进行着色需要考虑的条件。<br><img src="/visual/webgl-share/136.png" alt=""></p><ul><li>着色点 <ul><li>法线normal</li><li>颜色diffuse coefficient</li><li>光泽度 shininess</li></ul></li><li>光源 <ul><li>光源位置 position</li><li>光源强度 intensity</li></ul></li><li>着色点到光源的距离r</li><li>着色点到光源的方向l</li><li>着色点到视点的方向v</li></ul><p>接下来，先考虑一下着色点的亮度和上面各种条件的关系。</p><h3 id="_1-光线与着色点法线的夹角" tabindex="-1"><a class="header-anchor" href="#_1-光线与着色点法线的夹角" aria-hidden="true">#</a> 1.光线与着色点法线的夹角</h3><p>在同样的光源下，入射光线和着色点法线的夹角会影响着色点接收光线的数量。<br><img src="/visual/webgl-share/137.png" alt=""></p><p>在上图中，假如第一个着色点能接收6条光线，则当着色点旋转45°后，它就只能接收4条光线了。<br> 因此，我们会用入射光线l 和着色点法线n的夹角的余弦值，来表示着色点的受光程度。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>cosθ <span class="token operator">=</span> l·n
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>解释一下上面的等式是怎么来的。</p><p>由点积公式得：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>l·n <span class="token operator">=</span> cosθ <span class="token operator">*</span> <span class="token operator">|</span>l<span class="token operator">|</span> <span class="token operator">*</span> <span class="token operator">|</span>n<span class="token operator">|</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p><code>所以</code>：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>cosθ <span class="token operator">=</span> l·n <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token operator">|</span>l<span class="token operator">|</span> <span class="token operator">*</span> <span class="token operator">|</span>n<span class="token operator">|</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p><code>因为</code>：l,n为单位向量</p><p><code>所以</code>：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>cosθ <span class="token operator">=</span> l·n <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">)</span>
cosθ <span class="token operator">=</span> l·n
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_2-光线的衰减" tabindex="-1"><a class="header-anchor" href="#_2-光线的衰减" aria-hidden="true">#</a> 2.光线的衰减</h3><p>光在传播的过程中会产生衰减。<br> 着色点到光源的距离越远，着色点接收到的光能就越少。</p><p>现实世界中影响光线衰减的因素有很多，比如天气情况、空气质量等。<br> 我们这里的图形学可以先不考虑太多，我们可以用一个简单的公式来模拟光线的衰减。<br><img src="/visual/webgl-share/138.png" alt=""></p><p><code>已知</code>：</p><p>I是光源的强度<br> r 是着色点到光源的距离<br> 求：着色点处的光线强度intensity</p><p><code>解</code>：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>intensity <span class="token operator">=</span> <span class="token constant">I</span> <span class="token operator">/</span> r²
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p><code>注</code>：</p><p>有些光的光线衰减是可以被忽略的，比如从窗外打进房间里的阳光。<br> 其原理就是，无论光线方向还是光线衰减，只要其在一定范围内变化极小，那就可以忽略，从而提高渲染速度。</p><p>接下来，把上面的已知条件和公式做一下梳理，求一下着色点的漫反射。</p><h3 id="_3-漫反射" tabindex="-1"><a class="header-anchor" href="#_3-漫反射" aria-hidden="true">#</a> 3.漫反射</h3><h4 id="_3-1漫反射公式" tabindex="-1"><a class="header-anchor" href="#_3-1漫反射公式" aria-hidden="true">#</a> 3.1漫反射公式</h4><p><img src="/visual/webgl-share/136.png" alt=""></p><p>漫反射的计算公式：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>Ld <span class="token operator">=</span> <span class="token function">kd</span><span class="token punctuation">(</span><span class="token constant">I</span> <span class="token operator">/</span> r²<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n·l<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ul><li>Ld-diffusely reflected light 漫反射</li><li>kd-diffuse coefficient 漫反射系数，即颜色</li><li>I/r² 着色点处的光线强度</li><li>max(0, n·l) 着色点接收到的光线数量</li></ul><p><code>注</code>：漫反射和 视线v 没有任何关系，这是因为漫反射是向四面八方反射的。</p><p>接下来，利用这个公式为webgl的世界添加一片阳光。</p><h4 id="_3-2-漫反射示例" tabindex="-1"><a class="header-anchor" href="#_3-2-漫反射示例" aria-hidden="true">#</a> 3-2-漫反射示例</h4><p><code>已知</code>：</p><ul><li>球体 <ul><li>漫反射系数 u_Kd</li></ul></li><li>球体被阳光照射</li><li>阳光的特性： <ul><li>平行光</li><li>光线方向为 u_LightDir</li><li>光线强度为1，衰减忽略</li></ul></li></ul><p><code>求</code>：球体的漫反射</p><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vs<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  attribute vec3 a_Normal<span class="token punctuation">;</span>
  uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
  uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
  varying vec3 v_Normal<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_PvMatrix <span class="token operator">*</span> u_ModelMatrix <span class="token operator">*</span> a_Position<span class="token punctuation">;</span>
    v_Normal <span class="token operator">=</span> a_Normal<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fs<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform vec3 u_Kd<span class="token punctuation">;</span>
  uniform vec3 u_LightDir<span class="token punctuation">;</span>
  varying vec3 v_Normal<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec3 diffuse <span class="token operator">=</span> u_Kd <span class="token operator">*</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>v_Normal<span class="token punctuation">,</span> u_LightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>diffuse<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> createProgram <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../jsm/Utils.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span>
    Matrix4<span class="token punctuation">,</span>
    PerspectiveCamera<span class="token punctuation">,</span>
    Vector3<span class="token punctuation">,</span>
    SphereGeometry
  <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> OrbitControls <span class="token keyword">from</span> <span class="token string">&#39;./lv/OrbitControls.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> Mat <span class="token keyword">from</span> <span class="token string">&#39;./lv/Mat.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> Geo <span class="token keyword">from</span> <span class="token string">&#39;./lv/Geo.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> Obj3D <span class="token keyword">from</span> <span class="token string">&#39;./lv/Obj3D.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> Scene <span class="token keyword">from</span> <span class="token string">&#39;./lv/Scene.js&#39;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
  <span class="token keyword">let</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">BLEND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">blendFunc</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">SRC_ALPHA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">ONE_MINUS_SRC_ALPHA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">//目标点</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">//视点</span>
  <span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">45</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span>
  <span class="token punctuation">]</span>
  <span class="token comment">// 透视相机</span>
  <span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span>
  <span class="token comment">// 轨道控制器</span>
  <span class="token keyword">const</span> orbit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrbitControls</span><span class="token punctuation">(</span><span class="token punctuation">{</span> camera<span class="token punctuation">,</span> target<span class="token punctuation">,</span> <span class="token literal-property property">dom</span><span class="token operator">:</span> canvas<span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>


  <span class="token comment">/* 声明已知条件 */</span>
  <span class="token comment">// 阳光光线方向</span>
  <span class="token keyword">const</span> lightDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 漫反射系数- 颜色</span>
  <span class="token keyword">const</span> u_Kd <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">]</span>
  <span class="token comment">// 球体</span>
  <span class="token keyword">const</span> sphere <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SphereGeometry</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span>
  <span class="token comment">// 顶点集合</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">array</span><span class="token operator">:</span> vertices <span class="token punctuation">}</span> <span class="token operator">=</span> sphere<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&#39;position&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">// 法线集合</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">array</span><span class="token operator">:</span> normals <span class="token punctuation">}</span> <span class="token operator">=</span> sphere<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&#39;normal&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">// 顶点索引集合</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">array</span><span class="token operator">:</span> indexes <span class="token punctuation">}</span> <span class="token operator">=</span> sphere<span class="token punctuation">.</span>index
  <span class="token comment">// 注意：球体是使用three.js 的SphereGeometry 对象建立的，</span>
  <span class="token comment">//可以直接从这里面提取球体的顶点集合、法线集合和顶点索引。</span>


  <span class="token comment">/* 绘图 */</span>
  <span class="token comment">// 场景</span>
  <span class="token keyword">const</span> scene <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">{</span> gl <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">//注册程序对象</span>
  scene<span class="token punctuation">.</span><span class="token function">registerProgram</span><span class="token punctuation">(</span>
    <span class="token string">&#39;Blinn-Phong&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>
        gl<span class="token punctuation">,</span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">attributeNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;a_Normal&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">uniformNames</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&#39;u_PvMatrix&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_ModelMatrix&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_Kd&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_LightDir&#39;</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">const</span> mat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;Blinn-Phong&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_Kd</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> u_Kd<span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_LightDir</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>lightDir<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> geo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">array</span><span class="token operator">:</span> vertices<span class="token punctuation">,</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">a_Normal</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">array</span><span class="token operator">:</span> normals<span class="token punctuation">,</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> indexes
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span> geo<span class="token punctuation">,</span> mat <span class="token punctuation">}</span><span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">ani</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>ani<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">/* 取消右击菜单的显示 */</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;contextmenu&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">/* 指针按下时，设置拖拽起始位，获取轨道控制器状态。 */</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerdown&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">pointerdown</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">/* 指针移动时，若控制器处于平移状态，平移相机；若控制器处于旋转状态，旋转相机。 */</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointermove&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">pointermove</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">/* 指针抬起 */</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerup&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">pointerup</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">/* 滚轮事件 */</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;wheel&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">wheel</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/139.png" alt=""></p><p>注意：<br> 微调Scene对象中用顶点索引绘图的方法：</p><p>将之前的gl.UNSIGNED_BYTE变成gl.UNSIGNED_SHORT。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">drawElements</span><span class="token punctuation">(</span>gl<span class="token punctuation">[</span>mode<span class="token punctuation">]</span><span class="token punctuation">,</span>count<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_SHORT</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>之前用顶点索引绘图时，用的数据类型是gl.UNSIGNED_BYTE，如：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">drawElements</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>此数据类型只能用Uint8Array对象建立顶点索引集合，如：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">array</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>……<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>然而，Uint8Array 有个弊端，其数据的取值范围只能是[0,255]，这就导致了一个模型的顶点数量不能超过256。</p><p>因此，我们需要扩大顶点索引的取值范围，比如用Uint16Array 建立顶点索引。<br> Uint16Array数据的取值范围是[0,65535 ]，这对于一般模型而言，已经够用了。</p><p>在three.js 里，其顶点索引用的就是Uint16Array 。<br> 使用Uint16Array 后，drawElements() 方法里的数据类型就需要变成gl.UNSIGNED_SHORT。</p></details><h3 id="_4-镜面反射" tabindex="-1"><a class="header-anchor" href="#_4-镜面反射" aria-hidden="true">#</a> 4.镜面反射</h3><h4 id="_4-1镜面反射公式" tabindex="-1"><a class="header-anchor" href="#_4-1镜面反射公式" aria-hidden="true">#</a> 4.1镜面反射公式</h4><p>塑料和石膏的差异在于其表面比较光滑，更加接近镜面，会有明显的高光存在。<br> 我们通过镜面反射考虑一下，我们的眼睛什么时候可以看见物体的高光。<br><img src="/visual/webgl-share/140.png" alt=""></p><p>在上图中，方向R 便是 光线I 在物体表面的镜面反射方向，R 和 l 基于法线 n 对称。 当视线v 接近R的时候，便可以看见高光。</p><p>因此，Phone 提出了通过∠&lt;v,R&gt; 的夹角来判断眼睛能否看见高光的方法。<br> 然而，要基于 光线l 和 法线n 去求 l 的反射向量R，是需要不小的计算量的。</p><p>所以，后来 Blinn 就对 Phone 的方案作出了改进，设计出了更简便的 Blinn-Phone 材质。 接下来，看一下Blinn-Phone 材质的设计思路。<br><img src="/visual/webgl-share/141.png" alt=""></p><p>上图中，向量h 是∠&lt;v,v+l&gt; 的角平分线。</p><p>通过观察，我们可以知道：<br> 随视线的变换，∠&lt;h,n&gt; 和∠&lt;v,R&gt; 的大小是成正比的。<br> 也就说，当视线v 越接近镜面反射R ，角平分线h就越接近法线n。</p><p>Blinn-Phone 计算镜面反射的公式如下：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>h <span class="token operator">=</span> <span class="token punctuation">(</span>v<span class="token operator">+</span>l<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token operator">|</span>v<span class="token operator">+</span>l<span class="token operator">|</span>
Ls <span class="token operator">=</span> ks <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token constant">I</span> <span class="token operator">/</span> r²<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n·h<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>h：∠&lt;v,v+l&gt; 的角平分线</li><li>|v+l|：(v+l) 的长度</li><li>Ls：镜面反射 specularly reflected light</li><li>ks：镜面反射系数 specularly coefficient</li><li>max(0,n·h)：cos∠&lt;h,n&gt;</li><li>pow(max(0,n·h),p)：cos∠&lt;h,n&gt;的p次方</li></ul><p>解释一下cos∠&lt;h,n&gt;的p次方的意义。<br> 若只用cos∠&lt;h,n&gt; 来计算高光，会得到较大的高光，而我们平时所见的高光一般都是比较小的。<br> 因此，我们可以对cos∠&lt;h,n&gt;做一下幂运算。<br><img src="/visual/webgl-share/142.png" alt=""></p><h4 id="_4-1镜面反射示例" tabindex="-1"><a class="header-anchor" href="#_4-1镜面反射示例" aria-hidden="true">#</a> 4.1镜面反射示例</h4><p>接下来，还是基于之前的那个球体来做一下镜面反射。</p><p><code>已知</code>：</p><ul><li>球体 <ul><li>漫反射系数 u_Kd</li><li>镜面反射系数 u_Ks</li></ul></li><li>球体被阳光照射</li><li>阳光的特性： <ul><li>平行光</li><li>光线方向为 u_LightDir</li><li>光线强度为 1，衰减忽略</li></ul></li><li>视点位置：u_Eye</li></ul><p><code>求</code>：球体的镜面反射</p><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vs<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  attribute vec3 a_Normal<span class="token punctuation">;</span>
  uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
  uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
  varying vec3 v_Normal<span class="token punctuation">;</span>
  varying vec3 v_Position<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_PvMatrix <span class="token operator">*</span> u_ModelMatrix <span class="token operator">*</span> a_Position<span class="token punctuation">;</span>
    v_Normal <span class="token operator">=</span> a_Normal<span class="token punctuation">;</span>
    v_Position <span class="token operator">=</span> <span class="token function">vec3</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fs<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform vec3 u_Kd<span class="token punctuation">;</span>
  uniform vec3 u_Ks<span class="token punctuation">;</span>
  uniform vec3 u_LightDir<span class="token punctuation">;</span>
  uniform vec3 u_Eye<span class="token punctuation">;</span>
  varying vec3 v_Normal<span class="token punctuation">;</span>
  varying vec3 v_Position<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//视点看向当前着色点的视线</span>
    vec3 eyeDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>u_Eye <span class="token operator">-</span> v_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//角平分线</span>
    vec3 h<span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>eyeDir <span class="token operator">+</span> u_LightDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//漫反射</span>
    vec3 diffuse <span class="token operator">=</span> u_Kd <span class="token operator">*</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>v_Normal<span class="token punctuation">,</span> u_LightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//镜面反射</span>
    vec3 specular <span class="token operator">=</span> u_Ks <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span>
      <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>v_Normal<span class="token punctuation">,</span>h<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token number">64.0</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//Blinn-Phong 反射</span>
    vec3 l <span class="token operator">=</span> diffuse <span class="token operator">+</span> specular<span class="token punctuation">;</span>

    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> createProgram <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../jsm/Utils.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span>
    Matrix4<span class="token punctuation">,</span>
    PerspectiveCamera<span class="token punctuation">,</span>
    Vector3<span class="token punctuation">,</span>
    SphereGeometry
  <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> OrbitControls <span class="token keyword">from</span> <span class="token string">&#39;./lv/OrbitControls.js&#39;</span>
  <span class="token keyword">import</span> Mat <span class="token keyword">from</span> <span class="token string">&#39;./lv/Mat.js&#39;</span>
  <span class="token keyword">import</span> Geo <span class="token keyword">from</span> <span class="token string">&#39;./lv/Geo.js&#39;</span>
  <span class="token keyword">import</span> Obj3D <span class="token keyword">from</span> <span class="token string">&#39;./lv/Obj3D.js&#39;</span>
  <span class="token keyword">import</span> Scene <span class="token keyword">from</span> <span class="token string">&#39;./lv/Scene.js&#39;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
  <span class="token keyword">let</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">BLEND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">blendFunc</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">SRC_ALPHA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">ONE_MINUS_SRC_ALPHA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 目标点</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">//视点</span>
  <span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">45</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span>
  <span class="token punctuation">]</span>
  <span class="token comment">// 透视相机</span>
  <span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span>
  <span class="token comment">// 轨道控制器</span>
  <span class="token keyword">const</span> orbit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrbitControls</span><span class="token punctuation">(</span><span class="token punctuation">{</span> camera<span class="token punctuation">,</span> target<span class="token punctuation">,</span> <span class="token literal-property property">dom</span><span class="token operator">:</span> canvas<span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

  
  <span class="token comment">/* 声明已知条件 */</span>
  <span class="token comment">// 阳光光线方向</span>
  <span class="token keyword">const</span> lightDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 漫反射系数- 颜色</span>
  <span class="token keyword">const</span> u_Kd <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">]</span>
  <span class="token comment">// 镜面反射系数</span>
  <span class="token keyword">const</span> u_Ks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">]</span>

  <span class="token comment">// 球体</span>
  <span class="token keyword">const</span> sphere <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SphereGeometry</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
  <span class="token comment">// 顶点集合</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">array</span><span class="token operator">:</span> vertices <span class="token punctuation">}</span> <span class="token operator">=</span> sphere<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&#39;position&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">// 法线集合</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">array</span><span class="token operator">:</span> normals <span class="token punctuation">}</span> <span class="token operator">=</span> sphere<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&#39;normal&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">// 顶点索引集合</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">array</span><span class="token operator">:</span> indexes <span class="token punctuation">}</span> <span class="token operator">=</span> sphere<span class="token punctuation">.</span>index

  <span class="token comment">// 场景</span>
  <span class="token keyword">const</span> scene <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">{</span> gl <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">//注册程序对象</span>
  scene<span class="token punctuation">.</span><span class="token function">registerProgram</span><span class="token punctuation">(</span>
    <span class="token string">&#39;Blinn-Phong&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>
        gl<span class="token punctuation">,</span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">attributeNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;a_Normal&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">uniformNames</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&#39;u_PvMatrix&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_ModelMatrix&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_Kd&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_LightDir&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;u_Ks&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_Eye&#39;</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">const</span> mat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;Blinn-Phong&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_Kd</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> u_Kd<span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_LightDir</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>lightDir<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_Ks</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> u_Ks<span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_Eye</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>camera<span class="token punctuation">.</span>position<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> geo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">array</span><span class="token operator">:</span> vertices<span class="token punctuation">,</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">a_Normal</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">array</span><span class="token operator">:</span> normals<span class="token punctuation">,</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> indexes
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span> geo<span class="token punctuation">,</span> mat <span class="token punctuation">}</span><span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">ani</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    scene<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&#39;u_Eye&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>camera<span class="token punctuation">.</span>position<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>ani<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">/* 取消右击菜单的显示 */</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;contextmenu&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">/* 指针按下时，设置拖拽起始位，获取轨道控制器状态。 */</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerdown&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">pointerdown</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">/* 指针移动时，若控制器处于平移状态，平移相机；若控制器处于旋转状态，旋转相机。 */</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointermove&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">pointermove</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">/* 指针抬起 */</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerup&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">pointerup</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">/* 滚轮事件 */</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;wheel&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">wheel</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/143.png" alt=""></p></details><h3 id="_5-环境反射" tabindex="-1"><a class="header-anchor" href="#_5-环境反射" aria-hidden="true">#</a> 5.环境反射</h3><h4 id="_5-1环境反射的公式" tabindex="-1"><a class="header-anchor" href="#_5-1环境反射的公式" aria-hidden="true">#</a> 5.1环境反射的公式</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>La <span class="token operator">=</span> ka <span class="token operator">*</span> Ia
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ul><li>La：环境反射 reflected ambient light</li><li>ka：环境光系数 ambient coefficient</li><li>Ia：环境光强度 ambient intensity</li></ul><h4 id="_5-2环境反射示例" tabindex="-1"><a class="header-anchor" href="#_5-2环境反射示例" aria-hidden="true">#</a> 5.2环境反射示例</h4><p><code>已知</code>：</p><ul><li><p>球体</p><ul><li>漫反射系数 u_Kd</li><li>镜面反射系数 u_Ks</li></ul></li><li><p>球体被阳光照射</p></li><li><p>阳光的特性：</p><ul><li>平行光</li><li>光线方向为 u_LightDir</li><li>光线强度为 1，衰减忽略</li></ul></li><li><p>视点位置：camera.position</p></li><li><p>环境光系数：u_Ka</p></li><li><p>环境光强度：1</p></li></ul><p><code>求</code>：球体的环境反射</p><details class="custom-container details"><summary>代码实现</summary><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vs<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  attribute vec3 a_Normal<span class="token punctuation">;</span>
  uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
  uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
  varying vec3 v_Normal<span class="token punctuation">;</span>
  varying vec3 v_Position<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> u_PvMatrix <span class="token operator">*</span> u_ModelMatrix <span class="token operator">*</span> a_Position<span class="token punctuation">;</span>
    v_Normal <span class="token operator">=</span> a_Normal<span class="token punctuation">;</span>
    v_Position <span class="token operator">=</span> <span class="token function">vec3</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fs<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform vec3 u_Kd<span class="token punctuation">;</span>
  uniform vec3 u_Ks<span class="token punctuation">;</span>
  uniform vec3 u_Ka<span class="token punctuation">;</span>
  uniform vec3 u_LightDir<span class="token punctuation">;</span>
  uniform vec3 u_Eye<span class="token punctuation">;</span>
  varying vec3 v_Normal<span class="token punctuation">;</span>
  varying vec3 v_Position<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//视点看向当前着色点的视线</span>
    vec3 eyeDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>u_Eye <span class="token operator">-</span> v_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//角平分线</span>
    vec3 h <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>eyeDir <span class="token operator">+</span> u_LightDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//漫反射</span>
    vec3 diffuse <span class="token operator">=</span> u_Kd <span class="token operator">*</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>v_Normal<span class="token punctuation">,</span> u_LightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//镜面反射</span>
    vec3 specular <span class="token operator">=</span> u_Ks <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span>
      <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>v_Normal<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token number">64.0</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//Blinn-Phong 反射 (漫反射 + 镜面反射 + 环境反射)</span>
    vec3 l <span class="token operator">=</span> diffuse <span class="token operator">+</span> specular <span class="token operator">+</span> u_Ka<span class="token punctuation">;</span>

    gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> createProgram <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../jsm/Utils.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span>
    Matrix4<span class="token punctuation">,</span> 
    PerspectiveCamera<span class="token punctuation">,</span> 
    Vector3<span class="token punctuation">,</span>
    SphereGeometry
  <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> OrbitControls <span class="token keyword">from</span> <span class="token string">&#39;./lv/OrbitControls.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> Mat <span class="token keyword">from</span> <span class="token string">&#39;./lv/Mat.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> Geo <span class="token keyword">from</span> <span class="token string">&#39;./lv/Geo.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> Obj3D <span class="token keyword">from</span> <span class="token string">&#39;./lv/Obj3D.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> Scene <span class="token keyword">from</span> <span class="token string">&#39;./lv/Scene.js&#39;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
  <span class="token keyword">let</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">BLEND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">blendFunc</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">SRC_ALPHA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">ONE_MINUS_SRC_ALPHA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 目标点</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">//视点</span>
  <span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">45</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span>
  <span class="token punctuation">]</span>
  <span class="token comment">// 透视相机</span>
  <span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span>
  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span>
  <span class="token comment">// 轨道控制器</span>
  <span class="token keyword">const</span> orbit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrbitControls</span><span class="token punctuation">(</span><span class="token punctuation">{</span> camera<span class="token punctuation">,</span> target<span class="token punctuation">,</span> <span class="token literal-property property">dom</span><span class="token operator">:</span> canvas<span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 阳光光线方向</span>
  <span class="token keyword">const</span> lightDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 漫反射系数- 颜色</span>
  <span class="token keyword">const</span> u_Kd <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">]</span>
  <span class="token comment">// 镜面反射系数</span>
  <span class="token keyword">const</span> u_Ks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">]</span>
  <span class="token comment">//环境反射系数</span>
  <span class="token keyword">const</span> u_Ka <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">]</span>

  <span class="token comment">// 球体</span>
  <span class="token keyword">const</span> sphere <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SphereGeometry</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
  <span class="token comment">// 顶点集合</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">array</span><span class="token operator">:</span> vertices <span class="token punctuation">}</span> <span class="token operator">=</span> sphere<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&#39;position&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">// 法线集合</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">array</span><span class="token operator">:</span> normals <span class="token punctuation">}</span> <span class="token operator">=</span> sphere<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&#39;normal&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">// 顶点索引集合</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">array</span><span class="token operator">:</span> indexes <span class="token punctuation">}</span> <span class="token operator">=</span> sphere<span class="token punctuation">.</span>index

  <span class="token comment">// 场景</span>
  <span class="token keyword">const</span> scene <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">{</span> gl <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">//注册程序对象</span>
  scene<span class="token punctuation">.</span><span class="token function">registerProgram</span><span class="token punctuation">(</span>
    <span class="token string">&#39;Blinn-Phong&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>
        gl<span class="token punctuation">,</span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">attributeNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;a_Normal&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">uniformNames</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&#39;u_PvMatrix&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_ModelMatrix&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_Kd&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_LightDir&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;u_Ks&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_Eye&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_Ka&#39;</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">const</span> mat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;Blinn-Phong&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_Kd</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> u_Kd<span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_LightDir</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>lightDir<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_Ks</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> u_Ks<span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_Eye</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>camera<span class="token punctuation">.</span>position<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">u_Ka</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>u_Ka<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> geo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">array</span><span class="token operator">:</span> vertices<span class="token punctuation">,</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">a_Normal</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">array</span><span class="token operator">:</span> normals<span class="token punctuation">,</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> indexes
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span> geo<span class="token punctuation">,</span> mat <span class="token punctuation">}</span><span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">ani</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    scene<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&#39;u_Eye&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>camera<span class="token punctuation">.</span>position<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>ani<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">/* 取消右击菜单的显示 */</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;contextmenu&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">/* 指针按下时，设置拖拽起始位，获取轨道控制器状态。 */</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerdown&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">pointerdown</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">/* 指针移动时，若控制器处于平移状态，平移相机；若控制器处于旋转状态，旋转相机。 */</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointermove&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">pointermove</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">/* 指针抬起 */</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerup&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">pointerup</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">/* 滚轮事件 */</span>
  canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;wheel&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    orbit<span class="token punctuation">.</span><span class="token function">wheel</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/144.png" alt=""></p></details><h3 id="_6-blinn-phong反射模型" tabindex="-1"><a class="header-anchor" href="#_6-blinn-phong反射模型" aria-hidden="true">#</a> 6.Blinn-Phong反射模型</h3><p>之前将漫反射Diffuse 、高光Specular 和 环境光Ambient 加在一起的方法，就叫Blinn-Phong 反射模型，即：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">L</span> <span class="token operator">=</span> Ld <span class="token operator">+</span> Ls <span class="token operator">+</span> La 
<span class="token constant">L</span> <span class="token operator">=</span> <span class="token function">kd</span><span class="token punctuation">(</span><span class="token constant">I</span><span class="token operator">/</span>r²<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>n·l<span class="token punctuation">)</span> <span class="token operator">+</span> ks<span class="token operator">*</span><span class="token punctuation">(</span><span class="token constant">I</span><span class="token operator">/</span>r²<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>n·h<span class="token punctuation">)</span><span class="token punctuation">,</span>p<span class="token punctuation">)</span> <span class="token operator">+</span>  ka<span class="token operator">*</span>Ia
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>通过上面的示例，可以知道：</p><ul><li>漫反射可以让物体具有体感；</li><li>镜面反射可以让物体在我们眼前一亮；</li><li>环境反射可以让物体看起来更加细腻。</li></ul><p>现在应该对于着色有了一定的认知，接下来再说一个之前跳过的知识点-着色频率。</p><h2 id="二十二、着色频率" tabindex="-1"><a class="header-anchor" href="#二十二、着色频率" aria-hidden="true">#</a> 二十二、着色频率</h2><p>着色频率与法线是息息相关的，所以得先从法线说起。<br> 法线就是垂直于着色点的一个单位向量，如下图：<br><img src="/visual/webgl-share/136.png" alt=""></p><p>在 webgl 中建立的模型是用三角形拼起来的，而不是用着色点拼起来的，那么之前在片元着色器里计算的法线是怎么来的呢？</p><p>那是从three.js的SphereGeometry 对象里来的。<br> 那SphereGeometry 对象是怎么算法线的呢？<br> 不妨先看一下法线的分布效果。</p><h3 id="_1-法线" tabindex="-1"><a class="header-anchor" href="#_1-法线" aria-hidden="true">#</a> 1.法线</h3><ol><li>准备一份用于绘制法线的辅助线的着色器</li></ol><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    attribute vec4 a_Position<span class="token punctuation">;</span>
    uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> u_PvMatrix <span class="token operator">*</span> a_Position<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ol start="2"><li>建立一个获取法线辅助线的顶点数据的方法 (顶点集合,法线集合,长度)</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getNormalHelper</span><span class="token punctuation">(</span><span class="token parameter">vertices<span class="token punctuation">,</span> normals<span class="token punctuation">,</span>length<span class="token operator">=</span><span class="token number">0.2</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> normalVertices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> normals<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 模型的顶点点位</span>
    <span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span>
      vertices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> vertices<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vertices<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    <span class="token comment">// 将法线从模型顶点向外延伸</span>
    <span class="token keyword">const</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span>
      normals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> normals<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> normals<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span>
    normalVertices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>p1<span class="token punctuation">,</span> <span class="token operator">...</span>p2<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>normalVertices<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ol start="3"><li>绘制法线辅助线</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>scene<span class="token punctuation">.</span><span class="token function">registerProgram</span><span class="token punctuation">(</span>
  <span class="token string">&#39;line&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">,</span>
      document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
      document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">attributeNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">uniformNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;u_PvMatrix&#39;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> matN <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;line&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">&#39;LINES&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> geoN <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> <span class="token function">getNormalHelper</span><span class="token punctuation">(</span>vertices<span class="token punctuation">,</span> normals<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> objN <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">geo</span><span class="token operator">:</span> geoN<span class="token punctuation">,</span> <span class="token literal-property property">mat</span><span class="token operator">:</span> matN <span class="token punctuation">}</span><span class="token punctuation">)</span>
scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>objN<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>效果：<br><img src="/visual/webgl-share/145.png" alt=""></p><p>由此可见，three.js 里的这个SphereGeometry对象的法线是由球心向四周反射。<br> 然而，模型的法线法线除了像上面这样分布，还有没有其它的分布方法呢？<br> 这就涉及着色频率的问题，接下来就通过着色频率说一下模型法线常见的设置方法。</p><h3 id="_2-认识着色频率" tabindex="-1"><a class="header-anchor" href="#_2-认识着色频率" aria-hidden="true">#</a> 2.认识着色频率</h3><p><img src="/visual/webgl-share/146.png" alt=""></p><p>常见的着色频率有三种：</p><ul><li><p>逐三角形着色(flat shading)：模型的每个面都拥有统一的法线，效果比较硬朗。</p></li><li><p>逐顶点着色(gouraud shading)：模型的每个顶点都拥有各自的法线。</p><p>每三个点构成的三角形的内部的点的法线会通过三角形的插值算法计算出来。<br> webgl 着色器已经通过varying 变量实现了此功能。<br> 效果比较平滑，但是三角形太大的话，高光就看不见了。</p></li><li><p>逐片元着色(phong shading)：模型的每个片元都拥有各自的法线，由phong 提出。</p></li></ul><p>接下来，考虑一下要渲染一个光滑球体，用哪种着色频率合适。<br><img src="/visual/webgl-share/147.png" alt=""></p><p>上图自上而下，球体顶点的数量是由少到多的。<br> 由图可知：</p><ul><li>当顶点数量很少时： <ul><li>逐三角形着色效果生硬，渲染速度最快。</li><li>逐顶点着色效果较为平滑，会失去高光，渲染速度适中。</li><li>逐片元着色效果最为平滑，渲染速度最慢。</li></ul></li><li>当顶点数量适中时，若对效果要求不苛刻，适合用顶点着色。因为其具有平滑的效果和高光，渲染速度也适中。</li><li>当顶点达到一定的数量，三种着色频率的着色效果都是一样的，且逐片元着色频率的渲染速度不一定会比其他的两种着色频率慢。</li></ul><p>接下来用代码写一下上面的着色频率。<br> 为了对着色频率有一个深刻的认知，先自己写个球体。</p><h3 id="_3-球体" tabindex="-1"><a class="header-anchor" href="#_3-球体" aria-hidden="true">#</a> 3.球体</h3><p>对于球体的绘制原理，将其展开就很好理解了。<br><img src="/visual/webgl-share/148.png" alt=""></p><p>上图是一个4行6列的球体。</p><p>在绘制的时候，只要将其分成两部分考虑就可以了：</p><ul><li>上下两行三角形</li><li>中间的矩阵</li></ul><p>接下来建立一个Sphere对象。</p><ul><li>属性： <ul><li>r：半径</li><li>widthSegments：横向段数，最小3段</li><li>heightSegments：纵向段数，最小3段</li><li>vertices：顶点集合</li><li>normals：法线集合</li><li>indexes：顶点索引集合</li><li>count：顶点数量</li></ul></li><li>方法 <ul><li>init() 基于球体的半径和分段，计算其用于顶点索引绘图的数据</li><li>getTriangles() 基于顶点索引集合解析出相对应的顶点集合，可以用于独立三角形的绘制</li><li>getVertice(ind) 基于某个顶点索引获取顶点</li></ul></li></ul><p>代码实现：</p><ol><li>建立 Sphere 球体对象</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Vector3<span class="token punctuation">,</span>Spherical<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>

<span class="token comment">/*
属性：
  r：半径
  widthSegments：横向段数，最小3端
  heightSegments：纵向段数，最小3端
  vertices：顶点集合
  normals：法线集合
  indexes：顶点索引集合
  count：顶点数量
*/</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Sphere</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">r<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> widthSegments<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> heightSegments<span class="token operator">=</span><span class="token number">16</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>r<span class="token operator">=</span>r
    <span class="token keyword">this</span><span class="token punctuation">.</span>widthSegments<span class="token operator">=</span>widthSegments
    <span class="token keyword">this</span><span class="token punctuation">.</span>heightSegments<span class="token operator">=</span>heightSegments
    <span class="token keyword">this</span><span class="token punctuation">.</span>vertices<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>normals<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>indexes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">=</span><span class="token number">0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> r<span class="token punctuation">,</span> widthSegments<span class="token punctuation">,</span> heightSegments <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">//顶点数量</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> widthSegments <span class="token operator">*</span> <span class="token punctuation">(</span>heightSegments <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span>
    <span class="token comment">// 球坐标系</span>
    <span class="token keyword">const</span> spherical <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Spherical</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// theta和phi方向的旋转弧度</span>
    <span class="token keyword">const</span> thetaSize <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">/</span> widthSegments
    <span class="token keyword">const</span> phiSize <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> heightSegments

    <span class="token comment">// 顶点集合，先内置北极点</span>
    <span class="token keyword">const</span> vertices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment">// 法线集合，先内置北极法线</span>
    <span class="token keyword">const</span> normals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment">// 顶点索引集合</span>
    <span class="token keyword">const</span> indexes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 最后一个顶点索引</span>
    <span class="token keyword">const</span> lastInd <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">-</span><span class="token number">1</span>
    <span class="token comment">// 逐行列遍历</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> heightSegments<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 球坐标垂直分量</span>
      <span class="token keyword">const</span> phi <span class="token operator">=</span> phiSize <span class="token operator">*</span> y
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x1 <span class="token operator">&lt;</span> widthSegments<span class="token punctuation">;</span> x1<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// x1后的两列</span>
        <span class="token keyword">const</span> x2 <span class="token operator">=</span> x1 <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">const</span> x3 <span class="token operator">=</span> x2 <span class="token operator">%</span> widthSegments <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 计算顶点和法线</span>
          spherical<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> phi<span class="token punctuation">,</span> thetaSize <span class="token operator">*</span> x1<span class="token punctuation">)</span>
          <span class="token keyword">const</span> vertice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromSpherical</span><span class="token punctuation">(</span>spherical<span class="token punctuation">)</span>
          vertices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>vertice<span class="token punctuation">)</span>
          normals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>vertice<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 第一行的三角网</span>
          indexes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x2<span class="token punctuation">,</span> x3<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&lt;</span> heightSegments <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 一个矩形格子的左上lt、右上rt、左下lb、右下rb点</span>
          <span class="token keyword">const</span> lt <span class="token operator">=</span> y <span class="token operator">*</span> widthSegments <span class="token operator">+</span> x2
          <span class="token keyword">const</span> rt <span class="token operator">=</span> y <span class="token operator">*</span> widthSegments <span class="token operator">+</span> x3
          <span class="token keyword">const</span> lb <span class="token operator">=</span> <span class="token punctuation">(</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> widthSegments <span class="token operator">+</span> x2
          <span class="token keyword">const</span> rb <span class="token operator">=</span> <span class="token punctuation">(</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> widthSegments <span class="token operator">+</span> x3
          <span class="token comment">// 第一行和最后一行中间的三角网</span>
          indexes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>lb<span class="token punctuation">,</span> rb<span class="token punctuation">,</span> lt<span class="token punctuation">,</span> lt<span class="token punctuation">,</span> rb<span class="token punctuation">,</span> rt<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">===</span> heightSegments <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 最后一行的三角网</span>
            indexes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>lastInd<span class="token punctuation">,</span> rb<span class="token punctuation">,</span> lb<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 南极顶点</span>
    vertices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment">// 南极法线</span>
    normals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>vertices<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>vertices<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>normals<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>normals<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>indexes<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Uint16Array</span><span class="token punctuation">(</span>indexes<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">getTriangles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>indexes<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span>
    <span class="token comment">// 顶点集合</span>
    <span class="token keyword">const</span> vertices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 通过顶点索引遍历三角形</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> indexes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 三角形的三个顶点</span>
      <span class="token keyword">const</span> p0 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVertice</span><span class="token punctuation">(</span>indexes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVertice</span><span class="token punctuation">(</span>indexes<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> p2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVertice</span><span class="token punctuation">(</span>indexes<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      vertices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>p0<span class="token punctuation">,</span> <span class="token operator">...</span>p1<span class="token punctuation">,</span> <span class="token operator">...</span>p2<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>vertices<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">getVertice</span><span class="token punctuation">(</span><span class="token parameter">ind</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>vertices<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span>
    <span class="token keyword">const</span> i <span class="token operator">=</span> ind <span class="token operator">*</span> <span class="token number">3</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span>vertices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> vertices<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vertices<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br></div></div><ol start="2"><li>实例化 Sphere 对象，将之前 three.js 的 SphereGeometry 对象替换掉</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> Sphere <span class="token keyword">from</span> <span class="token string">&#39;./jsm/Sphere.js&#39;</span>
<span class="token keyword">const</span> sphere <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sphere</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> vertices<span class="token punctuation">,</span> indexes<span class="token punctuation">,</span>normals <span class="token punctuation">}</span> <span class="token operator">=</span> sphere
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>接下来，就用不同的着色频率为这个球体着色。</p><h3 id="_4-flat逐三角形着色" tabindex="-1"><a class="header-anchor" href="#_4-flat逐三角形着色" aria-hidden="true">#</a> 4.Flat逐三角形着色</h3><p>逐三角形着色的法线是比较好算的，直接通过三角形两边的叉乘便可以得到。</p><ol><li>建立一个专门用于计算着色频率的模块。</li></ol><p>ShadingFrequency.js</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Vector3<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>

<span class="token comment">// 逐三角形着色</span>
<span class="token keyword">function</span> <span class="token function">flatShading</span><span class="token punctuation">(</span><span class="token parameter">vertices<span class="token punctuation">,</span> indexes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// flat 法线集合</span>
  <span class="token keyword">const</span> normals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// 通过顶点索引遍历三角形</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> indexes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 三角形的三个顶点</span>
    <span class="token keyword">const</span> p0 <span class="token operator">=</span> <span class="token function">getVertice</span><span class="token punctuation">(</span>vertices<span class="token punctuation">,</span> indexes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token function">getVertice</span><span class="token punctuation">(</span>vertices<span class="token punctuation">,</span> indexes<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> p2 <span class="token operator">=</span> <span class="token function">getVertice</span><span class="token punctuation">(</span>vertices<span class="token punctuation">,</span> indexes<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">// 三角面的法线</span>
    <span class="token keyword">const</span> n <span class="token operator">=</span> p2<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>
        p0<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    normals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>n<span class="token punctuation">,</span> <span class="token operator">...</span>n<span class="token punctuation">,</span> <span class="token operator">...</span>n<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>normals<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取顶点</span>
<span class="token keyword">function</span> <span class="token function">getVertice</span><span class="token punctuation">(</span><span class="token parameter">vertices<span class="token punctuation">,</span> ind</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> i <span class="token operator">=</span> ind <span class="token operator">*</span> <span class="token number">3</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span>vertices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> vertices<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vertices<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span>
  flatShading<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><ol start="2"><li>在项目文件中调用上面逐三角形着色的方法。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> flatShading <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./jsm/ShadingFrequency.js&#39;</span>

<span class="token comment">// 球体</span>
<span class="token keyword">const</span> sphere <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sphere</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span>
<span class="token comment">// 用独立三角形绘制球体的顶点</span>
<span class="token keyword">const</span> vertices <span class="token operator">=</span> sphere<span class="token punctuation">.</span><span class="token function">getTriangles</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 逐三角形着色的法线</span>
<span class="token keyword">const</span> normals <span class="token operator">=</span> <span class="token function">flatShading</span><span class="token punctuation">(</span>sphere<span class="token punctuation">.</span>vertices<span class="token punctuation">,</span> sphere<span class="token punctuation">.</span>indexes<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>因为在逐三角形着色的模型中，每个顶点都有不同的法线，所以不需要再使用顶点索引绘图了，直接用独立三角形gl.TRIANGLES 绘图即可。</p><ol start="3"><li>绘图</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 场景</span>
<span class="token keyword">const</span> scene <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">{</span> gl <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 注册程序对象</span>
scene<span class="token punctuation">.</span><span class="token function">registerProgram</span><span class="token punctuation">(</span>
  <span class="token string">&#39;Blinn-Phong&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">,</span>
      document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
      document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">attributeNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;a_Normal&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">uniformNames</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&#39;u_PvMatrix&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_ModelMatrix&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_Kd&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_LightDir&#39;</span><span class="token punctuation">,</span>
      <span class="token string">&#39;u_Ks&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_Eye&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_Ka&#39;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> mat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;Blinn-Phong&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">u_LightDir</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>LightDir<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">u_Kd</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> u_Kd<span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">u_Ks</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> u_Ks<span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">u_Ka</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> u_Ka<span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">u_Eye</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>position<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">&#39;TRIANGLES&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> geo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> vertices<span class="token punctuation">,</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">a_Normal</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> normals<span class="token punctuation">,</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span> geo<span class="token punctuation">,</span> mat <span class="token punctuation">}</span><span class="token punctuation">)</span>
scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>

scene<span class="token punctuation">.</span><span class="token function">registerProgram</span><span class="token punctuation">(</span>
  <span class="token string">&#39;line&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">,</span>
      document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
      document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">attributeNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">uniformNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;u_PvMatrix&#39;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> matN <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;line&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">&#39;LINES&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> geoN <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> <span class="token function">getNormalHelper</span><span class="token punctuation">(</span>vertices<span class="token punctuation">,</span> normals<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> objN <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">geo</span><span class="token operator">:</span> geoN<span class="token punctuation">,</span> <span class="token literal-property property">mat</span><span class="token operator">:</span> matN <span class="token punctuation">}</span><span class="token punctuation">)</span>
scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>objN<span class="token punctuation">)</span>

scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br></div></div><p>最终效果如下：<br><img src="/visual/webgl-share/149.png" alt=""></p><p>接下来，再考虑一下逐顶点着色的法线。</p><p><code>注</code>：</p><p>在对使用模型矩阵变换模型的时候，需要将顶点的和法线的插值一起变换。</p><p>这是我们之前的顶点着色器：</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vs<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    attribute vec4 a_Position<span class="token punctuation">;</span>
    attribute vec3 a_Normal<span class="token punctuation">;</span>
    uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
    uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
    varying vec3 v_Normal<span class="token punctuation">;</span>
    varying vec3 v_Position<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> u_PvMatrix<span class="token operator">*</span>u_ModelMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
      v_Normal<span class="token operator">=</span>a_Normal<span class="token punctuation">;</span>
      v_Position<span class="token operator">=</span><span class="token function">vec3</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>需要让上面的的v_Normal和v_Position也受模型矩阵u_ModelMatrix的影响。</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vs<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    ……
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      vec4 worldPos <span class="token operator">=</span> u_ModelMatrix <span class="token operator">*</span> a_Position<span class="token punctuation">;</span>
      gl_Position <span class="token operator">=</span> u_PvMatrix <span class="token operator">*</span> worldPos<span class="token punctuation">;</span>
      v_Normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">mat3</span><span class="token punctuation">(</span>u_ModelMatrix<span class="token punctuation">)</span> <span class="token operator">*</span> a_Normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
      v_Position <span class="token operator">=</span> <span class="token function">vec3</span><span class="token punctuation">(</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>u_ModelMatrix*a_Position 是模型矩阵对顶点的变换</li><li>mat3(u_ModelMatrix) 是为了提取模型矩阵的变换因子，也就是去掉位移数据</li><li>mat3(u_ModelMatrix)*a_Normal 就是对法线的变换，变换之后，别忘了再用normalize 方法将其归一化</li></ul><h3 id="_5-gouraud逐顶点着色" tabindex="-1"><a class="header-anchor" href="#_5-gouraud逐顶点着色" aria-hidden="true">#</a> 5.Gouraud逐顶点着色</h3><h4 id="_5-1算法原理" tabindex="-1"><a class="header-anchor" href="#_5-1算法原理" aria-hidden="true">#</a> 5.1算法原理</h4><p>three.js 里SphereGeometry 对象的法线，就是用于逐顶点着色的。<br><img src="/visual/webgl-share/150.png" alt=""></p><p>然而，如果一个模型不是球体，应该如何计算其逐顶点着色的法线呢？<br> 我们可以这么算：求顶点相邻三角形法线的均值。 <img src="/visual/webgl-share/151.png" alt=""></p><p>以上图中的顶点法线Nv 为例，其计算公式如下<br><img src="/visual/webgl-share/152.png" alt=""></p><p>然而，为了追求更好的效果，我们还可以在求均值的时候，基于三角形的面积做一下加权处理。</p><h4 id="_5-2代码实现" tabindex="-1"><a class="header-anchor" href="#_5-2代码实现" aria-hidden="true">#</a> 5.2代码实现</h4><ol><li>在之前的ShadingFrequency.js 文件里添加一个gouraudShading() 方法，用于获取逐顶点着色的法线。</li></ol><p>gouraudShading(vertices, indexes,type=1)</p><ul><li>vertices 顶点集合</li><li>indexes 顶点索引集合</li><li>type 计算法线的方式 <ul><li>0，相邻三角形的法线的平均值</li><li>1，相邻的三角形法线基于面积的加权平均值，默认</li></ul></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">gouraudShading</span><span class="token punctuation">(</span><span class="token parameter">vertices<span class="token punctuation">,</span> indexes<span class="token punctuation">,</span>type<span class="token operator">=</span><span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> normals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vertices<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    normals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token function">getGouraudNormal</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>vertices<span class="token punctuation">,</span>indexes<span class="token punctuation">,</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>normals<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//基于顶点索引获取顶点的法线</span>
<span class="token keyword">function</span> <span class="token function">getGouraudNormal</span><span class="token punctuation">(</span><span class="token parameter">ind<span class="token punctuation">,</span> vertices<span class="token punctuation">,</span> indexes<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 法线</span>
  <span class="token keyword">const</span> normal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 与顶点相邻三角形的数据集合</span>
    <span class="token keyword">const</span> triangles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 与顶点相邻三角形的面积的总和</span>
    <span class="token keyword">let</span> sumArea <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment">// 寻找相邻三角形</span>
    <span class="token function">findTriangles</span><span class="token punctuation">(</span>ind<span class="token punctuation">,</span>vertices<span class="token punctuation">,</span> indexes<span class="token punctuation">,</span> <span class="token parameter">n</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> area <span class="token operator">=</span> n<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      sumArea <span class="token operator">+=</span> area
      triangles<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>n<span class="token punctuation">,</span>area<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 加权平均值</span>
    triangles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> n<span class="token punctuation">,</span> area <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      normal<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
        n<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span>area <span class="token operator">/</span> sumArea<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 与顶点相邻三角形的法线的总和</span>
    <span class="token function">findTriangles</span><span class="token punctuation">(</span>ind<span class="token punctuation">,</span>vertices<span class="token punctuation">,</span> indexes<span class="token punctuation">,</span> <span class="token parameter">n</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      normal<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 法线之和归一化</span>
    normal<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> normal
<span class="token punctuation">}</span>

<span class="token comment">// 寻找与顶点相邻的所有三角形</span>
<span class="token keyword">function</span> <span class="token function">findTriangles</span><span class="token punctuation">(</span><span class="token parameter">ind<span class="token punctuation">,</span>vertices<span class="token punctuation">,</span> indexes<span class="token punctuation">,</span>fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> indexes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 寻找共点三角形</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>indexes<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>ind<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 三角形的三个顶点</span>
      <span class="token keyword">const</span> p0 <span class="token operator">=</span> <span class="token function">getVertice</span><span class="token punctuation">(</span>vertices<span class="token punctuation">,</span> indexes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token function">getVertice</span><span class="token punctuation">(</span>vertices<span class="token punctuation">,</span> indexes<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> p2 <span class="token operator">=</span> <span class="token function">getVertice</span><span class="token punctuation">(</span>vertices<span class="token punctuation">,</span> indexes<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token comment">// 三角面的法线</span>
      <span class="token keyword">const</span> n <span class="token operator">=</span> p2<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>
          p0<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      <span class="token function">fn</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><ol start="2"><li>使用之前的球体测试一下</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> gouraudShading <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./jsm/ShadingFrequency.js&#39;</span>

<span class="token keyword">const</span> sphere <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sphere</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> vertices<span class="token punctuation">,</span> indexes <span class="token punctuation">}</span> <span class="token operator">=</span> sphere
<span class="token keyword">const</span> normals <span class="token operator">=</span> <span class="token function">gouraudShading</span><span class="token punctuation">(</span>vertices<span class="token punctuation">,</span> indexes<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>效果如下：<br><img src="/visual/webgl-share/153.png" alt=""></p><p>由上图可见，高光没了。<br> 这就是逐顶点着色的弊端，只要面数不够，高光就没了。<br> 若是用逐片元着色来绘图，这个问题就不会出现。</p><h3 id="_6-phong-逐片元着色" tabindex="-1"><a class="header-anchor" href="#_6-phong-逐片元着色" aria-hidden="true">#</a> 6.Phong-逐片元着色</h3><p>之前逐顶点着色时，在片元着色器里计算的法线插值已经不一定是单位向量，而是长度小于等于1的向量。 比如下图中橙色法线之间的黑色向量，其长度已经小于了1，这就是逐顶点着色中高光消失的原因。<br><img src="/visual/webgl-share/154.png" alt=""></p><p>若想让高光出现，将黑色向量单位化即可，也就是让其长度再加上蓝色的那一段，如此着色的方法就叫逐片元着色。<br> 接下里，我们可以直接基于逐顶点着色的方法改一下片元着色器即可。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;fs&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-fragment&quot;</span><span class="token operator">&gt;</span>
    precision mediump float<span class="token punctuation">;</span>
    uniform vec3 u_Kd<span class="token punctuation">;</span>
    uniform vec3 u_Ks<span class="token punctuation">;</span>
    uniform vec3 u_Ka<span class="token punctuation">;</span>
    uniform vec3 u_LightDir<span class="token punctuation">;</span>
    uniform vec3 u_Eye<span class="token punctuation">;</span>
    varying vec3 v_Normal<span class="token punctuation">;</span>
    varying vec3 v_Position<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//法线插值归一化</span>
      vec3 normal<span class="token operator">=</span><span class="token function">normalize</span><span class="token punctuation">(</span>v_Normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//眼睛看向当前着色点的视线</span>
      vec3 eyeDir<span class="token operator">=</span><span class="token function">normalize</span><span class="token punctuation">(</span>u_Eye<span class="token operator">-</span>v_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//视线与光线之和</span>
      vec3 el<span class="token operator">=</span>eyeDir<span class="token operator">+</span>u_LightDir<span class="token punctuation">;</span>
      <span class="token comment">//视线与光线的角平分线</span>
      vec3 h<span class="token operator">=</span>el<span class="token operator">/</span><span class="token function">length</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//漫反射</span>
      vec3 diffuse<span class="token operator">=</span>u_Kd<span class="token operator">*</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span>u_LightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//反射</span>
      vec3 specular<span class="token operator">=</span>u_Ks<span class="token operator">*</span><span class="token function">pow</span><span class="token punctuation">(</span>
        <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span>h<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">64.0</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//Blinn-Phong反射</span>
      vec3 l<span class="token operator">=</span>diffuse<span class="token operator">+</span>specular<span class="token operator">+</span>u_Ka<span class="token punctuation">;</span>
      gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>效果如下：<br><img src="/visual/webgl-share/155.png" alt=""></p><p>上面球体的宽、高段数是6和4，面数很低，但其表面效果依旧很细腻，这就是逐片元着色的优势。</p><h2 id="二十三、光源类型" tabindex="-1"><a class="header-anchor" href="#二十三、光源类型" aria-hidden="true">#</a> 二十三、光源类型</h2><p>之前用平行光说了着色频率的概念。<br> 光源除了平行光，还有点光源，若对平行光和点光源的照射范围和衰减做限制，还会衍生出筒灯、聚光灯等类型的灯光。</p><h3 id="_1-筒灯" tabindex="-1"><a class="header-anchor" href="#_1-筒灯" aria-hidden="true">#</a> 1.筒灯</h3><h4 id="_1-1筒灯概念" tabindex="-1"><a class="header-anchor" href="#_1-1筒灯概念" aria-hidden="true">#</a> 1.1筒灯概念</h4><p>对平行光的照射范围做限制后，其灯光打出的效果便可以如下图一样：<br><img src="/visual/webgl-share/156.png" alt=""></p><p>筒灯的照射方式如下：<br><img src="/visual/webgl-share/157.png" alt=""></p><p>通过上面的两个图，可以知道，要把平行光限制成筒灯，需要以下已知条件：</p><ul><li>筒灯位置 u_LightPos</li><li>筒灯目标点 u_LightTarget</li><li>光照强度 u_Intensity</li><li>衰减距离 <ul><li>衰减起始距离 u_Dist1</li><li>衰减结束距离 u_Dist2</li><li>反向衰减距离 u_Dist3</li></ul></li><li>衰减范围 <ul><li>衰减起始范围 u_R1</li><li>衰减结束范围 u_R2</li></ul></li></ul><h4 id="_1-2代码实现" tabindex="-1"><a class="header-anchor" href="#_1-2代码实现" aria-hidden="true">#</a> 1.2代码实现</h4><p>下图是将要实现的筒灯效果。<br><img src="/visual/webgl-share/158.png" alt=""></p><p>为了更好的观察灯光，需要先建立一块幕布。</p><ol><li>幕布 Backdrop.js</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/*
属性：
  w：宽
  h：高
  d：深
  vertices：顶点集合
  normals：法线集合
  indexes：顶点索引集合
  count：顶点数量
*/</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Backdrop</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">w<span class="token punctuation">,</span>h<span class="token punctuation">,</span>d</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>w<span class="token operator">=</span>w
    <span class="token keyword">this</span><span class="token punctuation">.</span>h<span class="token operator">=</span>h
    <span class="token keyword">this</span><span class="token punctuation">.</span>d<span class="token operator">=</span>d
    <span class="token keyword">this</span><span class="token punctuation">.</span>vertices<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>normals<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>indexes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">12</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>w <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>d<span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token operator">-</span>x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token operator">-</span>x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">,</span>
      x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">,</span>
      <span class="token operator">-</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token operator">-</span>x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>normals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>indexes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint16Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><ol start="2"><li>着色器</li></ol><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vs<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    attribute vec4 a_Position<span class="token punctuation">;</span>
    attribute vec3 a_Normal<span class="token punctuation">;</span>
    uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
    uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
    varying vec3 v_Normal<span class="token punctuation">;</span>
    varying vec3 v_Position<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      vec4 worldPos<span class="token operator">=</span>u_ModelMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
      gl_Position <span class="token operator">=</span> u_PvMatrix<span class="token operator">*</span>worldPos<span class="token punctuation">;</span>
      v_Normal<span class="token operator">=</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">mat3</span><span class="token punctuation">(</span>u_ModelMatrix<span class="token punctuation">)</span><span class="token operator">*</span>a_Normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
      v_Position<span class="token operator">=</span><span class="token function">vec3</span><span class="token punctuation">(</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fs<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    precision mediump float<span class="token punctuation">;</span>
    <span class="token comment">//漫反射系数</span>
    uniform vec3 u_Kd<span class="token punctuation">;</span>
    <span class="token comment">//镜面反射系数</span>
    uniform vec3 u_Ks<span class="token punctuation">;</span>
    <span class="token comment">//环境光反射系数</span>
    uniform vec3 u_Ka<span class="token punctuation">;</span>

    <span class="token comment">//视点</span>
    uniform vec3 u_Eye<span class="token punctuation">;</span>
    <span class="token comment">// 筒灯位置</span>
    uniform vec3 u_LightPos<span class="token punctuation">;</span>
    <span class="token comment">// 筒灯目标点 </span>
    uniform vec3 u_LightTarget<span class="token punctuation">;</span>
    <span class="token comment">//灯光强度</span>
    uniform float u_Intensity<span class="token punctuation">;</span>
    
    <span class="token comment">//衰减起始距离</span>
    uniform float u_Dist1<span class="token punctuation">;</span>
    <span class="token comment">//衰减结束距离</span>
    uniform float u_Dist2<span class="token punctuation">;</span>
    <span class="token comment">//反向衰减距离</span>
    uniform float u_Dist3<span class="token punctuation">;</span>
    
    <span class="token comment">//衰减起始范围</span>
    uniform float u_R1<span class="token punctuation">;</span>
    <span class="token comment">//衰减结束范围</span>
    uniform float u_R2<span class="token punctuation">;</span>
    
    <span class="token comment">//法线插值</span>
    varying vec3 v_Normal<span class="token punctuation">;</span>
    <span class="token comment">//点位插值</span>
    varying vec3 v_Position<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//光线方向</span>
      vec3 lightDir<span class="token operator">=</span><span class="token function">normalize</span><span class="token punctuation">(</span>u_LightPos<span class="token operator">-</span>u_LightTarget<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//法线插值归一化</span>
      vec3 normal<span class="token operator">=</span><span class="token function">normalize</span><span class="token punctuation">(</span>v_Normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//眼睛看向当前着色点的视线</span>
      vec3 eyeDir<span class="token operator">=</span><span class="token function">normalize</span><span class="token punctuation">(</span>u_Eye<span class="token operator">-</span>v_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//视线与光线的角平分线</span>
      vec3 h<span class="token operator">=</span><span class="token function">normalize</span><span class="token punctuation">(</span>eyeDir<span class="token operator">+</span>lightDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//漫反射</span>
      vec3 diffuse<span class="token operator">=</span>u_Kd<span class="token operator">*</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span>lightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//镜面反射</span>
      vec3 specular<span class="token operator">=</span>u_Ks<span class="token operator">*</span><span class="token function">pow</span><span class="token punctuation">(</span>
        <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span>h<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">64.0</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//着色点到光源的向量</span>
      vec3 pl<span class="token operator">=</span>u_LightPos<span class="token operator">-</span>v_Position<span class="token punctuation">;</span>
      <span class="token comment">//着色点到光线的距离</span>
      float r<span class="token operator">=</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token function">cross</span><span class="token punctuation">(</span>pl<span class="token punctuation">,</span>lightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//光线垂直方向的衰减</span>
      float fallY<span class="token operator">=</span><span class="token number">1.0</span><span class="token operator">-</span><span class="token function">smoothstep</span><span class="token punctuation">(</span>u_R1<span class="token punctuation">,</span>u_R2<span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//当前着色点到筒灯光源平面的距离</span>
      float dist<span class="token operator">=</span><span class="token function">dot</span><span class="token punctuation">(</span>pl<span class="token punctuation">,</span>lightDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//光线方向的衰减</span>
      float fallX<span class="token operator">=</span><span class="token number">1.0</span><span class="token operator">-</span><span class="token function">smoothstep</span><span class="token punctuation">(</span>u_Dist1<span class="token punctuation">,</span>u_Dist2<span class="token punctuation">,</span>dist<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//反向衰减</span>
      float fallB<span class="token operator">=</span><span class="token function">smoothstep</span><span class="token punctuation">(</span>u_Dist3<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>dist<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//筒灯作用于当前着色点的亮度</span>
      float intensity<span class="token operator">=</span>u_Intensity<span class="token operator">*</span>fallY<span class="token operator">*</span>fallX<span class="token operator">*</span>fallB<span class="token punctuation">;</span>
      <span class="token comment">//着色点颜色</span>
      vec3 color<span class="token operator">=</span>intensity<span class="token operator">*</span><span class="token punctuation">(</span>diffuse<span class="token operator">+</span>specular<span class="token punctuation">)</span><span class="token operator">+</span>u_Ka<span class="token punctuation">;</span>
      gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div><ol start="2"><li>导入相关组件</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createProgram<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;/jsm/Utils.js&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Matrix4<span class="token punctuation">,</span> PerspectiveCamera<span class="token punctuation">,</span> Vector3
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> OrbitControls <span class="token keyword">from</span> <span class="token string">&#39;./jsm/OrbitControls.js&#39;</span>
<span class="token keyword">import</span> Mat <span class="token keyword">from</span> <span class="token string">&#39;./lv/Mat.js&#39;</span>
<span class="token keyword">import</span> Geo <span class="token keyword">from</span> <span class="token string">&#39;./lv/Geo.js&#39;</span>
<span class="token keyword">import</span> Obj3D <span class="token keyword">from</span> <span class="token string">&#39;./lv/Obj3D.js&#39;</span>
<span class="token keyword">import</span> Scene <span class="token keyword">from</span> <span class="token string">&#39;./lv/Scene.js&#39;</span>
<span class="token keyword">import</span> Sphere <span class="token keyword">from</span> <span class="token string">&#39;./lv/Sphere.js&#39;</span>
<span class="token keyword">import</span> Backdrop <span class="token keyword">from</span> <span class="token string">&#39;./lv/Backdrop.js&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> gouraudShading <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./lv/ShadingFrequency.js&#39;</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ol start="3"><li>建立webgl上下文对象</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
<span class="token keyword">let</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="4"><li>建立相机轨道</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 视点</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token number">45</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">50</span>
<span class="token punctuation">]</span>
<span class="token comment">// 透视相机</span>
<span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span>
camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span>
<span class="token comment">// 轨道控制器</span>
<span class="token keyword">const</span> orbit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrbitControls</span><span class="token punctuation">(</span><span class="token punctuation">{</span> camera<span class="token punctuation">,</span> target<span class="token punctuation">,</span> <span class="token literal-property property">dom</span><span class="token operator">:</span> canvas<span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ol start="5"><li>实例化球体和幕布</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* 球体 */</span>
<span class="token keyword">const</span> sphere <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sphere</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> vertices<span class="token punctuation">,</span> indexes <span class="token punctuation">}</span> <span class="token operator">=</span> sphere
<span class="token keyword">const</span> normals <span class="token operator">=</span> <span class="token function">gouraudShading</span><span class="token punctuation">(</span>vertices<span class="token punctuation">,</span> indexes<span class="token punctuation">)</span>
<span class="token comment">//球体模型矩阵</span>
<span class="token keyword">const</span> sphereMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> sphere<span class="token punctuation">.</span>r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment">/* 幕布 */</span>
<span class="token keyword">const</span> backdrop <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Backdrop</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment">// 幕布模型矩阵</span>
<span class="token keyword">const</span> backMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ol start="6"><li>声明模型的颜色系数和灯光数据</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 漫反射系数-颜色</span>
<span class="token keyword">const</span> u_Kd <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">]</span>
<span class="token comment">// 镜面反射系数-颜色</span>
<span class="token keyword">const</span> u_Ks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">]</span>
<span class="token comment">// 环境光系数-颜色</span>
<span class="token keyword">const</span> u_Ka <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">]</span>

<span class="token comment">// 筒灯位置</span>
<span class="token keyword">const</span> u_LightPos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment">// 筒灯目标点</span>
<span class="token keyword">const</span> u_LightTarget <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 光照强度</span>
<span class="token keyword">const</span> u_Intensity <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">// 衰减起始距离</span>
<span class="token keyword">const</span> u_Dist1 <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">// 衰减结束距离</span>
<span class="token keyword">const</span> u_Dist2 <span class="token operator">=</span> <span class="token number">10</span>
<span class="token comment">// 反向衰减距离</span>
<span class="token keyword">const</span> u_Dist3 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token comment">// 衰减起始范围</span>
<span class="token keyword">const</span> u_R1 <span class="token operator">=</span> <span class="token number">2</span>
<span class="token comment">// 衰减结束范围</span>
<span class="token keyword">const</span> u_R2 <span class="token operator">=</span> <span class="token number">2.5</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><ol start="7"><li>基于上面的已知条件，建立三类uniform数据</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 灯光数据</span>
<span class="token keyword">const</span> lightData <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">u_LightPos</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>u_LightPos<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">u_LightTarget</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>u_LightTarget<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">u_Intensity</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform1f&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">u_R1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> u_R1<span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform1f&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">u_R2</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> u_R2<span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform1f&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">u_Dist1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> u_Dist1<span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform1f&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">u_Dist2</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> u_Dist2<span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform1f&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">u_Dist3</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> u_Dist3<span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform1f&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token comment">// 材质数据</span>
<span class="token keyword">const</span> matData <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">u_Kd</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> u_Kd<span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">u_Ks</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> u_Ks<span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">u_Ka</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> u_Ka<span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token comment">// 相机数据</span>
<span class="token keyword">const</span> cameraData <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">u_Eye</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>position<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform3fv&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><ol start="8"><li>绘图</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 场景</span>
<span class="token keyword">const</span> scene <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">{</span> gl <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 注册程序对象</span>
scene<span class="token punctuation">.</span><span class="token function">registerProgram</span><span class="token punctuation">(</span>
  <span class="token string">&#39;Blinn-Phong&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">,</span>
      document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
      document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">attributeNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;a_Normal&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">uniformNames</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&#39;u_PvMatrix&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_ModelMatrix&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_Eye&#39;</span><span class="token punctuation">,</span>
      <span class="token string">&#39;u_Kd&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_Ks&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_Ka&#39;</span><span class="token punctuation">,</span>
      <span class="token string">&#39;u_LightPos&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_LightTarget&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_Intensity&#39;</span><span class="token punctuation">,</span>
      <span class="token string">&#39;u_Dist1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_Dist2&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_Dist3&#39;</span><span class="token punctuation">,</span>
      <span class="token string">&#39;u_R1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_R2&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token comment">// 球体</span>
<span class="token keyword">const</span> matSphere <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;Blinn-Phong&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> sphereMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>cameraData<span class="token punctuation">,</span>
    <span class="token operator">...</span>lightData<span class="token punctuation">,</span>
    <span class="token operator">...</span>matData
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">&#39;TRIANGLES&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> geoSphere <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> vertices<span class="token punctuation">,</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">a_Normal</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> normals<span class="token punctuation">,</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">array</span><span class="token operator">:</span> indexes
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> objSphere <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">geo</span><span class="token operator">:</span> geoSphere<span class="token punctuation">,</span> <span class="token literal-property property">mat</span><span class="token operator">:</span> matSphere <span class="token punctuation">}</span><span class="token punctuation">)</span>
scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>objSphere<span class="token punctuation">)</span>

<span class="token comment">// 幕布</span>
<span class="token keyword">const</span> matBack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;Blinn-Phong&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> backMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>cameraData<span class="token punctuation">,</span>
    <span class="token operator">...</span>lightData<span class="token punctuation">,</span>
    <span class="token operator">...</span>matData
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> geoBack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> backdrop<span class="token punctuation">.</span>vertices<span class="token punctuation">,</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">a_Normal</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> backdrop<span class="token punctuation">.</span>normals<span class="token punctuation">,</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">array</span><span class="token operator">:</span> backdrop<span class="token punctuation">.</span>indexes
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> objBack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">mat</span><span class="token operator">:</span> matBack<span class="token punctuation">,</span> <span class="token literal-property property">geo</span><span class="token operator">:</span> geoBack <span class="token punctuation">}</span><span class="token punctuation">)</span>
scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>objBack<span class="token punctuation">)</span>

<span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&#39;u_Eye&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>position<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br></div></div><ol start="9"><li>相机轨道交互事件</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* 取消右击菜单的显示 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;contextmenu&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/* 指针按下时，设置拖拽起始位，获取轨道控制器状态。 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerdown&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">pointerdown</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/* 指针移动时，若控制器处于平移状态，平移相机；若控制器处于旋转状态，旋转相机。 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointermove&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">pointermove</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/* 指针抬起 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerup&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">pointerup</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/* 滚轮事件 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;wheel&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">wheel</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="_2-锥形灯" tabindex="-1"><a class="header-anchor" href="#_2-锥形灯" aria-hidden="true">#</a> 2.锥形灯</h3><h4 id="_1-1锥形灯概念" tabindex="-1"><a class="header-anchor" href="#_1-1锥形灯概念" aria-hidden="true">#</a> 1.1锥形灯概念</h4><p>锥形灯可以理解为对点光源的限制，从侧面看，其打出的光线成锥形。<br><img src="/visual/webgl-share/159.png" alt=""></p><p>锥形灯的照射效果如下：<br><img src="/visual/webgl-share/160.png" alt=""></p><p>定义锥形灯的条件：</p><ul><li>锥形灯位置 u_LightPos</li><li>锥形灯目标点 u_LightTarget</li><li>光照强度 u_Intensity</li><li>衰减距离 <ul><li>衰减起始距离 u_Dist1</li><li>衰减结束距离 u_Dist2</li></ul></li><li>衰减夹角 <ul><li>衰减起始夹角 u_Fov1</li><li>衰减结束夹角 u_Fov2</li></ul></li></ul><h4 id="_1-2代码实现-1" tabindex="-1"><a class="header-anchor" href="#_1-2代码实现-1" aria-hidden="true">#</a> 1.2代码实现</h4><p>可以直接在之前筒灯的基础上做一下修改。</p><ol><li>把之前的衰减范围变成衰减夹角</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 衰减起始范围</span>
<span class="token keyword">const</span> u_Fov1 <span class="token operator">=</span> <span class="token number">20</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">180</span>
<span class="token comment">// 衰减结束范围</span>
<span class="token keyword">const</span> u_Fov2 <span class="token operator">=</span> u_Fov1 <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">180</span>
<span class="token comment">// 灯光数据</span>
<span class="token keyword">const</span> lightData <span class="token operator">=</span> <span class="token punctuation">{</span>
  ……
  <span class="token literal-property property">u_Fov1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> u_Fov1<span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform1f&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">u_Fov2</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> u_Fov2<span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform1f&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  ……
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ol start="2"><li>在片元着色器中，根据衰减夹角计算灯光在光线垂直方向的衰减</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//衰减范围</span>
float r1<span class="token operator">=</span><span class="token function">tan</span><span class="token punctuation">(</span>u_Fov1<span class="token punctuation">)</span><span class="token operator">*</span>dist<span class="token punctuation">;</span>
float r2<span class="token operator">=</span><span class="token function">tan</span><span class="token punctuation">(</span>u_Fov2<span class="token punctuation">)</span><span class="token operator">*</span>dist<span class="token punctuation">;</span>
<span class="token comment">//着色点到光线的距离</span>
float r<span class="token operator">=</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token function">cross</span><span class="token punctuation">(</span>pl<span class="token punctuation">,</span>lightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//光线垂直方向的衰减</span>
float fallY<span class="token operator">=</span><span class="token number">1.0</span><span class="token operator">-</span><span class="token function">smoothstep</span><span class="token punctuation">(</span>r1<span class="token punctuation">,</span>r2<span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//取消灯光背面的照明</span>
float fallB<span class="token operator">=</span><span class="token function">step</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span>dist<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>对于灯光的类型，就先说这两个。<br> 其实，灯光中是可以绘图的，只是这块知识有点复杂，后面说。<br> 这里，就看个小例子。</p><h3 id="扩展-泉" tabindex="-1"><a class="header-anchor" href="#扩展-泉" aria-hidden="true">#</a> 扩展-泉</h3><p>可以基于着色点到光线的距离做一个正弦波衰减。<br><img src="/visual/webgl-share/161.png" alt=""></p><ol><li>片元着色器中的算法如下：</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//衰减范围</span>
float r1<span class="token operator">=</span><span class="token function">tan</span><span class="token punctuation">(</span>u_Fov1<span class="token punctuation">)</span><span class="token operator">*</span>dist<span class="token punctuation">;</span>
float r2<span class="token operator">=</span><span class="token function">tan</span><span class="token punctuation">(</span>u_Fov2<span class="token punctuation">)</span><span class="token operator">*</span>dist<span class="token punctuation">;</span>
<span class="token comment">//着色点到光线的距离</span>
float r<span class="token operator">=</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token function">cross</span><span class="token punctuation">(</span>pl<span class="token punctuation">,</span>lightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//光线垂直方向的衰减</span>
float fallY<span class="token operator">=</span><span class="token number">1.0</span><span class="token operator">-</span><span class="token function">smoothstep</span><span class="token punctuation">(</span>r1<span class="token punctuation">,</span>r2<span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//正弦波衰减弧度</span>
float fallAng<span class="token operator">=</span><span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span>r2<span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">40.0</span><span class="token operator">-</span>u_Time<span class="token operator">/</span><span class="token number">60.0</span><span class="token punctuation">;</span>
<span class="token comment">//正弦波衰减</span>
float fallSin<span class="token operator">=</span><span class="token number">1.0</span><span class="token operator">-</span><span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token function">sin</span><span class="token punctuation">(</span>fallAng<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//取消灯光背面的照明</span>
float fallB<span class="token operator">=</span><span class="token function">step</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span>dist<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//光源作用于当前着色点的亮度</span>
float intensity<span class="token operator">=</span>u_Intensity<span class="token operator">*</span>fallX<span class="token operator">*</span>fallY<span class="token operator">*</span>fallSin<span class="token operator">*</span>fallB<span class="token punctuation">;</span>
<span class="token comment">//着色点颜色</span>
vec3 color<span class="token operator">=</span>intensity<span class="token operator">*</span><span class="token punctuation">(</span>diffuse<span class="token operator">+</span>specular<span class="token punctuation">)</span><span class="token operator">+</span>u_Ka<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ol start="2"><li>调整一下相机和灯光</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//相机目标点</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment">//相机视点</span>
<span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
……

<span class="token comment">// 锥形灯位置</span>
<span class="token keyword">const</span> u_LightPos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">// 锥形灯目标点</span>
<span class="token keyword">const</span> u_LightTarget <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 光照强度</span>
<span class="token keyword">const</span> u_Intensity <span class="token operator">=</span> <span class="token number">15</span>
<span class="token comment">// 衰减起始距离</span>
<span class="token keyword">const</span> u_Dist1 <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">// 衰减结束距离</span>
<span class="token keyword">const</span> u_Dist2 <span class="token operator">=</span> <span class="token number">8.5</span>
<span class="token comment">// 衰减起始范围</span>
<span class="token keyword">const</span> u_Fov1 <span class="token operator">=</span> <span class="token number">25</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">180</span>
<span class="token comment">// 衰减结束范围</span>
<span class="token keyword">const</span> u_Fov2 <span class="token operator">=</span> u_Fov1 <span class="token operator">+</span> <span class="token number">10</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">180</span>
……
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="二十四、帧缓冲区" tabindex="-1"><a class="header-anchor" href="#二十四、帧缓冲区" aria-hidden="true">#</a> 二十四、帧缓冲区</h2><p>其实，接下来想说投影的，然而投影的计算还需要帧缓冲区，所以得先解释一下帧缓冲区的概念。</p><h3 id="_1-帧缓冲区的概念" tabindex="-1"><a class="header-anchor" href="#_1-帧缓冲区的概念" aria-hidden="true">#</a> 1.帧缓冲区的概念</h3><p>webgl 绘图过程是：顶点着色器定形，片元着色器逐片元填颜色，然后绘制到canvas画布上。<br><img src="/visual/webgl-share/162.png" alt=""></p><p>其实，绘图的时候，也可以不把图形绘制到画布上，而是绘制到内存之中，这样可以在不显示图像的前提下，获取webgl 绘制的图像数据。<br> 这块在内存中存储webgl 图像的区域，就叫<strong>帧缓冲区</strong>。<br><img src="/visual/webgl-share/163.png" alt=""></p><p>有了帧缓冲区的图像数据之后，还不显示它，那帧缓冲区有啥用呢？<br> 帧缓冲区的作用非常强大，可以对webgl 的渲染结果做后处理，比如为模型添加描边、光晕等；还可以基于光源生成深度贴图，计算投影……</p><p>对于帧缓冲区的基本概念和作用就说到这，接下来用代码敲一下。</p><h3 id="_2-帧缓冲区的代码实现" tabindex="-1"><a class="header-anchor" href="#_2-帧缓冲区的代码实现" aria-hidden="true">#</a> 2.帧缓冲区的代码实现</h3><p>入门webgl 的时候画过一个点，接下把这个点画到帧缓冲区里去。</p><ol><li>这是在canvas 画布中绘制一个点的方法。</li></ol><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vs1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//点位</span>
      gl_Position<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//尺寸</span>
      gl_PointSize<span class="token operator">=</span><span class="token number">100.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fs1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">import</span> <span class="token punctuation">{</span> createProgram <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../jsm/Utils.js&#39;</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">;</span>
  	canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> vs1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vs1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
    <span class="token keyword">const</span> fs1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fs1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
    <span class="token keyword">const</span> program1 <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vs1<span class="token punctuation">,</span> fs1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program1<span class="token punctuation">)</span>
    
    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>效果如下：<br><img src="/visual/webgl-share/164.png" alt=""></p><ol start="2"><li>在绘制图形的时候做个拦截，把图形画到帧缓冲区里。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>……
<span class="token keyword">const</span> vs1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vs1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
<span class="token keyword">const</span> fs1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fs1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
<span class="token keyword">const</span> program1 <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vs1<span class="token punctuation">,</span> fs1<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program1<span class="token punctuation">)</span>

<span class="token comment">//纹理对象</span>
gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>
  gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
  gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span>
  gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>
  gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token keyword">null</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//帧缓冲区</span>
<span class="token keyword">const</span> framebuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createFramebuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> framebuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">framebufferTexture2D</span><span class="token punctuation">(</span>
  gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span>
  gl<span class="token punctuation">.</span><span class="token constant">COLOR_ATTACHMENT0</span><span class="token punctuation">,</span>
  gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
  texture<span class="token punctuation">,</span> <span class="token number">0</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//设置渲染尺寸</span>
gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//绘图</span>
gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>运行上面的代码，会发现浏览器在没有报错的前提下，成功绘制不出任何东西来了。<br> 上面的代码可以分两部分看，一部分是纹理对象，一部分是帧缓冲区。</p><ol><li>纹理对象是用来装webgl 绘图结果的，可以将其理解为像素数据。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>
  gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
  gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span>
  gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>
  gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token keyword">null</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>createTexture() 创建纹理对象</li><li>bindTexture(target, texture) 将纹理对象绑定到目标对象上，上面代码里的目标对象就是二维纹理对象gl.TEXTURE_2D</li><li>texParameteri() 设置纹理参数</li><li>texImage2D(target, level, internalformat, width, height, border, format, type, ArrayBufferView? pixels) 设置纹理对象的图像源 <ul><li>target 纹理目标</li><li>level mipmap 图像级别</li><li>internalformat 颜色格式</li><li>width, height 纹理对象的尺寸</li><li>border 边界宽度，必须为0</li><li>format 颜色格式， WebGL 1 中必须和internalformat 一致</li><li>type 纹理数据类型</li><li>pixels 纹理的像素源</li></ul></li></ul><ol start="2"><li>帧缓冲区可以理解为用来装纹理对象缓冲区。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> framebuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createFramebuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> framebuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">framebufferTexture2D</span><span class="token punctuation">(</span>
  gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span>
  gl<span class="token punctuation">.</span><span class="token constant">COLOR_ATTACHMENT0</span><span class="token punctuation">,</span>
  gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
  texture<span class="token punctuation">,</span> <span class="token number">0</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>createFramebuffer() 建立帧缓冲区</li><li>bindFramebuffer(target, framebuffer) 将帧缓冲区绑定到目标对象上。 <ul><li>target 目标对象，用于收集渲染图像的时所需的颜色、透明度、深度和模具缓冲区数据</li><li>framebuffer 帧缓冲区</li></ul></li><li>framebufferTexture2D(target, attachment, textarget, texture, level) 将纹理对象添加到帧缓冲区中 <ul><li>target 目标对象</li><li>attachment 设置将纹理对象绑定到哪个缓冲区中 <ul><li>gl.COLOR_ATTACHMENT0 将纹理对象绑定到颜色缓冲区</li><li>gl.DEPTH_ATTACHMENT 将纹理对象绑定到深度缓冲区</li><li>gl.STENCIL_ATTACHMENT 将纹理对象绑定到模板缓冲区</li></ul></li><li>textarget 纹理的目标对象</li><li>texture 纹理对象</li><li>level mipmap 图像级别</li></ul></li></ul><ol start="3"><li>渲染方法，把图形渲染进帧缓冲区的纹理对象里。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="4"><li>图形在渲染的时候，会有一个VIEWPORT 尺寸，可以把这个尺寸理解为渲染尺寸，这个尺寸默认和canvas 画布一致。</li></ol><p>可以用gl.getParameter(gl.VIEWPORT) 方法获取画布的像素尺寸。<br> 也需要知道设置这个渲染尺寸的方法：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//设置渲染尺寸</span>
gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//绘图</span>
gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>viewport(x,y,w,h) <ul><li>x,y 是VIEWPORT 的左下角点位置</li><li>w,h 是VIEWPORT 的宽高</li></ul></li></ul><p>在帧缓冲区中，一般会把VIEWPORT 尺寸设置的和纹理对象一样大，这样最终渲染出的图像就是和纹理对象一样大的图像。</p><p>有了帧缓冲区之后，就可以把帧缓冲区中的纹理对象当成真的纹理对象来用，把它贴到模型上。</p><h3 id="_3-帧缓冲区的显示" tabindex="-1"><a class="header-anchor" href="#_3-帧缓冲区的显示" aria-hidden="true">#</a> 3.帧缓冲区的显示</h3><p>接着上面的代码往后写。</p><ol><li>写一套纹理着色器，用于显示帧缓冲区里的纹理对象。</li></ol><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vs2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  attribute vec2 a_Pin<span class="token punctuation">;</span>
  varying vec2 v_Pin<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
    v_Pin<span class="token operator">=</span>a_Pin<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fs2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform sampler2D u_Sampler<span class="token punctuation">;</span>
  varying vec2 v_Pin<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor<span class="token operator">=</span><span class="token function">texture2D</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span>v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ol start="2"><li>帧缓冲区绘制完图像后，把帧缓冲区置空，否则下次绘图还是会画到帧缓冲区里，而不是画到canvas 画布里。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol start="3"><li>将viewport 恢复到当前canvas 画布的尺寸。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol start="4"><li>绘制一个矩形面，把帧缓冲区里的纹理对象贴上去。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> vs2 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vs2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
<span class="token keyword">const</span> fs2 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fs2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
<span class="token keyword">const</span> program2 <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vs2<span class="token punctuation">,</span> fs2<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program2<span class="token punctuation">)</span>

<span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
<span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> buffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program2<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> a_Pin <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program2<span class="token punctuation">,</span> <span class="token string">&#39;a_Pin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_Pin<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>

gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span>
<span class="token keyword">const</span> u_Sampler <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program2<span class="token punctuation">,</span> <span class="token string">&#39;u_Sampler&#39;</span><span class="token punctuation">)</span>
gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>最终效果如下：<br><img src="/visual/webgl-share/165.png" alt=""></p><p>当把帧缓冲区里的纹理对象显示出来后，还需要考虑一个深度问题。</p><h3 id="_4-帧缓冲区里的深度测试" tabindex="-1"><a class="header-anchor" href="#_4-帧缓冲区里的深度测试" aria-hidden="true">#</a> 4.帧缓冲区里的深度测试</h3><h4 id="_4-1深度测试的概念" tabindex="-1"><a class="header-anchor" href="#_4-1深度测试的概念" aria-hidden="true">#</a> 4.1深度测试的概念</h4><p>在webgl中绘图的时候，若没有开启深度测试 gl.DEPTH_TEST，那它就会像画水粉一样，一层层的往canvas 画布上覆盖颜色，它不会考虑图形在深度上的遮挡问题。<br><img src="/visual/webgl-share/166.png" alt=""></p><p>当开启了深度测试，离视点近的图形就会遮挡例视点远的图形。<br> 当然，这种对于深度测试的解释是有点笼统的，比如像下面的三个三角形，就没法判断谁远谁近了。<br><img src="/visual/webgl-share/167.png" alt=""></p><p>webgl的深度测试是先基于整个场景生成一张深度贴图，深度贴图里存储了离视点最近的片元的深度信息。<br> webgl 在逐片元着色时，会判断一下当前片元的的深度是否小于深度贴图里相应片元的深度，若是的话，那webgl就不会对当前片元进行渲染。<br> 从而webgl就通过只绘制在深度上离视点最近的片元的方式，解决了图形遮挡问题。</p><p>在代码里给大家演示一下深度测试的原理。</p><h4 id="_4-2深度测试的代码实现" tabindex="-1"><a class="header-anchor" href="#_4-2深度测试的代码实现" aria-hidden="true">#</a> 4.2深度测试的代码实现</h4><ol><li>画两个不同深度的点。</li></ol><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vs1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    attribute vec4 a_Position<span class="token punctuation">;</span>
    varying float v_Z<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position<span class="token operator">=</span>a_Position<span class="token punctuation">;</span>
      gl_PointSize<span class="token operator">=</span><span class="token number">200.0</span><span class="token punctuation">;</span>
      v_Z<span class="token operator">=</span>a_Position<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fs1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    precision mediump float<span class="token punctuation">;</span>
    varying float v_Z<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token function">vec3</span><span class="token punctuation">(</span>v_Z<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> createProgram <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;/jsm/Utils.js&#39;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> vs1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vs1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fs1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fs1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
  <span class="token keyword">const</span> program1 <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vs1<span class="token punctuation">,</span> fs1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program1<span class="token punctuation">)</span>

  <span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> buffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program1<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>

  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>其效果如下：<br><img src="/visual/webgl-share/168.png" alt=""></p><p>通过代码可以知道，在裁剪空间中，黑点的深度是0，白点深度是0.9，按理说是应该黑点遮挡白点的。<br> 这就因为在没有开启深度测试的情况下，webgl 会像画油画一样，根据顶点数据的排序，一个个绘制。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token comment">//黑点</span>
  <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token comment">//白点</span>
  <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在上面的代码里，先写入了黑点，又写入了白点，所以webgl先画完了黑点后，又在黑点上面覆盖了一个白点。</p><p>注：上面的点位是裁剪空间中的点位，不要将其当成世界坐标系里的点位，裁剪空间和右手规则的世界坐标系的z轴是相反的。</p><ol start="2"><li>为webgl 开启深度测试</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>效果如下：<br><img src="/visual/webgl-share/169.png" alt=""></p><p>这样 webgl 就可以解决不同深度上得图形遮挡问题。</p><p>接下来，测一下在帧缓冲区里是否也可以用同样的方式解决图形遮挡问题。</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- 点 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vs1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  varying float v_Z<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position<span class="token operator">=</span>a_Position<span class="token punctuation">;</span>
    gl_PointSize<span class="token operator">=</span><span class="token number">200.0</span><span class="token punctuation">;</span>
    v_Z<span class="token operator">=</span>a_Position<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fs1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  varying float v_Z<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token function">vec3</span><span class="token punctuation">(</span>v_Z<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 纹理着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vs2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  attribute vec2 a_Pin<span class="token punctuation">;</span>
  varying vec2 v_Pin<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
    v_Pin<span class="token operator">=</span>a_Pin<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fs2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform sampler2D u_Sampler<span class="token punctuation">;</span>
  varying vec2 v_Pin<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor<span class="token operator">=</span><span class="token function">texture2D</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span>v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> createProgram <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;/jsm/Utils.js&#39;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> texture <span class="token operator">=</span> <span class="token keyword">null</span>

  <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vs1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vs1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
    <span class="token keyword">const</span> fs1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fs1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
    <span class="token keyword">const</span> program1 <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vs1<span class="token punctuation">,</span> fs1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program1<span class="token punctuation">)</span>
    gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> buffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program1<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>

    gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span>
    texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
      gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span>
      gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token keyword">null</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> framebuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createFramebuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> framebuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">framebufferTexture2D</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span>
      gl<span class="token punctuation">.</span><span class="token constant">COLOR_ATTACHMENT0</span><span class="token punctuation">,</span>
      gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
      texture<span class="token punctuation">,</span> <span class="token number">0</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    gl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vs2 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vs2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
    <span class="token keyword">const</span> fs2 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fs2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
    <span class="token keyword">const</span> program2 <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vs2<span class="token punctuation">,</span> fs2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program2<span class="token punctuation">)</span>

    <span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> buffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> a_Position <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program2<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> a_Pin <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program2<span class="token punctuation">,</span> <span class="token string">&#39;a_Pin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_Pin<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>

    gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span>
    <span class="token keyword">const</span> u_Sampler <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program2<span class="token punctuation">,</span> <span class="token string">&#39;u_Sampler&#39;</span><span class="token punctuation">)</span>
    gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br></div></div><p>效果如下：<br><img src="/visual/webgl-share/170.png" alt=""></p><p>由此可见，在帧缓冲区中开启了帧缓冲区后，依旧无法实现不同深度的图形遮挡。<br> 这是因为还需要为帧缓冲区绑定深度缓冲区。</p><h4 id="_4-3深度缓冲区" tabindex="-1"><a class="header-anchor" href="#_4-3深度缓冲区" aria-hidden="true">#</a> 4.3深度缓冲区</h4><p>在帧缓冲区绘图之前，再建立一个渲染缓冲区，然后将其添加到帧缓冲区中。<br> 渲染缓冲区可以用于存储深度缓冲区。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> depthbuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createRenderbuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindRenderbuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">RENDERBUFFER</span><span class="token punctuation">,</span> depthbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">renderbufferStorage</span><span class="token punctuation">(</span>
  gl<span class="token punctuation">.</span><span class="token constant">RENDERBUFFER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_COMPONENT16</span><span class="token punctuation">,</span>
  <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">framebufferRenderbuffer</span><span class="token punctuation">(</span>
  gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_ATTACHMENT</span><span class="token punctuation">,</span>
  gl<span class="token punctuation">.</span><span class="token constant">RENDERBUFFER</span><span class="token punctuation">,</span> depthbuffer
<span class="token punctuation">)</span><span class="token punctuation">;</span>

gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ul><li>createRenderbuffer() 建立渲染缓冲区，渲染缓冲区可以用于存储渲染数据</li><li>renderbufferStorage(target, internalFormat, width, height) 初始化渲染缓冲区 <ul><li>target 渲染缓冲区的目标对象，只能是 gl.RENDERBUFFER</li><li>internalFormat 数据格式，gl.DEPTH_COMPONENT16便是针对深度数据的</li><li>width, height 渲染缓冲区的宽、高</li></ul></li><li>framebufferRenderbuffer(target, attachment, renderbuffertarget, renderbuffer) 向帧缓冲区中添加渲染缓冲区 <ul><li>target 帧缓冲区的目标对象</li><li>attachment 要为帧缓冲区绑定的缓冲区 <ul><li>gl.DEPTH_ATTACHMENT 深度缓冲区</li><li>……</li></ul></li><li>renderbuffertarget 渲染缓冲区的目标对象，只能是gl.RENDERBUFFER</li><li>renderbuffer 渲染缓冲区</li></ul></li></ul><p>最终效果如下：<br><img src="/visual/webgl-share/171.png" alt=""></p><p>注：webgl 的有些API 读起来有些晦涩，这里面有些是webgl 的历史遗留问题。有些API，先知道其实现原理和功能即可，有些参数不必太过深究。</p><h2 id="二十五、投影" tabindex="-1"><a class="header-anchor" href="#二十五、投影" aria-hidden="true">#</a> 二十五、投影</h2><p>当生活有了光的时候，也会有投影的存在。<br> 投影可以更好的衬托光明，让生活变得立体，有节奏。</p><p>接下来，就让我们一起探索投影，发现未知。在光影沉浮之中，寻找生活的节奏感。</p><h3 id="_1-投影的概念" tabindex="-1"><a class="header-anchor" href="#_1-投影的概念" aria-hidden="true">#</a> 1.投影的概念</h3><p>投影就是光源照射不到的地方。<br> 可以把光源想象成视点，光源看不见它所照射的物体的影子。<br> 在webgl里，要知道一个地方有没有投影，只要知道视点所看的地方有没有被光源看见到即可。<br><img src="/visual/webgl-share/172.png" alt=""></p><p>以上图的锥形灯为例，说一下如何判断一个地方有没有投影：</p><ol><li>把光源当成相机，渲染一张投影贴图塞进帧缓冲区里。投影贴图是存储图形到相机距离的图像。</li><li>在实际相机中逐片元渲染时，对比当前片元与投影贴图中相应位置的片元的深度大小。若当前片元的深度小于投影贴图中相应片元的深度，就说明当前片元在投影中。</li></ol><p>看了上面的步骤，大家可能会有很多的疑问：</p><ul><li>投影贴图怎么做？</li><li>如何把图形到光源的深度数据存入投影贴图中？</li><li>如何找到渲染时，当前片元在投影贴图中所对应的片元？</li><li>……</li></ul><p>接下来，带着疑问，看一下其代码实现过程。</p><h3 id="_2-投影的代码实现" tabindex="-1"><a class="header-anchor" href="#_2-投影的代码实现" aria-hidden="true">#</a> 2.投影的代码实现</h3><p>在下面的代码里，通过锥形灯给一个三角形添加投影。<br> 为了直击重点，先不考虑三角形对光的反射，我们只关注三角形的投影。<br> 其效果如下：<br><img src="/visual/webgl-share/173.png" alt=""></p><h4 id="_2-1在帧缓冲区中绘制投影贴图" tabindex="-1"><a class="header-anchor" href="#_2-1在帧缓冲区中绘制投影贴图" aria-hidden="true">#</a> 2.1在帧缓冲区中绘制投影贴图</h4><ol><li>在帧缓冲区绘制投影贴图的着色器</li></ol><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vs1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
  uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position<span class="token operator">=</span>u_PvMatrix<span class="token operator">*</span>u_ModelMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fs1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>z<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>在顶点着色器里，u_PvMatrix 是基于把锥形灯当成相机后，获取的投影视图矩阵。<br> 在片元着色器里，gl_FragCoord.z 是片元的深度信息，这个信息被写进了gl_FragColor 片元颜色里。<br> gl_FragCoord 对应的是片元坐标的意思，我们需要知道片元坐标和裁剪坐标的映射关系。</p><p>我之前说过，裁剪空间在x,y,z 方向的边界都是(-1,1)，这三个方向的边界映射到片元坐标后就是(0,1)，如下图所示：<br><img src="/visual/webgl-share/174.png" alt=""></p><ol start="2"><li>在js 中准备相机、灯光和模型数据</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createProgram <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;/jsm/Utils.js&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Matrix4<span class="token punctuation">,</span> 
  PerspectiveCamera<span class="token punctuation">,</span> 
  Vector3
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ratio <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth <span class="token operator">/</span> window<span class="token punctuation">.</span>innerHeight
canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth
canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight
<span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 灯光</span>
<span class="token keyword">const</span> light <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span><span class="token number">70</span><span class="token punctuation">,</span> ratio<span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">)</span>
light<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
light<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
light<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> pvMatrixLight <span class="token operator">=</span> light<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>light<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">)</span>

<span class="token comment">// 相机</span>
<span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">,</span> ratio<span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">)</span>
camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">)</span>
camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span>
camera<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> pvMatrix <span class="token operator">=</span> camera<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">)</span>

<span class="token comment">// 三角形数据</span>
<span class="token keyword">const</span> triangleVertice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span>
  <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span>
  <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// 地面数据</span>
<span class="token keyword">const</span> floorVertice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
  <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
  <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span>
  <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><ol start="3"><li>在帧缓冲区中绘图</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 纹理尺寸</span>
<span class="token keyword">const</span> width <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">,</span> height <span class="token operator">=</span> <span class="token number">1024</span>
<span class="token comment">// 纹理对象</span>
<span class="token keyword">let</span> texture <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token comment">/* 帧缓冲区内绘图 */</span>
<span class="token punctuation">{</span>
  <span class="token comment">// 程序对象</span>
  <span class="token keyword">const</span> program <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>
    gl<span class="token punctuation">,</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vs1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fs1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText
  <span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span>

  <span class="token comment">// 纹理对象</span>
  gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span>
  texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>
    gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
    gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span>
    gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>
    gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span>
    width<span class="token punctuation">,</span> height<span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token keyword">null</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 帧缓冲区</span>
  <span class="token keyword">const</span> framebuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createFramebuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> framebuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">framebufferTexture2D</span><span class="token punctuation">(</span>
    gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span>
    gl<span class="token punctuation">.</span><span class="token constant">COLOR_ATTACHMENT0</span><span class="token punctuation">,</span>
    gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
    texture<span class="token punctuation">,</span> <span class="token number">0</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 渲染缓冲区，存储深度数据</span>
  <span class="token keyword">const</span> depthbuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createRenderbuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindRenderbuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">RENDERBUFFER</span><span class="token punctuation">,</span> depthbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">renderbufferStorage</span><span class="token punctuation">(</span>
    gl<span class="token punctuation">.</span><span class="token constant">RENDERBUFFER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_COMPONENT16</span><span class="token punctuation">,</span>
    width<span class="token punctuation">,</span> height
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">framebufferRenderbuffer</span><span class="token punctuation">(</span>
    gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_ATTACHMENT</span><span class="token punctuation">,</span>
    gl<span class="token punctuation">.</span><span class="token constant">RENDERBUFFER</span><span class="token punctuation">,</span> depthbuffer
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 视口尺寸</span>
  gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 清理画布</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 灯光的投影视图矩阵</span>
  <span class="token keyword">const</span> u_PvMatrixLight <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">&#39;u_PvMatrix&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_PvMatrixLight<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> pvMatrixLight<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 三角形的模型矩阵</span>
  <span class="token keyword">const</span> u_ModelMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">&#39;u_ModelMatrix&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ModelMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 绘制三角形</span>
  <span class="token function">drawObj</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> triangleVertice<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>

  <span class="token comment">// 绘制平面</span>
  <span class="token function">drawObj</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> floorVertice<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>

  <span class="token comment">//还原</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//绘制图形</span>
<span class="token keyword">function</span> <span class="token function">drawObj</span><span class="token punctuation">(</span><span class="token parameter">program<span class="token punctuation">,</span> vertice<span class="token punctuation">,</span> count</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> verticesBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> verticesBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertice<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> attribute <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>attribute<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br></div></div><p>在帧缓冲区中绘图的原理，已经说过，这里就不再过多解释。</p><h4 id="_2-2在canvas-画布上绘图" tabindex="-1"><a class="header-anchor" href="#_2-2在canvas-画布上绘图" aria-hidden="true">#</a> 2.2在canvas 画布上绘图</h4><ol><li>着色器</li></ol><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vs2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
  uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
  
  uniform mat4 u_PvMatrixLight<span class="token punctuation">;</span>
  varying vec4 v_ClipPosLight<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec4 worldPos<span class="token operator">=</span>u_ModelMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
    gl_Position<span class="token operator">=</span>u_PvMatrix<span class="token operator">*</span>worldPos<span class="token punctuation">;</span>
    v_ClipPosLight<span class="token operator">=</span>u_PvMatrixLight<span class="token operator">*</span>worldPos<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fs2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform sampler2D u_ShadowMap<span class="token punctuation">;</span>
  varying vec4 v_ClipPosLight<span class="token punctuation">;</span>
  bool <span class="token function">isInShadow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec3 fragPos<span class="token operator">=</span><span class="token punctuation">(</span>v_ClipPosLight<span class="token punctuation">.</span>xyz<span class="token operator">/</span>v_ClipPosLight<span class="token punctuation">.</span>w<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2.0</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
    vec4 shadowFrag <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_ShadowMap<span class="token punctuation">,</span> fragPos<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> fragPos<span class="token punctuation">.</span>z<span class="token operator">&gt;</span>shadowFrag<span class="token punctuation">.</span>r<span class="token operator">+</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">256.0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    float darkness<span class="token operator">=</span><span class="token function">isInShadow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token number">0.7</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">;</span>
    gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token function">vec3</span><span class="token punctuation">(</span>darkness<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>在顶点着色器中，用到了两种点位，两种投影视图矩阵。</p><ul><li>a_Position 当前模型的顶点点位。</li><li>u_ModelMatrix 当前模型的模型矩阵。</li><li>u_PvMatrix 相机的投影视图矩阵。</li><li>u_PvMatrixLight 灯光的投影视图矩阵。</li><li>v_ClipPosLight 以锥形灯为相机时，顶点在裁剪空间里的位置。</li></ul><p>在片元着色器里，isInShadow() 即使判断当前片元是否在投影里的方法。</p><p>fragPos就是当前片元在灯光相机里的片元位。<br> fragPos的x,y 值就是当前片元在投影贴图里的x,y位置。<br> 基于fragPos的x,y 值，就可以找到投影贴图里的相应片元，即shadowFrag。<br> 因为shadowFrag的r 值里面存储了离光源最近的片元的深度，所以将其和fragPos.z 做大小判断，就可以知道当前片元是否在投影中了。<br> 按理说，我用fragPos.z&gt;shadowFrag.r 便可以判断两个深度值的大小。<br> 但是，我还让shadowFrag.r 加上了1.0/256.0，这是为了解决数据的精度问题。<br> fragPos.z 属于float 浮点数，其精度是mediump 中等精度，其范围(-pow(2,14),pow(2,14))<br> shadowFrag.r 属于像素数据，其精度只有1/pow(2,8)，即1/256=0.00390625<br> 低精度的数据在存储时，会发生数据丢失。</p><p>举个例子：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>gl_FragColor<span class="token punctuation">.</span>r<span class="token operator">=</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">256.0</span><span class="token operator">-</span><span class="token number">0.0000000001</span><span class="token punctuation">;</span>
float z<span class="token operator">=</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">256.0</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>z<span class="token operator">==</span>gl_FragColor<span class="token punctuation">.</span>r<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//绿色</span>
  gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>z<span class="token operator">&gt;</span>gl_FragColor<span class="token punctuation">.</span>r<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//红色</span>
  gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>按理说，z肯定是要比gl_FragColor.r 大的。<br> 但是，因为精度问题，gl_FragColor.r 依旧等于1.0/256.0<br> 所以，最终gl_FragColor是绿色。<br> 这也就导致了，本应该显示出来的投影不会显示。<br> 所以，我又为gl_FragColor.r 加上了一个精度。</p><ol start="2"><li>在canvas画布上绘图</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token comment">// 程序对象</span>
  <span class="token keyword">const</span> program <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>
    gl<span class="token punctuation">,</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vs2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fs2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 清理画布</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 纹理</span>
  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span>
  <span class="token keyword">const</span> u_Sampler <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">&#39;u_ShadowMap&#39;</span><span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

  <span class="token comment">//相机的投影视图矩阵</span>
  <span class="token keyword">const</span> u_PvMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">&#39;u_PvMatrix&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_PvMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> pvMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//灯光的投影视图矩阵</span>
  <span class="token keyword">const</span> u_PvMatrixLight <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">&#39;u_PvMatrixLight&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_PvMatrixLight<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> pvMatrixLight<span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 三角形的模型矩阵</span>
  <span class="token keyword">const</span> u_ModelMatrix <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">&#39;u_ModelMatrix&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>u_ModelMatrix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 绘制三角形</span>
  <span class="token function">drawObj</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> triangleVertice<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>

  <span class="token comment">// 绘制平面</span>
  <span class="token function">drawObj</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> floorVertice<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>上面的绘图逻辑之前都说过，所以就不再赘述了。</p><h3 id="_3-提高深度数据的精度" tabindex="-1"><a class="header-anchor" href="#_3-提高深度数据的精度" aria-hidden="true">#</a> 3.提高深度数据的精度</h3><p>当着色点间的深度差异较小，在gl_FragColor的1/256的精度下，可能就难以其深度差异。</p><p>比如，我把之前的光源高度调高，阴影就会消失。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>light<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>效果如下：<br><img src="/visual/webgl-share/175.png" alt=""></p><p>对于这种问题，可以通过把深度数据存储到gl_FragColor 的所有分量里，从而提高深度数据的存储精度。</p><h4 id="_3-1算法" tabindex="-1"><a class="header-anchor" href="#_3-1算法" aria-hidden="true">#</a> 3.1算法</h4><p>1/256的精度不太直观，拿1/10的精度举例子。</p><p><code>已知</code>：</p><ul><li>深度n=0.1234</li><li>四维向量v(r,g,b,a)</li><li>向量v 中每个分量的精度都是1/10</li></ul><p><code>求</code>：</p><ul><li>在不丢失数据的前提下，将实数n 存入向量v 的方法</li><li>从向量v 中读取完整数据的方法</li></ul><p><code>思路</code>：</p><p>根据已知条件可知，向量v中的每个分量只能存储小数点后的一位数，即0.0到0.9。<br> 若我们给v.x一个0.11的数字，那么向量v 会将0.11 解析为小数点后的一位数。<br> 至于解析方式是四舍五入、还是银行家舍入，那都不重要，我们只需要知道向量v中的每个分量只能存储小数点后的一位数即可。<br> 根据目测，可以知道，将实数n 小数点后的1,2,3,4 分别存入向量v 即可，因此v=(0.1,0.2,0.3,0.4)</p><p><code>解</code>：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>a<span class="token operator">=</span><span class="token punctuation">(</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
a<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>

b<span class="token operator">=</span>n<span class="token operator">*</span>a
b<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.1234</span><span class="token punctuation">,</span> <span class="token number">1.234</span><span class="token punctuation">,</span> <span class="token number">12.34</span><span class="token punctuation">,</span> <span class="token number">123.4</span><span class="token punctuation">)</span>

c<span class="token operator">=</span><span class="token function">fract</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
c<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.1234</span><span class="token punctuation">,</span> <span class="token number">0.234</span><span class="token punctuation">,</span> <span class="token number">0.34</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span>

d<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

e<span class="token operator">=</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>gba<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span>d
e<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.0234</span><span class="token punctuation">,</span> <span class="token number">0.034</span><span class="token punctuation">,</span> <span class="token number">0.04</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>

v<span class="token operator">=</span>c<span class="token operator">-</span>e
v<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">0.4</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>上面的运算过程，就是在不丢失数据的前提下，将实数n 存入向量v 的方法。<br> 接下来，再从向量v 中提取完整数据。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>a<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">/</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">/</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">/</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">/</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
a<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span>

n<span class="token operator">=</span>v·a
n<span class="token operator">=</span><span class="token number">0.1</span><span class="token operator">+</span><span class="token number">0.02</span><span class="token operator">+</span><span class="token number">0.003</span><span class="token operator">+</span><span class="token number">0.0004</span>
n<span class="token operator">=</span><span class="token number">0.1234</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这就是把一个实数存入特定精度的向量，并取出的方法。<br> 当向量v 中每个分量的精度不是1/10，而是256 的时候，只要将10 替换成256 即可。</p><h4 id="_3-2代码" tabindex="-1"><a class="header-anchor" href="#_3-2代码" aria-hidden="true">#</a> 3.2代码</h4><ol><li>在帧缓冲区绘制投影贴图时，把深度存入gl_FragColor 的所有分量里。</li></ol><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fs1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> vec4 bitShift <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>
      <span class="token number">1.0</span><span class="token punctuation">,</span> 
      <span class="token number">256.0</span><span class="token punctuation">,</span> 
      <span class="token number">256.0</span> <span class="token operator">*</span> <span class="token number">256.0</span><span class="token punctuation">,</span> 
      <span class="token number">256.0</span> <span class="token operator">*</span> <span class="token number">256.0</span> <span class="token operator">*</span> <span class="token number">256.0</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> vec4 bitMask <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">256.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vec4 depth <span class="token operator">=</span> <span class="token function">fract</span><span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>z <span class="token operator">*</span> bitShift<span class="token punctuation">)</span><span class="token punctuation">;</span>
    depth <span class="token operator">-=</span> depth<span class="token punctuation">.</span>gbaa <span class="token operator">*</span> bitMask<span class="token punctuation">;</span>
    gl_FragColor<span class="token operator">=</span>depth<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>	
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ol start="2"><li>在canvas 画布上绘图时，从投影贴图中提取投影数据。</li></ol><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fs2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform sampler2D u_ShadowMap<span class="token punctuation">;</span>
  varying vec4 v_ClipPosLight<span class="token punctuation">;</span>
  bool <span class="token function">isInShadow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec3 fragPos<span class="token operator">=</span><span class="token punctuation">(</span>v_ClipPosLight<span class="token punctuation">.</span>xyz<span class="token operator">/</span>v_ClipPosLight<span class="token punctuation">.</span>w<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2.0</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
    vec4 shadowFrag <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_ShadowMap<span class="token punctuation">,</span> fragPos<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> vec4 bitShift <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>
      <span class="token number">1.0</span><span class="token punctuation">,</span> 
      <span class="token number">1.0</span><span class="token operator">/</span><span class="token number">256.0</span><span class="token punctuation">,</span> 
      <span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">256.0</span><span class="token operator">*</span><span class="token number">256.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
      <span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">256.0</span><span class="token operator">*</span><span class="token number">256.0</span><span class="token operator">*</span><span class="token number">256.0</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    float depth <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>shadowFrag<span class="token punctuation">,</span> bitShift<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> fragPos<span class="token punctuation">.</span>z<span class="token operator">&gt;</span>depth<span class="token operator">+</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">256.0</span><span class="token operator">*</span><span class="token number">4.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    float darkness<span class="token operator">=</span><span class="token function">isInShadow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token number">0.7</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">;</span>
    gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token function">vec3</span><span class="token punctuation">(</span>darkness<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>这样就可以正常绘制出投影：<br><img src="/visual/webgl-share/173.png" alt=""></p><p>帧缓冲区以及帧缓冲区在投影中的应用就说到这，接下来封装个帧缓冲区出来。</p><h3 id="_4-帧缓冲区的封装" tabindex="-1"><a class="header-anchor" href="#_4-帧缓冲区的封装" aria-hidden="true">#</a> 4.帧缓冲区的封装</h3><p>帧缓冲区和之前建立的 Scene 场景对象是差不多的。只是在其基础上，要额外告诉webgl，在绘图的时候，不要再画到canvas 画布上了，而是要画到帧缓冲区里。</p><p>所以，可以建立一个Frame 对象，继承自 Scene对象，然后再为其新增帧缓冲区相关的方法。</p><h4 id="_4-1完善scene-对象" tabindex="-1"><a class="header-anchor" href="#_4-1完善scene-对象" aria-hidden="true">#</a> 4.1完善Scene 对象</h4><ol><li>先给Scene 对象添加两个属性：</li></ol><ul><li>backgroundColor 背景色</li><li>depthTest 是否开启深度测试</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">defAttr</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  ……
  <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">depthTest</span><span class="token operator">:</span><span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>之前是把这两个属性写在Scene外面的，但有了帧缓冲区后，这就不合适了。比如，帧缓冲区和Scene 对象可能有两种不一样的背景色。</p><ol start="2"><li>在绘图方法中，更新背景色和深度测试。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> gl<span class="token punctuation">,</span> children2Draw<span class="token punctuation">,</span> programs<span class="token punctuation">,</span>backgroundColor<span class="token punctuation">,</span>depthTest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token operator">...</span>backgroundColor<span class="token punctuation">)</span>
  depthTest <span class="token operator">?</span> gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span> <span class="token operator">:</span> gl<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span>
	……
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_4-2建立frame-对象" tabindex="-1"><a class="header-anchor" href="#_4-2建立frame-对象" aria-hidden="true">#</a> 4.2建立Frame 对象</h4><p>Frame.js 代码如下：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> Scene <span class="token keyword">from</span> <span class="token string">&#39;./Scene.js&#39;</span>

<span class="token keyword">const</span> <span class="token function-variable function">defAttr</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">texture</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">framebuffer</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">depthbuffer</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">1024</span><span class="token punctuation">,</span>
  <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">1024</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Frame</span> <span class="token keyword">extends</span> <span class="token class-name">Scene</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token function">defAttr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>attr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 初始化帧缓冲区</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> gl <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>framebuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createFramebuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>depthbuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createRenderbuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 更新化帧缓冲区</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> gl<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// 纹理对象</span>
    gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span>
    gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>texture<span class="token punctuation">)</span>
    gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
      gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span>
      gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span>
      width<span class="token punctuation">,</span> height<span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token keyword">null</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 帧缓冲区</span>
    gl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>framebuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">framebufferTexture2D</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span>
      gl<span class="token punctuation">.</span><span class="token constant">COLOR_ATTACHMENT0</span><span class="token punctuation">,</span>
      gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>texture<span class="token punctuation">,</span> <span class="token number">0</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 渲染缓冲区，存储深度数据</span>
    gl<span class="token punctuation">.</span><span class="token function">bindRenderbuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">RENDERBUFFER</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>depthbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">renderbufferStorage</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">.</span><span class="token constant">RENDERBUFFER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_COMPONENT16</span><span class="token punctuation">,</span>
      width<span class="token punctuation">,</span> height
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">framebufferRenderbuffer</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_ATTACHMENT</span><span class="token punctuation">,</span>
      gl<span class="token punctuation">.</span><span class="token constant">RENDERBUFFER</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>depthbuffer
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 视口尺寸</span>
    gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">//清理缓冲区，重置视口</span>
  <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> gl <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">canvas</span><span class="token operator">:</span> <span class="token punctuation">{</span> width<span class="token punctuation">,</span>height<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">=</span>gl
    gl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    gl<span class="token punctuation">.</span><span class="token function">bindRenderbuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">RENDERBUFFER</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><p>属性：</p><ul><li>texture 纹理对象</li><li>framebuffer 帧缓冲区</li><li>depthbuffer 深度缓冲区</li><li>width 纹理对象的宽度</li><li>height 纹理对象的高度</li></ul><p>方法：</p><ul><li>init() 初始化</li><li>update() 绑定帧缓冲区</li><li>reset() 清理缓冲区，重置视口</li><li>draw() 绘图方法</li></ul><p>Frame对象执行了draw() 方法后，便可以将渲染结果存储到texture 对象里。</p><p>之后在canvas 画布中绘图的时候，需要texture 交给Scene场景中三维物体的Mat对象，如下：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mat<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;Blinn-Phong&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span><span class="token punctuation">{</span>……<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">maps</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token literal-property property">u_ShadowMap</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">texture</span><span class="token operator">:</span> frame<span class="token punctuation">.</span>texture
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>以前在 maps 中是通过 image 图像源建立的 texture 纹理对象，而现在 texture 纹理对象已经有了，所需要对之前的Mat 材质对象也做下调整。</p><h4 id="_4-3调整mat-对象" tabindex="-1"><a class="header-anchor" href="#_4-3调整mat-对象" aria-hidden="true">#</a> 4.3调整Mat 对象</h4><ol><li>在init() 初始化方法中，若map贴图没有texture 纹理对象，再去建立纹理对象。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>maps<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">map<span class="token punctuation">,</span> ind</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>map<span class="token punctuation">.</span>texture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      map<span class="token punctuation">.</span>texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateMap</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span>map<span class="token punctuation">,</span>ind<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol start="2"><li>在updateMap() 方法中，若image 图像源存在，再执行图像源的设置方法。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">updateMap</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> map<span class="token punctuation">,</span> ind</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ……
  image<span class="token operator">&amp;&amp;</span>gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>
    gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    format<span class="token punctuation">,</span>
    format<span class="token punctuation">,</span>
    gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span>
    image
  <span class="token punctuation">)</span>
  ……
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>完成了帧缓冲区的封装，接下来将其实例化，测试一下。</p><h4 id="_4-4实例化帧缓冲区对象" tabindex="-1"><a class="header-anchor" href="#_4-4实例化帧缓冲区对象" aria-hidden="true">#</a> 4.4实例化帧缓冲区对象</h4><p>可以在之前锥形灯的基础上，为小球添加一个投影，效果如下：<br><img src="/visual/webgl-share/176.png" alt=""></p><ol><li>着色器</li></ol><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- 在帧缓冲区绘制投影贴图 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vShadow<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
  uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position<span class="token operator">=</span>u_PvMatrix<span class="token operator">*</span>u_ModelMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fShadow<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> vec4 bitShift <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>
      <span class="token number">1.0</span><span class="token punctuation">,</span> 
      <span class="token number">256.0</span><span class="token punctuation">,</span> 
      <span class="token number">256.0</span> <span class="token operator">*</span> <span class="token number">256.0</span><span class="token punctuation">,</span> 
      <span class="token number">256.0</span> <span class="token operator">*</span> <span class="token number">256.0</span> <span class="token operator">*</span> <span class="token number">256.0</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> vec4 bitMask <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">256.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vec4 depth <span class="token operator">=</span> <span class="token function">fract</span><span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>z <span class="token operator">*</span> bitShift<span class="token punctuation">)</span><span class="token punctuation">;</span>
    depth <span class="token operator">-=</span> depth<span class="token punctuation">.</span>gbaa <span class="token operator">*</span> bitMask<span class="token punctuation">;</span>
    gl_FragColor<span class="token operator">=</span>depth<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- Blinn-Phong --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vs<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  ……
  uniform mat4 u_PvMatrixLight<span class="token punctuation">;</span>
  varying vec4 v_ClipPosLight<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    ……
    v_ClipPosLight<span class="token operator">=</span>u_PvMatrixLight<span class="token operator">*</span>worldPos<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fs<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  ……   
  <span class="token comment">//投影贴图</span>
  uniform sampler2D u_ShadowMap<span class="token punctuation">;</span>
  <span class="token comment">//当前着色点在灯光里的裁剪坐标</span>
  varying vec4 v_ClipPosLight<span class="token punctuation">;</span>
  
  <span class="token comment">//当前着色点是否在投影中</span>
  bool <span class="token function">isInShadow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec3 fragPos<span class="token operator">=</span><span class="token punctuation">(</span>v_ClipPosLight<span class="token punctuation">.</span>xyz<span class="token operator">/</span>v_ClipPosLight<span class="token punctuation">.</span>w<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2.0</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
    vec4 shadowFrag <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_ShadowMap<span class="token punctuation">,</span> fragPos<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> vec4 bitShift <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>
      <span class="token number">1.0</span><span class="token punctuation">,</span> 
      <span class="token number">1.0</span><span class="token operator">/</span><span class="token number">256.0</span><span class="token punctuation">,</span> 
      <span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">256.0</span><span class="token operator">*</span><span class="token number">256.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
      <span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">256.0</span><span class="token operator">*</span><span class="token number">256.0</span><span class="token operator">*</span><span class="token number">256.0</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    float depth <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>shadowFrag<span class="token punctuation">,</span> bitShift<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> fragPos<span class="token punctuation">.</span>z<span class="token operator">&gt;</span>depth<span class="token operator">+</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">256.0</span><span class="token operator">*</span><span class="token number">4.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    ……
    <span class="token comment">//投影</span>
    float darkness<span class="token operator">=</span><span class="token function">isInShadow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token number">0.4</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token comment">//着色点颜色</span>
    vec3 color<span class="token operator">=</span>intensity<span class="token operator">*</span>darkness<span class="token operator">*</span><span class="token punctuation">(</span>diffuse<span class="token operator">+</span>specular<span class="token punctuation">)</span><span class="token operator">+</span>u_Ka<span class="token punctuation">;</span>
    
    gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><ol start="2"><li>引入缓冲区对象</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> Frame <span class="token keyword">from</span> <span class="token string">&#39;./lv/Frame.js&#39;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol start="3"><li>建立webgl上下文对象</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
<span class="token keyword">let</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//gl.clearColor(0.0, 0.0, 0.0, 1.0);</span>
<span class="token comment">//gl.enable(gl.DEPTH_TEST);</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="4"><li>建立相机和相机轨道</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 目标点</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1.5</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment">//视点</span>
<span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token number">45</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">50</span>
<span class="token punctuation">]</span>
<span class="token comment">// 透视相机</span>
<span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span>
camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span>
<span class="token comment">// 轨道控制器</span>
<span class="token keyword">const</span> orbit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrbitControls</span><span class="token punctuation">(</span><span class="token punctuation">{</span> camera<span class="token punctuation">,</span> target<span class="token punctuation">,</span> <span class="token literal-property property">dom</span><span class="token operator">:</span> canvas<span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ol start="5"><li>实例化球体和幕布</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* 球体 */</span>
<span class="token keyword">const</span> sphere <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sphere</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> vertices<span class="token punctuation">,</span> indexes<span class="token punctuation">,</span>normals <span class="token punctuation">}</span> <span class="token operator">=</span> sphere
<span class="token comment">//球体模型矩阵</span>
<span class="token keyword">const</span> sphereMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> sphere<span class="token punctuation">.</span>r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment">/* 幕布 */</span>
<span class="token keyword">const</span> backdrop <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Backdrop</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment">// 幕布模型矩阵</span>
<span class="token keyword">const</span> backMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol start="6"><li>用透视相机建立灯光对象，并从中获取透视视图矩阵，存入灯光数据中。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> light <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span><span class="token number">70</span><span class="token punctuation">,</span> ratio<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>
light<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>u_LightPos<span class="token punctuation">)</span>
light<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>u_LightTarget<span class="token punctuation">)</span>
light<span class="token punctuation">.</span><span class="token function">updateMatrixWorld</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> pvMatrixLight <span class="token operator">=</span> light<span class="token punctuation">.</span>projectionMatrix<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>light<span class="token punctuation">.</span>matrixWorldInverse<span class="token punctuation">)</span>

<span class="token comment">// 灯光数据</span>
<span class="token keyword">const</span> lightData <span class="token operator">=</span> <span class="token punctuation">{</span>
  ……
  <span class="token literal-property property">u_PvMatrixLight</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> pvMatrixLight<span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ol start="7"><li>实例化帧缓冲区对象</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 帧缓冲区</span>
<span class="token keyword">const</span> frame <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Frame</span><span class="token punctuation">(</span><span class="token punctuation">{</span> gl <span class="token punctuation">}</span><span class="token punctuation">)</span>
frame<span class="token punctuation">.</span><span class="token function">registerProgram</span><span class="token punctuation">(</span>
  <span class="token string">&#39;shadow&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">,</span>
      document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vShadow&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
      document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fShadow&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">attributeNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">uniformNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;u_PvMatrix&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_ModelMatrix&#39;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ol start="8"><li>实例化场景对象</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 场景</span>
<span class="token keyword">const</span> scene <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">{</span> gl <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 注册程序对象</span>
scene<span class="token punctuation">.</span><span class="token function">registerProgram</span><span class="token punctuation">(</span>
  <span class="token string">&#39;Blinn-Phong&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    ……
    <span class="token literal-property property">uniformNames</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      ……
      <span class="token string">&#39;u_PvMatrixLight&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_ShadowMap&#39;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ol start="9"><li>建立球体和幕布所对应的Geo和Mat</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 球体</span>
<span class="token keyword">const</span> matSphere <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;Blinn-Phong&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> sphereMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>cameraData<span class="token punctuation">,</span>
    <span class="token operator">...</span>lightData<span class="token punctuation">,</span>
    <span class="token operator">...</span>matData
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> geoSphere <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> vertices<span class="token punctuation">,</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">a_Normal</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> normals<span class="token punctuation">,</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">array</span><span class="token operator">:</span> indexes
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 幕布</span>
<span class="token keyword">const</span> matBack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;Blinn-Phong&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> backMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>cameraData<span class="token punctuation">,</span>
    <span class="token operator">...</span>lightData<span class="token punctuation">,</span>
    <span class="token operator">...</span>matData
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> geoBack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> backdrop<span class="token punctuation">.</span>vertices<span class="token punctuation">,</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">a_Normal</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> backdrop<span class="token punctuation">.</span>normals<span class="token punctuation">,</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">array</span><span class="token operator">:</span> backdrop<span class="token punctuation">.</span>indexes
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><ol start="10"><li>基于球体和幕布所对应的Geo和Mat，在帧缓冲区中绘制投影贴图。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 在帧缓冲区中绘图</span>
frame<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">geo</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">a_Position</span><span class="token operator">:</span> geoSphere<span class="token punctuation">.</span>data<span class="token punctuation">.</span>a_Position<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">index</span><span class="token operator">:</span> geoSphere<span class="token punctuation">.</span>index
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">mat</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;shadow&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> matSphere<span class="token punctuation">.</span>data<span class="token punctuation">.</span>u_ModelMatrix<span class="token punctuation">,</span>
        <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> matSphere<span class="token punctuation">.</span>data<span class="token punctuation">.</span>u_PvMatrixLight<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">geo</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">a_Position</span><span class="token operator">:</span> geoBack<span class="token punctuation">.</span>data<span class="token punctuation">.</span>a_Position<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">index</span><span class="token operator">:</span> geoBack<span class="token punctuation">.</span>index
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">mat</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;shadow&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> matBack<span class="token punctuation">.</span>data<span class="token punctuation">.</span>u_ModelMatrix<span class="token punctuation">,</span>
        <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> matBack<span class="token punctuation">.</span>data<span class="token punctuation">.</span>u_PvMatrixLight<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
frame<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><ol start="11"><li>将帧缓冲区里的纹理对象交给球体和幕布的材质对象，用于渲染投影。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> maps <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">u_ShadowMap</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">texture</span><span class="token operator">:</span> frame<span class="token punctuation">.</span>texture
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
matSphere<span class="token punctuation">.</span>maps <span class="token operator">=</span> maps
matBack<span class="token punctuation">.</span>maps <span class="token operator">=</span> maps
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="12"><li>在canvas 画布中绘图。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> objSphere <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">geo</span><span class="token operator">:</span> geoSphere<span class="token punctuation">,</span> <span class="token literal-property property">mat</span><span class="token operator">:</span> matSphere <span class="token punctuation">}</span><span class="token punctuation">)</span>
scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>objSphere<span class="token punctuation">)</span>
<span class="token keyword">const</span> objBack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">mat</span><span class="token operator">:</span> matBack<span class="token punctuation">,</span> <span class="token literal-property property">geo</span><span class="token operator">:</span> geoBack <span class="token punctuation">}</span><span class="token punctuation">)</span>
scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>objBack<span class="token punctuation">)</span>

<span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&#39;u_Eye&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>position<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ol start="13"><li>我们也可以为小球添加一个弹跳动画，测试一下异步渲染。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">time <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> y <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>time <span class="token operator">/</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> sphere<span class="token punctuation">.</span>r
  sphereMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> y
  frame<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">&#39;u_Eye&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>position<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>关于投影和帧缓冲区的用法，就先说到这。<br> 对于投影的模糊，以及帧缓冲区的其它玩法，等走完了整个课程，再做深度剖析。<br> 到目前为止，都是用纯色定义的模型的反射系数。<br> 在实际项目中，纹理是不可或缺的，因此还需要说一下纹理映射。</p><h2 id="二十六、纹理映射" tabindex="-1"><a class="header-anchor" href="#二十六、纹理映射" aria-hidden="true">#</a> 二十六、纹理映射</h2><p>纹理映射就是将纹理中的像素映射到模型相应位置的着色点上。<br> 纹理中所存储的像素信息，可以用来表示模型的漫反射、镜面反射、透明度、凹凸等。<br> 纹理映射是通过UV 坐标实现的。<br> 在实际项目中，若模型是由建模师提供的，那我们可以跟他要一份贴图的 UV 坐标。<br> 然而，有些模型是需要我们动态建模的，这种模型所需的 UV 坐标就需要我们自己来计算了。</p><p>接下来说两个常见纹理映射。</p><h3 id="_1-等距圆柱投影" tabindex="-1"><a class="header-anchor" href="#_1-等距圆柱投影" aria-hidden="true">#</a> 1.等距圆柱投影</h3><h4 id="_1-1概念" tabindex="-1"><a class="header-anchor" href="#_1-1概念" aria-hidden="true">#</a> 1.1概念</h4><p>之前画过一个球体：<br><img src="/visual/webgl-share/144.png" alt=""></p><p>然后从基维百科上找了一张地球的等距圆柱投影贴图：<br><img src="/visual/webgl-share/177.jpg" alt=""></p><p>接下来便可以利用等距投影规则把上面的贴图贴到球体上：<br><img src="/visual/webgl-share/178.png" alt=""></p><p>实现上面这个效果的关键就是纹理映射，我所使用的纹理映射方法就是等距圆柱投影。<br> 等距的意思就是上面的贴图里，每个格子的宽(纬线)、高(经线)尺寸都是相等的。<br> 圆柱投影的意思是，用圆柱包裹球体，圆柱的面与球体相切。在球体中心放一个点光源，点光源会把球体投射到圆柱上，从而得到球体的圆柱投影。<br><img src="/visual/webgl-share/179.png" alt=""></p><p>等距圆柱投影贴图也可以理解为球体展开后的样子。<br><img src="/visual/webgl-share/180.png" alt=""></p><p>等距圆柱投影除了可以画地球，它在VR 中也得到了广泛的应用。<br> 现在市面上的720°全景相机拍摄出的全景图片，一般都是等距圆柱投影图片。<br><img src="/visual/webgl-share/181.jpg" alt=""></p><p>等距圆柱投影的计算挺简单的，之前说球坐标系的时候就已经为其打好了基础。</p><h4 id="_1-2地理坐标系" tabindex="-1"><a class="header-anchor" href="#_1-2地理坐标系" aria-hidden="true">#</a> 1.2地理坐标系</h4><p>地理坐标系(Geographic coordinate system) 就是一种球坐标系(Spherical coordinate system)。<br> 地理坐标系和three.js 里的Spherical 球坐标系差不多，只是在θ和φ的定义上略有差异。</p><p>Spherical 球坐标系里的方位角θ和极角φ的定义规则：</p><ul><li>θ 起始于z轴的正半轴，逆时针旋转，旋转量越大θ 值越大，0 ≤ θ &lt; 2π</li><li>φ 起始于y轴的正半轴，向下旋转，旋转量越大φ 值越大，0 ≤ φ &lt; π</li></ul><p>下图是地理坐标系：<br><img src="/visual/webgl-share/182.png" alt=""></p><ul><li>θ 对应经度，起始于x轴的正半轴，即本初子午线的位置，θ=0 <ul><li>从0° 逆时针旋转，旋转量越大θ 值越大，旋转到180°结束，是为东经，0 ≤ θ &lt; π</li><li>从0° 顺时针旋转，旋转量越大θ 值越小，旋转到-180°结束，是为西经，0 ≤ θ &lt; -π</li></ul></li><li>φ 对应维度，起始于赤道，φ=0 <ul><li>从0° 向上旋转，旋转量越大φ 值越大，旋转到90°结束，是为北纬，0 ≤ φ &lt; π/2</li><li>从0° 向下旋转，旋转量越大φ 值越小，旋转到-90°结束，是为南纬，0 ≤ φ &lt; -π/2</li></ul></li></ul><p>对于已知一点的经纬度，求此点的三维直角坐标位的方法，上图已经详细画出。</p><h4 id="_1-3经纬度与等距圆柱投影贴图的线性映射" tabindex="-1"><a class="header-anchor" href="#_1-3经纬度与等距圆柱投影贴图的线性映射" aria-hidden="true">#</a> 1.3经纬度与等距圆柱投影贴图的线性映射</h4><p>通过上面经纬度的定义规则，可以知道：</p><ul><li>经度和U值相映射</li><li>维度和V值相映射</li></ul><p>其具体的映射映射方式如下图所示：<br><img src="/visual/webgl-share/183.png" alt=""></p><ul><li>经度[-π,π] 映射u[0,1]</li><li>维度[-π/2,π/2] 映射v[0,1]</li></ul><h4 id="_1-4绘制地球" tabindex="-1"><a class="header-anchor" href="#_1-4绘制地球" aria-hidden="true">#</a> 1.4绘制地球</h4><ol><li>建立一个地理坐标系Geography对象，方便把经纬度转三维直角坐标。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Vector3<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>
<span class="token comment">/*
属性：
  r：半径
  longitude：经度(弧度)
  latitude：纬度(弧度)
  position：三维坐标位

构造参数：
  r,longitude,latitude 
  或者
  position
*/</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Geography</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">r<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>longitude<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> latitude<span class="token operator">=</span><span class="token number">0</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>r<span class="token operator">=</span>r
    <span class="token keyword">this</span><span class="token punctuation">.</span>longitude<span class="token operator">=</span>longitude
    <span class="token keyword">this</span><span class="token punctuation">.</span>latitude <span class="token operator">=</span> latitude
    <span class="token keyword">this</span><span class="token punctuation">.</span>position<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updatePos</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//克隆</span>
  <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> r<span class="token punctuation">,</span> longitude<span class="token punctuation">,</span> latitude <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Geography</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> longitude<span class="token punctuation">,</span> latitude<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//设置半径，更新三维直角坐标位</span>
  <span class="token function">setR</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>r <span class="token operator">=</span> r
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updatePos</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//根据经纬度更新三维直角坐标位</span>
  <span class="token function">updatePos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> r<span class="token punctuation">,</span>longitude<span class="token punctuation">,</span>latitude <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> len <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>latitude<span class="token punctuation">)</span> <span class="token operator">*</span> r
    <span class="token keyword">this</span><span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
      Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>longitude<span class="token punctuation">)</span><span class="token operator">*</span>len<span class="token punctuation">,</span>
      Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>latitude<span class="token punctuation">)</span><span class="token operator">*</span>r<span class="token punctuation">,</span>
      <span class="token operator">-</span>Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>longitude<span class="token punctuation">)</span><span class="token operator">*</span>len
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><ol start="2"><li>建模</li></ol><p>之前画过一个球体Sphere.js，只不过这个球体的南极和北极共用一个顶点，不适合做柱状投影贴图。</p><p>接下来，在其基础上再改装一个球体Earth出来，这个Earth对象是按照矩形网格建模的，如下图所示：<br><img src="/visual/webgl-share/184.png" alt=""></p><p>当前这个Earth对象是直接按照矩形网格建模的。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> Geography <span class="token keyword">from</span> <span class="token string">&#39;./Geography.js&#39;</span>

<span class="token comment">/*
属性：
  r：半径
  widthSegments：横向段数，最小3端
  heightSegments：纵向段数，最小2端
  vertices：顶点集合
  normals：法线集合
  indexes：顶点索引集合
  uv：uv坐标
  count：顶点数量
*/</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Earth</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">r<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> widthSegments<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> heightSegments<span class="token operator">=</span><span class="token number">2</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>r<span class="token operator">=</span>r
    <span class="token keyword">this</span><span class="token punctuation">.</span>widthSegments<span class="token operator">=</span>widthSegments
    <span class="token keyword">this</span><span class="token punctuation">.</span>heightSegments<span class="token operator">=</span>heightSegments
    <span class="token keyword">this</span><span class="token punctuation">.</span>vertices<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>normals<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>indexes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>uv<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">=</span><span class="token number">0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>r<span class="token punctuation">,</span>widthSegments<span class="token punctuation">,</span> heightSegments <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">//网格线的数量</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>width<span class="token punctuation">,</span>height<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">[</span>widthSegments<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>heightSegments <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token comment">//顶点数量</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> width<span class="token operator">*</span>height
    <span class="token comment">// theta和phi方向的旋转弧度</span>
    <span class="token keyword">const</span> thetaSize <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">/</span> widthSegments
    <span class="token keyword">const</span> phiSize <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> heightSegments

    <span class="token comment">// 顶点集合</span>
    <span class="token keyword">const</span> vertices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 法线集合</span>
    <span class="token keyword">const</span> normals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 顶点索引集合</span>
    <span class="token keyword">const</span> indexes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">//uv 坐标集合</span>
    <span class="token keyword">const</span> uv<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 逐行列遍历</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> height<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 维度 </span>
      <span class="token keyword">const</span> phi <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token operator">/</span><span class="token number">2</span><span class="token operator">-</span>phiSize <span class="token operator">*</span> y
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//经度，-Math.PI是为了让0°经线经过x轴的正半轴</span>
        <span class="token keyword">const</span> theta <span class="token operator">=</span> thetaSize <span class="token operator">*</span> x<span class="token operator">-</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span>
        <span class="token comment">// 计算顶点和法线</span>
        <span class="token keyword">const</span> vertice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geography</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>theta<span class="token punctuation">,</span>phi<span class="token punctuation">)</span><span class="token punctuation">.</span>position
        vertices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>vertice<span class="token punctuation">)</span><span class="token punctuation">)</span>
        normals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>vertice<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> <span class="token punctuation">[</span>u<span class="token punctuation">,</span> v<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
          x <span class="token operator">/</span> widthSegments<span class="token punctuation">,</span>
          <span class="token number">1</span><span class="token operator">-</span>y<span class="token operator">/</span>heightSegments
        <span class="token punctuation">]</span>
        uv<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
        <span class="token comment">// 顶点索引</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 一个矩形格子的左上lt、右上rt、左下lb、右下rb点</span>
          <span class="token keyword">const</span> lt <span class="token operator">=</span> <span class="token punctuation">(</span>y<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> width <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
          <span class="token keyword">const</span> rt <span class="token operator">=</span> <span class="token punctuation">(</span>y<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> width <span class="token operator">+</span> x
          <span class="token keyword">const</span> lb <span class="token operator">=</span> y <span class="token operator">*</span> width <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
          <span class="token keyword">const</span> rb <span class="token operator">=</span> y <span class="token operator">*</span> width <span class="token operator">+</span> x
          indexes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>lb<span class="token punctuation">,</span> rb<span class="token punctuation">,</span> lt<span class="token punctuation">,</span> lt<span class="token punctuation">,</span> rb<span class="token punctuation">,</span> rt<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vertices<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>vertices<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>normals<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>normals<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>uv<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>uv<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>indexes<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Uint16Array</span><span class="token punctuation">(</span>indexes<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><ol start="3"><li>着色器</li></ol><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vs<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  attribute vec2 a_Pin<span class="token punctuation">;</span>
  uniform mat4 u_PvMatrix<span class="token punctuation">;</span>
  uniform mat4 u_ModelMatrix<span class="token punctuation">;</span>
  varying vec2 v_Pin<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_Position<span class="token operator">=</span>u_PvMatrix<span class="token operator">*</span>u_ModelMatrix<span class="token operator">*</span>a_Position<span class="token punctuation">;</span>
    v_Pin<span class="token operator">=</span>a_Pin<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fs<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform sampler2D u_Sampler<span class="token punctuation">;</span>
  varying vec2 v_Pin<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor<span class="token operator">=</span><span class="token function">texture2D</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span>v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><ol start="3"><li>贴图</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createProgram<span class="token punctuation">,</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;/jsm/Utils.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Matrix4<span class="token punctuation">,</span> PerspectiveCamera<span class="token punctuation">,</span> Vector3
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> OrbitControls <span class="token keyword">from</span> <span class="token string">&#39;./lv/OrbitControls.js&#39;</span>
<span class="token keyword">import</span> Mat <span class="token keyword">from</span> <span class="token string">&#39;./lv/Mat.js&#39;</span>
<span class="token keyword">import</span> Geo <span class="token keyword">from</span> <span class="token string">&#39;./lv/Geo.js&#39;</span>
<span class="token keyword">import</span> Obj3D <span class="token keyword">from</span> <span class="token string">&#39;./lv/Obj3D.js&#39;</span>
<span class="token keyword">import</span> Scene <span class="token keyword">from</span> <span class="token string">&#39;./lv/Scene.js&#39;</span>
<span class="token keyword">import</span> Earth <span class="token keyword">from</span> <span class="token string">&#39;./lv/Earth.js&#39;</span>

<span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth
canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight
<span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 球体</span>
<span class="token keyword">const</span> earth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Earth</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>

<span class="token comment">// 目标点</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//视点</span>
<span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token number">45</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
  <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">5</span>
<span class="token punctuation">]</span>
<span class="token comment">// 透视相机</span>
<span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span>
camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span>
<span class="token comment">// 轨道控制器</span>
<span class="token keyword">const</span> orbit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrbitControls</span><span class="token punctuation">(</span><span class="token punctuation">{</span> camera<span class="token punctuation">,</span> target<span class="token punctuation">,</span> <span class="token literal-property property">dom</span><span class="token operator">:</span> canvas<span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 场景</span>
<span class="token keyword">const</span> scene <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">{</span> gl <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//注册程序对象</span>
scene<span class="token punctuation">.</span><span class="token function">registerProgram</span><span class="token punctuation">(</span>
  <span class="token string">&#39;map&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">,</span>
      document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
      document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">attributeNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;a_Pin&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">uniformNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;u_PvMatrix&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_ModelMatrix&#39;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment">//地球</span>
<span class="token keyword">const</span> matEarth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;map&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> geoEarth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> earth<span class="token punctuation">.</span>vertices<span class="token punctuation">,</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">a_Pin</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> earth<span class="token punctuation">.</span>uv<span class="token punctuation">,</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">array</span><span class="token operator">:</span> earth<span class="token punctuation">.</span>indexes
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//加载图片</span>
<span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&#39;./images/earth.jpg&#39;</span>
image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  matEarth<span class="token punctuation">.</span>maps<span class="token punctuation">.</span>u_Sampler <span class="token operator">=</span> <span class="token punctuation">{</span> image <span class="token punctuation">}</span>
  scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">geo</span><span class="token operator">:</span> geoEarth<span class="token punctuation">,</span>
    <span class="token literal-property property">mat</span><span class="token operator">:</span> matEarth
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 连续渲染</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">time <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 取消右击菜单的显示 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;contextmenu&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/* 指针按下时，设置拖拽起始位，获取轨道控制器状态。 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerdown&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">pointerdown</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/* 指针移动时，若控制器处于平移状态，平移相机；若控制器处于旋转状态，旋转相机。 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointermove&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">pointermove</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/* 指针抬起 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerup&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">pointerup</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/* 滚轮事件 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;wheel&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">wheel</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br></div></div><p>效果如下：<br><img src="/visual/webgl-share/178.png" alt=""></p><p>到现在，应该对等距圆柱投影有了一个整体的认知。<br> 接下就可以再做一下扩展，根据经纬度，为某个地点做标记。</p><h4 id="_1-5标记点" tabindex="-1"><a class="header-anchor" href="#_1-5标记点" aria-hidden="true">#</a> 1.5标记点</h4><p>百度地图里拿到了天安门的经纬度(116.404,39.915)，其意思就是东经116.404°, 北纬39.915°<br> 使用Geography 对象便可以将经纬度转三维直角坐标位，然后再根据这个三维直角坐标位做个标记即可。<br><img src="/visual/webgl-share/185.png" alt=""></p><p>标记点的制作思路有两种：</p><ul><li>用<img>之类的HTML标签实现。 <ul><li>优点：制作便捷，尤其是要为其添加文字的时候。</li><li>缺点：要将标记点在webgl 裁剪空间坐标位转换到css 坐标位。需要额外考虑标记点与模型的遮挡问题。</li></ul></li><li>在webgl 中实现。 <ul><li>优点：标记点操作方便，模型遮挡实现便捷。</li><li>缺点：若标记点中存在文字，需做额外考量。</li></ul></li></ul><p>对于文字标记的显示问题，这里先不说，后面会单独详解。<br> 接下来，先用webgl 在地图上显示一个不带文字的标记点。</p><ol><li>建立一个矩形面对象，方便之后把标记点作为贴图贴上去。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Vector2<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>

<span class="token comment">/*
属性：
  size:尺寸
  orign:基点，百分比，默认左下角
  vertices：顶点集合
  normals：法线集合
  indexes：顶点索引集合
  uv：uv坐标
*/</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Rect</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">w<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> h<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>y<span class="token operator">=</span><span class="token number">0</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>size<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span>h<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>orign<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vertices<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>normals<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>indexes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>uv<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> size<span class="token punctuation">,</span> orign <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> l<span class="token operator">=</span><span class="token operator">-</span>orign<span class="token punctuation">.</span>x<span class="token operator">*</span>size<span class="token punctuation">.</span>x
    <span class="token keyword">const</span> b <span class="token operator">=</span><span class="token operator">-</span>orign<span class="token punctuation">.</span>y <span class="token operator">*</span> size<span class="token punctuation">.</span>y
    <span class="token keyword">const</span> r<span class="token operator">=</span>size<span class="token punctuation">.</span>x<span class="token operator">+</span>l
    <span class="token keyword">const</span> t<span class="token operator">=</span>size<span class="token punctuation">.</span>y<span class="token operator">+</span>b
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>vertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      l<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      l<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      r<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      r<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>normals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>uv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>indexes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint16Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>接下来，基于之前圆柱投影文件略作调整。</p><ol start="2"><li>实例化Rect 对象</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> Rect <span class="token keyword">from</span> <span class="token string">&#39;./lv/Rect.js&#39;</span>
……
gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">BLEND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">blendFunc</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">SRC_ALPHA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">ONE_MINUS_SRC_ALPHA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
……
<span class="token comment">// 矩形面</span>
<span class="token keyword">const</span> rect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span><span class="token number">0.02</span><span class="token punctuation">,</span> <span class="token number">0.02</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="3"><li>基于天安门经纬度，建立Geography 对象。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> rad <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">180</span>
<span class="token keyword">const</span> geography <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geography</span><span class="token punctuation">(</span>
  earth<span class="token punctuation">.</span>r<span class="token punctuation">,</span>
  <span class="token number">116.404</span> <span class="token operator">*</span> rad<span class="token punctuation">,</span>
  <span class="token number">39.915</span> <span class="token operator">*</span> rad
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="4"><li>让相机的视点直视天门。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> eye <span class="token operator">=</span> geography<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">setR</span><span class="token punctuation">(</span>earth<span class="token punctuation">.</span>r <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>position
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="5"><li>基于标记点的三维直角坐标位构建一个模型矩阵</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> modelMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span>geography<span class="token punctuation">.</span>position<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="6"><li>建立标记点的Mat和Geo 对象</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> matMark <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;map&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> modelMatrix<span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> geoMark <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> rect<span class="token punctuation">.</span>vertices<span class="token punctuation">,</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">a_Pin</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> rect<span class="token punctuation">.</span>uv<span class="token punctuation">,</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">array</span><span class="token operator">:</span> rect<span class="token punctuation">.</span>indexes
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><ol start="7"><li>当所有贴图都加载成功后，将贴图传给相应的Mat 对象。然后建立地球和标记点所对应的Obj3D对象，将其添加到Scene 场景中，进行渲染。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//加载图形</span>
<span class="token keyword">const</span> imgPromises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;earth.jpg&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;mark.png&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  img<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./images/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token keyword">return</span> <span class="token function">imgPromise</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>imgPromises<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">imgs</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  matEarth<span class="token punctuation">.</span>maps<span class="token punctuation">.</span>u_Sampler <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">image</span><span class="token operator">:</span> imgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
  matMark<span class="token punctuation">.</span>maps<span class="token punctuation">.</span>u_Sampler <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">image</span><span class="token operator">:</span> imgs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">format</span><span class="token operator">:</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span>
  <span class="token punctuation">}</span>
  scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">geo</span><span class="token operator">:</span> geoEarth<span class="token punctuation">,</span>
    <span class="token literal-property property">mat</span><span class="token operator">:</span> matEarth
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">geo</span><span class="token operator">:</span> geoMark<span class="token punctuation">,</span>
    <span class="token literal-property property">mat</span><span class="token operator">:</span> matMark
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 连续渲染</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">time <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><ol start="8"><li>让标记点贴合到地球表面</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> modelMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span>geography<span class="token punctuation">.</span>position<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>
          geography<span class="token punctuation">.</span>position<span class="token punctuation">,</span>
          target<span class="token punctuation">,</span>
          <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>最终效果如下：<br><img src="/visual/webgl-share/186.png" alt=""></p><p>在实际项目中，围绕地球，是可以做很多东西。<br> 比如在球体上绘制柱状图，表示不同地区的经济增长情况；<br> 在两个地点之间绘制3D路径，以表示两地之间存在的联系；<br> 对于这些效果，就先不做扩展了。</p><p>接下来，再把相机塞进地球里，做一个VR的效果。</p><h3 id="_2-vr" tabindex="-1"><a class="header-anchor" href="#_2-vr" aria-hidden="true">#</a> 2.VR</h3><p>VR(Virtual Reality) 的意思就是虚拟现实，可以通过VR 眼镜给人环境沉浸感。</p><p>VR 的制作需要考虑两点：</p><ul><li>搭建场景，当前比较常见的搭建场景的方法就是将全景图贴到立方体，或者球体上。</li><li>场景变换，一般会把透视相机塞进立方体，或者球体里，然后变换场景。</li></ul><p>接下来具体说一下其实现步骤。</p><h4 id="_2-1搭建场景" tabindex="-1"><a class="header-anchor" href="#_2-1搭建场景" aria-hidden="true">#</a> 2.1搭建场景</h4><ol><li><p>用720°全景相机拍摄一张室内全景图。<br><img src="/visual/webgl-share/181.jpg" alt=""></p></li><li><p>在之前地球文件的基础上做修改，把地图替换成上面的室内全景图。</p></li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&#39;./images/room.jpg&#39;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="3"><li>把相机打入球体之中</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 目标点</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//视点</span>
<span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0.15</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token number">60</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
  <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>效果如下：<br><img src="/visual/webgl-share/187.png" alt=""></p><p>现在VR的效果就已经有了，接下来还需要考虑VR 场景的变换。</p><h4 id="_2-2-vr场景的变换" tabindex="-1"><a class="header-anchor" href="#_2-2-vr场景的变换" aria-hidden="true">#</a> 2.2 VR场景的变换</h4><p>VR 场景的变换通过相机轨道控制器便可以实现。<br> 当前相机轨道控制器已经具备了旋转、缩放和平移功能。<br> 只不过，针对VR 还得对相机轨道控制器做一下微调。</p><ol><li>取消相机的平移，以避免相机跑到球体之外。</li></ol><p>为相机轨道控制器 OrbitControls 添加一个是否启用平移的功能。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">defAttr</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  ……
  <span class="token literal-property property">enablePan</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在平移方法中，做个是否平移的判断：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">pointermove</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> dragStart<span class="token punctuation">,</span> dragEnd<span class="token punctuation">,</span> state<span class="token punctuation">,</span>enablePan<span class="token punctuation">,</span> <span class="token literal-property property">camera</span><span class="token operator">:</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
  dragEnd<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>clientX<span class="token punctuation">,</span> clientY<span class="token punctuation">)</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&#39;pan&#39;</span><span class="token operator">:</span>
      enablePan<span class="token operator">&amp;&amp;</span><span class="token keyword">this</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pan</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>dragStart<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    ……
  <span class="token punctuation">}</span>
  dragStart<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>dragEnd<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这样就可以在实例化OrbitControls 对象的时候，将enablePan 设置为false，从而禁止相机平移。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> orbit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrbitControls</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  camera<span class="token punctuation">,</span>
  target<span class="token punctuation">,</span>
  <span class="token literal-property property">dom</span><span class="token operator">:</span> canvas<span class="token punctuation">,</span>
  <span class="token literal-property property">enablePan</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="2"><li>使用透视相机缩放VR 场景时，不再使用视点到目标的距离来缩放场景，因为这样的放大效果不太明显。所以，可以直接像正交相机那样，缩放裁剪面。</li></ol><p>为OrbitControls 对象的wheel 方法添加一个控制缩放方式的参数。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">wheel</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> deltaY <span class="token punctuation">}</span><span class="token punctuation">,</span>type<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>camera<span class="token punctuation">.</span>type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> zoomScale<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
  <span class="token keyword">let</span> scale<span class="token operator">=</span>deltaY <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token operator">?</span>zoomScale<span class="token operator">:</span><span class="token number">1</span> <span class="token operator">/</span> zoomScale
  <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">dolly</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">(</span>scale<span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateSph</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这样就可以像缩放正交相机那样缩放透视相机。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;wheel&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">wheel</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">&#39;OrthographicCamera&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="3"><li>在缩放的时候，需要限制一下缩放范围，免得缩放得太大，或者缩小得超出了球体之外。</li></ol><p>为OrbitControls 添加两个缩放极值：</p><ul><li>minZoom 缩放的最小值</li><li>maxZoom 缩放的最大值</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">defAttr</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  ……
  <span class="token literal-property property">minZoom</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token literal-property property">maxZoom</span><span class="token operator">:</span> <span class="token number">Infinity</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在相应的缩放方法中，对缩放量做限制：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">dollyOrthographicCamera</span><span class="token punctuation">(</span><span class="token parameter">dollyScale</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>camera<span class="token punctuation">,</span>maxZoom<span class="token punctuation">,</span>minZoom<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span>
  <span class="token keyword">const</span> zoom<span class="token operator">=</span>camera<span class="token punctuation">.</span>zoom<span class="token operator">*</span>dollyScale
  camera<span class="token punctuation">.</span>zoom <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>
    Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>maxZoom<span class="token punctuation">,</span> zoom<span class="token punctuation">)</span><span class="token punctuation">,</span>
    minZoom
  <span class="token punctuation">)</span>
  camera<span class="token punctuation">.</span><span class="token function">updateProjectionMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在实例化OrbitControls 对象时，设置缩放范围：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> orbit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrbitControls</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  ……
  <span class="token literal-property property">maxZoom</span><span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
  <span class="token literal-property property">minZoom</span><span class="token operator">:</span> <span class="token number">0.4</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_2-3陀螺仪" tabindex="-1"><a class="header-anchor" href="#_2-3陀螺仪" aria-hidden="true">#</a> 2.3陀螺仪</h4><p>VR 的真正魅力在于，你可以带上VR 眼镜，体会身临其境的感觉。<br> VR 眼镜之所以能给你身临其境的感觉，是因为它内部有一个陀螺仪，可以监听设备的转动，从而带动VR 场景的变换。<br> 目前市场上常见的VR 眼镜有两种：需要插入手机的VR眼镜和一体机。<br> 一般手机里都是有陀螺仪的，因此我们可以用手机来体验VR。</p><p>接下来，可以先整个小例子练练手。<br> 要画个立方体，然后用陀螺仪旋转它。</p><p>为了更好的理解陀螺仪。我们把之前的球体变成立方体，在其上面贴上画有东、西、南、北和上、下的贴图。然后在其中打入相机，用陀螺仪变换相机视点，如下图：<br><img src="/visual/webgl-share/188.png" alt=""></p><ol><li>建立立方体对象Box</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/*
属性：
  w：宽
  h：高
  d：深
  vertices：顶点集合
  normals：法线集合
  indexes：顶点索引集合
  uv：uv坐标集合
  count：顶点数量
*/</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Box</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">w<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>h<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>d<span class="token operator">=</span><span class="token number">1</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>w<span class="token operator">=</span>w
    <span class="token keyword">this</span><span class="token punctuation">.</span>h<span class="token operator">=</span>h
    <span class="token keyword">this</span><span class="token punctuation">.</span>d<span class="token operator">=</span>d
    <span class="token keyword">this</span><span class="token punctuation">.</span>vertices<span class="token operator">=</span><span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>normals<span class="token operator">=</span><span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>indexes <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>uv <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">36</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>w <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>d <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token comment">// 前 0 1 2 3</span>
      <span class="token operator">-</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> <span class="token operator">-</span>x<span class="token punctuation">,</span> <span class="token operator">-</span>y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token operator">-</span>y<span class="token punctuation">,</span> z<span class="token punctuation">,</span>
      <span class="token comment">// 右 4 5 6 7</span>
      x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token operator">-</span>y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">-</span>z<span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token operator">-</span>y<span class="token punctuation">,</span> <span class="token operator">-</span>z<span class="token punctuation">,</span>
      <span class="token comment">// 后 8 9 10 11</span>
      x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">-</span>z<span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token operator">-</span>y<span class="token punctuation">,</span> <span class="token operator">-</span>z<span class="token punctuation">,</span> <span class="token operator">-</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">-</span>z<span class="token punctuation">,</span> <span class="token operator">-</span>x<span class="token punctuation">,</span> <span class="token operator">-</span>y<span class="token punctuation">,</span> <span class="token operator">-</span>z<span class="token punctuation">,</span>
      <span class="token comment">// 左 12 13 14 15 </span>
      <span class="token operator">-</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">-</span>z<span class="token punctuation">,</span> <span class="token operator">-</span>x<span class="token punctuation">,</span> <span class="token operator">-</span>y<span class="token punctuation">,</span> <span class="token operator">-</span>z<span class="token punctuation">,</span> <span class="token operator">-</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> <span class="token operator">-</span>x<span class="token punctuation">,</span> <span class="token operator">-</span>y<span class="token punctuation">,</span> z<span class="token punctuation">,</span>
      <span class="token comment">// 上 16 17 18 19</span>
      <span class="token operator">-</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">-</span>z<span class="token punctuation">,</span> <span class="token operator">-</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">-</span>z<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span>
      <span class="token comment">// 下 20 21 22 23 </span>
      <span class="token operator">-</span>x<span class="token punctuation">,</span><span class="token operator">-</span>y<span class="token punctuation">,</span>z<span class="token punctuation">,</span><span class="token operator">-</span>x<span class="token punctuation">,</span><span class="token operator">-</span>y<span class="token punctuation">,</span><span class="token operator">-</span>z<span class="token punctuation">,</span>x<span class="token punctuation">,</span><span class="token operator">-</span>y<span class="token punctuation">,</span>z<span class="token punctuation">,</span>x<span class="token punctuation">,</span><span class="token operator">-</span>y<span class="token punctuation">,</span><span class="token operator">-</span>z<span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>normals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> 
      <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">/* this.uv = new Float32Array([
      0,1,0,0,1,1,1,0,
      0,1,0,0,1,1,1,0,
      0,1,0,0,1,1,1,0,
      0,1,0,0,1,1,1,0,
      0,1,0,0,1,1,1,0,
      0,1,0,0,1,1,1,0,
    ]) */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>uv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span>
      <span class="token number">0.25</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span>
      <span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.75</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.75</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.25</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.25</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0.25</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.25</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.75</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.75</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>indexes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint16Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span>
      <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span>
      <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span>
      <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> 
      <span class="token number">20</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">23</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><ol start="2"><li>在Google浏览器中打开传感器，模拟陀螺仪的旋转。</li></ol><p>在电脑里做测试的时候，需要用浏览器里的开发者工具<br><img src="/visual/webgl-share/189.jpg" alt=""></p><p>之后可以在js中通过 deviceorientation 事件监听陀螺仪的变化。<br> 从deviceorientation 事件的回调参数event里，可以解构出alpha, beta, gamma 三个参数。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;deviceorientation&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> alpha<span class="token punctuation">,</span> beta<span class="token punctuation">,</span> gamma <span class="token punctuation">}</span><span class="token operator">=</span>event
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>alpha, beta, gamma对应了陀螺仪欧拉旋转的三个参数。</p><p>在右手坐标系中，其概念如下：</p><ul><li>alpha：绕世界坐标系的y轴逆时针旋转的角度，旋转范围是[-180°,180°)</li><li>beta：绕本地坐标系的x轴逆时针旋转的角度，旋转范围是[-180°,180°)</li><li>gamma ：绕本地坐标系的z轴顺时针旋转的角度，旋转范围是[-90°,90°)</li></ul><p><code>注</code>：alpha, beta, gamma具体是绕哪个轴旋转，跟我们当前程序所使用的坐标系有关。所以大家之后若是看到有些教程在说陀螺仪时，跟我说的不一样，也不要惊奇，只要在实践中没有问题就可以。</p><p>陀螺仪欧拉旋转的顺序是&#39;YXZ&#39;，而不是欧拉对象默认的&#39;XYZ&#39;。<br> 欧拉旋转顺序是很重要的，如果乱了，就无法让VR旋转与陀螺仪相匹配了。</p><p>接下来，基于之前VR.html 文件做下调整。</p><ol start="3"><li>建立立方体对象</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> Box <span class="token keyword">from</span> <span class="token string">&#39;./lv/Box.js&#39;</span>
<span class="token keyword">const</span> box <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Box</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="4"><li>调整相机数据</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 目标点</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//视点</span>
<span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.45</span><span class="token punctuation">,</span> <span class="token number">0.0001</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token number">120</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
  <span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">2</span>
<span class="token punctuation">]</span>
<span class="token comment">// 透视相机</span>
<span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span>
camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>相机的视线是根据陀螺仪的初始状态设置的。<br> 在陀螺仪的alpha, beta, gamma皆为0的情况下，手机成俯视状态。<br><img src="/visual/webgl-share/190.png" alt=""></p><p>所以，相机也要成俯视状态，因此视点的y值设置为0.45。<br> 然而，视线也不能完全垂直，因为这样视点绕y轴旋转就会失效。<br> 所以，视点的z值给了一个较小的数字0.0001。</p><ol start="5"><li>场景的渲染和之前是一样。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 轨道控制器</span>
<span class="token keyword">const</span> orbit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrbitControls</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  camera<span class="token punctuation">,</span>
  target<span class="token punctuation">,</span>
  <span class="token literal-property property">dom</span><span class="token operator">:</span> canvas<span class="token punctuation">,</span>
  <span class="token literal-property property">enablePan</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">maxZoom</span><span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
  <span class="token literal-property property">minZoom</span><span class="token operator">:</span> <span class="token number">0.4</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 场景</span>
<span class="token keyword">const</span> scene <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">{</span> gl <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//注册程序对象</span>
scene<span class="token punctuation">.</span><span class="token function">registerProgram</span><span class="token punctuation">(</span>
  <span class="token string">&#39;map&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">,</span>
      document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
      document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">attributeNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;a_Pin&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">uniformNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;u_PvMatrix&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_ModelMatrix&#39;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment">//立方体</span>
<span class="token keyword">const</span> matBox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;map&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> geoBox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> box<span class="token punctuation">.</span>vertices<span class="token punctuation">,</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">a_Pin</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> box<span class="token punctuation">.</span>uv<span class="token punctuation">,</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">array</span><span class="token operator">:</span> box<span class="token punctuation">.</span>indexes
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//加载图片</span>
<span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&#39;./images/magic.jpg&#39;</span>
image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  matBox<span class="token punctuation">.</span>maps<span class="token punctuation">.</span>u_Sampler <span class="token operator">=</span> <span class="token punctuation">{</span>
    image<span class="token punctuation">,</span>
    <span class="token literal-property property">magFilte</span><span class="token operator">:</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">,</span>
    <span class="token literal-property property">minFilter</span><span class="token operator">:</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">geo</span><span class="token operator">:</span> geoBox<span class="token punctuation">,</span>
    <span class="token literal-property property">mat</span><span class="token operator">:</span> matBox
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br></div></div><p>效果如下：<br><img src="/visual/webgl-share/190.png" alt=""></p><ol start="7"><li>监听陀螺仪事件时，需要考虑三件事：</li></ol><ul><li>判断当前设备里是否有陀螺仪。</li><li>让用户触发浏览器对陀螺仪事件的监听，可通过click 之类的事件触发。</li><li>若系统是ios，需要请求用户许可。</li></ul><p>css 样式：</p><div class="language-css ext-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">html</span> <span class="token punctuation">{</span><span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token selector">body</span> <span class="token punctuation">{</span>
  <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  <span class="token property">overflow</span><span class="token punctuation">:</span> hidden
<span class="token punctuation">}</span>
<span class="token selector">.wrapper</span> <span class="token punctuation">{</span>
  <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
  <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  <span class="token property">justify-content</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">z-index</span><span class="token punctuation">:</span> 10<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">#playBtn</span> <span class="token punctuation">{</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 24px 24px<span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> 24px<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #00acec<span class="token punctuation">;</span>
  <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>
  <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 24px<span class="token punctuation">;</span>
  <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 6px solid <span class="token function">rgba</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span> 255<span class="token punctuation">,</span> 255<span class="token punctuation">,</span> 0.7<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 9px 9px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.7<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>html 标签：</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>wrapper<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>playBtn<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>开启VR之旅<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>js 代码：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 遮罩</span>
<span class="token keyword">const</span> wrapper <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;.wrapper&#39;</span><span class="token punctuation">)</span>
<span class="token comment">// 按钮</span>
<span class="token keyword">const</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#playBtn&#39;</span><span class="token punctuation">)</span>
<span class="token comment">// 判断设备中是否有陀螺仪</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>DeviceMotionEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 让用户触发陀螺仪的监听事件</span>
  btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;click&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//若是ios系统，需要请求用户许可</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>DeviceMotionEvent<span class="token punctuation">.</span>requestPermission<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&#39;您的设备里没有陀螺仪！&#39;</span>
<span class="token punctuation">}</span>

<span class="token comment">//请求用户许可</span>
<span class="token keyword">function</span> <span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  DeviceMotionEvent<span class="token punctuation">.</span><span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">permissionState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// granted:用户允许浏览器监听陀螺仪事件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>permissionState <span class="token operator">===</span> <span class="token string">&#39;granted&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&#39;请允许使用陀螺仪🌹&#39;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&#39;请求失败！&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//监听陀螺仪</span>
<span class="token keyword">function</span> <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  wrapper<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">&#39;none&#39;</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;deviceorientation&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> alpha<span class="token punctuation">,</span> beta<span class="token punctuation">,</span> gamma <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> rad <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">180</span>
    <span class="token keyword">const</span> euler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Euler</span><span class="token punctuation">(</span>
      beta <span class="token operator">*</span> rad<span class="token punctuation">,</span>
      alpha <span class="token operator">*</span> rad<span class="token punctuation">,</span>
      <span class="token operator">-</span>gamma <span class="token operator">*</span> rad<span class="token punctuation">,</span>
      <span class="token string">&#39;YXZ&#39;</span>
    <span class="token punctuation">)</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>
      eye<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">applyEuler</span><span class="token punctuation">(</span>euler<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    orbit<span class="token punctuation">.</span><span class="token function">updateCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    orbit<span class="token punctuation">.</span><span class="token function">resetSpherical</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>关于陀螺仪的基本用法就说到这。</p><p>之前在网上看了一些陀螺仪相关的教程，很多都没说到点上，因为若是不知道欧拉旋转的概念，就说不明白陀螺仪。</p><p>所以，一定要花时间学习图形学，图形学关系着自身发展的潜力。<br> 接下来可以在VR.html 文件里，以同样的原理把陀螺仪写进去，并结合项目的实际需求做一下优化。</p><h4 id="_2-4-vr-陀螺仪" tabindex="-1"><a class="header-anchor" href="#_2-4-vr-陀螺仪" aria-hidden="true">#</a> 2.4 VR+陀螺仪</h4><p>可以先把陀螺仪封装一下，以后用起来方便。</p><ol><li>封装一个陀螺仪对象Gyro.js</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Euler<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> rad <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">180</span>

<span class="token keyword">const</span> <span class="token function-variable function">defAttr</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">//用于触发事件的按钮</span>
  <span class="token literal-property property">btn</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token comment">//没有陀螺仪</span>
  <span class="token function-variable function">noDevice</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//当点击按钮时</span>
  <span class="token function-variable function">onClick</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//可以使用陀螺仪时触发一次</span>
  <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//用户拒绝开启陀螺仪</span>
  <span class="token function-variable function">reject</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//请求失败</span>
  <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//陀螺仪变换</span>
  <span class="token function-variable function">change</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Gyro</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">defAttr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> attr<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> btn <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>DeviceMotionEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 让用户触发陀螺仪的监听事件</span>
      btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;click&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//若系统是ios，需要请求用户许可</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DeviceMotionEvent<span class="token punctuation">.</span>requestPermission<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">noDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//请求用户许可</span>
  <span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    DeviceMotionEvent<span class="token punctuation">.</span><span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">permissionState</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// granted:用户允许浏览器监听陀螺仪事件</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>permissionState <span class="token operator">===</span> <span class="token string">&#39;granted&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 监听陀螺仪</span>
  <span class="token function">translate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;deviceorientation&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> beta<span class="token punctuation">,</span> alpha<span class="token punctuation">,</span> gamma <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Euler</span><span class="token punctuation">(</span>
        beta <span class="token operator">*</span> rad<span class="token punctuation">,</span>
        alpha <span class="token operator">*</span> rad<span class="token punctuation">,</span>
        <span class="token operator">-</span>gamma <span class="token operator">*</span> rad<span class="token punctuation">,</span>
        <span class="token string">&#39;YXZ&#39;</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><ol start="2"><li>把陀螺仪对象引入VR文件</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> Gyro <span class="token keyword">from</span> <span class="token string">&#39;./lv/Gyro.js&#39;</span>

<span class="token comment">// 遮罩</span>
<span class="token keyword">const</span> wrapper <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;.wrapper&#39;</span><span class="token punctuation">)</span>
<span class="token comment">// 按钮</span>
<span class="token keyword">const</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#playBtn&#39;</span><span class="token punctuation">)</span>
<span class="token comment">// 陀螺仪</span>
<span class="token keyword">const</span> gyro <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gyro</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  btn<span class="token punctuation">,</span>
  <span class="token function-variable function">noDevice</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&#39;您的设备里没有陀螺仪！&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">reject</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&#39;请允许使用陀螺仪🌹&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&#39;请求失败！&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    wrapper<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">&#39;none&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">change</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">euler</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>
      eye<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">applyEuler</span><span class="token punctuation">(</span>euler<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    orbit<span class="token punctuation">.</span><span class="token function">updateCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    orbit<span class="token punctuation">.</span><span class="token function">resetSpherical</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
gyro<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><ol start="3"><li>优化图像的加载。</li></ol><p>在实际开发中，为了让用户看到比较清晰的效果，往往需要使用比较大的全景图，比如4096*2048 的尺寸。<br> 大尺寸的图片加载起来会很慢，为了减少用户的等待，可以先加载一个较小的图片，然后慢慢的过度到大图。</p><p>比如，可以从小到大准备4张不同尺寸的全景图：</p><ul><li>512*256</li><li>1024*512</li><li>2048*1024</li><li>4096*2048</li></ul><p>接下来先加载第一张小图，将其显示出来后，再依次加载后面的大图。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//图片序号</span>
<span class="token keyword">let</span> level <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">//加载图片</span>
<span class="token function">loadImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">loadImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./images/room</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>level<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.jpg</span><span class="token template-punctuation string">`</span></span>
  image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">firstRender</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//更新贴图</span>
      matEarth<span class="token punctuation">.</span><span class="token function">setMap</span><span class="token punctuation">(</span><span class="token string">&#39;u_Sampler&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> image <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      level<span class="token operator">++</span>
      <span class="token function">loadImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 第一次渲染</span>
<span class="token keyword">function</span> <span class="token function">firstRender</span><span class="token punctuation">(</span><span class="token parameter">image</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  btn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&#39;开启VR之旅&#39;</span>
  matEarth<span class="token punctuation">.</span>maps<span class="token punctuation">.</span>u_Sampler <span class="token operator">=</span> <span class="token punctuation">{</span>
    image<span class="token punctuation">,</span>
    <span class="token literal-property property">magFilte</span><span class="token operator">:</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">,</span>
    <span class="token literal-property property">minFilter</span><span class="token operator">:</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">geo</span><span class="token operator">:</span> geoEarth<span class="token punctuation">,</span>
    <span class="token literal-property property">mat</span><span class="token operator">:</span> matEarth
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>与此同时，我们还得微调一下Mat.js里的更新贴图方法：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">updateMap</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span>map<span class="token punctuation">,</span>ind</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ……
  <span class="token comment">//gl.bindTexture(gl.TEXTURE_2D, null)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>需要取消对纹理缓冲区的清理。<br> 以前要清理纹理缓冲区，是因为不需要对纹理缓冲区里的纹理对象进行更新，将其清理掉还可以节约内存。<br> 而现在需要对纹理缓冲区里的纹理对象进行更新，那就不能清理掉了。</p><h4 id="_2-5开场动画" tabindex="-1"><a class="header-anchor" href="#_2-5开场动画" aria-hidden="true">#</a> 2.5开场动画</h4><p>开场动画的作用，就是给用户一个吸引眼球的效果，提高项目的趣味性。<br> 开场动画的开场方式有很多，咱们这里就说一个比较常见的：从上帝视角到普通视角的过度。</p><p>上帝视角就是一个俯视的视角，视野一定要广，如下图：<br><img src="/visual/webgl-share/191.png" alt=""></p><p>之后，我会用补间动画，将其过度到普通视角，如下图：<br><img src="/visual/webgl-share/187.png" alt=""></p><p>从上帝视角到普通视角的变换涉及以下属性：</p><ul><li>相机视点的位置</li><li>相机视椎体的垂直视角</li></ul><p>接下来便可以基于上面的属性做缓动动画。</p><ol><li>把当前的相机视角调为上帝视角。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 目标点</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//视点-根据陀螺仪做欧拉旋转</span>
<span class="token keyword">const</span> eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span> <span class="token number">0.15</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.0001</span><span class="token punctuation">)</span>
<span class="token comment">// 透视相机</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token number">130</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
  <span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">2</span>
<span class="token punctuation">]</span>
<span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span>
<span class="token comment">// 上帝视角</span>
camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.42</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ol start="2"><li>基于相机的视点和视椎体的垂直夹角建立两个目标变量</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> endPos <span class="token operator">=</span> camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> endFov <span class="token operator">=</span> fov
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>上面的两个目标变量默认是和当前相机一致的，之后陀螺仪发生变化时会对其做修改。</p><ol start="3"><li>在陀螺仪发生变化时，设置目标变量</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 陀螺仪</span>
<span class="token keyword">const</span> gyro <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gyro</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  ……
  <span class="token function-variable function">change</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">euler</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    endFov <span class="token operator">=</span> <span class="token number">60</span>
    endPos<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>
      eye<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">applyEuler</span><span class="token punctuation">(</span>euler<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>当前的开场动画是针对有陀螺仪的手机而言的，接下来再做对PC端的开场动画。</p><ol start="4"><li>当鼠标点击“开启VR之旅” 的时候，若浏览器在PC端，将视角调为普通视角。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> pc <span class="token operator">=</span> <span class="token function">isPC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> gyro <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gyro</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
 	……
  <span class="token function-variable function">onClick</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      endPos<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0.15</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.0001</span><span class="token punctuation">)</span>
      endFov <span class="token operator">=</span> <span class="token number">60</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>isPC() 是判断浏览器是否在PC端的方法。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">isPC</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token operator">!</span>navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="5"><li>建立缓动动画方法</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">tween</span><span class="token punctuation">(</span><span class="token parameter">ratio <span class="token operator">=</span> <span class="token number">0.05</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//若当前设备为PC,缓动结束后就不再缓动，之后的变换交给轨道控制器</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pc <span class="token operator">&amp;&amp;</span> camera<span class="token punctuation">.</span>fov <span class="token operator">&lt;</span> endFov <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>

  camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>endPos<span class="token punctuation">,</span> ratio<span class="token punctuation">)</span>
  camera<span class="token punctuation">.</span>fov <span class="token operator">+=</span> <span class="token punctuation">(</span>endFov <span class="token operator">-</span> camera<span class="token punctuation">.</span>fov<span class="token punctuation">)</span> <span class="token operator">*</span> ratio
  camera<span class="token punctuation">.</span><span class="token function">updateProjectionMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  orbit<span class="token punctuation">.</span><span class="token function">updateCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  orbit<span class="token punctuation">.</span><span class="token function">resetSpherical</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li><p>camera.updateProjectionMatrix() 更新投影矩阵。</p><p>因为上面更新了视椎体的垂直夹角，所以相机的投影矩阵也要做同步的更新，具体原理参见之前的透视投影矩阵。</p></li><li><p>orbit.updateCamera() 更新相机，将相机的视点位置和视线写入相机的本地矩阵里。</p></li><li><p>orbit.resetSpherical() 重置球坐标。用鼠标旋转相机的时候会将旋转信息写入球坐标。</p></li></ul><ol start="6"><li>在连续渲染时执行缓动动画</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">tween</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_2-6添加标记点" tabindex="-1"><a class="header-anchor" href="#_2-6添加标记点" aria-hidden="true">#</a> 2.6添加标记点</h4><p>标记点可以告诉用户不同区域的名称，或者为用户指引方向。<br> 在添加标记点的时候，我们要考虑两点：</p><ul><li>如何添加标记点</li><li>如何制作标记点</li></ul><p>接下来在 VR 场景中添加HTML类型的标记点，这种方法是比较常见的。<br> 在VR中添加HTML类型标记点的核心问题是：如何让HTML 标记点随VR 场景同步变换。<br> 解决这个问题要按以下几步走：<br><img src="/visual/webgl-share/192.png" alt=""></p><ol><li>鼠标点击canvas 画布时，将此点的canvas坐标转世界坐标A。<br> ​<code>注</code>：canvas坐标转世界坐标的原理在“进入三维世界”的选择立方体里说过。</li><li>以视点为起点，A点位方向做射线EA。</li><li>求射线EA与球体的交点P，此点便是标记点在世界坐标系内的世界坐标。</li><li>在变换VR场景时，将标记点的世界坐标转canvas坐标，然后用此坐标更新标记点的位置。</li></ol><p>在上面的步骤中，第3步是关键，我们详细讲解以下。</p><p><code>已知</code>：</p><ul><li>射线 EA</li><li>球体球心为O，半径为 r</li></ul><p><code>求</code>：射线 EA与球体的交点P</p><p><code>解</code>：</p><p>先判断射线的基线与球体的关系。</p><p><code>设</code>：EA的单位向量为v</p><p>用EO叉乘EA的单位向量，求得球心O 到直线的距离|OB|</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">|</span><span class="token constant">OB</span><span class="token operator">|=</span><span class="token operator">|</span><span class="token constant">EO</span><span class="token operator">^</span>v<span class="token operator">|</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>基于|OB|和半径r，可以知道基线与球体的关系：<br><img src="/visual/webgl-share/193.png" alt=""></p><ul><li>|OB|&gt;r，直线与球体相离，没有交点</li><li>|OB|=r，直线与球体相切，1个交点 ，交点为B点</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">B</span><span class="token operator">=</span>v<span class="token operator">*</span><span class="token punctuation">(</span><span class="token constant">EO</span>·v<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ul><li>|OB|&lt;r，直线与球体相交，2个交点，其算法如下：<br><img src="/visual/webgl-share/192.png" alt=""></li></ul><p>在直线EA上的点可以写做：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">E</span><span class="token operator">+</span>λv<span class="token punctuation">,</span> λ∈<span class="token constant">R</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>直线和球体相交的点满足：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">(</span><span class="token constant">E</span><span class="token operator">+</span>λv<span class="token operator">-</span><span class="token constant">O</span><span class="token punctuation">)</span>²<span class="token operator">=</span>r²
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>(λv+OE)²可理解为向量OP的长度的平方。<br> E-O可写做OE：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">(</span>λv<span class="token operator">+</span><span class="token constant">OE</span><span class="token punctuation">)</span>²<span class="token operator">=</span>r²
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>展开上式：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>λ²v²<span class="token operator">+</span><span class="token number">2</span>λv·<span class="token constant">OE</span><span class="token operator">+</span><span class="token constant">OE</span>²<span class="token operator">=</span>r²
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p><code>因为</code>：单位向量与其自身的点积等于1<br><code>所以</code>：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>λ²<span class="token operator">+</span><span class="token number">2</span>λv·<span class="token constant">OE</span><span class="token operator">+</span><span class="token constant">OE</span>²<span class="token operator">=</span>r²
λ²<span class="token operator">+</span><span class="token number">2</span>λv·<span class="token constant">OE</span><span class="token operator">+</span><span class="token constant">OE</span>²<span class="token operator">-</span>r²<span class="token operator">=</span><span class="token number">0</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>解一元二次方程式，求λ：<br> 为了方便书写，设：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>b<span class="token operator">=</span>2v·<span class="token constant">OE</span>
c<span class="token operator">=</span><span class="token constant">OE</span>²<span class="token operator">-</span>r²
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>则</code>：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>λ²<span class="token operator">+</span>λb<span class="token operator">+</span>c<span class="token operator">=</span><span class="token number">0</span>
λ²<span class="token operator">+</span>bλ<span class="token operator">+</span><span class="token punctuation">(</span>b<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>²<span class="token operator">=</span><span class="token operator">-</span>c<span class="token operator">+</span><span class="token punctuation">(</span>b<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token function">²</span>
<span class="token punctuation">(</span>λ<span class="token operator">+</span>b<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>²<span class="token operator">=</span><span class="token punctuation">(</span>b²<span class="token operator">-</span>4c<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span>
λ<span class="token operator">+</span>b<span class="token operator">/</span><span class="token number">2</span><span class="token operator">=</span><span class="token function">±sqrt</span><span class="token punctuation">(</span>b²<span class="token operator">-</span>4c<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>
λ<span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token function">b±sqrt</span><span class="token punctuation">(</span>b²<span class="token operator">-</span>4c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>知道了λ ，也就可以直线与球体的交点。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>λv<span class="token operator">+</span><span class="token constant">OE</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p><code>注</code>：当λ小于0时，交点在射线EA的反方向，应该舍弃。<br> 关于射线与球体的交点，就说到这。</p><p>接下来基于之前的VR.html 代码，在VR球体上打一个标记点。</p><ol><li>建立一个标记点。当前先不考虑标记点的文字内容的编辑，只关注标记点的位置。</li></ol><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
  <span class="token selector">#mark</span> <span class="token punctuation">{</span>
    <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
    <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
    <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.6<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">padding</span><span class="token punctuation">:</span> 6px 12px<span class="token punctuation">;</span>
    <span class="token property">border-radius</span><span class="token punctuation">:</span> 3px<span class="token punctuation">;</span>
    <span class="token property">user-select</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mark<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>标记点<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ol start="2"><li>获取标记点，建立markWp变量，用于记录标记点的世界坐标。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 标记</span>
<span class="token keyword">const</span> mark <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#mark&#39;</span><span class="token punctuation">)</span>
<span class="token comment">// 标记点的世界位</span>
<span class="token keyword">let</span> markWp <span class="token operator">=</span> <span class="token keyword">null</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="3"><li>当鼠标双击canvas 画布的时候，添加标记点。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;dblclick&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">addMark</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>addMark() 方法做了3件事情：</p><ul><li>worldPos() 把鼠标点击在canvas画布上的canvas坐标转换为世界坐标.<br> 此方法咱们之前写过，从Utils.js 中引入即可。</li><li>getMarkWp() 根据鼠标点的世界坐标设置标记点的世界坐标。<br> 这便是参照之前射线和球体交点的数学公式来写的。<br><code>注</code>：鼠标点的世界坐标并不是标记点的世界坐标。</li><li>setMarkCp() 设置标记点的canvas坐标位。</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">addMark</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//鼠标点的世界坐标</span>
  <span class="token keyword">const</span> <span class="token constant">A</span> <span class="token operator">=</span> <span class="token function">worldPos</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> canvas<span class="token punctuation">,</span> pvMatrix<span class="token punctuation">)</span>
  <span class="token comment">//获取标记点的世界坐标</span>
  markWp <span class="token operator">=</span><span class="token function">getMarkWp</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>position<span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> earth<span class="token punctuation">.</span>r<span class="token punctuation">)</span>
  <span class="token comment">//设置标记点的canvas坐标位</span>
  <span class="token function">setMarkCp</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>clientX<span class="token punctuation">,</span> event<span class="token punctuation">.</span>clientY<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 获取射线和球体的交点
  E 射线起点-视点
  A 射线目标点
  O 球心
  r 半径
*/</span>
<span class="token keyword">function</span> <span class="token function">getMarkWp</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">O</span><span class="token punctuation">,</span> r</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> v <span class="token operator">=</span> <span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token constant">E</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token constant">OE</span> <span class="token operator">=</span> <span class="token constant">E</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token constant">O</span><span class="token punctuation">)</span>
  <span class="token comment">//b=2v·OE</span>
  <span class="token keyword">const</span> b <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span><span class="token constant">OE</span><span class="token punctuation">)</span>
  <span class="token comment">//c=OE²-r²</span>
  <span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token constant">OE</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span><span class="token constant">OE</span><span class="token punctuation">)</span> <span class="token operator">-</span> r <span class="token operator">*</span> r
  <span class="token comment">//λ=(-b±sqrt(b²-4c))/2</span>
  <span class="token keyword">const</span> lambda <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span>b <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>b <span class="token operator">*</span> b <span class="token operator">-</span> <span class="token number">4</span> <span class="token operator">*</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
  <span class="token comment">//λv+OE</span>
  <span class="token keyword">return</span> v<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiplyScalar</span><span class="token punctuation">(</span>lambda<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">OE</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//设置标记点的canvas坐标位</span>
<span class="token keyword">function</span> <span class="token function">setMarkCp</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  mark<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span>
  mark<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>y<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><ol start="4"><li>当旋转和缩放相机的时候，对标记点进行同步变换。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointermove&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">pointermove</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  <span class="token function">updateMarkCp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;wheel&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">wheel</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">&#39;OrthographicCamera&#39;</span><span class="token punctuation">)</span>
  <span class="token function">updateMarkCp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//更新标记点的位置</span>
<span class="token keyword">function</span> <span class="token function">updateMarkCp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>markWp<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>

  <span class="token comment">//判断标记点在相机的正面还是背面</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>position<span class="token punctuation">}</span><span class="token operator">=</span>camera
  <span class="token keyword">const</span> dot <span class="token operator">=</span> markWp<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>
    target<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dot <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mark<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">&#39;block&#39;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    mark<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">&#39;none&#39;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 将标记点的世界坐标转裁剪坐标</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span> markWp<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>pvMatrix<span class="token punctuation">)</span>
  <span class="token comment">// 将标记点的裁剪坐标转canvas坐标</span>
  <span class="token function">setMarkCp</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token operator">-</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> canvas<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">2</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>之后围绕标记点还可以再进一步优化：</p><ul><li>使标记点的文字内容可编辑</li><li>优化标记点样式</li><li>使标记点可拖拽</li><li>添加多个标记点</li><li>……</li></ul><p>这些都是正常的前端业务逻辑，我这里就只重点说图形学相关的知识了。<br> 之后可以参考一个叫“<a href="https://720yun.com/" target="_blank" rel="noopener noreferrer">720云<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>”的网站，它就是专业做VR的。<br><img src="/visual/webgl-share/194.png" alt=""></p><h4 id="_2-7-vr场景的切换" tabindex="-1"><a class="header-anchor" href="#_2-7-vr场景的切换" aria-hidden="true">#</a> 2.7 VR场景的切换</h4><p>在实际开发中通常会遇到这样的需求：<br> 在客厅的VR场景中有一扇进入卧室的门，在卧室门上有一个写着“卧室”的标记点。<br> 当点击“卧室”标记点时，就进入卧室的VR 中。<br> 这个需求便涉及了客厅和卧室两个VR场景的切换。<br> 两个VR场景的切换最简单的实现方法就是直接换贴图了，这个方法快速、简单、直接，然而通常老板还想让我们给它一个过度效果。<br> 因此，两个VR 场景的过度才是这里要说的重点。</p><ol><li>准备一份VR数据vr.json，相当于后端数据库里的数据。</li></ol><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;imgSrc&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./images/room.jpg&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;eye&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">-0.14966274559865525</span><span class="token punctuation">,</span> <span class="token number">-0.009630159419482085</span><span class="token punctuation">,</span> <span class="token number">0.002884893313037499</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;marks&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;次卧&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;pos&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">-0.45099085840209097</span><span class="token punctuation">,</span> <span class="token number">0.0889607157340315</span><span class="token punctuation">,</span> <span class="token number">0.19670596506927274</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;link&quot;</span><span class="token operator">:</span> <span class="token number">2</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;主卧&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;pos&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">-0.34961792927865026</span><span class="token punctuation">,</span> <span class="token number">0.30943492493218633</span><span class="token punctuation">,</span> <span class="token number">-0.17893387258739163</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;link&quot;</span><span class="token operator">:</span> <span class="token number">3</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">&quot;imgSrc&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./images/secBed.jpg&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;eye&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">-0.14966274559865525</span><span class="token punctuation">,</span> <span class="token number">-0.009630159419482085</span><span class="token punctuation">,</span> <span class="token number">0.002884893313037499</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;marks&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;客厅&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;pos&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">-0.34819482247111166</span><span class="token punctuation">,</span> <span class="token number">0.29666506812630905</span><span class="token punctuation">,</span> <span class="token number">-0.20186679508508473</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;link&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token property">&quot;imgSrc&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./images/mainBed.jpg&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;eye&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">-0.14966274559865525</span><span class="token punctuation">,</span> <span class="token number">-0.009630159419482085</span><span class="token punctuation">,</span> <span class="token number">0.002884893313037499</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;marks&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;客厅&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;pos&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">-0.07077938553590507</span><span class="token punctuation">,</span> <span class="token number">0.14593627464082626</span><span class="token punctuation">,</span> <span class="token number">-0.47296181910077806</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;link&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>当前这个json 文件里有3个VR 场景的数据，分别是客厅、主卧、次卧。</p><ul><li>imgSrc VR图片</li><li>eye 相机视点</li><li>marks 标记点 <ul><li>name 标记点名称</li><li>pos 标记点世界位，可在上一节添加标记点的时候，将其存储到后端</li><li>link 当前标记点链接的VR 的id</li></ul></li></ul><ol start="2"><li>基于之前添加标记点文件，做下调整，建立一个标记点容器marks，之后会往marks里放html类型的标记点</li></ol><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
  <span class="token selector">.mark</span> <span class="token punctuation">{</span>
    <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
    <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">translate</span><span class="token punctuation">(</span>-50%<span class="token punctuation">,</span> -50%<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
    <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.6<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">padding</span><span class="token punctuation">:</span> 6px 12px<span class="token punctuation">;</span>
    <span class="token property">border-radius</span><span class="token punctuation">:</span> 3px<span class="token punctuation">;</span>
    <span class="token property">user-select</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
    <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>marks<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  ……
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ol start="3"><li>简化出一个VR场景</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createProgram<span class="token punctuation">,</span> worldPos <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;/jsm/Utils.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Matrix4<span class="token punctuation">,</span> PerspectiveCamera<span class="token punctuation">,</span> Vector3
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> OrbitControls <span class="token keyword">from</span> <span class="token string">&#39;./lv/OrbitControls.js&#39;</span>
<span class="token keyword">import</span> Mat <span class="token keyword">from</span> <span class="token string">&#39;./lv/Mat.js&#39;</span>
<span class="token keyword">import</span> Geo <span class="token keyword">from</span> <span class="token string">&#39;./lv/Geo.js&#39;</span>
<span class="token keyword">import</span> Obj3D <span class="token keyword">from</span> <span class="token string">&#39;./lv/Obj3D.js&#39;</span>
<span class="token keyword">import</span> Scene <span class="token keyword">from</span> <span class="token string">&#39;./lv/Scene.js&#39;</span>
<span class="token keyword">import</span> Earth <span class="token keyword">from</span> <span class="token string">&#39;./lv/Earth.js&#39;</span>

<span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
<span class="token keyword">let</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 球体</span>
<span class="token keyword">const</span> earth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Earth</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>

<span class="token comment">// 目标点</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token number">60</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
  <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">5</span>
<span class="token punctuation">]</span>
<span class="token comment">// 透视相机</span>
<span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span>fov<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span>
<span class="token comment">// 轨道控制器</span>
<span class="token keyword">const</span> orbit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrbitControls</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  camera<span class="token punctuation">,</span>
  target<span class="token punctuation">,</span>
  <span class="token literal-property property">dom</span><span class="token operator">:</span> canvas<span class="token punctuation">,</span>
  <span class="token literal-property property">enablePan</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">maxZoom</span><span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
  <span class="token literal-property property">minZoom</span><span class="token operator">:</span> <span class="token number">0.4</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//投影视图矩阵</span>
<span class="token keyword">const</span> pvMatrix <span class="token operator">=</span> orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">//标记</span>
<span class="token keyword">const</span> marks <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#marks&#39;</span><span class="token punctuation">)</span>

<span class="token comment">// 场景</span>
<span class="token keyword">const</span> scene <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">{</span> gl <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//注册程序对象</span>
scene<span class="token punctuation">.</span><span class="token function">registerProgram</span><span class="token punctuation">(</span>
  <span class="token string">&#39;map&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">,</span>
      document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
      document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">attributeNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;a_Pin&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">uniformNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;u_PvMatrix&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_ModelMatrix&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_Sampler&#39;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment">//球体</span>
<span class="token keyword">const</span> mat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;map&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">maps</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">u_Sampler</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">magFilter</span><span class="token operator">:</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">,</span>
      <span class="token literal-property property">minFilter</span><span class="token operator">:</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> geo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> earth<span class="token punctuation">.</span>vertices<span class="token punctuation">,</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">a_Pin</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> earth<span class="token punctuation">.</span>uv<span class="token punctuation">,</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">array</span><span class="token operator">:</span> earth<span class="token punctuation">.</span>indexes
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span> geo<span class="token punctuation">,</span> mat <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 渲染</span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 取消右击菜单的显示 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;contextmenu&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/* 指针按下时，设置拖拽起始位，获取轨道控制器状态。 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerdown&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">pointerdown</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/* 指针移动时，若控制器处于平移状态，平移相机；若控制器处于旋转状态，旋转相机。 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointermove&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">pointermove</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  <span class="token function">updateMarkCp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/* 指针抬起 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointerup&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">pointerup</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/* 滚轮事件 */</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;wheel&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">wheel</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">&#39;OrthographicCamera&#39;</span><span class="token punctuation">)</span>
  <span class="token function">updateMarkCp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br></div></div><p>当前是渲染不出东西来的，因为我还没有给球体指定贴图。</p><ol start="4"><li>请求VR 数据，更新VR。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> data<span class="token punctuation">;</span>
<span class="token keyword">let</span> curVr<span class="token punctuation">;</span>
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&#39;./data/vr.json&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">dt</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    data <span class="token operator">=</span> dt
    curVr <span class="token operator">=</span> <span class="token function">getVrById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">//更新VR</span>
    <span class="token function">updateVr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 渲染</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//根据id获取VR数据</span>
<span class="token keyword">function</span> <span class="token function">getVrById</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">===</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//根据数据更新VR</span>
<span class="token keyword">function</span> <span class="token function">updateVr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  image<span class="token punctuation">.</span>src <span class="token operator">=</span> curVr<span class="token punctuation">.</span>imgSrc
  image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//更新图片</span>
    mat<span class="token punctuation">.</span><span class="token function">setMap</span><span class="token punctuation">(</span><span class="token string">&#39;u_Sampler&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> image <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//更新相机视点</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token operator">...</span>curVr<span class="token punctuation">.</span>eye<span class="token punctuation">)</span>
    orbit<span class="token punctuation">.</span><span class="token function">updateCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    orbit<span class="token punctuation">.</span><span class="token function">resetSpherical</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//显示标记点</span>
    <span class="token function">showMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//显示标记点</span>
<span class="token keyword">function</span> <span class="token function">showMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  curVr<span class="token punctuation">.</span>marks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">ele</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">)</span>
    div<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">&#39;mark&#39;</span>
    div<span class="token punctuation">.</span>innerText <span class="token operator">=</span> ele<span class="token punctuation">.</span>name
    div<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&#39;data-link&#39;</span><span class="token punctuation">,</span> ele<span class="token punctuation">.</span>link<span class="token punctuation">)</span>
    marks<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//更新标记点的canvas坐标位</span>
<span class="token keyword">function</span> <span class="token function">updateMarkCp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>marks<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> position <span class="token punctuation">}</span> <span class="token operator">=</span> camera
  <span class="token keyword">const</span> <span class="token constant">EO</span> <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span>
  curVr<span class="token punctuation">.</span>marks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ele<span class="token punctuation">,</span> ind</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> markWp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token operator">...</span>ele<span class="token punctuation">.</span>pos<span class="token punctuation">)</span>
    <span class="token keyword">const</span> mark <span class="token operator">=</span> marks<span class="token punctuation">.</span>children<span class="token punctuation">[</span>ind<span class="token punctuation">]</span>
    <span class="token keyword">const</span> dot <span class="token operator">=</span> markWp<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span><span class="token constant">EO</span><span class="token punctuation">)</span>
    mark<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> dot <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">&#39;block&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;none&#39;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span> markWp<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">applyMatrix4</span><span class="token punctuation">(</span>pvMatrix<span class="token punctuation">)</span>
    mark<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span>
    mark<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token punctuation">(</span><span class="token operator">-</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> canvas<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">2</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><ol start="5"><li>点击标记点时，根据标记点的data-link 更新VR</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>marks<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;click&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> target <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>className <span class="token operator">!==</span> <span class="token string">&#39;mark&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
  marks<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
  curVr <span class="token operator">=</span> <span class="token function">getVrById</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&#39;data-link&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">updateVr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="6"><li>连续渲染的时候，更新标记点的canvas坐标位</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">updateMarkCp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="7"><li>把鼠标的位移事件绑定到window上</li></ol><p>当鼠标移动到标记点上时，会被标记点卡住，无法移动，这是因为标记点挡住了canvas，所以不能再把鼠标事件绑定到canvas上了。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;pointermove&#39;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  orbit<span class="token punctuation">.</span><span class="token function">pointermove</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_2-8-vr场景的过渡动画" tabindex="-1"><a class="header-anchor" href="#_2-8-vr场景的过渡动画" aria-hidden="true">#</a> 2.8 VR场景的过渡动画</h4><p>当前显示的VR就叫它旧VR，接下来要显示的VR就叫它新VR。<br> 这两个VR可以想象成两张图片，旧VR在新VR上面，旧VR遮挡了新VR。<br> 在切换VR的时候，可以先实现这样一个过渡效果：让旧VR渐隐，从而露出下面的新VR。<br> 帧缓冲区便可以视之为存储在内存里的图片。<br> 将两个VR场景分别渲染到两个帧缓冲区里后，便可以基于透明度融合一下，然后贴到一个充满窗口的平面上，从而实现过度效果。</p><ol><li>封装个场景对象出来，这个场景里只有一个充满窗口的平面，之后会把帧缓冲区贴上去</li></ol><p>VRPlane.js</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createProgram <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./Utils.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Mat <span class="token keyword">from</span> <span class="token string">&#39;./Mat.js&#39;</span>
<span class="token keyword">import</span> Geo <span class="token keyword">from</span> <span class="token string">&#39;./Geo.js&#39;</span>
<span class="token keyword">import</span> Obj3D <span class="token keyword">from</span> <span class="token string">&#39;./Obj3D.js&#39;</span>
<span class="token keyword">import</span> Scene <span class="token keyword">from</span> <span class="token string">&#39;./Scene.js&#39;</span>
<span class="token keyword">import</span> Rect <span class="token keyword">from</span> <span class="token string">&#39;./Rect.js&#39;</span>

<span class="token keyword">const</span> vs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  attribute vec4 a_Position;
  attribute vec2 a_Pin;
  varying vec2 v_Pin;
  void main(){
    gl_Position=a_Position;
    v_Pin=a_Pin;
  }
</span><span class="token template-punctuation string">`</span></span>

<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  precision mediump float;
  uniform float u_Ratio;
  uniform sampler2D u_SampNew;
  uniform sampler2D u_SampOld;
  varying vec2 v_Pin;
  void main(){
    vec4 t1 = texture2D( u_SampNew, v_Pin );
    vec4 t2 = texture2D( u_SampOld, v_Pin );
    gl_FragColor = mix(t2,t1, u_Ratio);
  }
</span><span class="token template-punctuation string">`</span></span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">VRPlane</span> <span class="token keyword">extends</span> <span class="token class-name">Scene</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">createModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> gl <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerProgram</span><span class="token punctuation">(</span><span class="token string">&#39;map&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span>vs<span class="token punctuation">,</span>fs<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">attributeNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;a_Pin&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">uniformNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;u_SampNew&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_SampOld&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_Ratio&#39;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> mat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;map&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">u_Ratio</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform1f&#39;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> rect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> geo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">array</span><span class="token operator">:</span> rect<span class="token punctuation">.</span>vertices<span class="token punctuation">,</span>
          <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">a_Pin</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">array</span><span class="token operator">:</span> rect<span class="token punctuation">.</span>uv<span class="token punctuation">,</span>
          <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">2</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">array</span><span class="token operator">:</span> rect<span class="token punctuation">.</span>indexes
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span> geo<span class="token punctuation">,</span> mat <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mat<span class="token operator">=</span>mat
  <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><ol start="2"><li>封装一个包含VR场景的帧缓冲区对象</li></ol><p>VRFrame.js</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createProgram <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./Utils.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Matrix4<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Mat <span class="token keyword">from</span> <span class="token string">&#39;./Mat.js&#39;</span>
<span class="token keyword">import</span> Geo <span class="token keyword">from</span> <span class="token string">&#39;./Geo.js&#39;</span>
<span class="token keyword">import</span> Obj3D <span class="token keyword">from</span> <span class="token string">&#39;./Obj3D.js&#39;</span>
<span class="token keyword">import</span> Earth <span class="token keyword">from</span> <span class="token string">&#39;./Earth.js&#39;</span>
<span class="token keyword">import</span> Frame <span class="token keyword">from</span> <span class="token string">&#39;./Frame.js&#39;</span>

<span class="token keyword">const</span> vs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  attribute vec4 a_Position;
  attribute vec2 a_Pin;
  uniform mat4 u_PvMatrix;
  uniform mat4 u_ModelMatrix;
  varying vec2 v_Pin;
  void main(){
    gl_Position=u_PvMatrix*u_ModelMatrix*a_Position;
    v_Pin=a_Pin;
  }
</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  precision mediump float;
  uniform sampler2D u_Sampler;
  varying vec2 v_Pin;
  void main(){
    gl_FragColor=texture2D(u_Sampler,v_Pin);
  }
</span><span class="token template-punctuation string">`</span></span>

<span class="token comment">/* 参数
  gl,
  orbit,
*/</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">VRFrame</span> <span class="token keyword">extends</span> <span class="token class-name">Frame</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">createModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> orbit<span class="token punctuation">,</span> gl <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerProgram</span><span class="token punctuation">(</span><span class="token string">&#39;map&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span>vs<span class="token punctuation">,</span>fs<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">attributeNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;a_Pin&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">uniformNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;u_PvMatrix&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_ModelMatrix&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;u_Sampler&#39;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> mat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;map&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">u_PvMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">value</span><span class="token operator">:</span> orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">u_ModelMatrix</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Matrix4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>elements<span class="token punctuation">,</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">maps</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">u_Sampler</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">magFilter</span><span class="token operator">:</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">,</span>
          <span class="token literal-property property">minFilter</span><span class="token operator">:</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> earth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Earth</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> geo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">array</span><span class="token operator">:</span> earth<span class="token punctuation">.</span>vertices<span class="token punctuation">,</span>
          <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">3</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">a_Pin</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">array</span><span class="token operator">:</span> earth<span class="token punctuation">.</span>uv<span class="token punctuation">,</span>
          <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">2</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">array</span><span class="token operator">:</span> earth<span class="token punctuation">.</span>indexes
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span> geo<span class="token punctuation">,</span> mat <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mat<span class="token operator">=</span>mat
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br></div></div><ol start="3"><li>基于之前的场景切换文件修改代码，引入组件</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Matrix4<span class="token punctuation">,</span> PerspectiveCamera<span class="token punctuation">,</span> Vector3
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> OrbitControls <span class="token keyword">from</span> <span class="token string">&#39;./lv/OrbitControls.js&#39;</span>
<span class="token keyword">import</span> VRFrame <span class="token keyword">from</span> <span class="token string">&#39;./lv/VRFrame.js&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> VRPlane <span class="token keyword">from</span> <span class="token string">&#39;./lv/VRPlane.js&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Track <span class="token keyword">from</span> <span class="token string">&#39;/jsm/Track.js&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="4"><li>开启透明度</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">BLEND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">blendFunc</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">SRC_ALPHA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">ONE_MINUS_SRC_ALPHA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="5"><li>实例化一个场景对象，两个帧缓冲区</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> scene <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VRPlane</span><span class="token punctuation">(</span><span class="token punctuation">{</span> gl <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> vrNew <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VRFrame</span><span class="token punctuation">(</span><span class="token punctuation">{</span> gl<span class="token punctuation">,</span> orbit <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> vrOld <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VRFrame</span><span class="token punctuation">(</span><span class="token punctuation">{</span> gl<span class="token punctuation">,</span> orbit <span class="token punctuation">}</span><span class="token punctuation">)</span>
scene<span class="token punctuation">.</span>mat<span class="token punctuation">.</span><span class="token function">setMap</span><span class="token punctuation">(</span><span class="token string">&#39;u_SampOld&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">texture</span><span class="token operator">:</span> vrOld<span class="token punctuation">.</span>texture
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>初始状态，旧VR 是没有图片的，默认画出来就是一张黑图，将其传给场景对象的u_SampOld后，便可以实现在黑暗中渐现新VR的效果。<br> 新VR 需要在加载到图片后，画出VR，再传给场景对象的u_SampNew。</p><ol start="6"><li>实例化时间轨对象</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 是否制作补间动画</span>
<span class="token keyword">let</span> tweenable <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token comment">// 补间数据</span>
<span class="token keyword">let</span> aniDt <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">ratio</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>
<span class="token comment">// 时间轨</span>
<span class="token keyword">let</span> track <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Track</span><span class="token punctuation">(</span>aniDt<span class="token punctuation">)</span>
track<span class="token punctuation">.</span>timeLen <span class="token operator">=</span> <span class="token number">1000</span>
track<span class="token punctuation">.</span>keyMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">[</span><span class="token string">&#39;ratio&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
track<span class="token punctuation">.</span><span class="token function-variable function">onEnd</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  tweenable <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ol start="7"><li>在切换图片时：</li></ol><ul><li>开启补间动画</li><li>设置新、旧VR的图片</li><li>把旧VR的纹理对象传入u_SampOld</li><li>根据VR 数据更新视点位置</li><li>根据VR 数据显示标记点</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//暂存当前的VR图像</span>
<span class="token keyword">let</span> tempImg <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token comment">// 更新VR图像</span>
<span class="token keyword">function</span> <span class="token function">updateVr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  image<span class="token punctuation">.</span>src <span class="token operator">=</span> curVr<span class="token punctuation">.</span>imgSrc
  image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//开启补间动画</span>
    tweenable <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">//时间轨起始时间</span>
    track<span class="token punctuation">.</span>start <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">//若tempImg 不为null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tempImg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 设置旧VR的图片</span>
      vrOld<span class="token punctuation">.</span>mat<span class="token punctuation">.</span><span class="token function">setMap</span><span class="token punctuation">(</span><span class="token string">&#39;u_Sampler&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">image</span><span class="token operator">:</span> tempImg <span class="token punctuation">}</span><span class="token punctuation">)</span>
      vrOld<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 把旧VR的纹理对象传入u_SampOld</span>
      scene<span class="token punctuation">.</span>mat<span class="token punctuation">.</span><span class="token function">setMap</span><span class="token punctuation">(</span><span class="token string">&#39;u_SampOld&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">texture</span><span class="token operator">:</span> vrOld<span class="token punctuation">.</span>texture
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//暂存当前图片</span>
    tempImg <span class="token operator">=</span> image
    <span class="token comment">//设置新VR的图片</span>
    vrNew<span class="token punctuation">.</span>mat<span class="token punctuation">.</span><span class="token function">setMap</span><span class="token punctuation">(</span><span class="token string">&#39;u_Sampler&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> image <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//设置相机视点</span>
    camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token operator">...</span>curVr<span class="token punctuation">.</span>eye<span class="token punctuation">)</span>
    orbit<span class="token punctuation">.</span><span class="token function">updateCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    orbit<span class="token punctuation">.</span><span class="token function">resetSpherical</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//显示当前VR的标记点</span>
    <span class="token function">showMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>将之前 Mat.js 对象的setMap 方法做下调整</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">setMap</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span>val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maps<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  val<span class="token punctuation">.</span>needUpdate <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span>val<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>maps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">=</span>val
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这样，若key在maps中存在，就合并val；若不存在，就写入val。</p><ol start="8"><li>连续渲染</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tweenable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 更新时间轨的时间</span>
    track<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 更新场景对象的插值数据</span>
    scene<span class="token punctuation">.</span>mat<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">&#39;u_Ratio&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> aniDt<span class="token punctuation">.</span>ratio
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 更新投影视图矩阵</span>
  orbit<span class="token punctuation">.</span><span class="token function">getPvMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 新VR绘图</span>
  vrNew<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 更新场景对象的u_SampNew</span>
  scene<span class="token punctuation">.</span>mat<span class="token punctuation">.</span><span class="token function">setMap</span><span class="token punctuation">(</span><span class="token string">&#39;u_SampNew&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">texture</span><span class="token operator">:</span> vrNew<span class="token punctuation">.</span>texture
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">//场景对象绘图</span>
  scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 更新标记点的canvas坐标</span>
  <span class="token function">updateMarkCp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>到目前为止，便可以实现VR场景的透明度补间动画。<br> 接下来，还可以再丰富一下补间动画效果。</p><ol start="9"><li>在透明度动画的基础上，再让旧VR做一个放大效果，给用户营造一个拉进视口的效果，使项目看起来更加走心</li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>precision mediump <span class="token keyword">float</span><span class="token punctuation">;</span>
uniform <span class="token keyword">float</span> u_Ratio<span class="token punctuation">;</span>
uniform sampler2D u_SampNew<span class="token punctuation">;</span>
uniform sampler2D u_SampOld<span class="token punctuation">;</span>
varying vec2 v_Pin<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  vec2 halfuv<span class="token operator">=</span><span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">float</span> scale<span class="token operator">=</span><span class="token number">1.0</span><span class="token operator">-</span>u_Ratio<span class="token operator">*</span><span class="token number">0.1</span><span class="token punctuation">;</span>
  vec2 pin<span class="token operator">=</span><span class="token punctuation">(</span>v_Pin<span class="token operator">-</span>halfuv<span class="token punctuation">)</span><span class="token operator">*</span>scale<span class="token operator">+</span>halfuv<span class="token punctuation">;</span>
  vec4 t1 <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span> u_SampNew<span class="token punctuation">,</span> v_Pin <span class="token punctuation">)</span><span class="token punctuation">;</span>
  vec4 t2 <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span> u_SampOld<span class="token punctuation">,</span> pin <span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl_FragColor <span class="token operator">=</span> <span class="token function">mix</span><span class="token punctuation">(</span>t2<span class="token punctuation">,</span>t1<span class="token punctuation">,</span> u_Ratio<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>放大旧VR的方法有很多，可以从模型、相机、片元着色器等方面来实现。<br> 这里就找了个比较简单的方法，在片元着色器里放大旧VR。</p><p>在片元着色器里放大旧VR 的方法，至少有两种：</p><ul><li>基于片元放大旧VR</li><li>基于UV放大旧VR</li></ul><p>基于片元放大旧VR，需要在片元着色器里知道canvas画布在gl_FragCoord 坐标系里的中心点，有点麻烦。<br> 基于UV放大旧VR，直接基于uv 坐标系的中心点(0.5,0.5) 缩小uv坐标即可，比较简单，所以就使用这个方法放大旧VR了。</p><h3 id="_3-线条的纹理映射" tabindex="-1"><a class="header-anchor" href="#_3-线条的纹理映射" aria-hidden="true">#</a> 3.线条的纹理映射</h3><p>之前在说WebGL图形的时候说过，WebGL有LINES、LINE_STRIP、LINE_LOOP 三种画线的方法。<br> 不过，三种方法只能绘制一个像素宽的线，如果要想画的是下图中粗点的公路呢？<br><img src="/visual/webgl-share/195.png" alt=""></p><p>这条公路的绘制要分两部分考虑：</p><ul><li>宽度线</li><li>纹理映射</li></ul><h4 id="_3-1认识宽度线" tabindex="-1"><a class="header-anchor" href="#_3-1认识宽度线" aria-hidden="true">#</a> 3.1认识宽度线</h4><p>当线有了宽度之后，它就不仅仅是有了宽度那么简单，因为这本质上是一个由线转面，提升了一个维度的问题。这会延伸出许多除宽度之外的其它特性。<br> 对于有宽度的线，canvas 2d 就做得很好，所以咱们先通过canvas 2d 认识一下有宽度的线的特性：</p><ul><li><p>lineWidth 定义描边的宽度，它是从路径的中心开始绘制的，内外各占宽度的一半。<br><img src="/visual/webgl-share/196.png" alt=""></p></li><li><p>lineCap 线条端点样式<br><img src="/visual/webgl-share/197.png" alt=""></p></li><li><p>lineJoin 拐角类型<br><img src="/visual/webgl-share/198.png" alt=""></p></li><li><p>miterLimit 限制尖角<br> 当lineJoin 为miter 时，若拐角过小，拐角的厚度就会过大。<br><img src="/visual/webgl-share/199.png" alt=""></p></li></ul><p>​miterLimit=1 后，可避免此问题<br><img src="/visual/webgl-share/200.png" alt=""></p><ul><li>setLineDash(segments) 虚线<br> ctx.setLineDash([ 60, 90 ])<br><img src="/visual/webgl-share/201.png" alt=""></li></ul><p>​ctx.setLineDash([ 60, 90, 120 ])<br><img src="/visual/webgl-share/202.png" alt=""></p><ul><li>lineDashOffset 虚线偏移</li></ul><p>ctx.lineDashOffset=0<br><img src="/visual/webgl-share/203.png" alt=""></p><p>​ctx.lineDashOffset=-60<br><img src="/visual/webgl-share/205.png" alt=""></p><h4 id="_3-2宽度线的绘制思路" tabindex="-1"><a class="header-anchor" href="#_3-2宽度线的绘制思路" aria-hidden="true">#</a> 3.2宽度线的绘制思路</h4><ul><li><p>着色器绘图：先用WebGL 原生方法绘制单像素的线，然后利用帧缓冲区为其描边。<br><img src="/visual/webgl-share/206.png" alt=""></p><ul><li>优点：简单快速，可以画出拐角和端点都为round 类型的线</li><li>缺点：难以控制其端点和拐角样式，无法做纹理映射，无法深度测试</li></ul></li><li><p>顶点建模，基于线条路径，向其内外两侧挤压线条。<br><img src="/visual/webgl-share/207.png" alt=""></p><ul><li>优点：可控性强，可满足各种线条特性，可做纹理映射，支持深度测试</li><li>缺点：顶点点位的计算量有点大。</li></ul></li></ul><p>因为要为宽度线贴图，所以就用顶点建模的方式绘制有宽度的线了。<br> 先用最简单的方式画一条宽度线：像canvas 2d那样，以lineCap为butt，lineJoin 为miter的方式绘制。</p><h4 id="_3-3宽度线的挤压原理" tabindex="-1"><a class="header-anchor" href="#_3-3宽度线的挤压原理" aria-hidden="true">#</a> 3.3宽度线的挤压原理</h4><p>宽度线中相邻的两条线段存在两种关系：</p><ul><li><p>相交<br><img src="/visual/webgl-share/207.png" alt=""></p></li><li><p>平行<br><img src="/visual/webgl-share/208.png" alt=""></p></li></ul><p>挤压顶点的方式有两种：</p><ul><li>垂直挤压，对应线条端点或相邻线段平行时的点。</li><li>非垂直挤压，对应相邻线段不平行时的点，即相交线段的拐点。</li></ul><h4 id="_3-4垂直挤压点" tabindex="-1"><a class="header-anchor" href="#_3-4垂直挤压点" aria-hidden="true">#</a> 3.4垂直挤压点</h4><p>以下图为例：<br><img src="/visual/webgl-share/208.png" alt=""></p><p><code>已知</code>：</p><ul><li>点A、点B</li><li>线条宽度为lineWidth</li><li>A1、A2是自点A 沿AB方向垂直挤压出的点</li></ul><p><code>求</code>：A1、A2</p><p><code>解</code>：</p><p>计算线条宽度的一半h：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>h<span class="token operator">=</span>lineWidth<span class="token operator">/</span><span class="token number">2</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>由点A、点B计算向量AB：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">AB</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token operator">=</span><span class="token constant">B</span><span class="token operator">-</span><span class="token constant">A</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>将向量AB逆时针旋转90°，设置长度为h，得点A1：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">A1</span><span class="token operator">=</span>h<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">-</span>y<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token operator">/</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token operator">-</span>y<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token operator">|</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>将向量AB顺时针旋转90°，设置长度为h，得点A2：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">A2</span><span class="token operator">=</span>h<span class="token operator">*</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span><span class="token operator">-</span>x<span class="token punctuation">)</span><span class="token operator">/</span><span class="token operator">|</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span><span class="token operator">-</span>x<span class="token punctuation">)</span><span class="token operator">|</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>挤压端点C 后的点C1、C2 亦是同理。<br> 至于挤压中间点B 后的B1、B2，若点B相邻的线段平行，其计算方法亦是同理。<br> AB是否平行于BC的判断方法：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">atan2</span><span class="token punctuation">(</span><span class="token constant">AB</span><span class="token punctuation">.</span>y<span class="token punctuation">,</span><span class="token constant">AB</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token operator">-</span>Math<span class="token punctuation">.</span><span class="token function">atan2</span><span class="token punctuation">(</span><span class="token constant">BC</span><span class="token punctuation">.</span>y<span class="token punctuation">,</span><span class="token constant">BC</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">%</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h4 id="_3-4计算拐点" tabindex="-1"><a class="header-anchor" href="#_3-4计算拐点" aria-hidden="true">#</a> 3.4计算拐点</h4><p><img src="/visual/webgl-share/209.png" alt=""></p><p><code>已知</code>：</p><ul><li>点A、点B、点C</li><li>线条宽度为lineWidth</li><li>AB、BC 不平行</li></ul><p><code>求</code>：拐点B1、B2</p><p><code>思路</code>：</p><p>求拐点的本质，就是求两条直线的的交点。 求直线交点的方法有很多，高中数学有一个用直线一般式求交点的方法，我们也可以用向量推导。</p><p><code>解</code>：</p><p>由已知条件可知：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">BD</span>∥<span class="token constant">EB2</span>
<span class="token constant">BE</span>∥<span class="token constant">DB2</span>
<span class="token operator">|</span><span class="token constant">BF</span><span class="token operator">|=</span><span class="token operator">|</span><span class="token constant">BG</span><span class="token operator">|</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>所以</code>：</p><p>BEB2D 是等边平行四边形。</p><p>计算向量BD的单位向量d：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>d<span class="token operator">=</span><span class="token constant">AB</span><span class="token operator">/</span><span class="token operator">|</span><span class="token constant">AB</span><span class="token operator">|</span> 
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>计算向量BE的单位向量e：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>e<span class="token operator">=</span><span class="token constant">CB</span><span class="token operator">/</span><span class="token operator">|</span><span class="token constant">CB</span><span class="token operator">|</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>由等边平行四边形定理，可求得BB2 的单位向量b：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>b<span class="token operator">=</span><span class="token punctuation">(</span>d<span class="token operator">+</span>e<span class="token punctuation">)</span><span class="token operator">/</span><span class="token operator">|</span>d<span class="token operator">+</span>e<span class="token operator">|</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>接下来，只要求得BB2的长度，便可知道点B2。</p><p>由向量的点积公式可知：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>cos∠<span class="token constant">B2BG</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token constant">BG</span>·b<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token operator">|</span><span class="token constant">BG</span><span class="token operator">|</span><span class="token operator">*</span><span class="token operator">|</span>b<span class="token operator">|</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p><code>因为</code>：</p><p>b是单位向量</p><p><code>所以</code>：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>cos∠<span class="token constant">B2BG</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token constant">BG</span>·b<span class="token punctuation">)</span><span class="token operator">/</span><span class="token operator">|</span><span class="token constant">BG</span><span class="token operator">|</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>由余弦公式可知：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>cos∠<span class="token constant">B2BG</span><span class="token operator">=</span><span class="token operator">|</span><span class="token constant">BG</span><span class="token operator">|</span><span class="token operator">/</span><span class="token operator">|</span><span class="token constant">BB2</span><span class="token operator">|</span>
<span class="token operator">|</span><span class="token constant">BB2</span><span class="token operator">|=</span><span class="token operator">|</span><span class="token constant">BG</span><span class="token operator">|</span><span class="token operator">/</span>cos∠<span class="token constant">B2BG</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>所以</code>：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">BB2</span><span class="token operator">=</span>b<span class="token operator">*</span><span class="token operator">|</span><span class="token constant">BB2</span><span class="token operator">|</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>所以：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">B2</span><span class="token operator">=</span><span class="token constant">BB2</span><span class="token operator">+</span><span class="token constant">B</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>知道了B2后，B1也就好求了：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">B1</span><span class="token operator">=</span><span class="token operator">-</span><span class="token constant">BB2</span><span class="token operator">+</span><span class="token constant">B</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>这便是用向量推导拐点的方法。</p><p>对于用直线的一般式求交点的方法，<a href="http://yxyy.name/blog/md.html?ossName=162765212208629481006223312756.md&amp;title=%E6%BC%AB%E8%B0%88%E7%9B%B4%E7%BA%BF%E4%B9%8B%E7%82%B9%E6%96%9C%E5%BC%8F%E5%92%8C%E4%B8%80%E8%88%AC%E5%BC%8F" target="_blank" rel="noopener noreferrer">相关文章<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</p><h4 id="_3-5绘制宽度线" tabindex="-1"><a class="header-anchor" href="#_3-5绘制宽度线" aria-hidden="true">#</a> 3.5绘制宽度线</h4><ol><li>建立一个BoldLine 对象</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Vector2<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span>
<span class="token comment">/*
属性：
  points:线条节点,二维，[Vector2,Vector2,……]
  lineWidth：线宽
  vertices：顶点集合
  normals：法线集合
  indexes：顶点索引集合
  uv：uv坐标集合
*/</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">BoldLine</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">points<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lineWidth<span class="token operator">=</span><span class="token number">1</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>points<span class="token operator">=</span>points
    <span class="token keyword">this</span><span class="token punctuation">.</span>lineWidth<span class="token operator">=</span>lineWidth
    <span class="token keyword">this</span><span class="token punctuation">.</span>vertices<span class="token operator">=</span><span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>normals<span class="token operator">=</span><span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>indexes <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>uv <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> points<span class="token punctuation">,</span><span class="token literal-property property">lineWidth</span><span class="token operator">:</span>h <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> len <span class="token operator">=</span> points<span class="token punctuation">.</span>length
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
    
    <span class="token comment">// 挤压线条，获取顶点</span>
    <span class="token keyword">const</span> extrudePoints<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">extrude</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 顶点集合</span>
    <span class="token keyword">const</span> vertices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 顶点索引</span>
    <span class="token keyword">const</span> indexes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    
    <span class="token comment">// 以线段挤压出的四边形为单位，构建顶点集合、顶点索引</span>
    <span class="token keyword">const</span> len1 <span class="token operator">=</span> points<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len1<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//四边形的4个顶点</span>
      <span class="token keyword">const</span> pi<span class="token operator">=</span>i <span class="token operator">*</span> <span class="token number">2</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token constant">A1</span><span class="token punctuation">,</span> <span class="token constant">A2</span><span class="token punctuation">,</span> <span class="token constant">B1</span><span class="token punctuation">,</span> <span class="token constant">B2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        extrudePoints<span class="token punctuation">[</span>pi<span class="token punctuation">]</span><span class="token punctuation">,</span>
        extrudePoints<span class="token punctuation">[</span>pi<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        extrudePoints<span class="token punctuation">[</span>pi<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        extrudePoints<span class="token punctuation">[</span>pi<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span>
      vertices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
        <span class="token operator">...</span><span class="token constant">A1</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token constant">A2</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token constant">B1</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token constant">B2</span>
      <span class="token punctuation">)</span>
      <span class="token comment">// 顶点索引</span>
      <span class="token keyword">const</span> A1i <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">4</span>
      <span class="token keyword">const</span> A2i <span class="token operator">=</span> A1i<span class="token operator">+</span><span class="token number">1</span>
      <span class="token keyword">const</span> B1i <span class="token operator">=</span> A1i<span class="token operator">+</span><span class="token number">2</span>
      <span class="token keyword">const</span> B2i <span class="token operator">=</span> A1i <span class="token operator">+</span> <span class="token number">3</span>
      indexes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
        A1i<span class="token punctuation">,</span>A2i<span class="token punctuation">,</span>B1i<span class="token punctuation">,</span>
        B1i<span class="token punctuation">,</span>A2i<span class="token punctuation">,</span>B2i
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>vertices<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>vertices<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>indexes<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Uint16Array</span><span class="token punctuation">(</span>indexes<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 挤压线条</span>
  <span class="token function">extrude</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> points <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">//线宽的一半</span>
    <span class="token keyword">const</span> h <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lineWidth <span class="token operator">/</span> <span class="token number">2</span>
    <span class="token comment">//顶点集合，挤压起始点置入其中</span>
    <span class="token keyword">const</span> extrudePoints <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">verticalPoint</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>points<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>h<span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
    <span class="token comment">// 挤压线条内部点，置入extrudePoints</span>
    <span class="token keyword">const</span> len1<span class="token operator">=</span>points<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">const</span> len2<span class="token operator">=</span>len1<span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len2<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 三个点,两条线</span>
      <span class="token keyword">const</span> <span class="token constant">A</span><span class="token operator">=</span>points<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">const</span> <span class="token constant">B</span><span class="token operator">=</span>points<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token keyword">const</span> <span class="token constant">C</span> <span class="token operator">=</span> points<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span>
      <span class="token comment">// 两条线是否相交</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">intersect</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">,</span><span class="token constant">B</span><span class="token punctuation">,</span><span class="token constant">C</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        extrudePoints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">interPoint</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        extrudePoints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">verticalPoint</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 挤压最后一个点</span>
    extrudePoints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">verticalPoint</span><span class="token punctuation">(</span>
      points<span class="token punctuation">[</span>len2<span class="token punctuation">]</span><span class="token punctuation">,</span> points<span class="token punctuation">[</span>len1<span class="token punctuation">]</span><span class="token punctuation">,</span> h<span class="token punctuation">,</span> points<span class="token punctuation">[</span>len1<span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> extrudePoints
  <span class="token punctuation">}</span>

  <span class="token comment">// 判断两条直线是否相交</span>
  <span class="token function">intersect</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">A</span><span class="token punctuation">,</span><span class="token constant">B</span><span class="token punctuation">,</span><span class="token constant">C</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> angAB<span class="token operator">=</span><span class="token constant">B</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">angle</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> angBC <span class="token operator">=</span> <span class="token constant">C</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">angle</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>angAB<span class="token operator">-</span>angBC<span class="token punctuation">)</span><span class="token operator">%</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//垂直挤压点</span>
  <span class="token function">verticalPoint</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">A</span><span class="token punctuation">,</span><span class="token constant">B</span><span class="token punctuation">,</span>h<span class="token punctuation">,</span><span class="token constant">M</span><span class="token operator">=</span><span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>x<span class="token punctuation">,</span>y<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token constant">B</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
      <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token operator">-</span>y<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">M</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span><span class="token operator">-</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">M</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 拐点</span>
  <span class="token function">interPoint</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token punctuation">,</span> h</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> d<span class="token operator">=</span><span class="token constant">B</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> e <span class="token operator">=</span> <span class="token constant">B</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token constant">C</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> b <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token constant">BG</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token operator">-</span>d<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span>
    <span class="token keyword">const</span> BGLen<span class="token operator">=</span><span class="token constant">BG</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> cos <span class="token operator">=</span> <span class="token constant">BG</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">/</span> BGLen
    <span class="token keyword">const</span> <span class="token constant">BB2</span> <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span>BGLen <span class="token operator">/</span> cos<span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token constant">BB1</span> <span class="token operator">=</span> <span class="token constant">BB2</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">negate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
      <span class="token constant">BB1</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token constant">BB2</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br></div></div><ol start="2"><li>绘制宽度线</li></ol><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vs<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    attribute vec4 a_Position<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fs<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    precision mediump float<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> createProgram<span class="token punctuation">,</span> imgPromise <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./lv/Utils.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> 
    Matrix4<span class="token punctuation">,</span> 
    PerspectiveCamera<span class="token punctuation">,</span> 
    Vector3<span class="token punctuation">,</span> 
    Vector2 
  <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> OrbitControls <span class="token keyword">from</span> <span class="token string">&#39;./jsm/OrbitControls.js&#39;</span>
  <span class="token keyword">import</span> Mat <span class="token keyword">from</span> <span class="token string">&#39;./lv/Mat.js&#39;</span>
  <span class="token keyword">import</span> Geo <span class="token keyword">from</span> <span class="token string">&#39;./lv/Geo.js&#39;</span>
  <span class="token keyword">import</span> Obj3D <span class="token keyword">from</span> <span class="token string">&#39;./lv/Obj3D.js&#39;</span>
  <span class="token keyword">import</span> Scene <span class="token keyword">from</span> <span class="token string">&#39;./lv/Scene.js&#39;</span>
  <span class="token keyword">import</span> BoldLine <span class="token keyword">from</span> <span class="token string">&#39;./lv/BoldLine.js&#39;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">900</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">900</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 场景</span>
  <span class="token keyword">const</span> scene <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">{</span> gl <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 注册程序对象</span>
  scene<span class="token punctuation">.</span><span class="token function">registerProgram</span><span class="token punctuation">(</span>
    <span class="token string">&#39;line&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>
        gl<span class="token punctuation">,</span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">attributeNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">const</span> mat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;line&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">&#39;TRIANGLES&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> line <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BoldLine</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> geo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">array</span><span class="token operator">:</span> line<span class="token punctuation">.</span>vertices<span class="token punctuation">,</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">2</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> line<span class="token punctuation">.</span>indexes
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span> geo<span class="token punctuation">,</span> mat <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>	
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br></div></div><p>效果如下：</p><p><img src="/visual/webgl-share/210.png" alt=""></p><h4 id="_3-6宽度线贴图思路" tabindex="-1"><a class="header-anchor" href="#_3-6宽度线贴图思路" aria-hidden="true">#</a> 3.6宽度线贴图思路</h4><p><img src="/visual/webgl-share/211.png" alt=""></p><ol><li>以线段挤出的四边形为单位进行贴图。</li><li>贴图的时候，为了方便做纹理映射，可以先让每一个四边形躺平，再做纹理映射。</li><li>为了避免贴图拉伸，可基于线宽，设置贴图在u向的reapeat 系数。</li></ol><p>举个例子。</p><p><code>已知</code>：</p><ul><li>贴图是一个正方形图片。</li><li>线宽为h</li></ul><p><code>求</code>：则点B1、B2、C1、C2所对应的uv坐标</p><p><code>解</code>：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">B1</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token constant">B12</span><span class="token punctuation">.</span>x<span class="token operator">/</span>h<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token constant">B2</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token constant">B22</span><span class="token punctuation">.</span>x<span class="token operator">/</span>h<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token constant">C1</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token constant">C12</span><span class="token punctuation">.</span>x<span class="token operator">/</span>h<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token constant">C2</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token constant">C22</span><span class="token punctuation">.</span>x<span class="token operator">/</span>h<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="_3-7宽度线贴图代码" tabindex="-1"><a class="header-anchor" href="#_3-7宽度线贴图代码" aria-hidden="true">#</a> 3.7宽度线贴图代码</h4><ol><li>在BoldLine.js 中计算uv坐标。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> points<span class="token punctuation">,</span><span class="token literal-property property">lineWidth</span><span class="token operator">:</span>h <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
  <span class="token keyword">const</span> len <span class="token operator">=</span> points<span class="token punctuation">.</span>length
  <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>

  <span class="token comment">// 挤压线条，获取顶点</span>
  <span class="token keyword">const</span> extrudePoints<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">extrude</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// 顶点集合</span>
  <span class="token keyword">const</span> vertices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// 顶点索引</span>
  <span class="token keyword">const</span> indexes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// uv 坐标</span>
  <span class="token keyword">const</span> uv<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token comment">// 以线段挤压成的四边形为单位，构建顶点集合、顶点索引、uv</span>
  <span class="token keyword">const</span> len1 <span class="token operator">=</span> points<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len1<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//四边形的4个顶点</span>
    <span class="token keyword">const</span> pi<span class="token operator">=</span>i <span class="token operator">*</span> <span class="token number">2</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token constant">A1</span><span class="token punctuation">,</span> <span class="token constant">A2</span><span class="token punctuation">,</span> <span class="token constant">B1</span><span class="token punctuation">,</span> <span class="token constant">B2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
      extrudePoints<span class="token punctuation">[</span>pi<span class="token punctuation">]</span><span class="token punctuation">,</span>
      extrudePoints<span class="token punctuation">[</span>pi<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      extrudePoints<span class="token punctuation">[</span>pi<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      extrudePoints<span class="token punctuation">[</span>pi<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
    vertices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
      <span class="token operator">...</span><span class="token constant">A1</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token constant">A2</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token constant">B1</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token constant">B2</span>
    <span class="token punctuation">)</span>
    <span class="token comment">// 顶点索引</span>
    <span class="token keyword">const</span> A1i <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">4</span>
    <span class="token keyword">const</span> A2i <span class="token operator">=</span> A1i<span class="token operator">+</span><span class="token number">1</span>
    <span class="token keyword">const</span> B1i <span class="token operator">=</span> A1i<span class="token operator">+</span><span class="token number">2</span>
    <span class="token keyword">const</span> B2i <span class="token operator">=</span> A1i <span class="token operator">+</span> <span class="token number">3</span>
    indexes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
      A1i<span class="token punctuation">,</span>A2i<span class="token punctuation">,</span>B1i<span class="token punctuation">,</span>
      B1i<span class="token punctuation">,</span>A2i<span class="token punctuation">,</span>B2i
    <span class="token punctuation">)</span>
    <span class="token comment">//逆向旋转四边形</span>
    <span class="token keyword">const</span> ang <span class="token operator">=</span> <span class="token operator">-</span><span class="token constant">B1</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token constant">A1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">angle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token constant">O</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>lb<span class="token punctuation">,</span> rt<span class="token punctuation">,</span> rb<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token constant">A2</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token constant">A1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rotateAround</span><span class="token punctuation">(</span><span class="token constant">O</span><span class="token punctuation">,</span>ang<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token constant">B1</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token constant">A1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rotateAround</span><span class="token punctuation">(</span><span class="token constant">O</span><span class="token punctuation">,</span>ang<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token constant">B2</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token constant">A1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rotateAround</span><span class="token punctuation">(</span><span class="token constant">O</span><span class="token punctuation">,</span>ang<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
    uv<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>        <span class="token comment">//A1</span>
      lb<span class="token punctuation">.</span>x <span class="token operator">/</span> h<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//A2</span>
      rt<span class="token punctuation">.</span>x <span class="token operator">/</span> h<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//B1</span>
      rb<span class="token punctuation">.</span>x <span class="token operator">/</span> h<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//B2</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>vertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>vertices<span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>uv<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>uv<span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>indexes<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Uint16Array</span><span class="token punctuation">(</span>indexes<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><ol start="2"><li>绘制宽度线</li></ol><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vs<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    attribute vec4 a_Position<span class="token punctuation">;</span>
    attribute vec2 a_Pin<span class="token punctuation">;</span>
    varying vec2 v_Pin<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position <span class="token operator">=</span> a_Position<span class="token punctuation">;</span>
      v_Pin<span class="token operator">=</span>a_Pin<span class="token punctuation">;</span>
      gl_PointSize<span class="token operator">=</span><span class="token number">10.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fs<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    precision mediump float<span class="token punctuation">;</span>
    uniform sampler2D u_Sampler<span class="token punctuation">;</span>
    varying vec2 v_Pin<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_FragColor<span class="token operator">=</span><span class="token function">texture2D</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span>v_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> createProgram<span class="token punctuation">,</span> imgPromise <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./lv/Utils.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> 
    Matrix4<span class="token punctuation">,</span> 
    PerspectiveCamera<span class="token punctuation">,</span> 
    Vector3<span class="token punctuation">,</span> 
    Vector2 
  <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;https://unpkg.com/three/build/three.module.js&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> OrbitControls <span class="token keyword">from</span> <span class="token string">&#39;./jsm/OrbitControls.js&#39;</span>
  <span class="token keyword">import</span> Mat <span class="token keyword">from</span> <span class="token string">&#39;./lv/Mat.js&#39;</span>
  <span class="token keyword">import</span> Geo <span class="token keyword">from</span> <span class="token string">&#39;./lv/Geo.js&#39;</span>
  <span class="token keyword">import</span> Obj3D <span class="token keyword">from</span> <span class="token string">&#39;./lv/Obj3D.js&#39;</span>
  <span class="token keyword">import</span> Scene <span class="token keyword">from</span> <span class="token string">&#39;./lv/Scene.js&#39;</span>
  <span class="token keyword">import</span> BoldLine <span class="token keyword">from</span> <span class="token string">&#39;./lv/BoldLine.js&#39;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">900</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">900</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;webgl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 场景</span>
  <span class="token keyword">const</span> scene <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span><span class="token punctuation">{</span> gl <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 注册程序对象</span>
  scene<span class="token punctuation">.</span><span class="token function">registerProgram</span><span class="token punctuation">(</span>
    <span class="token string">&#39;line&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>
        gl<span class="token punctuation">,</span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;vs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">attributeNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;a_Position&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;a_Pin&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">uniformNames</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;u_Sampler&#39;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">const</span> mat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">program</span><span class="token operator">:</span> <span class="token string">&#39;line&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">&#39;TRIANGLES&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> line <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BoldLine</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Vector2</span><span class="token punctuation">(</span><span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> geo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Geo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">array</span><span class="token operator">:</span> line<span class="token punctuation">.</span>vertices<span class="token punctuation">,</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">2</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">a_Pin</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">array</span><span class="token operator">:</span> line<span class="token punctuation">.</span>uv<span class="token punctuation">,</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">2</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">array</span><span class="token operator">:</span> line<span class="token punctuation">.</span>indexes
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Obj3D</span><span class="token punctuation">(</span><span class="token punctuation">{</span> geo<span class="token punctuation">,</span> mat <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./images/road.jpg</span><span class="token template-punctuation string">`</span></span>
  image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mat<span class="token punctuation">.</span><span class="token function">setMap</span><span class="token punctuation">(</span><span class="token string">&#39;u_Sampler&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      image
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    scene<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br></div></div><ol start="3"><li>对Mat.js 对象里的updateMap() 方法稍作调整，判断一下要更新的贴图里有没有纹理对象texture，若没有，就新建一个。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">updateMap</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> map<span class="token punctuation">,</span> ind</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    format <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span>
    image<span class="token punctuation">,</span>
    wrapS<span class="token punctuation">,</span>
    wrapT<span class="token punctuation">,</span>
    magFilter<span class="token punctuation">,</span>
    minFilter<span class="token punctuation">,</span>
    texture
  <span class="token punctuation">}</span> <span class="token operator">=</span> map
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>texture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    map<span class="token punctuation">.</span>texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">TEXTURE</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ind<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> map<span class="token punctuation">.</span>texture<span class="token punctuation">)</span>
  ……
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>效果如下：</p><p><img src="/visual/webgl-share/195.png" alt=""></p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: wangdouliang@zzltop.com">wangdouliang</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/visual/assets/app.6795915a.js" defer></script>
  </body>
</html>
