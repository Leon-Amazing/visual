<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.34">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="logo.png"><title>GLSL ES 实践 | 数据可视化</title><meta name="description" content="Leon's library">
    <link rel="modulepreload" href="/visual/assets/app.6795915a.js"><link rel="modulepreload" href="/visual/assets/GLSL-ES-practice.html.f4976ea2.js"><link rel="modulepreload" href="/visual/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/visual/assets/GLSL-ES-practice.html.77400944.js">
    <link rel="stylesheet" href="/visual/assets/style.14b7ee11.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/visual/" class=""><img class="logo" src="/visual/logo.png" alt="数据可视化"><span class="site-name can-hide">数据可视化</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/visual/computer/ComputerGraphics.md" class="" aria-label="计算机图形学"><!--[--><!--]--> 计算机图形学 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="WebGL"><span class="title">WebGL</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="WebGL"><span class="title">WebGL</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>WebGL</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/visual/webgl/WebGL-share.md" class="" aria-label="WebGL基础"><!--[--><!--]--> WebGL基础 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/visual/webgl/WebGL-practice.md" class="" aria-label="WebGL实践"><!--[--><!--]--> WebGL实践 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>GLSL ES</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/visual/webgl/GLSL-ES-basic.md" class="" aria-label="GLSL ES基础"><!--[--><!--]--> GLSL ES基础 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/visual/webgl/GLSL-ES-practice.md" class="" aria-label="GLSL ES实践"><!--[--><!--]--> GLSL ES实践 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a href="/visual/threejs/index.md" class="" aria-label="ThreeJS"><!--[--><!--]--> ThreeJS <!--[--><!--]--></a></div><div class="navbar-item"><a href="/visual/echarts/index.md" class="" aria-label="Echarts"><!--[--><!--]--> Echarts <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="Search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/visual/computer/ComputerGraphics.md" class="" aria-label="计算机图形学"><!--[--><!--]--> 计算机图形学 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="WebGL"><span class="title">WebGL</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="WebGL"><span class="title">WebGL</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>WebGL</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/visual/webgl/WebGL-share.md" class="" aria-label="WebGL基础"><!--[--><!--]--> WebGL基础 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/visual/webgl/WebGL-practice.md" class="" aria-label="WebGL实践"><!--[--><!--]--> WebGL实践 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>GLSL ES</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/visual/webgl/GLSL-ES-basic.md" class="" aria-label="GLSL ES基础"><!--[--><!--]--> GLSL ES基础 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/visual/webgl/GLSL-ES-practice.md" class="" aria-label="GLSL ES实践"><!--[--><!--]--> GLSL ES实践 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a href="/visual/threejs/index.md" class="" aria-label="ThreeJS"><!--[--><!--]--> ThreeJS <!--[--><!--]--></a></div><div class="navbar-item"><a href="/visual/echarts/index.md" class="" aria-label="Echarts"><!--[--><!--]--> Echarts <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">GLSL ES 实践 <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/GLSL-ES-practice.html#一、渐变" class="router-link-active router-link-exact-active sidebar-item" aria-label="一、渐变"><!--[--><!--]--> 一、渐变 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/GLSL-ES-practice.html#_1-渐变的画布" class="router-link-active router-link-exact-active sidebar-item" aria-label="1-渐变的画布"><!--[--><!--]--> 1-渐变的画布 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/GLSL-ES-practice.html#_2-线性渐变对象" class="router-link-active router-link-exact-active sidebar-item" aria-label="2-线性渐变对象"><!--[--><!--]--> 2-线性渐变对象 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/GLSL-ES-practice.html#_3-多节点线性渐变" class="router-link-active router-link-exact-active sidebar-item" aria-label="3-多节点线性渐变"><!--[--><!--]--> 3-多节点线性渐变 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/GLSL-ES-practice.html#_4-用-js-向片元着色器传递渐变数据" class="router-link-active router-link-exact-active sidebar-item" aria-label="4-用 js 向片元着色器传递渐变数据"><!--[--><!--]--> 4-用 js 向片元着色器传递渐变数据 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/GLSL-ES-practice.html#_5-优化-js-中的节点数据" class="router-link-active router-link-exact-active sidebar-item" aria-label="5-优化 js 中的节点数据"><!--[--><!--]--> 5-优化 js 中的节点数据 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/GLSL-ES-practice.html#_6-径向渐变" class="router-link-active router-link-exact-active sidebar-item" aria-label="6-径向渐变"><!--[--><!--]--> 6-径向渐变 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/GLSL-ES-practice.html#_7-极坐标渐变" class="router-link-active router-link-exact-active sidebar-item" aria-label="7-极坐标渐变"><!--[--><!--]--> 7-极坐标渐变 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/GLSL-ES-practice.html#_8-三点渐变" class="router-link-active router-link-exact-active sidebar-item" aria-label="8-三点渐变"><!--[--><!--]--> 8-三点渐变 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/GLSL-ES-practice.html#二、杂色" class="router-link-active router-link-exact-active sidebar-item" aria-label="二、杂色"><!--[--><!--]--> 二、杂色 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/GLSL-ES-practice.html#_1-杂色原理" class="router-link-active router-link-exact-active sidebar-item" aria-label="1-杂色原理"><!--[--><!--]--> 1-杂色原理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/GLSL-ES-practice.html#_2-肌理" class="router-link-active router-link-exact-active sidebar-item" aria-label="2-肌理"><!--[--><!--]--> 2-肌理 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/GLSL-ES-practice.html#三、极坐标" class="router-link-active router-link-exact-active sidebar-item" aria-label="三、极坐标"><!--[--><!--]--> 三、极坐标 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/visual/webgl/GLSL-ES-practice.html#_1-极坐标的基本概念" class="router-link-active router-link-exact-active sidebar-item" aria-label="1-极坐标的基本概念"><!--[--><!--]--> 1-极坐标的基本概念 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/GLSL-ES-practice.html#_2-直角坐标系" class="router-link-active router-link-exact-active sidebar-item" aria-label="2-直角坐标系"><!--[--><!--]--> 2-直角坐标系 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/GLSL-ES-practice.html#_3-极角与-x-轴的映射" class="router-link-active router-link-exact-active sidebar-item" aria-label="3-极角与 x 轴的映射"><!--[--><!--]--> 3-极角与 x 轴的映射 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/visual/webgl/GLSL-ES-practice.html#_4-全景图的极坐标扭曲" class="router-link-active router-link-exact-active sidebar-item" aria-label="4-全景图的极坐标扭曲"><!--[--><!--]--> 4-全景图的极坐标扭曲 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/visual/webgl/GLSL-ES-practice.html#综合案例-磨砂金属按钮" class="router-link-active router-link-exact-active sidebar-item" aria-label="综合案例-磨砂金属按钮"><!--[--><!--]--> 综合案例-磨砂金属按钮 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="glsl-es-实践" tabindex="-1"><a class="header-anchor" href="#glsl-es-实践" aria-hidden="true">#</a> GLSL ES 实践</h1><h2 id="一、渐变" tabindex="-1"><a class="header-anchor" href="#一、渐变" aria-hidden="true">#</a> 一、渐变</h2><h3 id="_1-渐变的画布" tabindex="-1"><a class="header-anchor" href="#_1-渐变的画布" aria-hidden="true">#</a> 1-渐变的画布</h3><p>画一个渐变的画布，其步骤如下：</p><p>1.绘制充满 canvas 的矩形，并向片元着色传递 canvas 画布的尺寸。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>const source = new Float32Array(<span class="token punctuation">[</span>
    <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">-1</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">-1</span>
<span class="token punctuation">]</span>);

const rect = new Poly(<span class="token punctuation">{</span>
  gl<span class="token punctuation">,</span>
  source<span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token string">&quot;TRIANGLE_STRIP&quot;</span><span class="token punctuation">,</span>
  attributes<span class="token operator">:</span> <span class="token punctuation">{</span>
    a_Position<span class="token operator">:</span> <span class="token punctuation">{</span>
      size<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      index<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  uniforms<span class="token operator">:</span> <span class="token punctuation">{</span>
    u_CanvasSize<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&quot;uniform2fv&quot;</span><span class="token punctuation">,</span>
      value<span class="token operator">:</span> <span class="token punctuation">[</span>canvas.width<span class="token punctuation">,</span> canvas.height<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>);

gl.clear(gl.COLOR_BUFFER_BIT);
rect.draw();
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>上面的 Poly 之前在纹理部分已经说过。</p><p>a_Position 是 attribute 类型的顶点位置。</p><p>u_CanvasSize 是 uniform 类型的画布尺寸。</p><p>2.顶点着色器</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-vertex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  attribute vec4 a_Position<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position<span class="token operator">=</span>a_Position<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>3.片元着色器</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform vec2 u_CanvasSize<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    gl_FragColor<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span>
      gl_FragCoord<span class="token punctuation">.</span>x<span class="token operator">/</span>u_CanvasSize<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
      gl_FragCoord<span class="token punctuation">.</span>y<span class="token operator">/</span>u_CanvasSize<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
      <span class="token number">0.8</span><span class="token punctuation">,</span>
      <span class="token number">1</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>上面的 gl_FragCoord 是当前片元在 canvas 画布中的像素位，其坐标系和 canvas 画布的坐标系类似，其坐标基底的两个分量都是一个像素的宽和高。</p><p>只不过 FragCoord 坐标原点在左下角，y 轴朝上，效果如下：</p><p><img src="/visual/glsl-es/1.jpg" alt=""></p><h3 id="_2-线性渐变对象" tabindex="-1"><a class="header-anchor" href="#_2-线性渐变对象" aria-hidden="true">#</a> 2-线性渐变对象</h3><p>canvas 2d 在绘制线性渐变图形的时候，需要先建立一个线性渐变对象。</p><p>线性渐变对象具备一个起点、一个终点，用于限定渐变范围。</p><p>线性渐变对象中具备多个渐变节点，每个渐变节点都有以下属性：</p><ul><li>节点颜色</li><li>节点位置 ，[0,1] 之间</li></ul><p>这里简化一下，只给起点和终点位置设置两个颜色节点。</p><p>1.建立矩形对象</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> rect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  gl<span class="token punctuation">,</span>
  source<span class="token punctuation">,</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;TRIANGLE_STRIP&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">uniforms</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">u_Start</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniform2fv&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">[</span>canvas<span class="token punctuation">.</span>width <span class="token operator">*</span> <span class="token number">0.25</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height <span class="token operator">*</span> <span class="token number">0.75</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">u_End</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniform2fv&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">[</span>canvas<span class="token punctuation">.</span>width <span class="token operator">*</span> <span class="token number">0.75</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height <span class="token operator">*</span> <span class="token number">0.25</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">u_Color0</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniform4fv&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">u_Color1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniform4fv&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>uniforms 中变量的意思：</p><ul><li><p>u_Start 起始点</p></li><li><p>u_End 终点</p></li><li><p>u_Color0 对应起点的颜色</p></li><li><p>u_Color1 对应终点的颜色</p><p>2.片元着色器</p></li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>precision mediump <span class="token keyword">float</span><span class="token punctuation">;</span>

uniform vec4 u_Color0<span class="token punctuation">;</span>
uniform vec4 u_Color1<span class="token punctuation">;</span>
vec4 c01<span class="token operator">=</span>u_Color1<span class="token operator">-</span>u_Color0<span class="token punctuation">;</span>

uniform vec2 u_Start<span class="token punctuation">;</span>
uniform vec2 u_End<span class="token punctuation">;</span>
vec2 se<span class="token operator">=</span>u_End<span class="token operator">-</span>u_Start<span class="token punctuation">;</span>
<span class="token keyword">float</span> seLen<span class="token operator">=</span><span class="token function">length</span><span class="token punctuation">(</span>se<span class="token punctuation">)</span><span class="token punctuation">;</span>
vec2 normal<span class="token operator">=</span><span class="token function">normalize</span><span class="token punctuation">(</span>se<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec2 sf<span class="token operator">=</span><span class="token function">vec2</span><span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">)</span><span class="token operator">-</span>u_Start<span class="token punctuation">;</span>
    <span class="token keyword">float</span> fsLen<span class="token operator">=</span><span class="token function">clamp</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>sf<span class="token punctuation">,</span>normal<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>seLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> ratio<span class="token operator">=</span>fsLen<span class="token operator">/</span>seLen<span class="token punctuation">;</span>
    gl_FragColor<span class="token operator">=</span>u_Color0<span class="token operator">+</span>c01<span class="token operator">*</span>ratio<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>效果如下：</p><p><img src="/visual/glsl-es/1.png" alt=""></p><p>上面变量的示意如下：</p><p><img src="/visual/glsl-es/2.png" alt=""></p><p>其原理就是获取当前片元在起点 u_Start 和终点 u_End 间的距离比 ratio，然后将此距离比作为颜色比，获取其在起始颜色 u_Color0 和结束颜色 u_Color1 间的颜色值。</p><h3 id="_3-多节点线性渐变" tabindex="-1"><a class="header-anchor" href="#_3-多节点线性渐变" aria-hidden="true">#</a> 3-多节点线性渐变</h3><p>上面说了，线性渐变对象中具备多个渐变节点，每个渐变节点都有以下属性：</p><ul><li>节点颜色</li><li>节点位置 ，[0,1] 之间</li></ul><p>接下来就来架构一下这个逻辑。</p><p>先把节点数据在片元着色器里写死，后面再考虑用 js 传递数据。</p><p>1.声明渐变的基础数据。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//起始位</span>
vec2 u_Start<span class="token operator">=</span><span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//结束位</span>
vec2 u_End<span class="token operator">=</span><span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">700</span><span class="token punctuation">,</span><span class="token number">700</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//节点颜色集合</span>
vec4 colors<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">//节点位置集合</span>
float ratios<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>2.基于渐变起点和结束点计算向量、向量长度和单位向量。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//终点减起点向量</span>
vec2 se<span class="token operator">=</span>u_End<span class="token operator">-</span>u_Start<span class="token punctuation">;</span>
<span class="token comment">//长度</span>
float seLen<span class="token operator">=</span><span class="token function">length</span><span class="token punctuation">(</span>se<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//单位向量</span>
vec2 se1<span class="token operator">=</span><span class="token function">normalize</span><span class="token punctuation">(</span>se<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>3.在 main 函数体中填充颜色集合和节点位置集合，然后获取片元颜色。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    colors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    colors<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    colors<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ratios<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">;</span>
    ratios<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">;</span>
    ratios<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">;</span>
    gl_FragColor<span class="token operator">=</span><span class="token function">getColor</span><span class="token punctuation">(</span>colors<span class="token punctuation">,</span>ratios<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>4.建立基于节点颜色集合和节点位置集合获取颜色的方法。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//获取片元颜色</span>
vec4 <span class="token function">getColor</span><span class="token punctuation">(</span><span class="token parameter">vec4 colors<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>float ratios<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//片元颜色</span>
    vec4 color<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//当前片元减起始片元的向量</span>
    vec2 sf<span class="token operator">=</span><span class="token function">vec2</span><span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">)</span><span class="token operator">-</span>u_Start<span class="token punctuation">;</span>
    <span class="token comment">//当前片元在se上的投影长度</span>
    float fsLen<span class="token operator">=</span><span class="token function">clamp</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>sf<span class="token punctuation">,</span>se1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span>seLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//长度比</span>
    float ratio<span class="token operator">=</span><span class="token function">clamp</span><span class="token punctuation">(</span>fsLen<span class="token operator">/</span>seLen<span class="token punctuation">,</span>ratios<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ratios<span class="token punctuation">[</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//第一个比值</span>
    float ratio1<span class="token operator">=</span>ratios<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//第一个颜色</span>
    vec4 color1<span class="token operator">=</span>colors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//遍历节点，按比值取色</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>int i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//第二个比值</span>
        float ratio2<span class="token operator">=</span>ratios<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//第二个颜色</span>
        vec4 color2<span class="token operator">=</span>colors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ratio<span class="token operator">&gt;=</span>ratio1<span class="token operator">&amp;&amp;</span>ratio<span class="token operator">&lt;=</span>ratio2<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//一段颜色的差值</span>
            vec4 color2_1<span class="token operator">=</span>color2<span class="token operator">-</span>color1<span class="token punctuation">;</span>
            <span class="token comment">//当前比值在一段比值中的比值</span>
            float ratioInRatio<span class="token operator">=</span><span class="token punctuation">(</span>ratio<span class="token operator">-</span>ratio1<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>ratio2<span class="token operator">-</span>ratio1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//当前比值在当前颜色段中所对应的颜色</span>
            color<span class="token operator">=</span>color1<span class="token operator">+</span>color2_1<span class="token operator">*</span>ratioInRatio<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ratio1<span class="token operator">=</span>ratio2<span class="token punctuation">;</span>
        color1<span class="token operator">=</span>color2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> color<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>效果如下：</p><p><img src="/visual/glsl-es/3.png" alt=""></p><h3 id="_4-用-js-向片元着色器传递渐变数据" tabindex="-1"><a class="header-anchor" href="#_4-用-js-向片元着色器传递渐变数据" aria-hidden="true">#</a> 4-用 js 向片元着色器传递渐变数据</h3><p>js 只能向着色器传递有限类型的数据，它无法传递任意长度的数组、字符串、json 对象等。</p><p>比如无法传递任意长度的数组、字符串、json 对象等。</p><p>所以把渐变节点装进了一个四维矩阵中，从而拼 8 个渐变节点出来，这对于一般的渐变操作是够的。</p><p>渐变结构如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[
    123000120, 255000, 255000000, 255077,
    255255000, 255128, 255000, 255178,
    200, 255255,       -1, -1,
    -1, -1,            -1, -1
]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li><p>每两个数字构成一个渐变节点</p><p>如：123000120, 255000</p></li><li><p>第一列对应颜色节点的 rgb 数据</p><p>如：123000120 对应的 rgb 数据分别是 123,0,120</p></li><li><p>第二列对应颜色节点的 a 数据和位置数据</p><p>如：255000 对应的 a 值是 255，节点位置为 0</p></li></ul><p>代码实现：</p><p>1.在矩形面中写入节点数据 u_ColorStops</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>const rect = new Poly(<span class="token punctuation">{</span>
    gl<span class="token punctuation">,</span>
    source<span class="token punctuation">,</span>
    type<span class="token operator">:</span> &#39;TRIANGLE_STRIP&#39;<span class="token punctuation">,</span>
    attributes<span class="token operator">:</span> <span class="token punctuation">{</span>
        a_Position<span class="token operator">:</span> <span class="token punctuation">{</span>
            size<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            index<span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    uniforms<span class="token operator">:</span> <span class="token punctuation">{</span>
        u_Start<span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> &#39;uniform2fv&#39;<span class="token punctuation">,</span>
            value<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        u_End<span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> &#39;uniform2fv&#39;<span class="token punctuation">,</span>
            value<span class="token operator">:</span> <span class="token punctuation">[</span>canvas.width<span class="token punctuation">,</span> canvas.height<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        u_ColorStops<span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> &#39;uniformMatrix4fv&#39;<span class="token punctuation">,</span>
            value<span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token number">123000120</span><span class="token punctuation">,</span> <span class="token number">255000</span><span class="token punctuation">,</span>
                <span class="token number">255000000</span><span class="token punctuation">,</span> <span class="token number">255077</span><span class="token punctuation">,</span>
                <span class="token number">255255000</span><span class="token punctuation">,</span> <span class="token number">255128</span><span class="token punctuation">,</span>
                <span class="token number">255000</span><span class="token punctuation">,</span> <span class="token number">255178</span><span class="token punctuation">,</span>
                <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">255255</span><span class="token punctuation">,</span>
                <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">-1</span><span class="token punctuation">,</span>
                <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">-1</span><span class="token punctuation">,</span>
                <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">-1</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>2.在片元着色器中写入相应的 uniform 变量</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//起始位</span>
uniform vec2 u_Start<span class="token punctuation">;</span>
<span class="token comment">//结束位</span>
uniform vec2 u_End<span class="token punctuation">;</span>
<span class="token comment">//四阶矩阵</span>
uniform mat4 u_ColorStops<span class="token punctuation">;</span>
<span class="token comment">//终点减起点向量</span>
vec2 se<span class="token operator">=</span>u_End<span class="token operator">-</span>u_Start<span class="token punctuation">;</span>
<span class="token comment">//长度</span>
float seLen<span class="token operator">=</span><span class="token function">length</span><span class="token punctuation">(</span>se<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//单位向量</span>
vec2 se1<span class="token operator">=</span><span class="token function">normalize</span><span class="token punctuation">(</span>se<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>3.在 main 函数内，声明节点的颜色集合和位置集合。</p><p>通过 setColorStops()方法将 u_ColorStops 中的数据解析入节点颜色集合和位置集合。</p><p>通过 getColor()方法获取片元颜色。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//节点颜色集合</span>
    vec4 colors<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//节点位置集合</span>
    float ratios<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//基于四维矩阵解析节点集合</span>
    <span class="token function">setColorStops</span><span class="token punctuation">(</span>colors<span class="token punctuation">,</span>ratios<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//片元颜色</span>
    gl_FragColor<span class="token operator">=</span><span class="token function">getColor</span><span class="token punctuation">(</span>colors<span class="token punctuation">,</span>ratios<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>setColorStops() 将 u_ColorStops 中的数据解析入节点颜色集合和位置集合。</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">void</span> <span class="token function">setColorStops</span><span class="token punctuation">(</span><span class="token parameter">out vec4 colors<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>out float ratios<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//节点颜色数据</span>
    vec4 colorSource<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//节点位置数据</span>
    float ratioSource<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token comment">//遍历四维矩阵的</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>int y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>y<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>y<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>int x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>x<span class="token operator">&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>x<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            int rgb<span class="token operator">=</span><span class="token function">int</span><span class="token punctuation">(</span>u_ColorStops<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            int ar<span class="token operator">=</span><span class="token function">int</span><span class="token punctuation">(</span>u_ColorStops<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>rgb<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">setColorStop</span><span class="token punctuation">(</span>rgb<span class="token punctuation">,</span>ar<span class="token punctuation">,</span>colorSource<span class="token punctuation">,</span>ratioSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            colors<span class="token punctuation">[</span>y<span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span>x<span class="token punctuation">]</span><span class="token operator">=</span>colorSource<span class="token punctuation">;</span>
            ratios<span class="token punctuation">[</span>y<span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span>x<span class="token punctuation">]</span><span class="token operator">=</span>ratioSource<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ul><li>setColorStop() 解析节点数据</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">void</span> <span class="token function">setColorStop</span><span class="token punctuation">(</span><span class="token parameter">int rgb<span class="token punctuation">,</span>int ar<span class="token punctuation">,</span>out vec4 color<span class="token punctuation">,</span>out float ratio</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    int rc<span class="token operator">=</span>rgb<span class="token operator">/</span><span class="token number">1000000</span><span class="token punctuation">;</span>
    int gc<span class="token operator">=</span><span class="token punctuation">(</span>rgb<span class="token operator">-</span>rc<span class="token operator">*</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">;</span>
    int bc<span class="token operator">=</span>rgb<span class="token operator">-</span><span class="token function">int</span><span class="token punctuation">(</span>rgb<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">;</span>
    int ac<span class="token operator">=</span>ar<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">;</span>
    int ratioI<span class="token operator">=</span>ar<span class="token operator">-</span>ac<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">;</span>
    color<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token function">float</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">float</span><span class="token punctuation">(</span>gc<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">float</span><span class="token punctuation">(</span>bc<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">float</span><span class="token punctuation">(</span>ac<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">255.0</span><span class="token punctuation">;</span>
    ratio<span class="token operator">=</span><span class="token function">float</span><span class="token punctuation">(</span>ratioI<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">255.0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>3.getColor() 方法和之前一样。</p><h3 id="_5-优化-js-中的节点数据" tabindex="-1"><a class="header-anchor" href="#_5-优化-js-中的节点数据" aria-hidden="true">#</a> 5-优化 js 中的节点数据</h3><p>觉得之前节点数据的书写方式不方便，也可以换成键值对的书写方式，然后对其进行解析。</p><p>1.渐变节点</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> colorStops <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">stop</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">stop</span><span class="token operator">:</span> <span class="token number">0.3</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">stop</span><span class="token operator">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">stop</span><span class="token operator">:</span> <span class="token number">0.7</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">stop</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>2.解析方法</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">parseColorStops</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stops <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  source<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> color<span class="token punctuation">,</span> stop <span class="token punctuation">}</span><span class="token punctuation">,</span> stopInd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> rgb <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> ar <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    color<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ele<span class="token punctuation">,</span> ind</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token punctuation">(</span>ele <span class="token operator">+</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ind <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rgb <span class="token operator">+=</span> str<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ar <span class="token operator">+=</span> str<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ar <span class="token operator">+=</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>stop <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stops<span class="token punctuation">[</span>stopInd <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> rgb<span class="token punctuation">;</span>
    stops<span class="token punctuation">[</span>stopInd <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> ar<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> stops<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>3.解析键值对类型的节点数据</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token literal-property property">u_ColorStops</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniformMatrix4fv&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token function">parseColorStops</span><span class="token punctuation">(</span>colorStops<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_6-径向渐变" tabindex="-1"><a class="header-anchor" href="#_6-径向渐变" aria-hidden="true">#</a> 6-径向渐变</h3><p>将之前的代码改改，便可以实现径向渐变。</p><p><img src="/visual/glsl-es/4.png" alt=""></p><p>1.在矩形面中，注释终点，添加半径</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// u_End: {</span>
<span class="token comment">//   type: &#39;uniform2fv&#39;,</span>
<span class="token comment">//   value: [canvas.width, canvas.height]</span>
<span class="token comment">// },</span>
<span class="token literal-property property">u_Radius</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;uniform1f&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">400</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>2.在片元着色器中也做相应调整。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//起始位</span>
uniform vec2 u_Start<span class="token punctuation">;</span>
<span class="token comment">//结束位</span>
<span class="token comment">//uniform vec2 u_End;</span>
<span class="token comment">//半径</span>
uniform float u_Radius<span class="token punctuation">;</span>
<span class="token comment">//四阶矩阵</span>
uniform mat4 u_ColorStops<span class="token punctuation">;</span>
<span class="token comment">//终点减起点向量</span>
<span class="token comment">//vec2 se=u_End-u_Start;</span>
<span class="token comment">//长度</span>
<span class="token comment">//float seLen=length(se);</span>
<span class="token comment">//单位向量</span>
<span class="token comment">//vec2 se1=normalize(se);</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>3.修改获取片元颜色的方法，基于极径取 ratio 比值。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//获取片元颜色</span>
vec4 <span class="token function">getColor</span><span class="token punctuation">(</span><span class="token parameter">vec4 colors<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>float ratios<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//片元颜色</span>
    vec4 color<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//当前片元减起始片元的向量</span>
    <span class="token comment">//vec2 sf=vec2(gl_FragCoord)-u_Start;</span>
    <span class="token comment">//当前片元到起始点的距离</span>
    float fsLen<span class="token operator">=</span><span class="token function">distance</span><span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>xy<span class="token punctuation">,</span>u_Start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//当前片元在se上的投影长度</span>
    <span class="token comment">//float fsLen=clamp(dot(sf,se1),0.0,seLen);</span>
    <span class="token comment">//极径比</span>
    float ratio<span class="token operator">=</span><span class="token function">clamp</span><span class="token punctuation">(</span>fsLen<span class="token operator">/</span>u_Radius<span class="token punctuation">,</span>ratios<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ratios<span class="token punctuation">[</span><span class="token number">8</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ……
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_7-极坐标渐变" tabindex="-1"><a class="header-anchor" href="#_7-极坐标渐变" aria-hidden="true">#</a> 7-极坐标渐变</h3><p>将之前的代码改改，还可以实现极坐标渐变。</p><p><img src="/visual/glsl-es/5.png" alt=""></p><p>1.在矩形面中，注释终点</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// u_End: {</span>
<span class="token comment">//   type: &#39;uniform2fv&#39;,</span>
<span class="token comment">//   value: [canvas.width, canvas.height]</span>
<span class="token comment">// },</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>2.在片元着色器中也做相应调整。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//起始位</span>
uniform vec2 u_Start<span class="token punctuation">;</span>
<span class="token comment">//结束位</span>
<span class="token comment">//uniform vec2 u_End;</span>
<span class="token comment">//终点减起点向量</span>
<span class="token comment">//vec2 se=u_End-u_Start;</span>
<span class="token comment">//四阶矩阵</span>
uniform mat4 u_ColorStops<span class="token punctuation">;</span>
<span class="token comment">//长度</span>
<span class="token comment">//float seLen=length(se);</span>
<span class="token comment">//单位向量</span>
<span class="token comment">//vec2 se1=normalize(se);</span>
<span class="token comment">//一圈的弧度</span>
float pi2<span class="token operator">=</span><span class="token function">radians</span><span class="token punctuation">(</span><span class="token number">360.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>3.修改获取片元颜色的方法，基于极角取 ratio 比值。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//获取片元颜色</span>
vec4 <span class="token function">getColor</span><span class="token punctuation">(</span><span class="token parameter">vec4 colors<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>float ratios<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//片元颜色</span>
    vec4 color<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//当前片元减起始片元的向量</span>
    vec2 sf<span class="token operator">=</span><span class="token function">vec2</span><span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">)</span><span class="token operator">-</span>u_Start<span class="token punctuation">;</span>
    <span class="token comment">//当前片元在se上的投影长度</span>
    <span class="token comment">//float fsLen=clamp(dot(sf,se1),0.0,seLen);</span>
    <span class="token comment">//长度比</span>
    <span class="token comment">//float ratio=clamp(fsLen/seLen,ratios[0],ratios[8-1]);</span>
    <span class="token comment">//向量方向</span>
    float dir<span class="token operator">=</span><span class="token function">atan</span><span class="token punctuation">(</span>sf<span class="token punctuation">.</span>y<span class="token punctuation">,</span>sf<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>dir<span class="token operator">&lt;</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        dir<span class="token operator">+=</span>pi2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    float ratio<span class="token operator">=</span>dir<span class="token operator">/</span>pi2<span class="token punctuation">;</span>
    ……
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="_8-三点渐变" tabindex="-1"><a class="header-anchor" href="#_8-三点渐变" aria-hidden="true">#</a> 8-三点渐变</h3><p>通过径向渐变和极坐标渐变的原理，还可以实现三点渐变。</p><p><img src="/visual/glsl-es/6.png" alt=""></p><p>1.建立三个点</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//点1</span>
vec2 p1<span class="token operator">=</span><span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
vec4 c1<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//点2</span>
vec2 p2<span class="token operator">=</span><span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">,</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
vec4 c2<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//点3</span>
vec2 p3<span class="token operator">=</span><span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span><span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
vec4 c3<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>p1 是点位，c1 是颜色。</p><p>2.基于三个位置点计算相应向量</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>vec2 v31<span class="token operator">=</span>p1<span class="token operator">-</span>p3<span class="token punctuation">;</span>
vec2 v32<span class="token operator">=</span>p2<span class="token operator">-</span>p3<span class="token punctuation">;</span>
vec2 v12<span class="token operator">=</span>p2<span class="token operator">-</span>p1<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>3.提前算出 p2 和 p1 点位的色差</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>vec4 c12<span class="token operator">=</span>c2<span class="token operator">-</span>c1<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>4.提前算出一圈的弧度，以备后用</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>float pi2<span class="token operator">=</span><span class="token function">radians</span><span class="token punctuation">(</span><span class="token number">360.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>radians() 是将角度转弧度的方法，360°=π*2</p><p>5.建立基于向量获取弧度的方法</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>float <span class="token function">getAngle</span><span class="token punctuation">(</span><span class="token parameter">vec2 v</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    float ang<span class="token operator">=</span><span class="token function">atan</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>y<span class="token punctuation">,</span>v<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ang<span class="token operator">&lt;</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        ang<span class="token operator">+=</span>pi2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ang<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>atan() 方法可以计算一个点基于 x 轴正方向的弧度，此弧度的取值范围是[-π,π]，为了方便计算，我将其范围设置为[0,2π]</p><p>6.获取点 p1、p2 和当前片元位相对于 p3 点的弧度。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>float ang31<span class="token operator">=</span><span class="token function">getAngle</span><span class="token punctuation">(</span>v31<span class="token punctuation">)</span><span class="token punctuation">;</span>
float ang32<span class="token operator">=</span><span class="token function">getAngle</span><span class="token punctuation">(</span>v32<span class="token punctuation">)</span><span class="token punctuation">;</span>
vec2 v3f<span class="token operator">=</span>gl_FragCoord<span class="token punctuation">.</span>xy<span class="token operator">-</span>p3<span class="token punctuation">;</span>
float ang3f<span class="token operator">=</span><span class="token function">getAngle</span><span class="token punctuation">(</span>v3f<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>7.用叉乘计算当前片元在向量 v12 的哪一侧</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>vec2 v1f<span class="token operator">=</span>gl_FragCoord<span class="token punctuation">.</span>xy<span class="token operator">-</span>p1<span class="token punctuation">;</span>
float z<span class="token operator">=</span>v1f<span class="token punctuation">.</span>x<span class="token operator">*</span>v12<span class="token punctuation">.</span>y<span class="token operator">-</span>v1f<span class="token punctuation">.</span>y<span class="token operator">*</span>v12<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>其原理之前在说三角形的时候说过，其实还可以这么写：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>vec2 v1f<span class="token operator">=</span>gl_FragCoord<span class="token punctuation">.</span>xy<span class="token operator">-</span>p1<span class="token punctuation">;</span>
float z <span class="token operator">=</span><span class="token function">cross</span><span class="token punctuation">(</span><span class="token function">vec3</span><span class="token punctuation">(</span>v1f<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">vec3</span><span class="token punctuation">(</span>v12<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>z<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>之前的运算实际上就是计算了两个 z 值为 0 的三维向量的叉乘结果的 z 值。</p><p>8.当片元在向量 v31 和 v32 之间，并且当前片元在向量 v12 的左侧时，当前片元在 △p1p2p3 中，我们便可以计算片元颜色。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>vec4 color<span class="token operator">=</span><span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>ang3f<span class="token operator">&gt;=</span>ang31<span class="token operator">&amp;&amp;</span>ang3f<span class="token operator">&lt;=</span>ang32<span class="token operator">&amp;&amp;</span>z<span class="token operator">&lt;</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//计算∠&lt;v3f,p3p1&gt;在∠&lt;p3p2,p3p1&gt;中的比值</span>
    ang3f<span class="token operator">=</span><span class="token function">clamp</span><span class="token punctuation">(</span>ang3f<span class="token punctuation">,</span>ang31<span class="token punctuation">,</span>ang32<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float angRatio<span class="token operator">=</span><span class="token punctuation">(</span>ang3f<span class="token operator">-</span>ang31<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>ang32<span class="token operator">-</span>ang31<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//向量v12和向量v3f的交点位置和颜色</span>
    vec2 p4<span class="token operator">=</span>p1<span class="token operator">+</span>v12<span class="token operator">*</span>angRatio<span class="token punctuation">;</span>
    vec4 c4<span class="token operator">=</span>c1<span class="token operator">+</span>c12<span class="token operator">*</span>angRatio<span class="token punctuation">;</span>

    <span class="token comment">//向量p3-gl_FragCoord在向量p3p4中的长度比</span>
    float lenE<span class="token operator">=</span><span class="token function">distance</span><span class="token punctuation">(</span>p4<span class="token punctuation">,</span>p3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float lenF<span class="token operator">=</span><span class="token function">length</span><span class="token punctuation">(</span>v3f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float lenRatio<span class="token operator">=</span>lenF<span class="token operator">/</span>lenE<span class="token punctuation">;</span>

    <span class="token comment">//基于长度比获取当前片元在c3、c4间的颜色</span>
    color<span class="token operator">=</span>c3<span class="token operator">+</span><span class="token punctuation">(</span>c4<span class="token operator">-</span>c3<span class="token punctuation">)</span><span class="token operator">*</span>lenRatio<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//片元颜色</span>
gl_FragColor<span class="token operator">=</span>color<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>解释一下 if 语法中的取色逻辑。</p><p>9.计算 ∠&lt;v32,v3f&gt;在 ∠&lt;v32,v31&gt;中的比值 angRatio</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>ang3f<span class="token operator">=</span><span class="token function">clamp</span><span class="token punctuation">(</span>ang3f<span class="token punctuation">,</span>ang31<span class="token punctuation">,</span>ang32<span class="token punctuation">)</span><span class="token punctuation">;</span>
float angRatio<span class="token operator">=</span><span class="token punctuation">(</span>ang3f<span class="token operator">-</span>ang31<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>ang32<span class="token operator">-</span>ang31<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>10.基于 angRatio 计算向量 v12 和向量 v1f 的交点位置 p4 和颜色 c4</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>vec2 p4<span class="token operator">=</span>p1<span class="token operator">+</span>v12<span class="token operator">*</span>angRatio<span class="token punctuation">;</span>
vec4 c4<span class="token operator">=</span>c1<span class="token operator">+</span>c12<span class="token operator">*</span>angRatio<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>11.计算向量 p3-gl_FragCoord 在向量 p3p4 中的长度比，然后基于此比值获取当前片元在 c3、c4 间的颜色</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>float lenE<span class="token operator">=</span><span class="token function">distance</span><span class="token punctuation">(</span>p4<span class="token punctuation">,</span>p3<span class="token punctuation">)</span><span class="token punctuation">;</span>
float lenF<span class="token operator">=</span><span class="token function">length</span><span class="token punctuation">(</span>v3f<span class="token punctuation">)</span><span class="token punctuation">;</span>
float lenRatio<span class="token operator">=</span>lenF<span class="token operator">/</span>lenE<span class="token punctuation">;</span>
color<span class="token operator">=</span>c3<span class="token operator">+</span><span class="token punctuation">(</span>c4<span class="token operator">-</span>c3<span class="token punctuation">)</span><span class="token operator">*</span>lenRatio<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="二、杂色" tabindex="-1"><a class="header-anchor" href="#二、杂色" aria-hidden="true">#</a> 二、杂色</h2><h3 id="_1-杂色原理" tabindex="-1"><a class="header-anchor" href="#_1-杂色原理" aria-hidden="true">#</a> 1-杂色原理</h3><p><img src="/visual/glsl-es/7.png" alt=""></p><p>杂色的真谛就是通过有规律条件得到无规律的结果。</p><p>有规律的条件 =&gt; 是片元在 canvas 画布中的像素位。</p><p>无规律的结果 =&gt; 是片元的随机色值。</p><p>杂色实现思路简单，方法也非常多。</p><p>接下来就写一个杂色的实现方法。</p><p>1.在片元着色器里建立一个基于 gl_FragCoord 获取随机颜色的方法。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>float <span class="token function">rand</span><span class="token punctuation">(</span><span class="token parameter">vec2 fragCoord</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec2 a<span class="token operator">=</span> <span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0.1234</span><span class="token punctuation">,</span><span class="token number">0.5678</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    float n<span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>fragCoord<span class="token punctuation">,</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">fract</span><span class="token punctuation">(</span><span class="token function">sin</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10000.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//sin(n)∈[-1,1]</span>
<span class="token comment">//sin(n)=-0.12345678</span>
<span class="token comment">//sin(n)*10000.0=-1234.5678</span>
<span class="token comment">//fract(sin(n)*10000.0)=0.5678 ∈(0,1)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>向量 a 是随便写的一个向量，小数点后的位数要多一点。</p><p>n 是片元位置与向量 a 的点积，这么做是为了将两个已知条件，即 fragCoord 的两个分量，合成一个已知条件。</p><p>tan(n) 是基于 n 值获取[-∞,∞] 之间一个随机数，是为了把片元位的行列规律破一下。</p><p>sin(n)*10000.0 是为了把小数点左移，之后通过 fract() 只获取小数点后面数字，这样的结果便会更为随机。</p><p>2.在主函数体中调用 rand()方法</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    float f <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>3.接下来对上面的向量 a 进行旋转，可以实现噪波动画。</p><ul><li>在片元着色器中添加 u_Ang 变量：</li></ul><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  precision mediump float<span class="token punctuation">;</span>
  uniform float u_Ang<span class="token punctuation">;</span>
  float s<span class="token operator">=</span><span class="token function">sin</span><span class="token punctuation">(</span>u_Ang<span class="token punctuation">)</span><span class="token punctuation">;</span>
  float c<span class="token operator">=</span><span class="token function">cos</span><span class="token punctuation">(</span>u_Ang<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mat2 m<span class="token operator">=</span><span class="token function">mat2</span><span class="token punctuation">(</span>
    c<span class="token punctuation">,</span>s<span class="token punctuation">,</span>
    <span class="token operator">-</span>s<span class="token punctuation">,</span>c
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  float <span class="token function">rand</span><span class="token punctuation">(</span><span class="token parameter">vec2 fragCoord</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec2 a<span class="token operator">=</span> m<span class="token operator">*</span><span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0.1234</span><span class="token punctuation">,</span><span class="token number">0.5678</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    float n<span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>fragCoord<span class="token punctuation">,</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">fract</span><span class="token punctuation">(</span><span class="token function">tan</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10000.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    float f <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><ul><li>js 代码</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> rect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  gl<span class="token punctuation">,</span>
  source<span class="token punctuation">,</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;TRIANGLE_STRIP&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">uniforms</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">u_Ang</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniform1f&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> ang <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">ani</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ang<span class="token operator">++</span><span class="token punctuation">;</span>
  rect<span class="token punctuation">.</span>uniforms<span class="token punctuation">.</span>u_Ang<span class="token punctuation">.</span>value <span class="token operator">=</span> ang<span class="token punctuation">;</span>
  rect<span class="token punctuation">.</span><span class="token function">updateUniform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rect<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>ani<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>效果如下：</p><p><img src="/visual/glsl-es/8.gif" alt=""></p><h3 id="_2-肌理" tabindex="-1"><a class="header-anchor" href="#_2-肌理" aria-hidden="true">#</a> 2-肌理</h3><p>肌理是美学中必不可少的一部分，不同的肌理有着不同的视觉体验。</p><p>可以把之前的代码做一下修改。</p><ul><li>把 10000.0 变成 10.0：</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>vec2 a<span class="token operator">=</span> <span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0.1234</span><span class="token punctuation">,</span><span class="token number">0.5678</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
float n<span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>fragCoord<span class="token punctuation">,</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token function">fract</span><span class="token punctuation">(</span><span class="token function">tan</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>效果如下：</p><p><img src="/visual/glsl-es/9.png" alt=""></p><p>有韵律的杂色。</p><ul><li>或者直接把 10.0 也去掉</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>vec2 a<span class="token operator">=</span> <span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0.1234</span><span class="token punctuation">,</span><span class="token number">0.5678</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
float n<span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>fragCoord<span class="token punctuation">,</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token function">fract</span><span class="token punctuation">(</span><span class="token function">tan</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>效果如下：</p><p><img src="/visual/glsl-es/10.png" alt=""></p><ul><li>把 a 改一下</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>vec2 a<span class="token operator">=</span> <span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0.111</span><span class="token punctuation">,</span><span class="token number">0.11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
float n<span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>fragCoord<span class="token punctuation">,</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token function">fract</span><span class="token punctuation">(</span><span class="token function">tan</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>效果如下：</p><p><img src="/visual/glsl-es/11.png" alt=""></p><ul><li>再把 a 改一下</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>vec2 a<span class="token operator">=</span> <span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0.111</span><span class="token punctuation">,</span><span class="token number">0.111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
float n<span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>fragCoord<span class="token punctuation">,</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token function">fract</span><span class="token punctuation">(</span><span class="token function">tan</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这便是拉丝的效果：</p><p><img src="/visual/glsl-es/12.png" alt=""></p><ul><li>或者还可以这样</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>float <span class="token function">rand</span><span class="token punctuation">(</span><span class="token parameter">vec2 fragCoord</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec2 v<span class="token operator">=</span>fragCoord<span class="token operator">-</span>u_CanvasSize<span class="token operator">/</span><span class="token number">2.0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">fract</span><span class="token punctuation">(</span>
        <span class="token function">atan</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>x<span class="token punctuation">,</span>v<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">500.0</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="/visual/glsl-es/13.png" alt=""></p><h2 id="三、极坐标" tabindex="-1"><a class="header-anchor" href="#三、极坐标" aria-hidden="true">#</a> 三、极坐标</h2><p>极坐标的创始人是牛顿，主要应用于数学领域。</p><h3 id="_1-极坐标的基本概念" tabindex="-1"><a class="header-anchor" href="#_1-极坐标的基本概念" aria-hidden="true">#</a> 1-极坐标的基本概念</h3><p><img src="/visual/glsl-es/14.png" alt=""></p><ul><li>极点：极坐标的坐标原点，即点 O</li><li>极轴：极坐标的起始轴，其对应的弧度为 0，即 Ox</li><li>正方向：极坐标中，点位按此方向的旋转量越大，其相对于极轴的弧度越大，此方向通常为逆时针方向</li><li>极径：极坐标系中一点到极点的距离，如|OM|</li><li>极角：极坐标系中一点相对于极轴的角度，如 θ</li><li>极坐标：由极坐标系中一点的极径和极角构成的有序数对，如(|OM|,θ)</li><li>极坐标系：按照以上原理确定某点的坐标位的坐标系</li></ul><h3 id="_2-直角坐标系" tabindex="-1"><a class="header-anchor" href="#_2-直角坐标系" aria-hidden="true">#</a> 2-直角坐标系</h3><p>gl_FragCoord 所对应的二维直角坐标系中，y 轴是朝上的，以像素为单位。</p><p><img src="/visual/glsl-es/1.jpg" alt=""></p><p>一个点的位置既可以用直角坐标来表示，也可以用极坐标来表示。</p><p>接下来说一下二维直角坐标系与极坐标系的转换方法。</p><h3 id="_3-极角与-x-轴的映射" tabindex="-1"><a class="header-anchor" href="#_3-极角与-x-轴的映射" aria-hidden="true">#</a> 3-极角与 x 轴的映射</h3><p>可以通过极角与 x 轴的映射实现放射效果。</p><h4 id="_3-1-放射" tabindex="-1"><a class="header-anchor" href="#_3-1-放射" aria-hidden="true">#</a> 3-1-放射</h4><p><img src="/visual/glsl-es/15.png" alt=""></p><p>1.在片元着色器里基于画布尺寸计算画布中心位，声明 360° 所对应的弧度，以备后用。</p><div class="language-j ext-j line-numbers-mode"><pre class="language-j"><code>uniform vec2 u_CanvasSize<span class="token verb keyword">;</span>
vec2 center<span class="token verb keyword">=</span>u_CanvasSize<span class="token adverb builtin">/</span><span class="token number">2.0</span><span class="token verb keyword">;</span>
float pi2<span class="token verb keyword">=</span>radians<span class="token punctuation">(</span><span class="token number">360.0</span><span class="token punctuation">)</span><span class="token verb keyword">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>2.以画布中心点为极点，计算当前片元的极角 ang。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec2 p<span class="token operator">=</span>gl_FragCoord<span class="token punctuation">.</span>xy<span class="token operator">-</span>center<span class="token punctuation">;</span>
    float ang<span class="token operator">=</span><span class="token function">atan</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token punctuation">,</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ……
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>3.以极角为变量，计算与计算一个 x 值</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>float x<span class="token operator">=</span>ang<span class="token operator">*</span><span class="token number">16.0</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>4.将 x 值拼上一个随意的 y 值，构成向量 v</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>vec2 v<span class="token operator">=</span><span class="token function">vec2</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>5.基于向量 v，通过 rand() 方法生成一个颜色</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>vec2 v<span class="token operator">=</span><span class="token function">vec2</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
float f <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>有了渐变的效果后，还可以让其旋转起来。</p><h4 id="_3-2-渐变旋转" tabindex="-1"><a class="header-anchor" href="#_3-2-渐变旋转" aria-hidden="true">#</a> 3-2-渐变旋转</h4><p>1.通过 requestAnimationFrame() 方法向着色器传递一个时间戳 u_Stamp</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> rect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Poly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  gl<span class="token punctuation">,</span>
  source<span class="token punctuation">,</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;TRIANGLE_STRIP&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a_Position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">uniforms</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">u_CanvasSize</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniform2fv&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">[</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">u_Stamp</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;uniform1f&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">ani</span><span class="token punctuation">(</span><span class="token parameter">stamp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rect<span class="token punctuation">.</span>uniforms<span class="token punctuation">.</span>u_Stamp<span class="token punctuation">.</span>value <span class="token operator">=</span> stamp<span class="token punctuation">;</span>
  rect<span class="token punctuation">.</span><span class="token function">updateUniform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rect<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>ani<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>2.在着色器中建立名为 u_Stamp 的 uniform 变量，并基于此变量建立只负责旋转的模型矩阵 modelMatrix。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>uniform vec2 u_CanvasSize<span class="token punctuation">;</span>
uniform float u_Stamp<span class="token punctuation">;</span>

vec2 center<span class="token operator">=</span>u_CanvasSize<span class="token operator">/</span><span class="token number">2.0</span><span class="token punctuation">;</span>
float pi2<span class="token operator">=</span><span class="token function">radians</span><span class="token punctuation">(</span><span class="token number">360.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

float angOffset<span class="token operator">=</span>u_Stamp<span class="token operator">*</span><span class="token number">0.001</span><span class="token punctuation">;</span>
float cosAng<span class="token operator">=</span><span class="token function">cos</span><span class="token punctuation">(</span>angOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
float sinAng<span class="token operator">=</span><span class="token function">sin</span><span class="token punctuation">(</span>angOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
mat2 modelMatrix<span class="token operator">=</span><span class="token function">mat2</span><span class="token punctuation">(</span>
    cosAng<span class="token punctuation">,</span>sinAng<span class="token punctuation">,</span>
    <span class="token operator">-</span>sinAng<span class="token punctuation">,</span>cosAng
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>3.在 main() 方法中使用 modelMatrix 旋转点 p</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec2 p<span class="token operator">=</span>gl_FragCoord<span class="token punctuation">.</span>xy<span class="token operator">-</span>center<span class="token punctuation">;</span>
    p<span class="token operator">=</span>modelMatrix<span class="token operator">*</span>p<span class="token punctuation">;</span>
    float ang<span class="token operator">=</span><span class="token function">atan</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token punctuation">,</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float x<span class="token operator">=</span>ang<span class="token operator">*</span><span class="token number">16.0</span><span class="token punctuation">;</span>

    vec2 v<span class="token operator">=</span><span class="token function">vec2</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    float f <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>以此原理，还可以通过时间戳改变上面向量 v 的 y 值，从而实现渐变闪烁。</p><h4 id="_3-3-渐变闪烁" tabindex="-1"><a class="header-anchor" href="#_3-3-渐变闪烁" aria-hidden="true">#</a> 3-3-渐变闪烁</h4><p>1.修改一下 main 方法</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec2 p<span class="token operator">=</span>gl_FragCoord<span class="token punctuation">.</span>xy<span class="token operator">-</span>center<span class="token punctuation">;</span>
    <span class="token comment">//p=modelMatrix*p;</span>
    float ang<span class="token operator">=</span><span class="token function">atan</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token punctuation">,</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float x<span class="token operator">=</span>ang<span class="token operator">*</span><span class="token number">16.0</span><span class="token punctuation">;</span>

    vec2 v<span class="token operator">=</span><span class="token function">vec2</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">int</span><span class="token punctuation">(</span>u_Stamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    float f <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>2.控制一下闪烁速度</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> lastTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> timeLen <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">ani</span><span class="token punctuation">(</span><span class="token parameter">stamp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stamp <span class="token operator">%</span> timeLen <span class="token operator">&lt;</span> lastTime <span class="token operator">%</span> timeLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rect<span class="token punctuation">.</span>uniforms<span class="token punctuation">.</span>u_Stamp<span class="token punctuation">.</span>value <span class="token operator">=</span> stamp<span class="token punctuation">;</span>
    rect<span class="token punctuation">.</span><span class="token function">updateUniform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rect<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  lastTime <span class="token operator">=</span> stamp<span class="token punctuation">;</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>ani<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>知道了基本的动画原理后，还可以建立多极点放射效果，从而玩点艺术效果。</p><h4 id="_3-4-来自深渊的凝视" tabindex="-1"><a class="header-anchor" href="#_3-4-来自深渊的凝视" aria-hidden="true">#</a> 3-4-来自深渊的凝视</h4><p>下图两个极点之间的图形像一只眼睛，所以我就叫它“来自深渊的凝视”啦。</p><p><img src="/visual/glsl-es/16.png" alt=""></p><p>这个动画是在放射旋转的基础上实现的，接下来我对其做一下修改。</p><p>1.建立两个模型矩阵</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>float angOffset1<span class="token operator">=</span>u_Stamp<span class="token operator">*</span><span class="token number">0.0002</span><span class="token punctuation">;</span>
float cosAng1<span class="token operator">=</span><span class="token function">cos</span><span class="token punctuation">(</span>angOffset1<span class="token punctuation">)</span><span class="token punctuation">;</span>
float sinAng1<span class="token operator">=</span><span class="token function">sin</span><span class="token punctuation">(</span>angOffset1<span class="token punctuation">)</span><span class="token punctuation">;</span>
mat2 modelMatrix1<span class="token operator">=</span><span class="token function">mat2</span><span class="token punctuation">(</span>
    cosAng1<span class="token punctuation">,</span>sinAng1<span class="token punctuation">,</span>
    <span class="token operator">-</span>sinAng1<span class="token punctuation">,</span>cosAng1
<span class="token punctuation">)</span><span class="token punctuation">;</span>

float angOffset2<span class="token operator">=</span>u_Stamp<span class="token operator">*</span><span class="token number">0.0008</span><span class="token punctuation">;</span>
float cosAng2<span class="token operator">=</span><span class="token function">cos</span><span class="token punctuation">(</span>angOffset2<span class="token punctuation">)</span><span class="token punctuation">;</span>
float sinAng2<span class="token operator">=</span><span class="token function">sin</span><span class="token punctuation">(</span>angOffset2<span class="token punctuation">)</span><span class="token punctuation">;</span>
mat2 modelMatrix2<span class="token operator">=</span><span class="token function">mat2</span><span class="token punctuation">(</span>
    cosAng2<span class="token punctuation">,</span>sinAng1<span class="token punctuation">,</span>
    <span class="token operator">-</span>sinAng2<span class="token punctuation">,</span>cosAng2
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ul><li>modelMatrix1 是用于旋转片元位的</li><li>modelMatrix2 是用于旋转极点的。</li></ul><p>注：modelMatrix2 中的第二个元素是 sinAng1，不是 sinAng2，我这么做是为打破一下其中规中矩的旋转方式。</p><p>2.将通过极坐标获取亮度的方法封装一下。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>float <span class="token function">getBright</span><span class="token punctuation">(</span><span class="token parameter">vec2 pole</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    pole<span class="token operator">=</span>center<span class="token operator">+</span>modelMatrix2<span class="token operator">*</span><span class="token punctuation">(</span>pole<span class="token operator">-</span>center<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vec2 p<span class="token operator">=</span>gl_FragCoord<span class="token punctuation">.</span>xy<span class="token operator">-</span>pole<span class="token punctuation">;</span>
    p<span class="token operator">=</span>modelMatrix1<span class="token operator">*</span>p<span class="token punctuation">;</span>
    float ang<span class="token operator">=</span><span class="token function">atan</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token punctuation">,</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float x<span class="token operator">=</span>ang<span class="token operator">*</span><span class="token number">16.0</span><span class="token punctuation">;</span>
    vec2 v<span class="token operator">=</span><span class="token function">vec2</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">rand</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>3.在 mian 中基于两个极点，获取两个亮度值。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec2 min<span class="token operator">=</span>u_CanvasSize<span class="token operator">*</span><span class="token number">0.35</span><span class="token punctuation">;</span>
    vec2 max<span class="token operator">=</span>u_CanvasSize<span class="token operator">*</span><span class="token number">0.65</span><span class="token punctuation">;</span>
    float bright1 <span class="token operator">=</span> <span class="token function">getBright</span><span class="token punctuation">(</span>min<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float bright2 <span class="token operator">=</span> <span class="token function">getBright</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ……
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>4.对两个亮度值进行合成。</p><p>其合成思路是若两个亮度值都比较暗，那我就让当前片元变亮；若都比较亮，那我就让其变暗。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec2 min<span class="token operator">=</span>u_CanvasSize<span class="token operator">*</span><span class="token number">0.35</span><span class="token punctuation">;</span>
    vec2 max<span class="token operator">=</span>u_CanvasSize<span class="token operator">*</span><span class="token number">0.65</span><span class="token punctuation">;</span>
    float bright1 <span class="token operator">=</span> <span class="token function">getBright</span><span class="token punctuation">(</span>min<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float bright2 <span class="token operator">=</span> <span class="token function">getBright</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>

    float f<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">;</span>
    float sum<span class="token operator">=</span>bright1<span class="token operator">+</span>bright2<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sum<span class="token operator">&gt;</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        f<span class="token operator">=</span>bright1<span class="token operator">*</span>bright2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        f<span class="token operator">=</span>sum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>以此原理，还可以再玩点别的，比如来上四个极点。</p><h4 id="_3-5-数字山谷" tabindex="-1"><a class="header-anchor" href="#_3-5-数字山谷" aria-hidden="true">#</a> 3-5-数字山谷</h4><p>下面这张图就叫它“数字山谷”了。</p><p>要用它来体现数字山谷的现代、科技、格子玻璃、明快、琐碎、进取，以及看似杂乱莫测的变化中又蕴含着的规律。</p><p><img src="/visual/glsl-es/17.png" alt=""></p><p>在“来自深渊的凝视”的基础上做一下修改。</p><p>1.修改一下矩阵变换的参数</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>float angOffset1<span class="token operator">=</span>u_Stamp<span class="token operator">*</span><span class="token number">0.00015</span><span class="token punctuation">;</span>
float cosAng1<span class="token operator">=</span><span class="token function">cos</span><span class="token punctuation">(</span>angOffset1<span class="token punctuation">)</span><span class="token punctuation">;</span>
float sinAng1<span class="token operator">=</span><span class="token function">sin</span><span class="token punctuation">(</span>angOffset1<span class="token punctuation">)</span><span class="token punctuation">;</span>
mat2 modelMatrix1<span class="token operator">=</span><span class="token function">mat2</span><span class="token punctuation">(</span>
    cosAng1<span class="token punctuation">,</span>sinAng1<span class="token punctuation">,</span>
    <span class="token operator">-</span>sinAng1<span class="token punctuation">,</span>cosAng1
<span class="token punctuation">)</span><span class="token punctuation">;</span>

float angOffset2<span class="token operator">=</span>u_Stamp<span class="token operator">*</span><span class="token number">0.0004</span><span class="token punctuation">;</span>
float cosAng2<span class="token operator">=</span><span class="token function">cos</span><span class="token punctuation">(</span>angOffset2<span class="token punctuation">)</span><span class="token punctuation">;</span>
float sinAng2<span class="token operator">=</span><span class="token function">sin</span><span class="token punctuation">(</span>angOffset2<span class="token punctuation">)</span><span class="token punctuation">;</span>
mat2 modelMatrix2<span class="token operator">=</span><span class="token function">mat2</span><span class="token punctuation">(</span>
    cosAng2<span class="token punctuation">,</span>sinAng1<span class="token punctuation">,</span>
    <span class="token operator">-</span>sinAng2<span class="token punctuation">,</span>cosAng2
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>2.通过 4 个极点获取亮度值，然后对其合成</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec2 min<span class="token operator">=</span>u_CanvasSize<span class="token operator">*</span><span class="token number">0.25</span><span class="token punctuation">;</span>
    vec2 max<span class="token operator">=</span>u_CanvasSize<span class="token operator">*</span><span class="token number">0.75</span><span class="token punctuation">;</span>
    float bright1 <span class="token operator">=</span> <span class="token function">getBright</span><span class="token punctuation">(</span>min<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float bright2 <span class="token operator">=</span> <span class="token function">getBright</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float bright3 <span class="token operator">=</span> <span class="token function">getBright</span><span class="token punctuation">(</span><span class="token function">vec2</span><span class="token punctuation">(</span>min<span class="token punctuation">.</span>x<span class="token punctuation">,</span>max<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    float bright4 <span class="token operator">=</span> <span class="token function">getBright</span><span class="token punctuation">(</span><span class="token function">vec2</span><span class="token punctuation">(</span>max<span class="token punctuation">.</span>x<span class="token punctuation">,</span>min<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    float f<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">;</span>
    float sum<span class="token operator">=</span>bright1<span class="token operator">+</span>bright2<span class="token operator">+</span>bright3<span class="token operator">+</span>bright4<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sum<span class="token operator">&gt;</span><span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        f<span class="token operator">=</span>bright1<span class="token operator">*</span>bright2<span class="token operator">*</span>bright3<span class="token operator">*</span>bright4<span class="token operator">*</span><span class="token number">4.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        f<span class="token operator">=</span>sum<span class="token operator">/</span><span class="token number">2.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="_3-6-正弦型放射" tabindex="-1"><a class="header-anchor" href="#_3-6-正弦型放射" aria-hidden="true">#</a> 3-6-正弦型放射</h4><p><img src="/visual/glsl-es/18.png" alt=""></p><p>先回顾一下正弦型函数：</p><p>y=Asin(ωx+φ)</p><ul><li>A 影响的是正弦曲线的波动幅度</li><li>φ 影响的是正弦曲线的平移</li><li>ω 影响的是正弦曲线的周期，ω 越大，周期越小</li></ul><p>接下来说一下代码实现。</p><p>1.声明 omega 和 a 变量</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>float omega<span class="token operator">=</span><span class="token number">7.0</span><span class="token punctuation">;</span>
float a<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li><p>omega 对应的是正弦函数式里的 ω，在放射效果中此值会影响射线的数量</p></li><li><p>a 对应的是正弦函数式里的 A，在放射效果中此值会影响亮度</p><p>2.在 main 方法中，以画布中心为极点，计算当前片元的极角</p></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec2 p<span class="token operator">=</span>gl_FragCoord<span class="token punctuation">.</span>xy<span class="token operator">-</span>center<span class="token punctuation">;</span>
    float ang<span class="token operator">=</span><span class="token function">atan</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token punctuation">,</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ……
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>3.以极角为变量计算正弦函数值</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>float f <span class="token operator">=</span> a<span class="token operator">*</span><span class="token function">sin</span><span class="token punctuation">(</span>omega<span class="token operator">*</span>ang<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.5</span><span class="token punctuation">;</span>
gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>上面求 f 时加的 0.5 是为了在[0,1]之间去亮度值：</p><ul><li>a*sin(omega*x)∈[-0.5,0.5]</li><li>a*sin(omega*x)+0.5∈[0,1]</li></ul><h4 id="_3-7-光影沉浮" tabindex="-1"><a class="header-anchor" href="#_3-7-光影沉浮" aria-hidden="true">#</a> 3-7-光影沉浮</h4><p>下图就叫它“光影沉浮”了。</p><p><img src="/visual/glsl-es/19.png" alt=""></p><p>片元着色器如下：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;fragmentShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-fragment&quot;</span><span class="token operator">&gt;</span>
  precision mediump float<span class="token punctuation">;</span>
  uniform vec2 u_CanvasSize<span class="token punctuation">;</span>
  uniform float u_Stamp<span class="token punctuation">;</span>

  vec2 center<span class="token operator">=</span>u_CanvasSize<span class="token operator">/</span><span class="token number">2.0</span><span class="token punctuation">;</span>
  float pi2<span class="token operator">=</span><span class="token function">radians</span><span class="token punctuation">(</span><span class="token number">360.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  float omega<span class="token operator">=</span><span class="token number">24.0</span><span class="token punctuation">;</span>
  float a<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">;</span>

  float angOffset1<span class="token operator">=</span>u_Stamp<span class="token operator">*</span><span class="token number">0.001</span><span class="token punctuation">;</span>
  float cosAng1<span class="token operator">=</span><span class="token function">cos</span><span class="token punctuation">(</span>angOffset1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  float sinAng1<span class="token operator">=</span><span class="token function">sin</span><span class="token punctuation">(</span>angOffset1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mat2 modelMatrix1<span class="token operator">=</span><span class="token function">mat2</span><span class="token punctuation">(</span>
    cosAng1<span class="token punctuation">,</span>sinAng1<span class="token punctuation">,</span>
    <span class="token operator">-</span>sinAng1<span class="token punctuation">,</span>cosAng1
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  float angOffset2<span class="token operator">=</span>u_Stamp<span class="token operator">*</span><span class="token number">0.001</span><span class="token punctuation">;</span>
  float cosAng2<span class="token operator">=</span><span class="token function">cos</span><span class="token punctuation">(</span>angOffset2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  float sinAng2<span class="token operator">=</span><span class="token function">sin</span><span class="token punctuation">(</span>angOffset2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mat2 modelMatrix2<span class="token operator">=</span><span class="token function">mat2</span><span class="token punctuation">(</span>
    cosAng2<span class="token punctuation">,</span>sinAng2<span class="token punctuation">,</span>
    <span class="token operator">-</span>sinAng2<span class="token punctuation">,</span>cosAng2
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  float <span class="token function">getBright</span><span class="token punctuation">(</span><span class="token parameter">vec2 pole</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    pole<span class="token operator">=</span>center<span class="token operator">+</span>modelMatrix2<span class="token operator">*</span><span class="token punctuation">(</span>pole<span class="token operator">-</span>center<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vec2 p<span class="token operator">=</span>gl_FragCoord<span class="token punctuation">.</span>xy<span class="token operator">-</span>pole<span class="token punctuation">;</span>
    p<span class="token operator">=</span>modelMatrix1<span class="token operator">*</span>p<span class="token punctuation">;</span>
    float ang<span class="token operator">=</span><span class="token function">atan</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token punctuation">,</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> a<span class="token operator">*</span><span class="token function">sin</span><span class="token punctuation">(</span>omega<span class="token operator">*</span>ang<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.5</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec2 min<span class="token operator">=</span>u_CanvasSize<span class="token operator">*</span><span class="token number">0.35</span><span class="token punctuation">;</span>
    vec2 max<span class="token operator">=</span>u_CanvasSize<span class="token operator">*</span><span class="token number">0.65</span><span class="token punctuation">;</span>
    float bright1 <span class="token operator">=</span> <span class="token function">getBright</span><span class="token punctuation">(</span>min<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float bright2 <span class="token operator">=</span> <span class="token function">getBright</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float f<span class="token operator">=</span><span class="token punctuation">(</span>bright1<span class="token operator">+</span>bright2<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.55</span><span class="token punctuation">;</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h4 id="_3-8-湍流" tabindex="-1"><a class="header-anchor" href="#_3-8-湍流" aria-hidden="true">#</a> 3-8-湍流</h4><p>下图具有流体效果，就叫它“湍流”啦。</p><p>其动画原理和之前都是一样的，就不再详解了。</p><p><img src="/visual/glsl-es/20.png" alt=""></p><p>片元着色器如下：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;fragmentShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-fragment&quot;</span><span class="token operator">&gt;</span>
  precision mediump float<span class="token punctuation">;</span>
  uniform vec2 u_CanvasSize<span class="token punctuation">;</span>
  uniform float u_Stamp<span class="token punctuation">;</span>

  vec2 center<span class="token operator">=</span>u_CanvasSize<span class="token operator">/</span><span class="token number">2.0</span><span class="token punctuation">;</span>
  float pi2<span class="token operator">=</span><span class="token function">radians</span><span class="token punctuation">(</span><span class="token number">360.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  float omega<span class="token operator">=</span><span class="token number">64.0</span><span class="token punctuation">;</span>
  float a<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">;</span>

  float angOffset1<span class="token operator">=</span>u_Stamp<span class="token operator">*</span><span class="token number">0.0004</span><span class="token punctuation">;</span>
  float sinAng1<span class="token operator">=</span><span class="token function">sin</span><span class="token punctuation">(</span>angOffset1<span class="token punctuation">)</span><span class="token punctuation">;</span>

  float angOffset2<span class="token operator">=</span>u_Stamp<span class="token operator">*</span><span class="token number">0.0002</span><span class="token punctuation">;</span>
  float cosAng2<span class="token operator">=</span><span class="token function">cos</span><span class="token punctuation">(</span>angOffset2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  float sinAng2<span class="token operator">=</span><span class="token function">sin</span><span class="token punctuation">(</span>angOffset2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mat2 modelMatrix2<span class="token operator">=</span><span class="token function">mat2</span><span class="token punctuation">(</span>
    cosAng2<span class="token punctuation">,</span>sinAng1<span class="token punctuation">,</span>
    <span class="token operator">-</span>sinAng2<span class="token punctuation">,</span>cosAng2
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  float <span class="token function">getBright</span><span class="token punctuation">(</span><span class="token parameter">vec2 pole</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    pole<span class="token operator">=</span>center<span class="token operator">+</span>modelMatrix2<span class="token operator">*</span><span class="token punctuation">(</span>pole<span class="token operator">-</span>center<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vec2 p<span class="token operator">=</span>gl_FragCoord<span class="token punctuation">.</span>xy<span class="token operator">-</span>pole<span class="token punctuation">;</span>
    float ang<span class="token operator">=</span><span class="token function">atan</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token punctuation">,</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> a<span class="token operator">*</span><span class="token function">sin</span><span class="token punctuation">(</span>omega<span class="token operator">*</span>ang<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.5</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec2 min<span class="token operator">=</span>u_CanvasSize<span class="token operator">*</span><span class="token number">0.25</span><span class="token punctuation">;</span>
    vec2 max<span class="token operator">=</span>u_CanvasSize<span class="token operator">*</span><span class="token number">0.75</span><span class="token punctuation">;</span>
    float bright1 <span class="token operator">=</span> <span class="token function">getBright</span><span class="token punctuation">(</span>min<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float bright2 <span class="token operator">=</span> <span class="token function">getBright</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float bright3 <span class="token operator">=</span> <span class="token function">getBright</span><span class="token punctuation">(</span><span class="token function">vec2</span><span class="token punctuation">(</span>min<span class="token punctuation">.</span>x<span class="token punctuation">,</span>max<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    float bright4 <span class="token operator">=</span> <span class="token function">getBright</span><span class="token punctuation">(</span><span class="token function">vec2</span><span class="token punctuation">(</span>max<span class="token punctuation">.</span>x<span class="token punctuation">,</span>min<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    float f<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">;</span>
    float sum<span class="token operator">=</span>bright1<span class="token operator">+</span>bright2<span class="token operator">+</span>bright3<span class="token operator">+</span>bright4<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sum<span class="token operator">&lt;</span><span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      f<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h3 id="_4-全景图的极坐标扭曲" tabindex="-1"><a class="header-anchor" href="#_4-全景图的极坐标扭曲" aria-hidden="true">#</a> 4-全景图的极坐标扭曲</h3><p>下图是提前准备好的全景图：</p><p><img src="/visual/glsl-es/21.jpg" alt=""></p><p>极坐标扭曲效果如下：</p><p><img src="/visual/glsl-es/22.png" alt=""></p><p>这就像广角镜头一样，接下来说一下代码实现。</p><p>1.建立带贴图的 rect 对象</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>const source = new Float32Array(<span class="token punctuation">[</span>
    <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">-1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span>
<span class="token punctuation">]</span>);

const rect = new Poly(<span class="token punctuation">{</span>
    gl<span class="token punctuation">,</span>
    source<span class="token punctuation">,</span>
    type<span class="token operator">:</span> &#39;TRIANGLE_STRIP&#39;<span class="token punctuation">,</span>
    attributes<span class="token operator">:</span> <span class="token punctuation">{</span>
        a_Position<span class="token operator">:</span> <span class="token punctuation">{</span>
            size<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            index<span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        a_Pin<span class="token operator">:</span> <span class="token punctuation">{</span>
            size<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            index<span class="token operator">:</span> <span class="token number">2</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    uniforms<span class="token operator">:</span> <span class="token punctuation">{</span>
        u_CanvasSize<span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> &#39;uniform2fv&#39;<span class="token punctuation">,</span>
            value<span class="token operator">:</span> <span class="token punctuation">[</span>canvas.width<span class="token punctuation">,</span> canvas.height<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>)

const image = new Image()
image.src = &#39;./images/room.jpg&#39;
image.onload = function () <span class="token punctuation">{</span>
    rect.maps = <span class="token punctuation">{</span>
        u_Sampler<span class="token operator">:</span> <span class="token punctuation">{</span> image <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    rect.updateMaps()
    render()
<span class="token punctuation">}</span>

<span class="token comment">//渲染</span>
function render() <span class="token punctuation">{</span>
    gl.clear(gl.COLOR_BUFFER_BIT);
    rect.draw()
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>2.顶点着色器</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;vertexShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-vertex&quot;</span><span class="token operator">&gt;</span>
  attribute vec4 a_Position<span class="token punctuation">;</span>
  attribute vec2 a_Pin<span class="token punctuation">;</span>
  varying vec2 v_Pin<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      gl_Position<span class="token operator">=</span>a_Position<span class="token punctuation">;</span>
      v_Pin<span class="token operator">=</span>a_Pin<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>3.片元着色器</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;fragmentShader&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;x-shader/x-fragment&quot;</span><span class="token operator">&gt;</span>
  precision mediump float<span class="token punctuation">;</span>
  uniform vec2 u_CanvasSize<span class="token punctuation">;</span>
  uniform sampler2D u_Sampler<span class="token punctuation">;</span>
  varying vec2 v_Pin<span class="token punctuation">;</span>
  vec2 center<span class="token operator">=</span>u_CanvasSize<span class="token operator">/</span><span class="token number">2.0</span><span class="token punctuation">;</span>
  float diagLen<span class="token operator">=</span><span class="token function">length</span><span class="token punctuation">(</span>center<span class="token punctuation">)</span><span class="token punctuation">;</span>
  float pi2<span class="token operator">=</span><span class="token function">radians</span><span class="token punctuation">(</span><span class="token number">360.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  float <span class="token function">getAngle</span><span class="token punctuation">(</span><span class="token parameter">vec2 v</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    float ang<span class="token operator">=</span><span class="token function">atan</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>y<span class="token punctuation">,</span>v<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ang<span class="token operator">&lt;</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        ang<span class="token operator">+=</span>pi2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ang<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vec2 p<span class="token operator">=</span>gl_FragCoord<span class="token punctuation">.</span>xy<span class="token operator">-</span>center<span class="token punctuation">;</span>
    float ang<span class="token operator">=</span><span class="token function">getAngle</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float x<span class="token operator">=</span>ang<span class="token operator">/</span>pi2<span class="token punctuation">;</span>
    float len<span class="token operator">=</span><span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float y<span class="token operator">=</span>len<span class="token operator">/</span>diagLen<span class="token punctuation">;</span>
    vec4 color<span class="token operator">=</span><span class="token function">texture2D</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span><span class="token function">vec2</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token operator">&gt;</span><span class="token number">0.0</span><span class="token operator">&amp;&amp;</span><span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      color<span class="token operator">=</span><span class="token function">texture2D</span><span class="token punctuation">(</span>u_Sampler<span class="token punctuation">,</span><span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    gl_FragColor<span class="token operator">=</span>color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h2 id="综合案例-磨砂金属按钮" tabindex="-1"><a class="header-anchor" href="#综合案例-磨砂金属按钮" aria-hidden="true">#</a> 综合案例-磨砂金属按钮</h2><p>接下来将之前说过的渐变、杂色、极坐标扭曲、拉丝融为一体，做一个磨砂金属按钮。</p><p><img src="/visual/glsl-es/23.png" alt=""></p><p>1.先制作一个磨砂材质</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-shader/x-fragment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
   precision mediump float<span class="token punctuation">;</span>
   uniform vec2 u_CanvasSize<span class="token punctuation">;</span>
   vec2 center<span class="token operator">=</span>u_CanvasSize<span class="token operator">/</span><span class="token number">2.0</span><span class="token punctuation">;</span>
   float diagLen<span class="token operator">=</span><span class="token function">length</span><span class="token punctuation">(</span>center<span class="token punctuation">)</span><span class="token punctuation">;</span>
   float pi2<span class="token operator">=</span><span class="token function">radians</span><span class="token punctuation">(</span><span class="token number">360.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   float omega<span class="token operator">=</span><span class="token number">4.0</span><span class="token punctuation">;</span>
   float a<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">;</span>

   <span class="token comment">//渐变</span>
   float <span class="token function">gradient</span><span class="token punctuation">(</span><span class="token parameter">float ang</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token keyword">return</span> a<span class="token operator">*</span><span class="token function">sin</span><span class="token punctuation">(</span>omega<span class="token operator">*</span>ang<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.5</span><span class="token punctuation">;</span> <span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//水平拉丝</span>
   float <span class="token function">wire</span><span class="token punctuation">(</span><span class="token parameter">vec2 v</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     vec2 a<span class="token operator">=</span> <span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     float n<span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token function">fract</span><span class="token punctuation">(</span><span class="token function">tan</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10000.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//杂色</span>
   float <span class="token function">noise</span><span class="token punctuation">(</span><span class="token parameter">vec2 v</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     vec2 a<span class="token operator">=</span> <span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0.1234</span><span class="token punctuation">,</span><span class="token number">0.5678</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     float n<span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token function">fract</span><span class="token punctuation">(</span><span class="token function">tan</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10000.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//获取弧度</span>
   float <span class="token function">getAngle</span><span class="token punctuation">(</span><span class="token parameter">vec2 v</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     float ang<span class="token operator">=</span><span class="token function">atan</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>y<span class="token punctuation">,</span>v<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span>ang<span class="token operator">&lt;</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         ang<span class="token operator">+=</span>pi2<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">return</span> ang<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     vec2 p<span class="token operator">=</span>gl_FragCoord<span class="token punctuation">.</span>xy<span class="token operator">-</span>center<span class="token punctuation">;</span>
     <span class="token comment">//极径</span>
     float len<span class="token operator">=</span><span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">//极角</span>
     float ang<span class="token operator">=</span><span class="token function">getAngle</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

     float x<span class="token operator">=</span>u_CanvasSize<span class="token punctuation">.</span>x<span class="token operator">*</span>ang<span class="token operator">/</span>pi2<span class="token punctuation">;</span>
     float y<span class="token operator">=</span><span class="token punctuation">(</span>len<span class="token operator">/</span>diagLen<span class="token punctuation">)</span><span class="token operator">*</span>u_CanvasSize<span class="token punctuation">.</span>y<span class="token punctuation">;</span>

  <span class="token comment">//渐变</span>
     float f1 <span class="token operator">=</span> <span class="token function">gradient</span><span class="token punctuation">(</span>ang<span class="token punctuation">)</span><span class="token punctuation">;</span>
     f1<span class="token operator">=</span><span class="token number">0.65</span><span class="token operator">*</span>f1<span class="token operator">+</span><span class="token number">0.5</span><span class="token punctuation">;</span>

  <span class="token comment">//拉丝</span>
     float f2 <span class="token operator">=</span> <span class="token function">wire</span><span class="token punctuation">(</span><span class="token function">vec2</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">int</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     f2<span class="token operator">=</span><span class="token function">clamp</span><span class="token punctuation">(</span>f2<span class="token punctuation">,</span><span class="token number">0.75</span><span class="token punctuation">,</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//杂色</span>
     float f3 <span class="token operator">=</span> <span class="token function">noise</span><span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
     f3<span class="token operator">*=</span><span class="token number">0.07</span><span class="token punctuation">;</span>

     <span class="token comment">//复合亮度</span>
     float f<span class="token operator">=</span>f1<span class="token operator">*</span>f2<span class="token operator">+</span>f3<span class="token punctuation">;</span>

     gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token function">vec3</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p>效果如下：</p><p><img src="/visual/glsl-es/24.png" alt=""></p><p>2.绘制凸出效果，对复合亮度做一下加工。</p><p><img src="/visual/glsl-es/25.png" alt=""></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>float ratio1<span class="token operator">=</span><span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token function">sin</span><span class="token punctuation">(</span>ang<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
float r<span class="token operator">=</span><span class="token number">150.0</span><span class="token punctuation">;</span>
float expand1<span class="token operator">=</span>r<span class="token operator">+</span><span class="token number">4.0</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">&gt;</span>r<span class="token operator">&amp;&amp;</span>len<span class="token operator">&lt;</span>expand1<span class="token punctuation">)</span><span class="token punctuation">{</span>
    f<span class="token operator">*=</span>ratio1<span class="token operator">+</span><span class="token number">0.3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>smoothstep(edge0,edge1,x) 求 x 在 edge0 和 edge1 间的插值[0,1]</p><ul><li><p>若 x&lt;edge0 返回 0</p></li><li><p>若 x&gt;edge1 返回 1</p></li><li><p>否则返回 x 在 edge0 和 edge1 间的插值</p></li></ul><p>例子：</p><p>smoothstep(3,7,1)=0</p><p>smoothstep(3,7,8)=1</p><p>smoothstep(3,7,5)=(5-3)/(7-3)=2/4=0.5</p><p>sin(ang)的单调性：</p><ul><li><p>ang∈[-π/2,π/2] 时，ang 越大，sin(ang)越大</p></li><li><p>ang∈[π/2,π/2+π] 时，ang 越大，sin(ang)越小</p><p>3.以此原理，我们还可以再做一圈凹陷效果。</p></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>float ratio1<span class="token operator">=</span><span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token function">sin</span><span class="token punctuation">(</span>ang<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
float ratio2<span class="token operator">=</span><span class="token number">1.0</span><span class="token operator">-</span>ratio1<span class="token punctuation">;</span>
float r<span class="token operator">=</span><span class="token number">150.0</span><span class="token punctuation">;</span>
float expand1<span class="token operator">=</span>r<span class="token operator">+</span><span class="token number">4.0</span><span class="token punctuation">;</span>
float expand2<span class="token operator">=</span>expand1<span class="token operator">+</span><span class="token number">12.0</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">&gt;</span>r<span class="token operator">&amp;&amp;</span>len<span class="token operator">&lt;</span>expand1<span class="token punctuation">)</span><span class="token punctuation">{</span>
    f<span class="token operator">*=</span>ratio1<span class="token operator">+</span><span class="token number">0.3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">&gt;</span>expand1<span class="token operator">&amp;&amp;</span>len<span class="token operator">&lt;</span>expand2<span class="token punctuation">)</span><span class="token punctuation">{</span>
    f<span class="token operator">*=</span>ratio2<span class="token operator">+</span><span class="token number">0.1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>效果如下：</p><p><img src="/visual/glsl-es/26.png" alt=""></p><p>上面的 ratio2 是实现了一个自上到下，由暗到亮的效果。</p><p>4.我们还可以再来一圈渐变，使凹凸效果更具层次。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>float ratio1<span class="token operator">=</span><span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token function">sin</span><span class="token punctuation">(</span>ang<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
float ratio2<span class="token operator">=</span><span class="token number">1.0</span><span class="token operator">-</span>ratio1<span class="token punctuation">;</span>
float r<span class="token operator">=</span><span class="token number">150.0</span><span class="token punctuation">;</span>
float expand1<span class="token operator">=</span>r<span class="token operator">+</span><span class="token number">4.0</span><span class="token punctuation">;</span>
float expand2<span class="token operator">=</span>expand1<span class="token operator">+</span><span class="token number">12.0</span><span class="token punctuation">;</span>
float expand3<span class="token operator">=</span>expand2<span class="token operator">+</span><span class="token number">2.0</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">&gt;</span>r<span class="token operator">&amp;&amp;</span>len<span class="token operator">&lt;</span>expand1<span class="token punctuation">)</span><span class="token punctuation">{</span>
    f<span class="token operator">*=</span>ratio1<span class="token operator">+</span><span class="token number">0.3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">&gt;</span>expand1<span class="token operator">&amp;&amp;</span>len<span class="token operator">&lt;</span>expand2<span class="token punctuation">)</span><span class="token punctuation">{</span>
    f<span class="token operator">*=</span>ratio2<span class="token operator">+</span><span class="token number">0.1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">&gt;</span>expand2<span class="token operator">&amp;&amp;</span>len<span class="token operator">&lt;</span>expand3<span class="token punctuation">)</span><span class="token punctuation">{</span>
    f<span class="token operator">*=</span>ratio2<span class="token operator">+</span><span class="token number">0.3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>效果如下：</p><p><img src="/visual/glsl-es/27.png" alt=""></p><p>5.也可以对代码做一点优化，把亮度和半径各自装进一个集合里。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//片元亮度集合</span>
float ratio1<span class="token operator">=</span><span class="token punctuation">(</span><span class="token function">sin</span><span class="token punctuation">(</span>ang<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2.0</span><span class="token punctuation">;</span>
float ratio2<span class="token operator">=</span><span class="token number">1.0</span><span class="token operator">-</span>ratio1<span class="token punctuation">;</span>
float ls<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
ls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>f<span class="token operator">*</span><span class="token punctuation">(</span>ratio1<span class="token operator">+</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ls<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>f<span class="token operator">*</span><span class="token punctuation">(</span>ratio2<span class="token operator">+</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ls<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span>f<span class="token operator">*</span><span class="token punctuation">(</span>ratio2<span class="token operator">+</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//初始半径</span>
float r<span class="token operator">=</span><span class="token number">150.0</span><span class="token punctuation">;</span>
<span class="token comment">//半径集合</span>
float rs<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
rs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>r<span class="token operator">+</span><span class="token number">4.0</span><span class="token punctuation">;</span>
rs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>rs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">12.0</span><span class="token punctuation">;</span>
rs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span>rs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">2.0</span><span class="token punctuation">;</span>

<span class="token comment">//基于len值，计算片元亮度</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>int i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">&gt;=</span>r<span class="token operator">&amp;&amp;</span>len<span class="token operator">&lt;</span>rs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        f<span class="token operator">=</span>ls<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    r<span class="token operator">=</span>rs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: wangdouliang@zzltop.com">wangdouliang</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/visual/assets/app.6795915a.js" defer></script>
  </body>
</html>
